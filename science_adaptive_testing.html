
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Science Learning Hub | AI 適性診斷中心</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+TC:wght@300;400;700;900&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
            mono: ['Orbitron', 'monospace'], // 用於數字顯示
          },
          colors: {
            tech: {
              bg: "#f0f4f8",
              card: "#ffffff",
              accent: "#3b82f6", // Blue-500
              success: "#10b981", // Emerald-500
              warning: "#f59e0b", // Amber-500
              error: "#ef4444",   // Red-500
              text: "#1e293b"     // Slate-800
            }
          },
          boxShadow: {
            'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
            'neumorph': '20px 20px 60px #d1d9e6, -20px -20px 60px #ffffff',
            'neumorph-inset': 'inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff',
            'glow': '0 0 15px rgba(59, 130, 246, 0.5)'
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    };
  </script>

  <style>
    body {
      background-color: #f0f4f8;
      background-image: 
        radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
      background-attachment: fixed;
    }

    /* 玻璃擬態卡片 */
    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
      border-radius: 1.5rem;
    }

    /* Loading Overlay */
    #loading-overlay {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(8px);
    }
    .tech-spinner {
      width: 60px; height: 60px;
      border: 4px solid rgba(59, 130, 246, 0.3);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 0 15px #3b82f6;
    }

    /* 賽車進度條 HUD 風格 */
    .track-container {
      background: #e2e8f0;
      box-shadow: inset 2px 2px 5px #cbd5e1, inset -2px -2px 5px #ffffff;
      border-radius: 999px;
      height: 16px;
      position: relative;
      overflow: visible;
    }
    .track-fill {
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      height: 100%;
      border-radius: 999px;
      transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
    }
    .car-wrapper {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      transition: left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
    }

    /* 選項按鈕互動 */
    .option-btn {
      transition: all 0.2s ease;
    }
    .option-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .option-btn.selected {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      color: white;
      transform: scale(1.02);
      box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
    }
    .option-btn.selected .opt-badge {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    /* PDF Report Styles (Hidden) */
    #pdf-report-content {
      width: 210mm;
      min-height: 297mm;
      background: white;
      padding: 20mm;
      font-family: 'Noto Sans TC', sans-serif;
      display: none; /* Hidden by default */
    }
    .report-header { border-bottom: 3px solid #3b82f6; padding-bottom: 10px; margin-bottom: 20px; }
    .report-section { margin-bottom: 25px; page-break-inside: avoid; }
    .report-title { font-size: 16px; font-weight: bold; color: #1e293b; margin-bottom: 10px; border-left: 4px solid #3b82f6; padding-left: 10px; }
    .score-circle { width: 100px; height: 100px; border-radius: 50%; border: 8px solid #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #3b82f6; margin: 0 auto; }
  </style>
</head>

<body class="text-slate-800 antialiased selection:bg-blue-200">

  <div id="loading-overlay" class="fixed inset-0 z-[9999] hidden flex-col justify-center items-center text-white">
    <div class="tech-spinner mb-6"></div>
    <div id="loading-title" class="text-2xl font-bold tracking-wider mb-2 font-mono">SYSTEM INITIALIZING</div>
    <div id="loading-desc" class="text-blue-200 text-sm">正在建立神經網路連接，請稍候...</div>
  </div>

  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-white/50 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="./student.html" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold transition text-sm">
          <i class="fa-solid fa-arrow-left"></i>
          <span>返回</span>
        </a>
        <div class="hidden sm:flex flex-col">
          <h1 class="text-lg font-black text-slate-800 tracking-tight leading-none">AI 適性診斷中心</h1>
          <span class="text-[10px] text-blue-500 font-mono font-bold tracking-wider">ADAPTIVE DIAGNOSIS SYSTEM</span>
        </div>
      </div>
      
      <div id="connBadge" class="flex items-center gap-2 px-4 py-1.5 rounded-full bg-slate-100 border border-slate-200 text-slate-400 text-xs font-bold shadow-inner transition-all">
        <i class="fa-solid fa-circle-notch fa-spin"></i>
        <span>連線中...</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8 pb-24">

    <section class="glass-card p-6 md:p-8 relative overflow-hidden transition-all duration-500 hover:shadow-glass">
      <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
      
      <div class="flex flex-wrap items-center justify-between mb-6 border-b border-slate-100 pb-4 relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center text-lg font-bold shadow-lg shadow-blue-500/30">1</div>
          <h2 class="text-xl font-bold text-slate-800">單元配置</h2>
        </div>
        <button id="btnReload" class="text-sm text-blue-500 hover:text-blue-700 font-bold flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition">
          <i class="fa-solid fa-rotate"></i> 重整教材庫
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 relative z-10">
        <div class="group">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Stage</label>
          <div class="relative">
            <select id="selStage" class="w-full appearance-none pl-4 pr-8 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition shadow-sm cursor-pointer"></select>
            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Grade</label>
          <div class="relative">
            <select id="selGrade" class="w-full appearance-none pl-4 pr-8 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition shadow-sm cursor-pointer"></select>
            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Semester</label>
          <div class="relative">
            <select id="selSemester" class="w-full appearance-none pl-4 pr-8 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition shadow-sm cursor-pointer"></select>
            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
        </div>

        <div class="group">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Version</label>
          <div class="relative">
            <select id="selPublisher" class="w-full appearance-none pl-4 pr-8 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition shadow-sm cursor-pointer"></select>
            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
          <div id="publisherHint" class="hidden"></div>
        </div>

        <div class="group lg:col-span-1">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Unit</label>
          <div class="relative">
            <select id="selUnit" class="w-full appearance-none pl-4 pr-8 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition shadow-sm cursor-pointer"></select>
            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
          <div id="unitHint" class="hidden"></div>
        </div>
      </div>

      <div class="mt-8 pt-6 border-t border-slate-100 flex flex-col md:flex-row items-center justify-between gap-6 relative z-10">
        <div class="flex items-center gap-4 bg-slate-50 px-4 py-2 rounded-xl border border-slate-200">
          <span class="text-sm font-bold text-slate-500">測驗題數</span>
          <div class="h-6 w-px bg-slate-300"></div>
          <input id="inpN" type="number" min="5" max="40" step="1" value="15" 
            class="w-16 bg-transparent text-center font-mono font-bold text-lg text-blue-600 focus:outline-none">
          <span class="text-xs font-bold text-slate-400">題</span>
        </div>

        <button id="btnStart" class="w-full md:w-auto px-8 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-lg shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:-translate-y-0.5 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2 group">
          <i class="fa-solid fa-rocket group-hover:animate-bounce"></i>
          <span> AI 自動命題</span>
        </button>
      </div>
    </section>

    <section class="glass-card p-6 md:p-8 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-32 h-32 bg-orange-400/5 rounded-full blur-3xl -translate-y-1/2 -translate-x-1/2"></div>

      <div class="flex items-center justify-between mb-8 relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-400 to-orange-500 text-white flex items-center justify-center text-lg font-bold shadow-lg shadow-orange-500/30">2</div>
          <div>
            <h2 class="text-xl font-bold text-slate-800">作答區</h2>
            <div class="text-[10px] text-slate-400 font-mono tracking-wider">ASSESSMENT PROGRESS</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
           <span class="font-mono text-xl font-black text-orange-500" id="progText">0/0</span>
        </div>
        <button id="btnFinish" class="hidden" disabled></button>
      </div>

      <div class="px-2 mb-10 relative z-10">
        <div class="track-container">
          <div id="progBar" class="track-fill" style="width: 0%"></div>
          <div id="turtleIcon" class="car-wrapper" style="left: 0%">
            <div class="relative">
              <i class="fa-solid fa-car-sport text-2xl text-red-500"></i>
              <div class="absolute -bottom-1 left-1 w-6 h-1 bg-black/20 blur-sm rounded-full"></div>
            </div>
          </div>
          <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 text-slate-300 text-xl z-0">
             <i class="fa-solid fa-flag-checkered"></i>
          </div>
        </div>
      </div>

      <div id="qArea" class="relative z-10 min-h-[300px]">
        
        <div id="qEmpty" class="absolute inset-0 flex flex-col items-center justify-center text-center opacity-60">
          <div class="w-24 h-24 rounded-full bg-slate-100 flex items-center justify-center mb-4 animate-float">
            <i class="fa-solid fa-gamepad text-4xl text-slate-300"></i>
          </div>
          <h3 class="text-lg font-bold text-slate-500">等待測驗啟動</h3>
          <p class="text-sm text-slate-400">請在上方選擇單元並按下按鈕</p>
        </div>

        <div id="qWrap" class="hidden animate-[fadeIn_0.5s_ease-out]">
          <div class="bg-white/60 rounded-2xl p-6 border border-white/50 shadow-inner mb-6">
            <span class="inline-block px-3 py-1 rounded-md bg-orange-100 text-orange-600 text-xs font-bold mb-3">QUESTION</span>
            <div id="qStem" class="text-xl font-medium text-slate-800 leading-relaxed font-serif"></div>
          </div>

          <div id="optWrap" class="grid grid-cols-1 gap-3 mb-8">
            </div>

          <div class="flex flex-col md:flex-row items-center gap-4 bg-white/50 p-4 rounded-xl border border-white/60">
            <div id="hint" class="flex-1 text-sm font-medium text-slate-500 flex items-center gap-2">
              <i class="fa-solid fa-circle-info text-blue-400"></i> 請選擇一個選項
            </div>
            <div class="flex gap-3 w-full md:w-auto">
              <button id="btnSubmit" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-slate-800 text-white font-bold hover:bg-slate-900 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg flex items-center justify-center gap-2">
                <span>送出</span> <i class="fa-solid fa-check"></i>
              </button>
              <button id="btnNext" disabled class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-slate-200 text-slate-400 font-bold disabled:cursor-not-allowed transition flex items-center justify-center gap-2">
                <span>下一題</span> <i class="fa-solid fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="resultSec" class="hidden glass-card p-6 md:p-8 relative overflow-hidden border-t-4 border-emerald-500">
      <div class="absolute top-0 right-0 w-40 h-40 bg-emerald-400/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>

      <div class="flex flex-wrap items-center justify-between mb-8 relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white flex items-center justify-center text-lg font-bold shadow-lg shadow-emerald-500/30">3</div>
          <h2 class="text-xl font-bold text-slate-800">AI 診斷報告</h2>
        </div>
        <div class="flex gap-3">
           <button id="btnDownloadPDF" class="text-sm bg-slate-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-900 transition flex items-center gap-2 shadow-lg hover:-translate-y-0.5">
             <i class="fa-solid fa-file-pdf"></i> 下載報告書
           </button>
           <button id="btnRestart" class="text-sm bg-white text-emerald-600 border border-emerald-200 px-4 py-2 rounded-lg font-bold hover:bg-emerald-50 transition flex items-center gap-2">
             <i class="fa-solid fa-rotate-left"></i> 重測
           </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 relative z-10">
        <div class="bg-white/80 p-6 rounded-2xl border border-emerald-100 shadow-sm flex items-center justify-between">
          <div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Accuracy</div>
            <div id="resScore" class="text-4xl font-mono font-black text-slate-800">—</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl">
            <i class="fa-solid fa-bullseye"></i>
          </div>
        </div>
        <div class="bg-white/80 p-6 rounded-2xl border border-emerald-100 shadow-sm flex items-center justify-between">
          <div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Score</div>
            <div id="resScore100" class="text-4xl font-mono font-black text-emerald-600">—</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl">
            <i class="fa-solid fa-trophy"></i>
          </div>
        </div>
        <div id="resTestId" class="hidden"></div>
        <div id="btnCopy" class="hidden"></div> </div>

      <div class="bg-red-50/50 rounded-2xl p-6 border border-red-100 mb-6 relative z-10">
        <h3 class="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-microscope"></i> 錯題概念分析
        </h3>
        <div id="resWrong" class="space-y-3"></div>
      </div>

      <div class="bg-white/60 rounded-2xl p-6 border border-slate-200 relative z-10">
        <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
          <i class="fa-solid fa-user-doctor"></i> 學習處方籤
        </h3>
        <div id="resFeedback" class="prose prose-slate max-w-none text-slate-600 font-medium"></div>
      </div>
    </section>

  </main>

  <div id="toast" class="fixed bottom-6 right-6 z-50 transform transition-all duration-300 translate-y-20 opacity-0 hidden">
    <div class="bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 border border-slate-700 max-w-sm">
      <div id="toastIcon" class="text-2xl"></div>
      <div>
        <div id="toastTitle" class="font-bold"></div>
        <div id="toastMsg" class="text-xs text-slate-400 mt-1"></div>
      </div>
    </div>
  </div>

  <div id="pdf-report-content">
    <div style="height: 1120px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border: 10px solid #f0f4f8; position: relative;">
      <div style="font-size: 80px; color: #3b82f6; margin-bottom: 20px;"><i class="fa-solid fa-atom"></i></div>
      <div style="font-size: 24px; color: #64748b; margin-bottom: 10px; font-weight: bold; letter-spacing: 2px;">AI SCHOOL 自然科學</div>
      <div style="font-size: 42px; color: #1e293b; font-weight: 900; margin-bottom: 20px; line-height: 1.2;">概念理解診斷報告書</div>
      <div id="pdf-cover-unit" style="font-size: 28px; color: #0f172a; margin-bottom: 60px; font-weight: bold; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;"></div>
      
      <div style="text-align: left; width: 60%; margin: 0 auto; font-size: 18px; line-height: 2;">
        <div style="border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between;">
          <span style="color: #64748b;">學生姓名：</span>
          <span id="pdf-cover-name" style="font-weight: bold;"></span>
        </div>
        <div style="border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; margin-top: 20px;">
          <span style="color: #64748b;">診斷日期：</span>
          <span id="pdf-cover-date" style="font-weight: bold;">2025年12月16日</span>
        </div>
      </div>
      
      <div style="position: absolute; bottom: 50px; font-size: 12px; color: #94a3b8;">Science Learning Hub • Adaptive Diagnosis System</div>
    </div>
    
    <div class="html2pdf__page-break"></div>

    <div style="padding: 40px;">
      <div class="report-header">
        <h2 style="margin: 0; color: #1e293b; font-size: 24px;">診斷分析詳情</h2>
        <span style="font-size: 12px; color: #64748b;">Report ID: <span id="pdf-test-id"></span></span>
      </div>

      <div class="report-section">
        <div class="report-title">一、測驗分數</div>
        <div style="display: flex; gap: 40px; align-items: center; background: #f8fafc; padding: 20px; border-radius: 10px;">
          <div style="text-align: center; flex: 1;">
            <div id="pdf-score-circle" class="score-circle">--</div>
            <div style="margin-top: 10px; font-size: 14px; font-weight: bold; color: #3b82f6;">總分</div>
          </div>
          <div style="flex: 2;">
            <div style="margin-bottom: 10px;">
              <span style="color: #64748b; font-size: 14px;">答對題數：</span>
              <span id="pdf-score-raw" style="font-weight: bold; font-size: 18px;"></span>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">評語：<span id="pdf-score-comment"></span></div>
          </div>
        </div>
      </div>

      <div class="report-section">
        <div class="report-title">二、錯題概念分析</div>
        <div style="font-size: 14px; color: #64748b; margin-bottom: 10px;">以下是本次測驗中發現您較不熟悉的概念：</div>
        <div id="pdf-wrong-list" style="background: #fef2f2; border: 1px solid #fee2e2; border-radius: 8px; padding: 15px;">
           </div>
      </div>

      <div class="report-section">
        <div class="report-title">三、AI 診斷與學習建議</div>
        <div id="pdf-feedback" style="font-size: 14px; line-height: 1.8; color: #334155; text-align: justify; white-space: pre-wrap;"></div>
      </div>
      
       <div style="margin-top: 50px; text-align: center; font-size: 12px; color: #cbd5e1; border-top: 1px solid #f1f5f9; padding-top: 20px;">
        本報告由 AI School 自然科學適性診斷系統自動生成，僅供學習參考。
      </div>
    </div>
  </div>

  <script>
    /* ===========================
       0) GAS URL & CONSTANTS (KEEP UNTOUCHED)
    =========================== */
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxvAOgRDBE6T-2R37UeTzo0RSQukgGOlEYyBrTw8zUSOlIKNIzLdJXozjNx4Hn6brc2/exec";
    const CONTENT_DB_ID = "1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk";
    const CONTENT_SHEET_NAME = "Sheet1";
    const USER_DB_ID = "1cDOsaa7E0EwD1R9CeCWoGf8_9ZMcFv8fxQ5d-LWUKu8";
    const USER_SHEET_NAME = "Users_student";
    const USER_STUDENTID_COL = "J";

    const ACTION = { GET_UNIT_OPTIONS: "getUnitOptions", START_CAT: "startCAT", SUBMIT_NEXT: "submitAndNext", FINISH_CAT: "finishCAT" };
    const META_ACTION_CANDIDATES = ["get_metadata", "getMaterialTree", "getTextbookMeta", "getContentMeta", "getContentOptions", "getTextbookOptions", "getLessonOptions", ACTION.GET_UNIT_OPTIONS];
    const STUDENTID_ACTION_CANDIDATES = ["getStudentIdByEmail", "getStudentIDByEmail", "resolveStudentIdByEmail", "resolveStudentIDByEmail", "resolveStudentId", "resolveStudentID", "getStudentId", "get_student_id", "getUserByEmail", "get_user_by_email", "getUser", "get_user", "getProfile", "get_profile"];

    /* ===========================
       1) GLOBAL STATE
    =========================== */
    const Meta = { mode: "tree", tree: {}, unitIndex: {}, publishers: [], unitsByPublisher: {} };
    const CAT = { started: false, test_id: "", student_id: "", current: null, next: null, selected: "", n: 15, step: 0 };

    /* ===========================
       2) UI UTILS (ENHANCED)
    =========================== */
    const UI = {
      setConn(ok, msg){
        const b = document.getElementById("connBadge");
        if(ok){
          b.innerHTML = `<i class="fa-solid fa-wifi text-emerald-500"></i> <span class="text-emerald-600">系統連線正常</span>`;
          b.className = "flex items-center gap-2 px-4 py-1.5 rounded-full bg-emerald-50 border border-emerald-200 text-xs font-bold shadow-sm transition-all";
        }else{
          b.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> <span class="text-red-600">連線中斷</span>`;
          b.className = "flex items-center gap-2 px-4 py-1.5 rounded-full bg-red-50 border border-red-200 text-xs font-bold shadow-sm transition-all";
          if(msg) UI.toast("連線失敗", msg, "warn");
        }
      },
      toast(title, msg, type="info"){
        const t = document.getElementById("toast");
        const ic = document.getElementById("toastIcon");
        const tt = document.getElementById("toastTitle");
        const tm = document.getElementById("toastMsg");

        let iconHTML = '<i class="fa-solid fa-circle-info text-blue-400"></i>';
        if(type==="good") iconHTML = '<i class="fa-solid fa-circle-check text-emerald-400"></i>';
        if(type==="warn") iconHTML = '<i class="fa-solid fa-triangle-exclamation text-amber-400"></i>';
        if(type==="bad")  iconHTML = '<i class="fa-solid fa-circle-xmark text-red-400"></i>';
        
        ic.innerHTML = iconHTML;
        tt.textContent = title || "提示";
        tm.textContent = msg || "";

        t.classList.remove("hidden");
        // Trigger reflow
        void t.offsetWidth;
        t.classList.remove("translate-y-20", "opacity-0");

        clearTimeout(UI._timer);
        UI._timer = setTimeout(()=>{
          t.classList.add("translate-y-20", "opacity-0");
          setTimeout(()=>t.classList.add("hidden"), 300);
        }, 4000);
      },
      setProgress(step, total){
        const txt = document.getElementById("progText");
        const bar = document.getElementById("progBar");
        const turtle = document.getElementById("turtleIcon");
        
        txt.textContent = `${step}/${total}`;
        const pct = total ? Math.min(100, (step/total)*100) : 0;
        
        bar.style.width = pct + "%";
        turtle.style.left = pct + "%";
      },
      showQuestion(show){
        document.getElementById("qEmpty").classList.toggle("hidden", show);
        document.getElementById("qWrap").classList.toggle("hidden", !show);
      },
      showResult(show){
        document.getElementById("resultSec").classList.toggle("hidden", !show);
        if(show) {
            setTimeout(() => {
                document.getElementById("resultSec").scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
      }
    };

    /* ===========================
       3) IDENTITY & HELPERS
    =========================== */
    function getStudentIdFromLogin(){ const storages=[sessionStorage,localStorage]; const directKeys=["student_id","StudentID","SLH_student_id","slh_student_id","user_student_id","login_student_id","current_student_id"]; for(const S of storages){ for(const k of directKeys){ const v=S.getItem(k); const s=String(v??"").trim(); if(s)return s; } } const jsonKeys=["currentUser","slh_user","SLH_USER","SLH_LOGIN","USER","LOGIN","user","auth","profile","me"]; for(const S of storages){ for(const k of jsonKeys){ const raw=S.getItem(k); if(!raw)continue; try{ const obj=JSON.parse(raw); let sid=obj?.student_id??obj?.StudentID??obj?.studentId??obj?.studentID??obj?.StudentId??obj?.sid??obj?.id??obj?.uid??obj?.user_id; if(!sid){ sid=obj?.user?.student_id??obj?.user?.StudentID??obj?.user?.studentId??obj?.profile?.student_id??obj?.profile?.StudentID??obj?.profile?.studentId; } const s=String(sid??"").trim(); if(s)return s; }catch(_){} } } const u=window.currentUser||window.USER||window.SLH_USER||window.Auth?.user; const sid=u?.student_id??u?.StudentID??u?.studentId??u?.studentID; return String(sid??"").trim()||""; }
    function __normalizeUser(u){ if(!u||typeof u!=="object")return null; const name=u.name??u.Name??u.displayName??u.nickname??u.username??""; const email=u.email??u.Email??""; const student_id=u.student_id??u.StudentID??u.studentId??u.studentID??u.StudentId??u.sid??u.id??u.uid??u.user_id??""; if(!student_id&&!name&&!email)return null; return{...u,name,email,student_id:String(student_id||"").trim()}; }
    function __loadCurrentUser(){ let raw=sessionStorage.getItem("currentUser")||localStorage.getItem("currentUser"); if(raw){try{return __normalizeUser(JSON.parse(raw));}catch(_){}} const fallbackKeys=["SLH_USER","SLH_LOGIN","USER","LOGIN","user","auth","profile","me"]; for(const k of fallbackKeys){ raw=sessionStorage.getItem(k)||localStorage.getItem(k); if(!raw)continue; try{const u=__normalizeUser(JSON.parse(raw));if(u)return u;}catch(_){} } return null; }
    function __syncLoginAliases(user){ if(!user)return null; const txt=JSON.stringify(user); try{sessionStorage.setItem("currentUser",txt);}catch(_){} try{localStorage.setItem("currentUser",txt);}catch(_){} const aliasKeys=["SLH_USER","SLH_LOGIN","USER","LOGIN","user","authUser"]; for(const k of aliasKeys){ try{sessionStorage.setItem(k,txt);}catch(_){} try{localStorage.setItem(k,txt);}catch(_){} } if(user.student_id){ const sid=String(user.student_id).trim(); try{localStorage.setItem("student_id",sid);}catch(_){} try{localStorage.setItem("StudentID",sid);}catch(_){} try{sessionStorage.setItem("student_id",sid);}catch(_){} try{sessionStorage.setItem("StudentID",sid);}catch(_){} try{localStorage.setItem("slh_user",txt);}catch(_){} } window.currentUser=user; window.USER=user; window.SLH_USER=user; window.Auth=window.Auth||{}; window.Auth.user=user; return user; }
    function __appendNameAfterConnected(name){ /* Optional UI enhancement */ }
    function __getEmailForLookup(){ const u=__loadCurrentUser?__loadCurrentUser():null; let email=String(u?.email||u?.Email||"").trim(); if(email)return email; const storages=[sessionStorage,localStorage]; const emailKeys=["email","Email","user_email","login_email","SLH_email","SLH_Email"]; for(const S of storages){ for(const k of emailKeys){ const v=String(S.getItem(k)||"").trim(); if(v&&v.includes("@"))return v; } } const sp=new URLSearchParams(location.search); email=String(sp.get("email")||sp.get("Email")||"").trim(); return email; }
    async function __resolveStudentIdByEmail(email){ const e=String(email||"").trim(); if(!e)return""; let lastErr=null; for(const act of STUDENTID_ACTION_CANDIDATES){ try{ const json=await api({ action:act, email:e, user_db_id:USER_DB_ID, user_sheet_name:USER_SHEET_NAME, student_id_col:USER_STUDENTID_COL }); const sid=json?.student_id??json?.StudentID??json?.studentId??json?.studentID??json?.data?.student_id??json?.user?.student_id??json?.profile?.student_id??json?.row?.student_id??json?.result?.student_id??""; const s=String(sid||"").trim(); if(s)return s; lastErr=new Error("回傳成功但未包含 StudentID。"); }catch(err){ lastErr=err; } } if(lastErr)throw lastErr; return""; }
    async function ensureStudentId(){ if(CAT.student_id)return String(CAT.student_id).trim(); let sid=String(getStudentIdFromLogin()||"").trim(); if(sid){ CAT.student_id=sid; return sid; } const email=__getEmailForLookup(); if(!email)return""; try{ sid=await __resolveStudentIdByEmail(email); }catch(_){ sid=""; } sid=String(sid||"").trim(); if(!sid)return""; try{localStorage.setItem("student_id",sid);}catch(_){} try{localStorage.setItem("StudentID",sid);}catch(_){} try{sessionStorage.setItem("student_id",sid);}catch(_){} try{sessionStorage.setItem("StudentID",sid);}catch(_){} try{const u=__loadCurrentUser()||{}; const merged={...u,student_id:sid,StudentID:sid,studentId:sid}; __syncLoginAliases(merged); }catch(_){} CAT.student_id=sid; return sid; }

    /* ===========================
       4) API CALLS (UNCHANGED)
    =========================== */
    function buildFormBody(payload){ const p=new URLSearchParams(); const action=payload?.action??""; if(action)p.set("action",action); if(payload?.content_db_id)p.set("content_db_id",String(payload.content_db_id)); if(payload?.sheet_name)p.set("sheet_name",String(payload.sheet_name)); if(payload?.email!=null)p.set("email",String(payload.email)); if(payload?.user_db_id)p.set("user_db_id",String(payload.user_db_id)); if(payload?.user_sheet_name)p.set("user_sheet_name",String(payload.user_sheet_name)); if(payload?.student_id_col)p.set("student_id_col",String(payload.student_id_col)); p.set("payload",JSON.stringify(payload??{})); if(payload?.subject!=null)p.set("subject",String(payload.subject)); if(payload?.stage!=null)p.set("stage",String(payload.stage)); if(payload?.grade!=null)p.set("grade",String(payload.grade)); if(payload?.semester!=null)p.set("semester",String(payload.semester)); const unit=payload?.unit; if(unit){ if(unit.subject!=null)p.set("subject",String(unit.subject)); if(unit.stage!=null)p.set("stage",String(unit.stage)); if(unit.grade!=null)p.set("grade",String(unit.grade)); if(unit.semester!=null)p.set("semester",String(unit.semester)); if(unit.textbook_version!=null)p.set("textbook_version",String(unit.textbook_version)); if(unit.unit_name!=null)p.set("unit_name",String(unit.unit_name)); if(unit.lesson_no!=null)p.set("lesson_no",String(unit.lesson_no)); if(unit.lesson_name!=null)p.set("lesson_name",String(unit.lesson_name)); if(unit.unit_key!=null)p.set("unit_key",String(unit.unit_key)); } const sid=payload?.student_id??payload?.student?.student_id; if(sid!=null)p.set("student_id",String(sid)); const keys=["test_id","item_id","response_option","max_items","min_items","stop_se","grade"]; for(const k of keys){ if(payload?.[k]!=null)p.set(k,String(payload[k])); } const settings=payload?.settings; if(settings){ if(settings.max_items!=null&&!p.has("max_items"))p.set("max_items",String(settings.max_items)); if(settings.min_items!=null&&!p.has("min_items"))p.set("min_items",String(settings.min_items)); if(settings.stop_se!=null&&!p.has("stop_se"))p.set("stop_se",String(settings.stop_se)); } return p; }
    function safeParseJSON(text){ const t=String(text??"").trim().replace(/^\)\]\}'\s*\n?/,""); try{return JSON.parse(t);}catch{return null;} }
    function normalizeOk(obj){ if(!obj||typeof obj!=="object")throw new Error("後端未回傳 JSON。"); const st=String(obj.status??"").toLowerCase(); if(st==="error"||st==="fail"||st==="failed")throw new Error(obj.message||obj.error||"後端回傳失敗（status=error）。"); if(st==="success")return{...obj,ok:true}; if(obj.ok===false)throw new Error(obj.error||obj.message||"後端回傳失敗。"); if(obj.success===false)throw new Error(obj.error||obj.message||"後端回傳失敗。"); if(obj.ok===true)return obj; if(obj.success===true)return{...obj,ok:true}; if(obj.error)throw new Error(obj.error); if(obj.message&&st)throw new Error(obj.message); return{...obj,ok:true}; }
    async function api(payload){ let lastErr=null; try{ const url=new URL(GAS_API_URL); if(payload?.action)url.searchParams.set("action",payload.action); if(payload?.content_db_id)url.searchParams.set("content_db_id",String(payload.content_db_id)); if(payload?.sheet_name)url.searchParams.set("sheet_name",String(payload.sheet_name)); if(payload?.email!=null)url.searchParams.set("email",String(payload.email)); if(payload?.user_db_id)url.searchParams.set("user_db_id",String(payload.user_db_id)); if(payload?.user_sheet_name)url.searchParams.set("user_sheet_name",String(payload.user_sheet_name)); if(payload?.student_id_col)url.searchParams.set("student_id_col",String(payload.student_id_col)); if(payload?.subject!=null)url.searchParams.set("subject",String(payload.subject)); if(payload?.stage!=null)url.searchParams.set("stage",String(payload.stage)); if(payload?.grade!=null)url.searchParams.set("grade",String(payload.grade)); if(payload?.semester!=null)url.searchParams.set("semester",String(payload.semester)); const res=await fetch(url.toString(),{method:"GET",redirect:"follow"}); const text=await res.text(); const json=safeParseJSON(text); if(json)return normalizeOk(json); throw new Error("後端未回傳 JSON（GET）。"); }catch(e){ lastErr=e; } try{ const formBody=buildFormBody(payload); const res=await fetch(GAS_API_URL,{method:"POST",body:formBody,redirect:"follow"}); const text=await res.text(); const json=safeParseJSON(text); if(json)return normalizeOk(json); throw new Error("後端未回傳 JSON（form POST）。"); }catch(e){ lastErr=e; } try{ const res=await fetch(GAS_API_URL,{method:"POST",body:JSON.stringify(payload),redirect:"follow"}); const text=await res.text(); const json=safeParseJSON(text); if(json)return normalizeOk(json); throw new Error("後端未回傳 JSON（JSON POST）。"); }catch(e){ throw new Error(String(e?.message||lastErr?.message||e)); } }
    async function ping(){ try{ const res=await fetch(GAS_API_URL,{method:"GET",redirect:"follow"}); if(!res.ok)throw new Error("HTTP "+res.status); UI.setConn(true); return true; }catch(e){ UI.setConn(false,String(e?.message||e)); return false; } }

    /* ===========================
       5) DATA PROCESSING (TREE)
    =========================== */
    function normStage(v){const s=String(v??"").trim();if(s.includes("國小")||s==="小學")return"國小";if(s.includes("國中")||s==="國中部")return"國中";return s;}
    function normSemester(v){const s=String(v??"").trim();if(s.includes("上"))return"上學期";if(s.includes("下"))return"下學期";return s;}
    function normVersion(v){return String(v??"").trim();}
    function normLessonNo(v){return String(v??"").trim();}
    function normLessonName(v){return String(v??"").trim();}
    function toIntGrade(v){const n=Number(String(v??"").replace(/[^\d]/g,""));return Number.isFinite(n)?n:NaN;}
    function buildTreeFromRows(rows){ const tree={}; const unitIndex={}; for(const r of rows){ const stage=normStage(r.stage??r["中小學"]??r["學習階段"]??r.level??r.school_stage); const grade=toIntGrade(r.grade??r["年級"]); const semester=normSemester(r.semester??r["學期"]); const version=normVersion(r.textbook_version??r.publisher??r["版本"]??r["出版社"]); const lessonNo=normLessonNo(r.lesson_no??r["課別"]??r.unit_no??r["課序"]); const lessonName=normLessonName(r.lesson_name??r["課名"]??r.unit_name??r["單元"]??r["單元名稱"]); if(!stage||!Number.isFinite(grade)||!semester||!version||!lessonName)continue; const unitName=(lessonNo?`${lessonNo} ${lessonName}`:lessonName).trim(); const unitKey=`${stage}||${grade}||${semester}||${version}||${lessonNo}||${lessonName}`; if(!tree[stage])tree[stage]={}; if(!tree[stage][grade])tree[stage][grade]={}; if(!tree[stage][grade][semester])tree[stage][grade][semester]={}; if(!tree[stage][grade][semester][version])tree[stage][grade][semester][version]=[]; tree[stage][grade][semester][version].push({unit_key:unitKey,lesson_no:lessonNo,lesson_name:lessonName,unit_name:unitName}); unitIndex[unitKey]={unit_key:unitKey,stage,grade,semester,textbook_version:version,lesson_no:lessonNo,lesson_name:lessonName,unit_name:unitName}; } for(const st of Object.keys(tree)){ for(const g of Object.keys(tree[st])){ for(const sem of Object.keys(tree[st][g])){ for(const ver of Object.keys(tree[st][g][sem])){ const arr=tree[st][g][sem][ver]||[]; const seen=new Set(); const uniq=[]; for(const u of arr){ if(seen.has(u.unit_key))continue; seen.add(u.unit_key); uniq.push(u); } uniq.sort((a,b)=>{ const an=Number(String(a.lesson_no||"").replace(/[^\d]/g,"")); const bn=Number(String(b.lesson_no||"").replace(/[^\d]/g,"")); if(Number.isFinite(an)&&Number.isFinite(bn)&&an!==bn)return an-bn; return String(a.unit_name).localeCompare(String(b.unit_name),"zh-Hant"); }); tree[st][g][sem][ver]=uniq; } } } } return{tree,unitIndex}; }
    function buildTreeFromLegacy(publishers,unitsByPublisher,grade,semester){ const tree={}; const unitIndex={}; const st=(grade<=6)?"國小":"國中"; const sem=normSemester(semester); tree[st]={}; tree[st][grade]={}; tree[st][grade][sem]={}; for(const ver of(publishers||[])){ const units=(unitsByPublisher&&unitsByPublisher[ver])?unitsByPublisher[ver]:[]; tree[st][grade][sem][ver]=[]; for(const u of units){ const unitName=String(u??"").trim(); if(!unitName)continue; const unitKey=`${st}||${grade}||${sem}||${ver}||||${unitName}`; tree[st][grade][sem][ver].push({unit_key:unitKey,lesson_no:"",lesson_name:unitName,unit_name:unitName}); unitIndex[unitKey]={unit_key:unitKey,stage:st,grade,semester:sem,textbook_version:ver,lesson_no:"",lesson_name:unitName,unit_name:unitName}; } } return{tree,unitIndex}; }
    async function loadMaterialTree(){ let lastErr=null; for(const act of META_ACTION_CANDIDATES){ try{ const json=await api({action:act,content_db_id:CONTENT_DB_ID,sheet_name:CONTENT_SHEET_NAME,subject:"自然科學"}); if(json.tree&&typeof json.tree==="object"){Meta.tree=json.tree;Meta.unitIndex=json.unitIndex||{};Meta.mode="tree";return true;} const rows=json.rows||json.data||json.items||json.materials; if(Array.isArray(rows)&&rows.length){const built=buildTreeFromRows(rows);Meta.tree=built.tree;Meta.unitIndex=built.unitIndex;Meta.mode="tree";return true;} if(Array.isArray(json.publishers)&&json.unitsByPublisher){Meta.publishers=json.publishers;Meta.unitsByPublisher=json.unitsByPublisher;Meta.mode="legacy";return true;} if(Array.isArray(json)&&json.length){const built=buildTreeFromRows(json);Meta.tree=built.tree;Meta.unitIndex=built.unitIndex;Meta.mode="tree";return true;} throw new Error("回傳格式不含教材選單資料。"); }catch(e){lastErr=e;} } throw new Error(String(lastErr?.message||lastErr||"無法載入教材選單。")); }

    /* ===========================
       6) DROPDOWNS
    =========================== */
    function setOptions(selectEl, options, placeholder){ selectEl.innerHTML=""; if(!options||options.length===0){ const op=document.createElement("option"); op.value=""; op.textContent=placeholder||"（無資料）"; selectEl.appendChild(op); return; } for(const {value,label} of options){ const op=document.createElement("option"); op.value=String(value); op.textContent=String(label); selectEl.appendChild(op); } }
    function getSelStage(){return document.getElementById("selStage").value.trim();}
    function getSelGrade(){return Number(document.getElementById("selGrade").value);}
    function getSelSemester(){return document.getElementById("selSemester").value.trim();}
    function getSelVersion(){return document.getElementById("selPublisher").value.trim();}
    function getSelUnitKey(){return document.getElementById("selUnit").value.trim();}
    function refreshAllDropdowns(){ const selStage=document.getElementById("selStage"); const selGrade=document.getElementById("selGrade"); const selSem=document.getElementById("selSemester"); const selVer=document.getElementById("selPublisher"); const selUnit=document.getElementById("selUnit"); const stageKeys=Object.keys(Meta.tree||{}).sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant")); const prevStage=selStage.value; setOptions(selStage,stageKeys.map(s=>({value:s,label:s})),"（尚無資料）"); if(prevStage&&stageKeys.includes(prevStage))selStage.value=prevStage; const stage=getSelStage(); const gradesObj=(Meta.tree&&stage&&Meta.tree[stage])?Meta.tree[stage]:{}; const gradeKeys=Object.keys(gradesObj).map(x=>Number(x)).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b); const prevGrade=selGrade.value; setOptions(selGrade,gradeKeys.map(g=>({value:g,label:`${g}年級`})),"（無年級）"); if(prevGrade&&gradeKeys.map(String).includes(String(prevGrade)))selGrade.value=prevGrade; const grade=getSelGrade(); const semObj=(gradesObj&&Number.isFinite(grade)&&gradesObj[grade])?gradesObj[grade]:{}; const semKeys=Object.keys(semObj); const semOrder=["上學期","下學期"]; semKeys.sort((a,b)=>semOrder.indexOf(a)-semOrder.indexOf(b)); const prevSem=selSem.value; setOptions(selSem,semKeys.map(s=>({value:s,label:s})),"（無學期）"); if(prevSem&&semKeys.includes(prevSem))selSem.value=prevSem; const semester=getSelSemester(); const verObj=(semObj&&semester&&semObj[semester])?semObj[semester]:{}; const verKeys=Object.keys(verObj).sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant")); const prevVer=selVer.value; setOptions(selVer,verKeys.map(v=>({value:v,label:v})),"（無題庫）"); if(prevVer&&verKeys.includes(prevVer))selVer.value=prevVer; const version=getSelVersion(); const unitsArr=(verObj&&version&&Array.isArray(verObj[version]))?verObj[version]:[]; const prevUnit=selUnit.value; setOptions(selUnit,unitsArr.map(u=>({value:u.unit_key,label:u.unit_name})),"（無單元）"); if(prevUnit&&unitsArr.some(u=>u.unit_key===prevUnit))selUnit.value=prevUnit; document.getElementById("publisherHint").textContent=""; document.getElementById("unitHint").textContent=""; }
    async function loadLegacyByGradeSemester(){ const selStage=document.getElementById("selStage"); const selGrade=document.getElementById("selGrade"); const selSem=document.getElementById("selSemester"); const selVer=document.getElementById("selPublisher"); const selUnit=document.getElementById("selUnit"); const stageOptions=[{value:"國小",label:"國小"},{value:"國中",label:"國中"}]; setOptions(selStage,stageOptions,"（無資料）"); const stage=getSelStage()||"國小"; selStage.value=stage; const gradeList=(stage==="國中")?[7,8,9]:[3,4,5,6]; setOptions(selGrade,gradeList.map(g=>({value:g,label:`${g}年級`})),"（無資料）"); setOptions(selSem,[{value:"上學期",label:"上學期"},{value:"下學期",label:"下學期"}],"（無資料）"); const grade=getSelGrade()||gradeList[0]; const semester=getSelSemester()||"上學期"; document.getElementById("publisherHint").textContent=""; document.getElementById("unitHint").textContent=""; const json=await api({ action:ACTION.GET_UNIT_OPTIONS, content_db_id:CONTENT_DB_ID, sheet_name:CONTENT_SHEET_NAME, subject:"自然科學", stage, grade, semester }); Meta.publishers=Array.isArray(json.publishers)?json.publishers:[]; Meta.unitsByPublisher=json.unitsByPublisher||{}; const publishers=Meta.publishers||[]; setOptions(selVer,publishers.map(p=>({value:p,label:p})),"（無題庫）"); const built=buildTreeFromLegacy(publishers,Meta.unitsByPublisher,grade,semester); Meta.tree=built.tree; Meta.unitIndex=built.unitIndex; refreshAllDropdowns(); }
    async function bootstrapMaterials(){ document.getElementById("publisherHint").textContent=""; document.getElementById("unitHint").textContent=""; Meta.mode="tree"; Meta.tree={}; Meta.unitIndex={}; await loadMaterialTree(); if(Meta.mode==="tree"){refreshAllDropdowns();return;} await loadLegacyByGradeSemester(); }

    /* ===========================
       7) TEST FLOW
    =========================== */
    function getUnit(){ const stage=getSelStage(); const grade=getSelGrade(); const semester=getSelSemester(); const textbook_version=getSelVersion(); const unit_key=getSelUnitKey(); const u=Meta.unitIndex[unit_key]||{}; const unit_name=(u.unit_name||"").trim(); return{subject:"自然科學",stage,grade,semester,textbook_version,unit_name,unit_key,lesson_no:u.lesson_no||"",lesson_name:u.lesson_name||""}; }
    function normalizeItem(raw){ if(!raw)return null; const optObj=raw.options||{}; return{ item_id:String(raw.item_id||"").trim(), stem:String(raw.stem||"").trim(), textbook_source:String(raw.textbook_source||"").trim(), concept_tag:String(raw.concept_tag||"").trim(), options:{ A:String(raw.option_A??optObj.A??""), B:String(raw.option_B??optObj.B??""), C:String(raw.option_C??optObj.C??""), D:String(raw.option_D??optObj.D??"") } }; }
    function parseAndRenderStimulus(rawStem){ const marker="[STIMULUS_JSON]"; const idx=rawStem.indexOf(marker); if(idx<0){return{text:rawStem,html:""};} const textPart=rawStem.substring(0,idx).trim(); const jsonPart=rawStem.substring(idx+marker.length).trim(); let htmlPart=""; try{ const data=JSON.parse(jsonPart); if(data.kind==="table"&&data.table){ const cols=data.table.columns||[]; const rows=data.table.rows||[]; htmlPart=`<div class="my-4 overflow-x-auto border border-orange-200 rounded-xl shadow-sm bg-white"><table class="min-w-full divide-y divide-orange-100 text-sm"><thead class="bg-orange-50"><tr>${cols.map(c=>`<th class="px-4 py-3 text-left font-bold text-orange-900 whitespace-nowrap">${c}</th>`).join('')}</tr></thead><tbody class="divide-y divide-orange-100 bg-white">${rows.map(r=>`<tr class="hover:bg-orange-50/50">${r.map(cell=>`<td class="px-4 py-3 text-slate-700 whitespace-nowrap">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`; } }catch(e){console.error("表格解析失敗:",e);} return{text:textPart,html:htmlPart}; }
    
    // RENDER QUESTION (UI Upgrade)
    function renderItem(item){
      UI.showQuestion(true);
      const content = parseAndRenderStimulus(item.stem || "");
      const stemDiv = document.getElementById("qStem");
      stemDiv.innerHTML = "";
      const textNode = document.createElement("div");
      textNode.textContent = content.text;
      stemDiv.appendChild(textNode);
      if (content.html) {
        const tableWrapper = document.createElement("div");
        tableWrapper.innerHTML = content.html;
        stemDiv.appendChild(tableWrapper);
      }

      const wrap = document.getElementById("optWrap");
      wrap.innerHTML = "";
      CAT.selected = "";
      
      const btnSubmit = document.getElementById("btnSubmit");
      const btnNext = document.getElementById("btnNext");
      
      btnSubmit.disabled = true;
      btnSubmit.classList.add('opacity-50', 'cursor-not-allowed');
      btnNext.disabled = true;
      btnNext.classList.add('opacity-50', 'cursor-not-allowed', 'bg-slate-200', 'text-slate-400');
      btnNext.classList.remove('bg-emerald-500', 'text-white', 'hover:bg-emerald-600', 'shadow-lg', 'animate-pulse');

      document.getElementById("hint").innerHTML = `<i class="fa-solid fa-circle-info text-blue-400"></i> 請選擇一個選項`;

      const letters = ["A","B","C","D"];
      for(const L of letters){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option-btn text-left w-full px-5 py-4 rounded-xl border border-slate-200 bg-white hover:border-blue-300 transition focus:outline-none mb-2 group flex items-start gap-4";
        btn.setAttribute("data-letter", L);
        btn.innerHTML = `
          <div class="opt-badge w-8 h-8 rounded-lg bg-slate-100 text-slate-500 font-bold flex items-center justify-center shrink-0 transition">${L}</div>
          <div class="flex-1 text-slate-700 font-medium pt-1">${escapeHtml(item.options[L] || "")}</div>
        `;
        btn.onclick = () => selectOption(L);
        wrap.appendChild(btn);
      }
    }

    function selectOption(letter){
      CAT.selected = letter;
      document.querySelectorAll("#optWrap button").forEach(b=>{
        const isSel = b.getAttribute("data-letter") === letter;
        if(isSel){
           b.classList.add("selected");
        }else{
           b.classList.remove("selected");
        }
      });
      const btnSubmit = document.getElementById("btnSubmit");
      btnSubmit.disabled = false;
      btnSubmit.classList.remove('opacity-50', 'cursor-not-allowed');
      document.getElementById("hint").innerHTML = `<i class="fa-solid fa-circle-check text-emerald-500"></i> 已選擇 <b>${letter}</b>，請按「送出」`;
    }

    async function startTest(){
      const unit = getUnit();
      if(!unit.stage || !unit.grade || !unit.semester || !unit.textbook_version || !unit.unit_name){
        UI.toast("資料不足", "請先完成單元選擇。", "warn"); return;
      }
      const sid = await ensureStudentId();
      if(!sid){ UI.toast("未取得學號", "找不到 StudentID，請重新登入。", "warn"); return; }
      const n = clampNum(Number(document.getElementById("inpN").value), 5, 40, 15);
      CAT.n = n;
      document.getElementById("btnStart").disabled = true;
      
      document.getElementById("loading-title").textContent = "AI 正在命題中...";
      document.getElementById("loading-desc").textContent = "第一次建立測驗模型約需 15-20 秒，請耐心候候";
      document.getElementById("loading-overlay").style.display = "flex";

      try{
        const json = await api({
          action: ACTION.START_CAT, student: { student_id: sid }, unit, settings: { max_items: n }
        });
        CAT.started = true;
        CAT.student_id = sid;
        CAT.test_id = json.test_id || "";
        CAT.step = 0;
        const first = normalizeItem(json.item);
        if(!first) throw new Error("後端未提供第一題。");
        CAT.current = first;
        CAT.next = null;
        UI.setProgress(0, CAT.n);
        document.getElementById("btnFinish").disabled = false;
        renderItem(first);
        UI.toast("測驗開始", "請認真作答", "good");
        // Scroll to question
        setTimeout(() => {
             const qSection = document.querySelector(".glass-card:nth-of-type(2)");
             qSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 500);
      }catch(e){
        UI.toast("開始失敗", String(e?.message || e), "bad");
        console.error(e);
      }finally{
        document.getElementById("btnStart").disabled = false;
        document.getElementById("loading-overlay").style.display = "none";
      }
    }

    async function submitAnswer(){
      if(!CAT.started || !CAT.current) return;
      if(!CAT.selected){ UI.toast("尚未選擇", "請先選擇一個選項。", "warn"); return; }
      
      const btnSubmit = document.getElementById("btnSubmit");
      const btnNext = document.getElementById("btnNext");

      btnSubmit.disabled = true;
      btnSubmit.classList.add('opacity-50');
      btnNext.disabled = true;
      document.getElementById("hint").innerHTML = `<i class="fa-solid fa-spinner fa-spin text-blue-500"></i> 答案傳輸中...`;
      
      const unit = getUnit();
      try{
        const json = await api({
          action: ACTION.SUBMIT_NEXT, test_id: CAT.test_id, student_id: CAT.student_id,
          item_id: CAT.current.item_id, response_option: CAT.selected,
          max_items: CAT.n, min_items: CAT.n, stop_se: 0, grade: String(unit.grade || "")
        });
        const prog = json.progress || {};
        CAT.step = Number(prog.n_admin || (CAT.step + 1));
        UI.setProgress(CAT.step, CAT.n);
        if(json.done === true || CAT.step >= CAT.n){ await finishTest(); return; }
        const next = normalizeItem(json.item);
        if(!next) throw new Error("後端未提供下一題。");
        CAT.next = next;
        
        btnNext.disabled = false;
        btnNext.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-slate-200', 'text-slate-400');
        btnNext.classList.add('bg-emerald-500', 'text-white', 'hover:bg-emerald-600', 'shadow-lg', 'animate-pulse');
        
        document.getElementById("hint").innerHTML = `<span class="text-emerald-600 font-bold"><i class="fa-solid fa-circle-check"></i> 作答成功！</span> 請按「下一題」。`;
      }catch(e){
        UI.toast("送出失敗", String(e?.message||e), "bad");
        btnSubmit.disabled = false;
        btnSubmit.classList.remove('opacity-50');
        document.getElementById("hint").textContent = "送出失敗，請重試。";
      }
    }

    function goNext(){
      if(!CAT.next) return;
      CAT.current = CAT.next;
      CAT.next = null;
      renderItem(CAT.current);
    }

    async function finishTest(){
      document.getElementById("btnFinish").disabled = true;
      document.getElementById("btnSubmit").disabled = true;
      document.getElementById("btnNext").disabled = true;
      
      document.getElementById("loading-title").textContent = "AI 診斷運算中...";
      document.getElementById("loading-desc").textContent = "正在分析您的概念理解模型，生成學習處方...";
      document.getElementById("loading-overlay").style.display = "flex";

      try{
        const json = await api({ action: ACTION.FINISH_CAT, test_id: CAT.test_id, student_id: CAT.student_id });
        UI.showResult(true);
        document.getElementById("loading-overlay").style.display = "none";

        document.getElementById("resScore").textContent = json.score ?? "—";
        
        const scoreStr = json.score || "0/0"; 
        const [correct, total] = scoreStr.split('/').map(Number);
        const finalScore = total ? Math.round((correct / total) * 100) : 0;
        document.getElementById("resScore100").textContent = finalScore + " 分";

        document.getElementById("resTestId").textContent = json.test_id ?? "";

        let fb = json.feedback_student || "尚無回饋";
        fb = fb.replace(/你的能力估計.*?測量精度.*?。/g, "");
        fb = fb.replace(/相對優勢概念：/g, "👍 **優勢概念**：");
        fb = fb.replace(/建議優先補強概念：/g, "💪 **補強建議**：");
        fb = fb.replace(/錯題建議回看：/g, "📖 **複習重點**：");
        
        if (finalScore === 100) {
            fb = "🎉 **太完美了！** 你的觀念非常清晰，完全掌握了這個單元！\n\n" + fb;
        }
        
        document.getElementById("resFeedback").textContent = fb.trim();
        const wrongHtml = renderWrongEnhanced(json.wrong_items || []);
        document.getElementById("resWrong").innerHTML = wrongHtml;

        // --- PREPARE PDF DATA ---
        preparePDFData(json, finalScore);

        UI.toast("診斷完成", "報告已生成", "good");
        CAT.started = false;
      }catch(e){
        document.getElementById("loading-overlay").style.display = "none";
        UI.toast("結束失敗", String(e?.message||e), "bad");
      }
    }

    function resetAll(){
      CAT.started = false; CAT.test_id = ""; CAT.current = null; CAT.next = null; CAT.selected = ""; CAT.step = 0;
      UI.setProgress(0, Number(document.getElementById("inpN").value) || 0);
      UI.showQuestion(false); UI.showResult(false);
      document.getElementById("btnFinish").disabled = true;
      document.getElementById("btnSubmit").disabled = true;
      document.getElementById("btnNext").disabled = true;
    }

    /* ===========================
       8) HELPERS & RENDERERS
    =========================== */
    function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function clampNum(x, lo, hi, fallback){ const n = Number(x); return Number.isFinite(n) ? Math.max(lo, Math.min(hi, n)) : fallback; }

    function renderWrongEnhanced(arr){
      const xs = Array.isArray(arr) ? arr : [];
      if(xs.length === 0) return `<div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-emerald-700 flex items-center gap-3"><i class="fa-solid fa-star text-xl"></i><span>太棒了！這次測驗沒有答錯的題目，概念掌握度 100%！</span></div>`;
      
      return xs.map((w, i) => {
        const concept = w.concept_tag ? `<span class="font-bold text-red-500">${escapeHtml(w.concept_tag)}</span>` : "此概念";
        const source = w.textbook_source ? `<div class="mt-2 text-sm text-slate-500 flex items-center gap-2 bg-white/50 px-3 py-1 rounded-lg w-fit"><i class="fa-solid fa-book-open text-blue-400"></i> 建議複習：${escapeHtml(w.textbook_source)}</div>` : "";
        
        return `
          <div class="p-4 bg-white rounded-xl border border-red-100 shadow-sm flex gap-4">
            <div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center font-bold shrink-0">${i+1}</div>
            <div class="flex-1">
              <div class="text-slate-700 leading-relaxed font-medium">關於「${concept}」的觀念還不夠熟悉。</div>
              ${source}
            </div>
          </div>
        `;
      }).join("");
    }
    
    // --- PDF Generation Logic ---
    function preparePDFData(json, finalScore) {
        // 1. Cover Info
        const unit = getUnit();
        document.getElementById('pdf-cover-unit').textContent = unit.unit_name || "未命名單元";
        
        const currentUser = __loadCurrentUser();
        const userName = currentUser ? (currentUser.name || currentUser.student_id) : "訪客";
        document.getElementById('pdf-cover-name').textContent = userName;
        
        // 2. Score Section
        document.getElementById('pdf-score-circle').textContent = finalScore;
        document.getElementById('pdf-score-raw').textContent = json.score || "0/0";
        document.getElementById('pdf-test-id').textContent = json.test_id || "N/A";
        
        let comment = "尚可";
        if (finalScore >= 90) comment = "優秀";
        else if (finalScore >= 80) comment = "良好";
        else if (finalScore >= 60) comment = "及格";
        else comment = "需加油";
        document.getElementById('pdf-score-comment').textContent = comment;
        
        // 3. Concept List
        const wrongListEl = document.getElementById('pdf-wrong-list');
        const xs = json.wrong_items || [];
        if (xs.length === 0) {
            wrongListEl.innerHTML = '<div style="color: #10b981; font-weight: bold;">恭喜！本次測驗無錯題，概念掌握極佳。</div>';
            wrongListEl.style.background = "#f0fdf4";
            wrongListEl.style.borderColor = "#dcfce7";
        } else {
            wrongListEl.style.background = "#fef2f2";
            wrongListEl.style.borderColor = "#fee2e2";
            wrongListEl.innerHTML = xs.map((w, i) => `
                <div style="margin-bottom: 15px; border-bottom: 1px solid #fecaca; padding-bottom: 10px;">
                    <div style="font-weight: bold; color: #b91c1c; margin-bottom: 5px;">${i+1}. 概念弱點：${escapeHtml(w.concept_tag || "未標示")}</div>
                    <div style="font-size: 13px; color: #64748b;">建議複習：${escapeHtml(w.textbook_source || "全單元")}</div>
                </div>
            `).join('');
        }

        // 4. Feedback
        document.getElementById('pdf-feedback').textContent = document.getElementById('resFeedback').textContent;
    }

    document.getElementById("btnDownloadPDF").addEventListener("click", function() {
        const element = document.getElementById('pdf-report-content');
        element.style.display = 'block'; // Show temporarily
        
        const unitName = getUnit().unit_name || "Diagnosis";
        const opt = {
          margin: 0,
          filename: `AI_Concept_Diagnosis_${unitName}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // UI Toast
        UI.toast("生成中", "正在製作您的 PDF 報告...", "info");

        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none'; // Hide again
            UI.toast("下載完成", "報告已下載", "good");
        }).catch(err => {
            console.error(err);
            element.style.display = 'none';
            UI.toast("錯誤", "PDF 生成失敗", "bad");
        });
    });

    /* ===========================
       9) INIT
    =========================== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      resetAll();
      UI.setProgress(0, clampNum(Number(document.getElementById("inpN").value),5,40,15));
      await ping();
      try{ await bootstrapMaterials(); UI.toast("準備就緒", "單元選單已更新", "good"); }
      catch(e){ UI.toast("載入失敗", String(e?.message||e), "bad"); }

      const __me = __syncLoginAliases(__loadCurrentUser());
      if(__me) __appendNameAfterConnected(__me.name);
      else UI.toast("未登入", "請先登入。", "warn");

      document.getElementById("btnReload").addEventListener("click", async ()=>{
        try{ await bootstrapMaterials(); UI.toast("已更新", "選單已重新載入。", "good"); }
        catch(e){ UI.toast("載入失敗", String(e?.message||e), "bad"); }
      });

      document.getElementById("selStage").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); else loadLegacyByGradeSemester(); });
      document.getElementById("selGrade").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); else loadLegacyByGradeSemester(); });
      document.getElementById("selSemester").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); else loadLegacyByGradeSemester(); });
      document.getElementById("selPublisher").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); });

      document.getElementById("inpN").addEventListener("change", ()=>{
        const n = clampNum(Number(document.getElementById("inpN").value),5,40,15);
        document.getElementById("inpN").value = n;
        if(!CAT.started) UI.setProgress(0, n);
      });

      document.getElementById("btnStart").addEventListener("click", startTest);
      document.getElementById("btnSubmit").addEventListener("click", submitAnswer);
      document.getElementById("btnNext").addEventListener("click", goNext);
      document.getElementById("btnFinish").addEventListener("click", finishTest);
      
      document.getElementById("btnRestart").addEventListener("click", ()=>{
        resetAll();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      document.addEventListener("keydown", (ev)=>{
        if(!CAT.started) return;
        const k = String(ev.key||"").toUpperCase();
        if(["A","B","C","D"].includes(k)){ selectOption(k); ev.preventDefault(); }
        if(k === "ENTER"){ if(!document.getElementById("btnSubmit").disabled) submitAnswer(); ev.preventDefault(); }
      });
    });
  </script>
</body>
</html>
