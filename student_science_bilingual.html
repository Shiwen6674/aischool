<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI School | ç§‘å­¸é›™èªé–±è®€</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        tech: {
                            bg: '#020617',
                            panel: 'rgba(15, 23, 42, 0.95)',
                            border: 'rgba(45, 212, 191, 0.3)',
                            accent: '#2dd4bf',
                            highlight: '#facc15'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #ccfbf1; overflow: hidden; }
        .glass-panel { background: rgba(10, 25, 47, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(45, 212, 191, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-track { background: rgba(2, 6, 23, 0.5); }
        .scroll-area::-webkit-scrollbar-thumb { background: #115e59; border-radius: 3px; }

        .nav-item { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; padding: 0.6rem 0.8rem; margin-bottom: 0.25rem; font-size: 0.9rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item:hover { background: rgba(45, 212, 191, 0.05); color: #ccfbf1; }
        .nav-item.active { background: linear-gradient(90deg, rgba(45, 212, 191, 0.1), transparent); border-left-color: #2dd4bf; color: #2dd4bf; font-weight: 700; }

        /* é»ƒè‰²æ¨™ç¤º */
        .sci-term { color: #facc15; font-weight: 700; border-bottom: 1px dashed rgba(250, 204, 21, 0.6); cursor: pointer; transition: all 0.2s; padding: 0 2px; }
        .sci-term:hover { background-color: rgba(250, 204, 21, 0.2); color: #fff; text-shadow: 0 0 10px #facc15; border-radius: 4px; }

        .custom-select { background-color: rgba(15, 23, 42, 0.8); border: 1px solid rgba(45, 212, 191, 0.3); color: #ccfbf1; appearance: none; padding-right: 1.5rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%232dd4bf' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.3rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; }

        .content-block { margin-bottom: 1rem; padding: 1rem; border-radius: 0.75rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s ease; }
        /* ... å…¶ä»–æ¨£å¼ ... */

        .en-text { 
            font-size: 1.1rem; 
            color: #2dd4bf; /* âœ… æ”¹æˆäº®ç¶ è‰² (Teal-400) */
            line-height: 1.6; 
            margin-bottom: 0.5rem; 
            font-weight: 500; 
            font-family: 'Inter', sans-serif; 
            cursor: pointer; 
            transition: color 0.2s; 
        }
        .en-text:hover { color: #fff; } /* æ»‘é¼ ç§»éå»è®Šç™½è‰²ï¼Œæ¯”è¼ƒæ˜é¡¯ */

        .zh-text { 
            font-size: 1rem; 
            color: #ffffff; /* âœ… æ”¹æˆç´”ç™½è‰² */
            line-height: 1.6; 
            padding-left: 8px; 
            border-left: 3px solid rgba(45, 212, 191, 0.3); 
            cursor: pointer; 
        }
        .zh-text:hover { color: #2dd4bf; } /* æ»‘é¼ ç§»éå»è®Šäº®ç¶ è‰² */

        /* ... å…¶ä»–æ¨£å¼ ... */

        .section-header { font-size: 1.4rem; font-weight: 800; color: #fff; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(45, 212, 191, 0.3); display: flex; align-items: center; gap: 0.5rem; }
        .section-header::before { content: ''; display: block; width: 5px; height: 24px; background: #2dd4bf; border-radius: 2px; }

        /* Vocab List Style */
        .vocab-item { background: rgba(15, 23, 42, 0.6); border-bottom: 1px solid rgba(45, 212, 191, 0.1); padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .vocab-item:hover { background: rgba(250, 204, 21, 0.05); }

        #canvas-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .loader { border: 2px solid rgba(45, 212, 191, 0.1); border-top: 2px solid #2dd4bf; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* æ­£åœ¨æœ—è®€çš„é«˜äº®æ¨£å¼ */
        /* æ­£åœ¨æœ—è®€çš„é«˜äº®æ¨£å¼ï¼šåŠ å…¥æµå…‰å‹•ç•« */
    .reading-active {
        /* è¨­å®šæ¼¸å±¤èƒŒæ™¯ï¼šå·¦é‚Šæ·º -> ä¸­é–“äº® -> å³é‚Šæ·º */
        background: linear-gradient(
            90deg, 
            rgba(45, 212, 191, 0.05) 0%, 
            rgba(45, 212, 191, 0.25) 50%, 
            rgba(45, 212, 191, 0.05) 100%
        ) !important;
        
        /* è®“èƒŒæ™¯æ¯”å€å¡Šå¤§ï¼Œé€™æ¨£æ‰èƒ½ç§»å‹• */
        background-size: 200% 100% !important;
        
        /* å•Ÿå‹•å‹•ç•«ï¼š3ç§’è·‘ä¸€æ¬¡ï¼Œç„¡é™å¾ªç’° */
        animation: reading-scan 3s linear infinite;
        
        border-left: 4px solid #facc15 !important;
        box-shadow: 0 0 15px rgba(45, 212, 191, 0.1);
        transition: all 0.3s ease;
    }

    /* å®šç¾©å‹•ç•«é—œéµå½±æ ¼ */
    @keyframes reading-scan {
        0% { background-position: 100% 0; }
        100% { background-position: -100% 0; }
    }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-teal-500/30 selection:text-white">

    <div id="canvas-container"><canvas id="molecule-canvas"></canvas></div>

    <div id="loader-overlay" class="absolute inset-0 bg-[#020617] z-50 flex flex-col items-center justify-center">
        <i class="fa-solid fa-satellite-dish text-5xl text-teal-400 animate-pulse mb-4"></i>
        <div class="text-teal-500 tracking-widest mt-2 font-bold">è³‡æ–™åº«é€£ç·šä¸­...</div>
    </div>

    <nav class="glass-panel sticky top-0 z-40 h-auto md:h-16 flex flex-col md:flex-row items-center shrink-0 border-b-0 shadow-lg">
        <div class="w-full px-4 md:px-6 py-2 flex justify-between items-center border-b border-teal-500/20 md:border-b-0">
            <div class="flex items-center gap-4">
                <button onclick="goBack()" class="flex items-center gap-2 text-teal-400 hover:text-white transition group">
                    <div class="p-1 rounded border border-teal-500/30 group-hover:bg-teal-500/20">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                    <span class="text-sm font-bold tracking-wider hidden md:inline" data-i18n="return">è¿”å›</span>
                </button>
                <div class="flex items-center gap-2 cursor-default">
                    <div class="w-8 h-8 rounded-lg bg-teal-500/10 border border-teal-500/30 flex items-center justify-center text-teal-400">
                        <i class="fa-solid fa-book-journal-whills"></i>
                    </div>
                    <span class="text-lg font-bold text-white tracking-wide" data-i18n="page_title">ç§‘å­¸é›™èªé–±è®€</span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex bg-slate-900/80 rounded-lg p-1 border border-teal-500/30">
                    <button onclick="setMode('en')" class="mode-btn px-2 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-en">EN</button>
                    <button onclick="setMode('dual')" class="mode-btn px-2 py-1 text-xs font-bold rounded bg-teal-600 text-white shadow-[0_0_10px_rgba(45,212,191,0.4)]" id="btn-dual">DUAL</button>
                    <button onclick="setMode('zh')" class="mode-btn px-2 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-zh">ç¹ä¸­</button>
                </div>

                <select id="ui-lang" class="bg-slate-900/80 border border-teal-500/30 text-teal-100 rounded-lg px-2 py-1 text-xs outline-none cursor-pointer hover:bg-slate-800" onchange="changeLanguage()">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                </select>
            </div>
        </div>

        <div class="w-full px-4 md:px-6 py-2 bg-slate-900/80 flex flex-wrap gap-2 items-center text-sm border-t border-teal-500/20 md:border-t-0 md:bg-transparent justify-end">
            <span class="text-xs font-bold text-teal-500 mr-2"><i class="fa-solid fa-filter"></i> ç¯©é¸:</span>
            <select id="sel-stage" class="custom-select px-2 py-1 rounded w-24 text-xs font-bold" onchange="filterUnits('stage')"><option value="" disabled selected data-i18n="stage">å­¸ç¿’éšæ®µ</option></select>
            <select id="sel-grade" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" onchange="filterUnits('grade')" disabled><option value="" disabled selected data-i18n="grade">å¹´ç´š</option></select>
            <select id="sel-version" class="custom-select px-2 py-1 rounded w-24 text-xs font-bold" onchange="filterUnits('version')" disabled><option value="" disabled selected data-i18n="version">ç‰ˆæœ¬</option></select>
            <select id="sel-semester" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" onchange="filterUnits('semester')" disabled><option value="" disabled selected data-i18n="semester">å­¸æœŸ</option></select>
            <select id="sel-unit" class="custom-select px-2 py-1 rounded flex-grow md:flex-grow-0 md:w-64 text-xs font-bold" onchange="loadSelectedUnit()" disabled><option value="" disabled selected data-i18n="unit">é¸æ“‡å–®å…ƒ</option></select>
        </div>
    </nav>

    <div class="flex-grow flex overflow-hidden p-4 gap-4 relative z-10">

        <aside class="w-64 glass-panel rounded-2xl flex flex-col overflow-hidden hidden md:flex">
            <div class="p-4 border-b border-teal-500/20 bg-slate-900/40">
                <h3 class="text-xs font-bold text-teal-500 tracking-widest mb-1" data-i18n="nav">ç›®éŒ„å°èˆª</h3>
                <div class="text-white font-bold text-sm truncate" id="nav-title">è«‹é¸æ“‡å–®å…ƒ</div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-2 space-y-1" id="unit-list">
                <div class="text-center text-slate-500 text-xs mt-10 p-4" data-i18n="select_hint">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å–®å…ƒã€‚</div>
            </div>
        </aside>

        <section class="flex-grow glass-panel rounded-2xl flex flex-col relative overflow-hidden">
            <div class="h-10 border-b border-teal-500/20 bg-slate-900/40 flex items-center justify-between px-6 gap-3">
                <div class="flex items-center gap-2 min-w-0">
                    <i class="fa-solid fa-file-lines text-teal-400"></i>
                    <span class="text-xs font-bold text-teal-200 truncate" id="status-bar">READY</span>
                    <span id="trans-loading" class="hidden text-xs text-teal-400 flex items-center gap-1 ml-2"><div class="loader"></div> Translating...</span>
                </div>

                <div class="flex items-center gap-3 shrink-0 bg-slate-900/50 rounded-full px-3 py-1 border border-teal-500/20">
                    <select id="play-rate" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" title="èªé€Ÿ">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                    </select>

                    <div class="h-4 w-px bg-teal-500/30"></div>

                    <div class="flex items-center gap-1">
                        <button onclick="setVoice('male')" id="btn-male" class="text-teal-400 p-1 hover:text-white" title="ç”·è²">
                            <i class="fa-solid fa-person text-lg"></i>
                        </button>
                        <button onclick="setVoice('female')" id="btn-female" class="text-slate-500 p-1 hover:text-white" title="å¥³è²">
                            <i class="fa-solid fa-person-dress text-lg"></i>
                        </button>
                    </div>

                    <div class="h-4 w-px bg-teal-500/30"></div>

                    <div class="flex items-center gap-2">
                        <button onclick="toggleSpeech()" class="w-8 h-8 flex items-center justify-center rounded-full bg-teal-600 hover:bg-teal-500 text-white transition shadow-lg" id="btn-play" title="æ’­æ”¾/æš«åœ">
                            <i class="fa-solid fa-play text-xs"></i>
                        </button>
                        <button onclick="stopSpeech()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-700 hover:bg-red-500 text-white transition shadow-lg" title="åœæ­¢">
                            <i class="fa-solid fa-stop text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto p-6 md:p-8 relative" id="reading-container">
                <article class="max-w-4xl mx-auto transition-opacity duration-500" id="article-body">
                    <h1 class="text-2xl md:text-3xl font-black text-white mb-6 font-heading tracking-tight text-center" id="article-title">
                        <span class="text-slate-500 opacity-50" data-i18n="select_hint">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å–®å…ƒ</span>
                    </h1>
                    <div id="article-content" class="space-y-4"></div>
                </article>
            </div>
        </section>

        <aside class="w-80 glass-panel rounded-2xl flex flex-col overflow-hidden hidden lg:flex border-l border-teal-500/30">
            <div class="p-4 border-b border-teal-500/20 bg-gradient-to-r from-slate-900/80 to-teal-900/20">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                    <h3 class="text-xs font-bold text-teal-400 tracking-widest" data-i18n="vocab_title">ç§‘å­¸è©å½™åº«</h3>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto" id="vocab-container">
                <div class="text-center py-10 opacity-50 text-sm text-teal-200/50" data-i18n="vocab_empty">
                    è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤
                </div>
            </div>
        </aside>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 border border-teal-500/30 text-teal-100 px-4 py-2 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-2 pointer-events-none text-sm font-bold">
        <i class="fa-solid fa-circle-check text-teal-400"></i> <span id="toast-msg">Ready</span>
    </div>

    <script>
        const SHEET_ID = '1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk';
        const TARGET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbgkNiMflfeLQd3KN8F4yjjIr6G2flnCAy-nUPMiC7_xDfdg_0hJ2Qzbsr92u8htlPLFR8GwwQPK_g/pub?gid=0&single=true&output=csv';

        const COL_STAGE=0, COL_VERSION=2, COL_GRADE=3, COL_SEMESTER=4, COL_UNIT_NUM=6, COL_UNIT_NAME=7,
              COL_CONTENT=8, COL_CKIP=9, COL_VOCAB=18;

        let rawData=[], processedUnits=[], isSpeaking=false, currentVoice='male', translationCache={}, synth=window.speechSynthesis;
        let activeVocabMap = {};

        let currentUnitTitleZh = "";
        let currentUnitTitleEn = "";

        const i18n = {
            'zh-TW': { return: 'è¿”å›', page_title: 'ç§‘å­¸é›™èªé–±è®€', nav: 'ç›®éŒ„å°èˆª', vocab_title: 'ç§‘å­¸è©å½™åº«', select_hint: 'è«‹å…ˆé¸æ“‡å–®å…ƒ', vocab_empty: 'è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤', stage: 'å­¸ç¿’éšæ®µ', grade: 'å¹´ç´š', version: 'ç‰ˆæœ¬', semester: 'å­¸æœŸ', unit: 'é¸æ“‡å–®å…ƒ' },
            'en': { return: 'RETURN', page_title: 'SCI-LINGUA READER', nav: 'NAVIGATION', vocab_title: 'VOCABULARY', select_hint: 'Select a unit to begin', vocab_empty: 'Terms will appear here', stage: 'Stage', grade: 'Grade', version: 'Version', semester: 'Semester', unit: 'Select Unit' },
            'ja': { return: 'æˆ»ã‚‹', page_title: 'ç§‘å­¦ãƒã‚¤ãƒªãƒ³ã‚¬ãƒ«', nav: 'ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³', vocab_title: 'ç§‘å­¦ç”¨èª', select_hint: 'å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„', vocab_empty: 'ç”¨èªã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™', stage: 'æ®µéš', grade: 'å­¦å¹´', version: 'ç‰ˆ', semester: 'å­¦æœŸ', unit: 'å˜å…ƒé¸æŠ' },
            'zh-CN': { return: 'è¿”å›', page_title: 'ç§‘å­¦åŒè¯­é˜…è¯»', nav: 'ç›®å½•å¯¼èˆª', vocab_title: 'ç§‘å­¦è¯æ±‡åº“', select_hint: 'è¯·å…ˆé€‰æ‹©å•å…ƒ', vocab_empty: 'è¯æ±‡å°†æ˜¾ç¤ºäºæ­¤', stage: 'å­¦ä¹ é˜¶æ®µ', grade: 'å¹´çº§', version: 'ç‰ˆæœ¬', semester: 'å­¦æœŸ', unit: 'é€‰æ‹©å•å…ƒ' }
        };

        document.addEventListener('DOMContentLoaded', () => {
  initCanvas(); fetchData();
  if(synth) synth.onvoiceschanged = () => synth.getVoices();

  // iOS Safariï¼šéœ€è¦ã€Œä½¿ç”¨è€…æ‰‹å‹¢ã€æ‰æœƒç©©å®šè¼‰å…¥/å•Ÿå‹• TTS
  document.addEventListener('touchstart', () => {
    try{
      if(!synth) return;
      synth.cancel();
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;              // ä¸å‡ºè²
      u.rate = 1.0;
      u.pitch = 1.0;
      synth.speak(u);
      synth.cancel();
      synth.getVoices?.();
    }catch(e){}
  }, { once: true, passive: true });
});


        function goBack() { window.location.href = 'student_science.html'; }

        function fetchData() {
            Papa.parse(TARGET_URL, {
                download: true, header: false,
                complete: res => { processData(res.data); document.getElementById('loader-overlay').style.display='none'; showToast("è³‡æ–™åº«é€£ç·šæˆåŠŸ"); },
                error: () => document.getElementById('loader-overlay').innerHTML='<div class="text-red-500">Error: Check Network</div>'
            });
        }

        const norm = (s) => (s ?? '').toString()
            .replace(/[\uFEFF\u200B\u200C\u200D]/g,'')
            .replace(/ã€€/g,' ')
            .trim();

        function parseVocabPairs(vocabText){
          const map = {};
          if(!vocabText) return map;

          vocabText.split(/[,;ï¼Œï¼›\n]+/).forEach(token=>{
            const t = (token||"").toString().trim();
            if(!t) return;

            let zh = "", en = "";

            const tabParts = t.split(/\t+/);
            if(tabParts.length >= 2){
              zh = tabParts[0].trim();
              en = tabParts.slice(1).join(' ').trim();
            } else {
              const sepParts = t.split(/[:ï¼š=ï¼]/);
              if(sepParts.length >= 2){
                zh = sepParts[0].trim();
                en = sepParts.slice(1).join(':').trim();
              } else {
                const m = t.match(/^(.+?)[ï¼ˆ(]\s*([^)ï¼‰]+?)\s*[)ï¼‰]\s*$/);
                if(m){
                  zh = (m[1]||"").trim();
                  en = (m[2]||"").trim();
                } else {
                  zh = t.trim();
                  en = "";
                }
              }
            }

            if(zh) map[zh] = en;
          });

          return map;
        }

        function ckipLineToPlainAndHtml(ckipLine, vocabMap){
          const raw = (ckipLine || "").toString().trim();
          if(!raw) return { plain: "", html: "" };

          const tokens = raw.replace(/ã€€/g, " ").split(/\s+/).filter(Boolean);

          let plain = "";
          let html = "";

          for(const tok of tokens){
            const base = tok.replace(/[\(ï¼ˆ].*$/, "");
            if(!base) continue;

            plain += base;

            const safeBase = escapeHtml(base);
            if(vocabMap && Object.prototype.hasOwnProperty.call(vocabMap, base)){
              const en = (vocabMap[base] || base).toString();
              const js = en.replace(/'/g, "\\'");
              const title = escapeHtml((vocabMap[base] || "").toString());
              html += `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${title}">${safeBase}</span>`;
            } else {
              html += safeBase;
            }
          }

          return { plain, html };
        }

        function processData(data) {
            rawData = data.slice(1);
            processedUnits = rawData.map((row, i) => {
                let content = (row[COL_CONTENT]||"").toString(),
                    ckip = (row[COL_CKIP]||"").toString(),
                    unitNum = norm(row[COL_UNIT_NUM]),
                    unitName = norm(row[COL_UNIT_NAME]);

                let title = (unitNum + (unitName ? " " + unitName : "")).trim() || `Unit ${i+1}`;

                return {
                    id: i,
                    stage: norm(row[COL_STAGE]),
                    version: norm(row[COL_VERSION]),
                    grade: norm(row[COL_GRADE]),
                    semester: norm(row[COL_SEMESTER]),
                    title,
                    content,
                    ckip,
                    vocab: (row[COL_VOCAB]||"").toString()
                };
            }).filter(u => (u.content || u.ckip).length > 5);

            initFilters();
        }

        function initFilters() { populateSelect('sel-stage', [...new Set(processedUnits.map(u=>u.stage).filter(Boolean))], 'stage'); }

        function filterUnits(lvl) {
            const ids=['stage','grade','version','semester','unit'], sels=ids.map(id=>document.getElementById(`sel-${id}`));
            let filtered = processedUnits.filter(u => {
                if(sels[0].value && u.stage!==sels[0].value) return false;
                if(sels[1].value && !sels[1].disabled && u.grade!==sels[1].value) return false;
                if(sels[2].value && !sels[2].disabled && u.version!==sels[2].value) return false;
                if(sels[3].value && !sels[3].disabled && u.semester!==sels[3].value) return false;
                return true;
            });

            const update=(sel,p,key)=> populateSelect(sel.id, [...new Set(filtered.map(u=>u[p]).filter(Boolean))], key);

            if(lvl==='stage') { update(sels[1],'grade','grade'); resetSelects(sels.slice(2)); }
            else if(lvl==='grade') { update(sels[2],'version','version'); resetSelects(sels.slice(3)); }
            else if(lvl==='version') { update(sels[3],'semester','semester'); resetSelects(sels.slice(4)); }
            else if(lvl==='semester') {
                sels[4].innerHTML='<option value="" disabled selected data-i18n="unit">é¸æ“‡å–®å…ƒ</option>';
                filtered.forEach(u=>sels[4].add(new Option(u.title,u.id)));
                sels[4].disabled=false;
                changeLanguage();
            }
        }

        function populateSelect(id,items,i18nKey){
            const s=document.getElementById(id);
            s.innerHTML=`<option value="" disabled selected data-i18n="${i18nKey}">${(i18n['zh-TW'][i18nKey]||'Select')}</option>`;
            items.forEach(i=>s.add(new Option(i,i)));
            s.disabled=false;
            changeLanguage();
        }
        function resetSelects(els){
            els.forEach(e=>{
                const key = e.id.replace('sel-','');
                e.innerHTML=`<option value="" disabled selected data-i18n="${key}">...</option>`;
                e.disabled=true;
            });
            changeLanguage();
        }

        function loadSelectedUnit(){ const u=processedUnits.find(i=>i.id==document.getElementById('sel-unit').value); if(u) renderArticle(u); }

        function renderVocabSidebar() {
          const container = document.getElementById('vocab-container');
          container.innerHTML = '';
          const keys = Object.keys(activeVocabMap || {});
          if(keys.length === 0) {
            container.innerHTML = '<div class="text-center opacity-50 text-sm mt-10">ç„¡è©å½™è³‡æ–™</div>';
            return;
          }

          keys.forEach(zh => {
            const enVal = (activeVocabMap[zh] || "").toString().trim();
            const showEn = enVal ? enVal : "Loading...";

            const card = document.createElement('div');
            card.className = "vocab-item";
            card.innerHTML = `
              <div class="flex-1 pr-2">
                <div class="text-base font-bold text-yellow-400 cursor-pointer"
                     onclick="speakText('${zh.replace(/'/g,"\\'")}')">${escapeHtml(zh)}</div>

                <div class="text-xs text-teal-200 en-term-label cursor-pointer"
                     data-zh="${escapeHtml(zh)}"
                     onclick="speakVocabEn('${zh.replace(/'/g,"\\'")}', this)">${escapeHtml(showEn)}</div>
              </div>

              <div class="flex items-center gap-1">
                <button onclick="event.stopPropagation(); speakText('${zh.replace(/'/g,"\\'")}')"
                        class="text-teal-300 hover:text-white px-2 py-1 rounded-full hover:bg-white/10 text-xs font-bold"
                        title="å¿µä¸­æ–‡">ä¸­</button>

                <button onclick="event.stopPropagation(); speakVocabEn('${zh.replace(/'/g,"\\'")}', this)"
                        class="text-teal-400 hover:text-white px-2 py-1 rounded-full hover:bg-white/10 text-xs font-bold"
                        title="Read English">EN</button>
              </div>
            `;

            container.appendChild(card);

            if(!enVal) translateVocabItem(zh, card.querySelector('.en-term-label'));
          });
        }

        async function speakVocabEn(zh, btn){
          const card = btn && btn.closest ? btn.closest('.vocab-item') : null;
          const label = card ? card.querySelector('.en-term-label') : null;

          let en = (activeVocabMap[zh] || "").toString().trim();

          if(!en){
            await translateVocabItem(zh, label);
            en = (activeVocabMap[zh] || "").toString().trim();
          }

          speakText(en || zh);
        }

        async function translateToEn(text) {
          const src = (text || "").toString().trim();
          if(!src) return "";

          const cacheKey = "__title__" + src;
          if(translationCache[cacheKey]) return translationCache[cacheKey];

          const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`);
          const json = await res.json();
          let out = "";
          (json[0] || []).forEach(x => out += (x[0] || ""));
          translationCache[cacheKey] = out;
          return out;
        }

        function ensureTitleTranslated() {
          if(!currentUnitTitleZh) return;
          const existing = document.getElementById('title-en');
          if(existing && existing.innerText && existing.innerText !== 'Translating...') return;

          translateToEn(currentUnitTitleZh).then(en => {
            currentUnitTitleEn = en || "";
            const enEl = document.getElementById('title-en');
            if(enEl) enEl.innerText = currentUnitTitleEn || "";
          }).catch(() => {});
        }

        function rehighlightEnglishBlocks(){
          const ens = document.querySelectorAll('.en-text');
          ens.forEach(el => {
            const src = decodeURIComponent(el.getAttribute('data-source') || "");

            const cached = translationCache[src];
            if(cached){
              el.innerHTML = makeClickable(highlightEnglishVocabInText(cached));
            }
          });
        }

async function renderArticle(unit) {
            currentUnitTitleZh = unit.title;
            currentUnitTitleEn = "";

            document.getElementById('article-title').innerHTML = `
              <div id="title-zh">${escapeHtml(currentUnitTitleZh)}</div>
              <div id="title-en" class="text-base md:text-lg font-semibold text-teal-400 italic mt-2">Translating...</div>
            `;

            document.getElementById('status-bar').innerText = unit.title;
            document.getElementById('nav-title').innerText = unit.title;

            activeVocabMap = parseVocabPairs(unit.vocab);
            renderVocabSidebar();

            const contentDiv = document.getElementById('article-content');
            contentDiv.innerHTML='';
            document.getElementById('unit-list').innerHTML='';

            let lines = (unit.content || "").split('\n').map(x=>x.trim()).filter(Boolean);

            if(lines.length===0 && unit.ckip){
                lines = unit.ckip.split('\n')
                  .map(x=>x.replace(/ã€€/g,' ').replace(/\([^)]*\)/g,'').trim())
                  .filter(Boolean);
            }

            const unitCkipSet = unit.ckip ? getCkipTokenSet(unit.ckip) : null;
            const unitCkipTokens = unit.ckip ? getCkipTokenArray(unit.ckip) : [];
            const unitMergeSet = buildCkipMergeSet(unitCkipTokens, getMaxKeyLen(activeVocabMap));

            for(let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                if(!line) continue;

                if((line.length<40 && !/[ã€‚ï¼ï¼Ÿ.!?]$/.test(line)) || line.includes("æ´»å‹•")) {
                    const anchorId = `sec-${i}`;
                    const navItem = document.createElement('div');
                    navItem.className='nav-item';
                    navItem.innerText = line;
                    navItem.onclick=()=>{ document.getElementById(anchorId).scrollIntoView({behavior:'smooth',block:'center'}); };
                    document.getElementById('unit-list').appendChild(navItem);

                    // âœ… [ä¿®æ”¹] æ¨™é¡Œå€ï¼šä¸­æ–‡ç¶­æŒç™½å­—ï¼Œè‹±æ–‡æ”¹æˆäº®ç¶ è‰² (text-teal-400)
                    contentDiv.innerHTML += `
                        <h2 id="${anchorId}" class="section-header items-start">
                            <div class="flex flex-col w-full">
                                <span class="zh-text text-xl md:text-2xl font-black text-white cursor-pointer hover:text-teal-300 transition" onclick="speakText(this.innerText)">${escapeHtml(line)}</span>
                                <span class="en-text hidden text-base md:text-lg text-teal-400 italic mt-1 font-medium cursor-pointer hover:text-white transition" 
                                      data-source="${encodeURIComponent(line)}"
                                      onclick="speakText(this.innerText)"></span>
                            </div>
                        </h2>`;
                } else {
                    let processed = processXRayWithCKIP(line, activeVocabMap, unitCkipSet, unitMergeSet);

                    // âœ… [ä¿®æ”¹] å…§æ–‡å€ï¼šè‹±æ–‡æ”¹æˆäº®ç¶ è‰² (text-teal-400)
                    contentDiv.innerHTML += `
                        <div class="content-block">
                            <p class="zh-text" onclick="speakText(this.innerText)">${processed}</p>
                            <p class="en-text hidden text-teal-400 italic text-sm mt-2"
                               onclick="speakText(this.innerText)"
                               data-source="${encodeURIComponent(line)}"></p>
                        </div>`;
                }
            }

            setMode('dual');
        }

        function getCkipTokenSet(ckipLine){
          const raw = (ckipLine || "").toString().trim();
          if(!raw) return new Set();
          return new Set(
            raw.replace(/ã€€/g, " ")
               .split(/\s+/)
               .filter(Boolean)
               .map(tok => tok.replace(/[\(ï¼ˆ].*$/, ""))
               .filter(Boolean)
          );
        }
function getCkipTokenArray(ckipText) {
  const raw = (ckipText || "").toString().replace(/ã€€/g, " ").trim();
  if (!raw) return [];
  return raw
    .split(/\s+/)
    .filter(Boolean)
    .map(tok => tok.replace(/[\(ï¼ˆ].*$/, "")) // å»æ‰ (POS)
    .filter(Boolean);
}

function getMaxKeyLen(vocabMap) {
  const keys = Object.keys(vocabMap || {});
  if (!keys.length) return 1;
  let m = 1;
  for (const k of keys) m = Math.max(m, (k || "").length);
  return m;
}

// å»ºç«‹ã€Œç›¸é„° token ä¸²æ¥ã€çš„å€™é¸é›†åˆï¼ˆç”¨æ–¼ï¼šæ°´æœ = æ°´+æœ é€™ç¨®æƒ…æ³ï¼‰
function buildCkipMergeSet(tokens, maxLen) {
  const set = new Set();
  if (!tokens || !tokens.length) return set;

  const L = Math.max(2, maxLen || 2);
  for (let i = 0; i < tokens.length; i++) {
    let acc = "";
    for (let j = i; j < tokens.length; j++) {
      acc += tokens[j];
      if (acc.length > L) break;
      if (acc.length >= 2) set.add(acc);
    }
  }
  return set;
}

// åˆ¤æ–·ã€Œæ˜¯å¦å…è¨±æ¨™è¨»ã€ï¼š
// - å–®å­—è©ï¼ˆå¦‚ æ°´ï¼‰ï¼šå¿…é ˆæ˜¯ CKIP token æ‰èƒ½æ¨™ï¼ˆé¿å…æŠŠã€Œæ°´å¹³ã€è£¡çš„æ°´èª¤æ¨™ï¼‰
// - å¤šå­—è©ï¼ˆå¦‚ æ°´æœï¼‰ï¼šè‹¥æ˜¯ token æˆ–å¯ç”±ç›¸é„° token ä¸²æ¥å¾—åˆ°ï¼Œå³å¯æ¨™
function shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet) {
  if (!term) return false;

  // æ²’æœ‰ CKIP è³‡è¨Šå°±é€€åŒ–æˆï¼šåªé  S æ¬„å­—å…¸ï¼ˆä»å¯é‹ä½œï¼‰
  if (!ckipTokenSet || ckipTokenSet.size === 0) return true;

  if (term.length === 1) return ckipTokenSet.has(term);

  if (ckipTokenSet.has(term)) return true;
  if (ckipMergeSet && ckipMergeSet.has(term)) return true;

  return false;
}

function processXRayWithCKIP(text, map, ckipTokenSet, ckipMergeSet) {
  const src = (text || "").toString().replace(/ã€€/g, "");
  const keys = Object.keys(map || {}).filter(Boolean).sort((a, b) => b.length - a.length);
  if (!keys.length) return escapeHtml(src);

  // é•·è©å„ªå…ˆï¼šå…ˆå»ºç«‹ã€Œä¸é‡ç–Šã€çš„å‘½ä¸­å€é–“ï¼ˆspanï¼‰
  const spans = [];

  const overlaps = (s, e) => spans.some(sp => !(e <= sp.start || s >= sp.end));

  for (const term of keys) {
    let from = 0;
    while (true) {
      const idx = src.indexOf(term, from);
      if (idx === -1) break;

      const start = idx, end = idx + term.length;
      from = idx + term.length;

      if (overlaps(start, end)) continue;
      if (!shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet)) continue;

      spans.push({ start, end, term });
    }
  }

  if (!spans.length) return escapeHtml(src);
  spans.sort((a, b) => a.start - b.start);

  // ä¾ spans å›å¡« HTML
  let html = "";
  let last = 0;

  for (const sp of spans) {
    html += escapeHtml(src.slice(last, sp.start));

    const zh = sp.term;
    const en = ((map[zh] || zh) + "").toString();
    const js = en.replace(/'/g, "\\'");
    const title = escapeHtml(((map[zh] || "") + "").toString());

    html += `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${title}">${escapeHtml(zh)}</span>`;
    last = sp.end;
  }

  html += escapeHtml(src.slice(last));
  return html;
}

        async function translateVocabItem(zh, el) {
          try {
            const q = encodeURIComponent(zh);
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${q}`);
            const json = await res.json();
            const en = (json && json[0] && json[0][0] && json[0][0][0]) ? json[0][0][0] : "";

            if(el) el.innerText = en || "â€”";
            activeVocabMap[zh] = en || "";
            rehighlightEnglishBlocks();
            return en || "";
          } catch(e) {
            if(el) el.innerText = "â€”";
            activeVocabMap[zh] = "";
            rehighlightEnglishBlocks();
            return "";
          }
        }

        async function translateVisibleBlocks() {
            const ens = document.querySelectorAll('.en-text'), load=document.getElementById('trans-loading');
            let need=false; ens.forEach(e=>{if(!e.innerText)need=true}); if(!need)return;
            load.classList.remove('hidden');
            for(let el of ens) {
                if(el.innerText) continue;
                let src = decodeURIComponent(el.getAttribute('data-source') || "");
src = src.replace(/ã€€/g,'');

                if(translationCache[src]) { el.innerHTML=makeClickable(highlightEnglishVocabInText(translationCache[src])); continue; }
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`);
                    const json = await res.json();
                    let txt=""; json[0].forEach(i=>txt+=i[0]);
                    el.innerHTML = makeClickable(highlightEnglishVocabInText(txt));
                    translationCache[src]=txt;
                } catch(e){ el.innerText="Error"; }
            }
            load.classList.add('hidden');
            rehighlightEnglishBlocks();
        }

        function makeClickable(html) {
          return `<span class="cursor-pointer hover:text-teal-300 transition">${html}</span>`;
        }

let currentBlockIndex = 0; // è¨˜éŒ„å”¸åˆ°ç¬¬å¹¾å¥

// âœ… [ä¿®æ”¹] åˆ‡æ›æ’­æ”¾/æš«åœé‚è¼¯
// âœ… [ä¿®æ­£ç‰ˆ] æ’­æ”¾/æš«åœéµï¼šè™•ç†æš«åœé‚è¼¯ï¼Œä¸¦ä¸æ¸…é™¤é«˜äº®
// âœ… [ä¿®æ­£ç‰ˆ] æ’­æ”¾éµé‚è¼¯ï¼šé…åˆ speakText çš„å¼·åˆ¶å•Ÿå‹•
function toggleSpeech() {
    const btn = document.getElementById('btn-play');

    if (isSpeaking) {
        // æš«åœ
        isSpeaking = false;
        if (synth) synth.cancel();
        btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
    } else {
        // æ’­æ”¾
        // æ³¨æ„ï¼šé€™è£¡ä¸éœ€è¦è¨­ isSpeaking = trueï¼Œå› ç‚º playSequence -> speakText æœƒè‡ªå‹•è¨­
        const blocks = document.querySelectorAll('.content-block');
        if (currentBlockIndex >= blocks.length) {
            currentBlockIndex = 0;
        }
        playSequence();
    }
}

// âœ… [æ–°å¢] é€å¥æ’­æ”¾æ ¸å¿ƒå‡½å¼
// âœ… [ä¿®æ­£ç‰ˆ] æ’­æ”¾åºåˆ—ï¼šå”¸æ¯ä¸€å¥å‰éƒ½æª¢æŸ¥æœ‰æ²’æœ‰è¢«æŒ‰æš«åœ
function playSequence() {
    // ğŸ›‘ å®‰å…¨æª¢æŸ¥ 1ï¼šå¦‚æœç¾åœ¨ç‹€æ…‹æ˜¯ã€Œä¸èªªè©±ã€(è¢«æŒ‰æš«åœ/åœæ­¢äº†)ï¼Œç›´æ¥çµæŸ
    if (!isSpeaking) return;

    const blocks = document.querySelectorAll('.content-block');
    if (currentBlockIndex >= blocks.length) {
        // å…¨éƒ¨å”¸å®Œï¼Œæ­¸é›¶ä¸¦åœæ­¢
        stopSpeech();
        return;
    }

    // 1. æ¸…é™¤èˆŠé«˜äº®
    clearHighlights();

    // 2. å–å¾—ç•¶å‰å€å¡Šä¸¦é«˜äº®
    const block = blocks[currentBlockIndex];
    if (block) {
        block.classList.add('reading-active');
        block.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 3. æ±ºå®šè¦å”¸ä»€éº¼
    const enEl = block.querySelector('.en-text');
    const zhEl = block.querySelector('.zh-text');
    
    let textToRead = "";
    if (enEl && !enEl.classList.contains('hidden') && enEl.innerText) {
        textToRead = enEl.innerText;
    } else if (zhEl) {
        textToRead = zhEl.innerText;
    }

    // 4. é–‹å§‹å”¸
    if (textToRead) {
        speakText(textToRead, () => {
            // ğŸ›‘ å®‰å…¨æª¢æŸ¥ 2ï¼šå”¸å®Œé€™å¥è¦æ¥ä¸‹ä¸€å¥æ™‚ï¼Œå†æª¢æŸ¥ä¸€æ¬¡æœ‰æ²’æœ‰è¢«æŒ‰æš«åœ
            if (!isSpeaking) return; 

            currentBlockIndex++;
            playSequence(); // æ²’è¢«æš«åœæ‰ç¹¼çºŒå”¸ä¸‹ä¸€å¥
        });
    } else {
        // æ²’æ–‡å­—ï¼Œç›´æ¥è·³ä¸‹ä¸€å¥
        currentBlockIndex++;
        playSequence();
    }
}

// âœ… [æ–°å¢] æ¸…é™¤æ‰€æœ‰é«˜äº®
function clearHighlights() {
    document.querySelectorAll('.reading-active').forEach(el => {
        el.classList.remove('reading-active');
    });
}

        function escapeHtml(s){
          return (s||"").toString()
            .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
        }

        function highlightEnglishVocabInText(txt){
          let safe = escapeHtml(txt);

          const terms = Object.values(activeVocabMap||{})
            .map(v => (v||"").trim())
            .filter(v => v && v !== "Loading..." && /[a-zA-Z]/.test(v));

          const uniq = [...new Set(terms)].sort((a,b)=>b.length-a.length);
          if(!uniq.length) return safe;

          for(const term of uniq){
            const escaped = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

            const isSingleWord = /^[A-Za-z]+$/.test(term);
            const re = isSingleWord ? new RegExp(`\\b(${escaped})\\b`,'gi') : new RegExp(`(${escaped})`,'gi');

            safe = safe.replace(re, (m) => {
              const js = m.replace(/'/g,"\\'");
              return `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${m}">${m}</span>`;
            });
          }
          return safe;
        }

        // âœ… [ä¿®æ­£ç‰ˆ] åœæ­¢éµï¼šå…ˆé—œé–‰é–‹é—œï¼Œå†åœæ­¢èªéŸ³ï¼Œä¸¦æ­¸é›¶é€²åº¦
function stopSpeech() {
    // 1. å…ˆé—œæ‰é–‹é—œ (æœ€é‡è¦ï¼å‘Šè¨´å¾Œé¢çš„ç¨‹å¼ç¾åœ¨æ˜¯åœæ­¢ç‹€æ…‹)
    isSpeaking = false;

    // 2. å¼·åˆ¶åœæ­¢ç™¼éŸ³
    if (synth) synth.cancel();

    // 3. é€²åº¦æ­¸é›¶
    currentBlockIndex = 0;

    // 4. æ¸…é™¤ç•«é¢ä¸Šæ‰€æœ‰é«˜äº®
    clearHighlights();

    // 5. æŒ‰éˆ•è®Šå›æ’­æ”¾åœ–ç¤º
    const btn = document.getElementById('btn-play');
    if (btn) btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
}


/**
 * æ™ºæ…§æŒ‘é¸æœ€ä½³èªéŸ³ (é‡å° Natural/Enhanced å„ªåŒ–)
 */
// âœ… [é‡å° iOS å„ªåŒ–ç‰ˆ] å¼·åˆ¶å„ªå…ˆæŠ“å– Siri å’Œ Enhanced é«˜å“è³ªèªéŸ³
// âœ… [çµ‚æ¥µä¿®æ­£ç‰ˆ] èªéŸ³é¸æ“‡ï¼šå„ªå…ˆä¿è­‰éŸ³è³ªï¼Œå…¶æ¬¡æ‰æ˜¯æ€§åˆ¥
function pickBestVoice(isEng, gender) {
    if (!window.speechSynthesis) return null;
    const voices = window.speechSynthesis.getVoices();
    if (voices.length === 0) return null;

    const targetLang = isEng ? ['en-us', 'en-gb', 'en'] : ['zh-tw', 'zh-hk', 'zh'];

    const getScore = (voice) => {
        let score = 0;
        const name = voice.name.toLowerCase();
        const lang = voice.lang.toLowerCase();

        // 1. èªè¨€çµ•å°å„ªå…ˆ
        if (targetLang.some(t => lang === t || lang.replace('_', '-').startsWith(t))) {
            score += 1000;
        } else {
            return -1;
        }

        // 2. éŸ³è³ªå„ªå…ˆ (iOS Siri / Enhanced / Premium)
        if (name.includes('siri')) score += 5000;      // Siri æœ€å„ªå…ˆ
        if (name.includes('enhanced')) score += 4000;  // å¢å¼·ç‰ˆæ¬¡ä¹‹
        if (name.includes('premium')) score += 4000;
        if (name.includes('natural')) score += 3000;   // Edge Natural

        // 3. æ‡²ç½°æ©Ÿå™¨éŸ³ (Compact)
        // é€™æ˜¯é—œéµï¼šå¦‚æœåªæœ‰æ©Ÿå™¨ç”·è²ï¼Œæˆ‘å€‘å¯§å¯ä¸è¦é¸å®ƒï¼Œè®“åˆ†æ•¸è®Šå¾ˆä½
        if (name.includes('compact')) score -= 10000; 

        // 4. æ€§åˆ¥åå¥½ (æ¬Šé‡é™ä½ï¼Œé¿å…ç‚ºäº†é¸æ€§åˆ¥è€Œé¸åˆ°æ©Ÿå™¨éŸ³)
        // åªæœ‰åœ¨éæ©Ÿå™¨éŸ³çš„æƒ…æ³ä¸‹ï¼Œæ€§åˆ¥æ‰é‡è¦
        if (!name.includes('compact')) {
            if (gender === 'male') {
                if (name.includes('male') || name.includes('man') || name.includes('boy')) score += 500;
                // æ³¨æ„ï¼šæˆ‘å€‘ä¸å†é‡ç½°å¥³è²ï¼Œå› ç‚º iOS å¯èƒ½åªæœ‰é«˜å“è³ªå¥³è²
            } else {
                if (name.includes('female') || name.includes('woman') || name.includes('girl')) score += 500;
            }
        }

        return score;
    };

    const sorted = voices
        .map(v => ({ v, score: getScore(v) }))
        .filter(item => item.score > -5000) // éæ¿¾æ‰æ¥µä½åˆ†çš„é¸é …
        .sort((a, b) => b.score - a.score);

    // å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•è²éŸ³ï¼Œå›å‚³ç¬¬ä¸€å€‹ï¼›å¦å‰‡å›å‚³æœ€é«˜åˆ†
    return sorted.length > 0 ? sorted[0].v : voices[0];
}

/* ===================== [ADD HERE] è²¼åœ¨é€™è£¡ï¼šå…©å€‹æ–°å‡½å¼ ===================== */
function isIOSDevice(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent)
      || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

function isMostlyEnglish(txt){
  const t = (txt || "").toString();
  const latin = (t.match(/[A-Za-z]/g) || []).length;
  const cjk   = (t.match(/[\u4E00-\u9FFF]/g) || []).length;
  if (cjk === 0) return latin > 0;
  return latin > cjk * 2;
}
/* ===================== [ADD HERE END] ===================== */
function splitTextForSpeak(text, isEng){
  const t = (text || "").toString().replace(/\s+/g, " ").trim();
  if(!t) return [];

  const maxLen = isEng ? 180 : 120; // iOS å»ºè­°çŸ­ä¸€é»ï¼Œé¿å…æ€ªè²/ä¸­æ–·
  const out = [];

  let s = t;
  while(s.length > maxLen){
    let cut = -1;

    // 1) å…ˆæ‰¾æ¨™é»åˆ‡å‰²
    const punct = isEng ? /[.!?;:]/g : /[ã€‚ï¼ï¼Ÿï¼›ï¼š]/g;
    let m, last = -1;
    while((m = punct.exec(s.substring(0, maxLen))) !== null){
      last = m.index + 1;
    }
    if(last >= Math.floor(maxLen * 0.4)) cut = last;

    // 2) å†ç”¨ç©ºç™½åˆ‡ï¼ˆè‹±æ–‡ï¼‰
    if(cut === -1 && isEng){
      const sp = s.lastIndexOf(" ", maxLen);
      if(sp >= Math.floor(maxLen * 0.5)) cut = sp;
    }

    // 3) æœ€å¾Œç¡¬åˆ‡
    if(cut === -1) cut = maxLen;

    out.push(s.slice(0, cut).trim());
    s = s.slice(cut).trim();
  }

  if(s) out.push(s);
  return out;
}

// âœ… [ä¿®æ”¹] å¢åŠ  onComplete åƒæ•¸ï¼Œè®“å®ƒçŸ¥é“å”¸å®Œå¾Œè¦å¹¹å˜›
// âœ… [ä¿®æ­£ç‰ˆ] ç™¼éŸ³æ ¸å¿ƒï¼šå¢åŠ åš´æ ¼çš„ç‹€æ…‹æª¢æŸ¥
// âœ… [çµ‚æ¥µä¿®æ­£ç‰ˆ] ç™¼éŸ³æ ¸å¿ƒï¼šé»æ“Šå¼·åˆ¶æ’­æ”¾ + iOS åƒæ•¸é–å®š
function speakText(txt, onComplete) {
    if (!synth) return;
    
    // 1. é»æ“Šç™¼éŸ³æ™‚ï¼Œè¦–ç‚ºã€Œé–‹å§‹æ’­æ”¾ã€ï¼Œå¼·åˆ¶æ‰“é–‹é–‹é—œ (è§£æ±ºé»æ“Šç„¡è²å•é¡Œ)
    isSpeaking = true;
    document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';

    // åœæ­¢ç•¶å‰ç™¼éŸ³
    synth.cancel();

    const cleanTxt = (txt || "").toString().replace(/<[^>]*>/g, "").replace(/\u00A0/g, " ").trim();
    
    // å¦‚æœæ²’å­—ï¼Œç›´æ¥çµæŸ
    if (!cleanTxt) {
        if (onComplete) onComplete();
        return;
    }

    const ios = isIOSDevice();
    const isEng = isMostlyEnglish(cleanTxt);
    const lang = isEng ? "en-US" : "zh-TW";

    // iOS é•·å¥åˆ‡å‰²é‚è¼¯
    const chunks = (ios && cleanTxt.length > (isEng ? 220 : 140)) ? splitTextForSpeak(cleanTxt, isEng) : [cleanTxt];
    const uiRate = parseFloat(document.getElementById('play-rate')?.value || "1.0");
    let idx = 0;

    const speakNext = () => {
        // ğŸ›‘ å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœä¸­é€”è¢«æŒ‰äº†æš«åœ/åœæ­¢ (isSpeaking è®Š false)ï¼Œå°±ä¸­æ­¢
        if (!isSpeaking) return;

        if (idx >= chunks.length) {
            if (onComplete) onComplete();
            return;
        }

        const part = chunks[idx++];
        const u = new SpeechSynthesisUtterance(part);
        u.lang = lang;

        // è¨­å®šè²éŸ³
        let voice = null;
        if (!ios) {
            voice = pickBestVoice(isEng, currentVoice);
        } else {
             // iOS èªéŸ³é¸æ“‡é‚è¼¯ (åœ¨ pickBestVoice å…§éƒ¨è™•ç†)
             voice = pickBestVoice(isEng, currentVoice);
        }
        if (voice) u.voice = voice;

        // âœ… [é—œéµä¿®æ­£] iOS åƒæ•¸é–å®š
        if (ios) {
            // iOS çš„å¢å¼·ç‰ˆèªéŸ³ (Meijia Enhanced) å°åƒæ•¸æ¥µåº¦æ•æ„Ÿ
            // åªè¦ rate != 1 æˆ– pitch != 1ï¼Œå®ƒå¸¸å¸¸æœƒç›´æ¥ã€ŒéœéŸ³ã€æˆ–è®Šå›ã€Œæ©Ÿå™¨éŸ³ã€
            // æ‰€ä»¥åœ¨ iOS ä¸Šï¼Œæˆ‘å€‘å¿…é ˆçŠ§ç‰²èªé€Ÿèª¿æ•´åŠŸèƒ½ï¼Œæ›å–éŸ³è³ª
            u.pitch = 1.0;
            u.rate = 1.0; 
        } else {
            u.rate = uiRate;
            u.pitch = (currentVoice === 'male') ? 1.0 : 1.05;
        }

        u.onstart = () => {
            if (!isSpeaking) { synth.cancel(); return; }
        };

        u.onend = speakNext;
        
        u.onerror = () => {
            if (isSpeaking) speakNext();
        };

        synth.speak(u);
    };

    speakNext();
}


        function setVoice(g) {
            currentVoice=g;
            document.getElementById('btn-male').className=g==='male'?'text-teal-400 p-1':'text-slate-500 p-1';
            document.getElementById('btn-female').className=g==='female'?'text-teal-400 p-1':'text-slate-500 p-1';
            stopSpeech();
        }

        function setMode(m) {
            ['en','dual','zh'].forEach(x=>document.getElementById(`btn-${x}`).className=x===m?"mode-btn px-2 py-1 text-xs font-bold rounded bg-teal-600 text-white":"mode-btn px-2 py-1 text-xs font-bold rounded text-teal-500 hover:text-white");
            if(m!=='zh') translateVisibleBlocks();

            const en=document.querySelectorAll('.en-text'), zh=document.querySelectorAll('.zh-text');
            if(m==='en'){en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.add('hidden'));}
            else if(m==='zh'){en.forEach(e=>e.classList.add('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
            else{en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}

            const tZh=document.getElementById('title-zh');
            const tEn=document.getElementById('title-en');
            if(tZh && tEn){
              if(m==='en'){ tZh.classList.add('hidden'); tEn.classList.remove('hidden'); }
              else if(m==='zh'){ tZh.classList.remove('hidden'); tEn.classList.add('hidden'); }
              else { tZh.classList.remove('hidden'); tEn.classList.remove('hidden'); }
            }

            if(m !== 'zh') ensureTitleTranslated();
        }

        function changeLanguage() {
            const lang = document.getElementById('ui-lang').value;
            const t = i18n[lang] || i18n['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if(t[k]) { if(el.tagName==='OPTION') el.text=t[k]; else el.innerText=t[k]; }
            });
        }

        function showToast(m) { const T=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; T.classList.remove('opacity-0','translate-y-10'); setTimeout(()=>T.classList.add('opacity-0','translate-y-10'),2000); }

        function initCanvas() {
            const c=document.getElementById('molecule-canvas'),x=c.getContext('2d');
            let p=[]; function r(){c.width=window.innerWidth;c.height=window.innerHeight;}
            window.addEventListener('resize',r);r();
            class A{constructor(){this.x=Math.random()*c.width;this.y=Math.random()*c.height;this.vx=(Math.random()-.5)*.2;this.vy=(Math.random()-.5)*.2;this.s=Math.random()*2+1;this.color=`rgba(45,212,191,${Math.random()*0.3+0.1})`;}u(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>c.width)this.vx*=-1;if(this.y<0||this.y>c.height)this.vy*=-1;}d(){x.beginPath();x.arc(this.x,this.y,this.s,0,Math.PI*2);x.fillStyle=this.color;x.fill();}}
            for(let i=0;i<50;i++)p.push(new A());
            function a(){x.clearRect(0,0,c.width,c.height);p.forEach(b=>{b.u();b.d()});requestAnimationFrame(a);}a();
        }
    </script>
</body>
</html>
