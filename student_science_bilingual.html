<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI School | 科學雙語閱讀</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;800&family=Orbitron:wght@500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                        heading: ['Outfit', 'sans-serif'],
                        tech: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        tech: {
                            bg: '#020617',
                            panel: 'rgba(15, 23, 42, 0.95)', 
                            border: 'rgba(45, 212, 191, 0.3)',
                            accent: '#2dd4bf', 
                            highlight: 'rgba(45, 212, 191, 0.15)'
                        }
                    },
                    animation: {
                        "pulse-slow": "pulse 3s infinite",
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #ccfbf1; overflow: hidden; }
        .glass-panel { background: rgba(10, 25, 47, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(45, 212, 191, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-track { background: rgba(2, 6, 23, 0.5); }
        .scroll-area::-webkit-scrollbar-thumb { background: #115e59; border-radius: 3px; }
        .scroll-area::-webkit-scrollbar-thumb:hover { background: #2dd4bf; }

        /* 左側導航 */
        .nav-item { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; padding: 0.5rem 0.75rem; margin-bottom: 0.25rem; border-radius: 0 0.5rem 0.5rem 0; font-size: 0.85rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item:hover { background: rgba(45, 212, 191, 0.05); color: #ccfbf1; }
        .nav-item.active { background: linear-gradient(90deg, rgba(45, 212, 191, 0.1), transparent); border-left-color: #2dd4bf; color: #2dd4bf; font-weight: 700; }

        /* X-Ray 關鍵字 */
        .sci-term { color: #2dd4bf; font-weight: 700; border-bottom: 1px dashed rgba(45, 212, 191, 0.6); cursor: help; transition: all 0.2s; padding: 0 2px; }
        .sci-term:hover { background-color: rgba(45, 212, 191, 0.25); color: #fff; text-shadow: 0 0 10px #2dd4bf; border-radius: 4px; }

        /* 點擊即讀句子特效 */
        .clickable-sentence {
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            border-radius: 4px;
            padding: 2px 0;
        }
        .clickable-sentence:hover {
            background-color: rgba(45, 212, 191, 0.15);
            color: #fff;
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.1);
        }
        .clickable-sentence:active {
            background-color: rgba(45, 212, 191, 0.3);
        }

        /* 下拉選單 */
        .custom-select { background-color: rgba(15, 23, 42, 0.8); border: 1px solid rgba(45, 212, 191, 0.3); color: #ccfbf1; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%232dd4bf' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.3rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; padding-right: 1.5rem; }
        .custom-select:focus { border-color: #2dd4bf; box-shadow: 0 0 10px rgba(45, 212, 191, 0.2); }
        .custom-select:disabled { opacity: 0.4; cursor: not-allowed; border-color: rgba(255,255,255,0.1); }

        #canvas-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        
        .content-block { margin-bottom: 1rem; padding: 1rem; border-radius: 0.75rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s ease; }
        .content-block:hover { background: rgba(45, 212, 191, 0.03); border-color: rgba(45, 212, 191, 0.2); }
        
        .en-text { font-size: 1.1rem; color: #e2e8f0; line-height: 1.6; margin-bottom: 0.5rem; font-weight: 500; font-family: 'Inter', sans-serif; min-height: 1.5rem; }
        .zh-text { font-size: 1rem; color: #94a3b8; line-height: 1.6; padding-left: 8px; border-left: 3px solid rgba(45, 212, 191, 0.3); }
        
        .section-header { font-size: 1.25rem; font-weight: 800; color: #fff; margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.25rem; border-bottom: 1px solid rgba(45, 212, 191, 0.3); display: flex; align-items: center; gap: 0.5rem; }
        .section-header::before { content: ''; display: block; width: 4px; height: 20px; background: #2dd4bf; border-radius: 2px; }
        
        .loader { border: 2px solid rgba(45, 212, 191, 0.1); border-top: 2px solid #2dd4bf; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-teal-500/30 selection:text-white">

    <div id="canvas-container"><canvas id="molecule-canvas"></canvas></div>

    <div id="loader-overlay" class="absolute inset-0 bg-[#020617] z-50 flex flex-col items-center justify-center">
        <i class="fa-solid fa-satellite-dish text-5xl text-teal-400 animate-pulse mb-4"></i>
        <div class="text-teal-500 font-tech tracking-widest">CONNECTING TO DATABASE...</div>
    </div>

    <nav class="glass-panel sticky top-0 z-40 h-auto md:h-16 flex flex-col md:flex-row items-center shrink-0 border-b-0 shadow-lg">
        <div class="w-full px-4 md:px-6 py-2 flex justify-between items-center border-b border-teal-500/20 md:border-b-0">
            <div class="flex items-center gap-4">
                <button onclick="goBack()" class="flex items-center gap-2 text-teal-400 hover:text-white transition group">
                    <div class="p-1 rounded border border-teal-500/30 group-hover:bg-teal-500/20">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                    <span class="text-sm font-tech tracking-wider hidden md:inline">RETURN</span>
                </button>
                <div class="text-lg font-heading font-bold text-white tracking-widest">
                    SCI-LINGUA <span class="text-teal-400">READER</span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <select id="ui-lang" class="bg-slate-900/80 border border-teal-500/30 text-teal-100 rounded-lg px-2 py-1 text-xs outline-none cursor-pointer hover:bg-slate-800">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                </select>

                <div class="flex items-center bg-slate-900/80 rounded-lg p-1 border border-teal-500/30">
                    <button onclick="setVoice('male')" class="voice-btn px-2 py-1 rounded transition text-teal-400 hover:bg-teal-500/20" id="voice-male" title="Teacher Spark">
                        <i class="fa-solid fa-user-tie"></i>
                    </button>
                    <button onclick="setVoice('female')" class="voice-btn px-2 py-1 rounded transition text-slate-500 hover:bg-teal-500/20" id="voice-female" title="Teacher Nova">
                        <i class="fa-solid fa-user-graduate"></i>
                    </button>
                </div>
                
                <div class="flex bg-slate-900/80 rounded-lg p-1 border border-teal-500/30">
                    <button onclick="setMode('en')" class="mode-btn px-3 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-en">EN</button>
                    <button onclick="setMode('dual')" class="mode-btn px-3 py-1 text-xs font-bold rounded bg-teal-600 text-white shadow-[0_0_10px_rgba(45,212,191,0.4)]" id="btn-dual">DUAL</button>
                    <button onclick="setMode('zh')" class="mode-btn px-3 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-zh">ZH</button>
                </div>
            </div>
        </div>

        <div class="w-full px-4 md:px-6 py-2 bg-slate-900/80 flex flex-wrap gap-2 items-center text-sm border-t border-teal-500/20 md:border-t-0 md:bg-transparent justify-end">
            <span class="text-xs font-tech text-teal-500 mr-2"><i class="fa-solid fa-filter"></i></span>
            <select id="sel-stage" class="custom-select px-2 py-1 rounded w-24 text-xs font-bold" onchange="filterUnits('stage')"><option value="" disabled selected>階段</option></select>
            <select id="sel-grade" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" onchange="filterUnits('grade')" disabled><option value="" disabled selected>年級</option></select>
            <select id="sel-version" class="custom-select px-2 py-1 rounded w-24 text-xs font-bold" onchange="filterUnits('version')" disabled><option value="" disabled selected>版本</option></select>
            <select id="sel-semester" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" onchange="filterUnits('semester')" disabled><option value="" disabled selected>學期</option></select>
            <select id="sel-unit" class="custom-select px-2 py-1 rounded flex-grow md:flex-grow-0 md:w-48 text-xs font-bold" onchange="loadSelectedUnit()" disabled><option value="" disabled selected>選擇單元</option></select>
        </div>
    </nav>

    <div class="flex-grow flex overflow-hidden p-4 gap-4 relative z-10">
        <aside class="w-64 glass-panel rounded-2xl flex flex-col overflow-hidden hidden md:flex">
            <div class="p-4 border-b border-teal-500/20 bg-slate-900/40">
                <h3 class="text-xs font-tech text-teal-500 tracking-widest mb-1">NAVIGATION</h3>
                <div class="text-white font-bold text-sm truncate" id="nav-title">Outline</div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-2 space-y-1" id="unit-list">
                <div class="text-center text-slate-500 text-xs mt-10 p-4">請先選擇單元。</div>
            </div>
        </aside>

        <section class="flex-grow glass-panel rounded-2xl flex flex-col relative overflow-hidden">
            <div class="h-12 border-b border-teal-500/20 bg-slate-900/40 flex items-center justify-between px-6">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-file-lines text-teal-400"></i>
                    <span class="text-xs font-tech text-teal-200" id="status-bar">READY</span>
                    <span id="trans-loading" class="hidden text-xs text-teal-400 flex items-center gap-1 ml-2"><div class="loader"></div> AI Translating...</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleSpeech()" class="text-teal-400 hover:text-white transition group w-8 h-8 flex items-center justify-center rounded-full hover:bg-teal-500/20" id="btn-play" title="播放全文"><i class="fa-solid fa-play"></i></button>
                    <button onclick="adjustFontSize(2)" class="text-teal-400 hover:text-white transition"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                    <button onclick="adjustFontSize(-2)" class="text-teal-400 hover:text-white transition"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto p-6 md:p-8 relative" id="reading-container">
                <article class="max-w-4xl mx-auto transition-opacity duration-500" id="article-body">
                    <h1 class="text-2xl md:text-3xl font-black text-white mb-6 font-heading tracking-tight text-center" id="article-title">
                        <span class="text-slate-500 opacity-50">請從上方選單選擇教材</span>
                    </h1>
                    <div id="article-content" class="space-y-4"></div>
                </article>
            </div>
        </section>

        <aside class="w-80 glass-panel rounded-2xl flex flex-col overflow-hidden hidden lg:flex border-l border-teal-500/30">
            <div class="p-4 border-b border-teal-500/20 bg-gradient-to-r from-slate-900/80 to-teal-900/20">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-2 h-2 bg-teal-400 rounded-full animate-pulse"></div>
                    <h3 class="text-xs font-tech text-teal-400 tracking-widest">AI X-RAY</h3>
                </div>
                <div class="text-xs text-slate-400">Vocabulary & Analysis</div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto p-4 space-y-4">
                <div id="ai-card-placeholder" class="text-center py-10 opacity-50">
                    <i class="fa-solid fa-dna text-4xl text-teal-500/30 mb-4 animate-float"></i>
                    <p class="text-sm text-teal-200/50">滑鼠移至螢光單字上方<br>即可啟動分析</p>
                </div>

                <div id="ai-card-display" class="hidden opacity-0 transition-all duration-300">
                    <div class="bg-gradient-to-b from-teal-900/40 to-slate-900/80 rounded-xl p-5 border border-teal-500/30 shadow-[0_0_20px_rgba(45,212,191,0.15)]">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-white text-xl tracking-wide" id="ai-term-title">Term</h4>
                            <span class="text-[10px] font-tech text-teal-400 border border-teal-500/30 px-2 py-0.5 rounded">SCI-TERM</span>
                        </div>
                        <p class="text-sm text-teal-300 font-bold mb-1" id="ai-term-zh">中文名稱</p>
                        <p class="text-sm text-slate-200 mb-3 leading-relaxed" id="ai-term-desc">Definition...</p>
                        <button onclick="speakTerm()" class="text-xs bg-teal-500/20 hover:bg-teal-500/40 text-teal-300 px-3 py-1.5 rounded transition flex items-center gap-2 justify-center w-full">
                            <i class="fa-solid fa-volume-high"></i> Pronounce (English)
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 border border-teal-500/30 text-teal-100 px-4 py-2 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-2 pointer-events-none text-sm font-tech">
        <i class="fa-solid fa-circle-check text-teal-400"></i> <span id="toast-msg">Ready</span>
    </div>

    <script>
        const SHEET_ID = '1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk';
        const PUBLISHED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbgkNiMflfeLQd3KN8F4yjjIr6G2flnCAy-nUPMiC7_xDfdg_0hJ2Qzbsr92u8htlPLFR8GwwQPK_g/pub?gid=0&single=true&output=csv'; // 若有發布網址請填入
        const FALLBACK_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&id=${SHEET_ID}&gid=0`;
        const TARGET_URL = PUBLISHED_CSV_URL || FALLBACK_CSV_URL;

        const COL_STAGE = 0; const COL_VERSION = 2; const COL_GRADE = 3; const COL_SEMESTER = 4;
        const COL_UNIT_NUM = 6; const COL_UNIT_NAME = 7; const COL_CONTENT = 8; const COL_VOCAB = 18;

        let rawData = [], processedUnits = [], isSpeaking = false, currentVoice = 'male', translationCache = {};

        document.addEventListener('DOMContentLoaded', () => {
            initCanvas(); fetchData();
            if(window.speechSynthesis) window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        });

        function goBack() { window.location.href = 'student_science.html'; }

        function fetchData() {
            Papa.parse(TARGET_URL, {
                download: true, header: false,
                complete: function(results) { processData(results.data); document.getElementById('loader-overlay').style.display = 'none'; showToast("資料庫連線成功"); },
                error: function(err) { console.error(err); document.getElementById('loader-overlay').innerHTML = `<div class="text-red-500">Access Denied</div>`; }
            });
        }

        function processData(data) {
            rawData = data.slice(1);
            processedUnits = rawData.map((row, index) => {
                let content = row[COL_CONTENT] || "";
                let title = (row[COL_UNIT_NUM]||"").trim();
                if(row[COL_UNIT_NAME]) title += " " + row[COL_UNIT_NAME].trim();
                if(!title || title.length < 2) title = `Unit ${index + 1}`;
                return {
                    id: index, stage: (row[COL_STAGE]||"").trim(), version: (row[COL_VERSION]||"").trim(),
                    grade: (row[COL_GRADE]||"").trim(), semester: (row[COL_SEMESTER]||"").trim(),
                    title: title, content: content, vocab: row[COL_VOCAB] || ""
                };
            }).filter(u => u.content.length > 5);
            initFilters();
        }

        function initFilters() {
            const stages = [...new Set(processedUnits.map(u => u.stage).filter(Boolean))];
            populateSelect('sel-stage', stages, '階段');
        }

        function filterUnits(level) {
            const ids = ['stage', 'grade', 'version', 'semester', 'unit'];
            const sels = ids.map(id => document.getElementById(`sel-${id}`));
            const [sSt, sGr, sVer, sSem, sUn] = sels;

            let filtered = processedUnits.filter(u => {
                if(sSt.value && u.stage !== sSt.value) return false;
                if(sGr.value && !sGr.disabled && u.grade !== sGr.value) return false;
                if(sVer.value && !sVer.disabled && u.version !== sVer.value) return false;
                if(sSem.value && !sSem.disabled && u.semester !== sSem.value) return false;
                return true;
            });

            const update = (sel, prop, txt) => { populateSelect(sel.id, [...new Set(filtered.map(u => u[prop]).filter(Boolean))], txt); };
            
            if(level==='stage') { update(sGr,'grade','年級'); resetSelects([sVer, sSem, sUn]); }
            else if(level==='grade') { update(sVer,'version','版本'); resetSelects([sSem, sUn]); }
            else if(level==='version') { update(sSem,'semester','學期'); resetSelects([sUn]); }
            else if(level==='semester') { 
                sUn.innerHTML='<option value="" disabled selected>請選擇單元</option>';
                filtered.forEach(u => sUn.add(new Option(u.title, u.id))); sUn.disabled=false; 
            }
        }

        function populateSelect(id, items, ph) { const s = document.getElementById(id); s.innerHTML=`<option value="" disabled selected>${ph}</option>`; items.forEach(i=>s.add(new Option(i,i))); s.disabled=false; }
        function resetSelects(els) { els.forEach(e=>{e.innerHTML=`<option value="" disabled selected>${e.options[0].text}</option>`;e.disabled=true;}); }
        function loadSelectedUnit() { const id = document.getElementById('sel-unit').value; const u = processedUnits.find(i=>i.id==id); if(u) renderArticle(u); }

        async function renderArticle(unit) {
            document.getElementById('article-title').innerText = unit.title;
            document.getElementById('status-bar').innerText = `READING: ${unit.title}`;
            document.getElementById('nav-title').innerText = unit.title;

            let vocabMap = {};
            if (unit.vocab) {
                let items = unit.vocab.split(/[,;，；\n]/);
                items.forEach(item => {
                    let p = item.split(/[:：]/); if(p[0].trim()) vocabMap[p[0].trim()] = p[1]?p[1].trim():"Sci-Term";
                });
            }

            const contentDiv = document.getElementById('article-content');
            const navList = document.getElementById('unit-list');
            contentDiv.innerHTML = ''; navList.innerHTML = '';

            let lines = unit.content.split('\n');
            let secCount = 0;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                const isHeader = (line.length < 40 && !/[。！？.!?]$/.test(line)) || line.includes("活動");

                if (isHeader) {
                    secCount++;
                    const anchorId = `sec-${i}`;
                    const navItem = document.createElement('div');
                    navItem.className = 'nav-item';
                    navItem.innerHTML = `<div class="text-[10px] text-teal-500/50">SEC ${secCount}</div><div class="nav-title truncate">${line}</div>`;
                    navItem.onclick = () => {
                        document.getElementById(anchorId).scrollIntoView({behavior:'smooth',block:'center'});
                        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                        navItem.classList.add('active');
                    };
                    navList.appendChild(navItem);
                    contentDiv.innerHTML += `<h2 id="${anchorId}" class="section-header">${line}</h2>`;
                } else {
                    // ★★★ 生成內容區塊 (Click-to-Speak 預備) ★★★
                    // 英文部分一開始是空的，會由 translateVisibleBlocks 填入
                    // 中文部分先處理 X-Ray
                    contentDiv.innerHTML += `
                        <div class="content-block" id="block-${i}">
                            <p class="zh-text">${processXRay(line, vocabMap)}</p>
                            <p class="en-text hidden text-teal-200/80 italic text-sm mt-2" data-source="${line}"></p>
                        </div>
                    `;
                }
            }
            setMode('dual');
        }

        // X-Ray 處理：長詞優先
        function processXRay(text, vocabMap) {
            const keys = Object.keys(vocabMap).sort((a,b)=>b.length-a.length);
            if(keys.length===0) return text;
            const pattern = new RegExp(`(${keys.map(k=>k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})`, 'g');
            return text.replace(pattern, m => `<span class="sci-term" onmouseenter="showAIAnalysis('${m}')">${m}</span>`);
        }

        // ★★★ 自動翻譯 + 句子切分 (Click to Speak) ★★★
        async function translateVisibleBlocks() {
            const enBlocks = document.querySelectorAll('.en-text');
            const loading = document.getElementById('trans-loading');
            
            let needsTrans = false;
            enBlocks.forEach(el => { if(!el.innerText) needsTrans = true; });
            if(!needsTrans) return;

            loading.classList.remove('hidden');
            for (let el of enBlocks) {
                if (el.innerText) continue;
                const src = el.getAttribute('data-source');
                if(translationCache[src]) {
                    el.innerHTML = makeClickable(translationCache[src]);
                    continue;
                }
                try {
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURI(src)}`;
                    const res = await fetch(url);
                    const json = await res.json();
                    let transText = "";
                    json[0].forEach(item => transText += item[0]);
                    
                    translationCache[src] = transText;
                    // ★ 轉成可點擊的句子 ★
                    el.innerHTML = makeClickable(transText);
                } catch(e) { console.error(e); el.innerText = "Translation Error"; }
            }
            loading.classList.add('hidden');
        }

        // 把英文段落切成可點擊的句子
        function makeClickable(text) {
            // 簡單切分：按 . ? ! 切分，保留標點
            const sentences = text.match(/[^.?!]+[.?!]+[\])'"]*|[^.?!]+$/g);
            if (!sentences) return `<span class="clickable-sentence" onclick="speakText(this.innerText)">${text}</span>`;
            
            return sentences.map(s => `<span class="clickable-sentence" onclick="speakText(this.innerText)">${s}</span>`).join(' ');
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            let voice = null;
            if(currentVoice==='male') voice = voices.find(v=>v.name.includes("Google US English")) || voices.find(v=>v.lang==='en-US');
            else voice = voices.find(v=>v.name.includes("Zira")) || voices.find(v=>v.lang==='en-US');
            if(voice) u.voice = voice;
            window.speechSynthesis.speak(u);
        }

        // Sidebar Vocabulary Translation (Auto)
        async function showAIAnalysis(termZh) {
            document.getElementById('ai-card-placeholder').classList.add('hidden');
            document.getElementById('ai-card-display').classList.remove('hidden', 'opacity-0');
            
            const titleEl = document.getElementById('ai-term-title');
            const zhEl = document.getElementById('ai-term-zh');
            const descEl = document.getElementById('ai-term-desc');

            zhEl.innerText = termZh;
            descEl.innerText = "Analyzing...";
            titleEl.innerText = "Translating...";

            // 自動翻譯詞彙到英文
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURI(termZh)}`;
                const res = await fetch(url);
                const json = await res.json();
                const engTerm = json[0][0][0];
                titleEl.innerText = engTerm;
                descEl.innerHTML = `Scientific term for <b>${termZh}</b>.`;
            } catch(e) {
                titleEl.innerText = termZh;
            }
        }

        function speakTerm() {
            const text = document.getElementById('ai-term-title').innerText;
            speakText(text);
        }

        function setVoice(g) { currentVoice = g; showToast(`Voice: ${g}`); const u=new SpeechSynthesisUtterance(''); window.speechSynthesis.speak(u); }
        function toggleSpeech() {
            const enNodes = document.querySelectorAll('.en-text');
            const isEn = enNodes.length>0 && !enNodes[0].classList.contains('hidden');
            let txt = "";
            document.querySelectorAll(isEn?'.en-text':'.zh-text').forEach(p=>txt+=p.innerText+" ");
            if(txt) speakText(txt);
            else showToast("No text found", "error");
        }

        function setMode(mode) {
            ['en','dual','zh'].forEach(m => document.getElementById(`btn-${m}`).className = m===mode?"mode-btn px-3 py-1 text-xs font-bold rounded bg-teal-600 text-white shadow":"mode-btn px-3 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition");
            
            if(mode==='en'||mode==='dual') translateVisibleBlocks();

            const en = document.querySelectorAll('.en-text');
            const zh = document.querySelectorAll('.zh-text');
            if(mode==='en') { en.forEach(e=>e.classList.remove('hidden')); zh.forEach(z=>z.classList.add('hidden')); }
            else if(mode==='zh') { en.forEach(e=>e.classList.add('hidden')); zh.forEach(z=>z.classList.remove('hidden')); }
            else { en.forEach(e=>e.classList.remove('hidden')); zh.forEach(z=>z.classList.remove('hidden')); }
        }

        function adjustFontSize(d) { const e=document.getElementById('article-content'); const s=parseFloat(window.getComputedStyle(e).fontSize); e.style.fontSize=(s+d)+'px'; }
        function showToast(m,t) { const T=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; T.classList.remove('opacity-0','translate-y-10'); setTimeout(()=>T.classList.add('opacity-0','translate-y-10'),2000); }
        function initCanvas() {
            const c=document.getElementById('molecule-canvas'),x=c.getContext('2d');
            let p=[]; function r(){c.width=window.innerWidth;c.height=window.innerHeight;}
            window.addEventListener('resize',r);r();
            class A{constructor(){this.x=Math.random()*c.width;this.y=Math.random()*c.height;this.vx=(Math.random()-.5)*.2;this.vy=(Math.random()-.5)*.2;this.s=Math.random()*2+1;}u(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>c.width)this.vx*=-1;if(this.y<0||this.y>c.height)this.vy*=-1;}d(){x.beginPath();x.arc(this.x,this.y,this.s,0,Math.PI*2);x.fillStyle='rgba(45,212,191,0.2)';x.fill();}}
            for(let i=0;i<50;i++)p.push(new A());
            function a(){x.clearRect(0,0,c.width,c.height);p.forEach(b=>{b.u();b.d()});requestAnimationFrame(a);}a();
        }
    </script>
</body>
</html>
