<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI School | ç§‘å­¸é›™èªé–±è®€</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        tech: {
                            bg: '#0f172a',
                            panel: 'rgba(15, 23, 42, 0.6)',
                            border: 'rgba(255, 255, 255, 0.08)',
                            accent: '#4ade80',
                            highlight: '#facc15'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 1. åŸºç¤è¨­å®š */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            overflow: hidden; 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ¥µå…‰èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(74, 222, 128, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.05) 0%, transparent 40%);
            z-index: -2;
            animation: aurora 20s infinite linear;
            pointer-events: none;
        }
        @keyframes aurora {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 2. é«˜ç´šç»ç’ƒé¢æ¿ */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); 
        }

        /* 3. æ²è»¸ç¾åŒ– */
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-track { background: transparent; }
        .scroll-area::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .scroll-area::-webkit-scrollbar-thumb:hover { background: rgba(74, 222, 128, 0.5); }

        /* 4. å°èˆªé¸å–®æŒ‰éˆ• */
        .nav-item { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border-left: 2px solid transparent; 
            cursor: pointer; 
            padding: 0.8rem 1rem; 
            margin-bottom: 0.25rem; 
            font-size: 0.95rem; 
            color: #94a3b8; 
            border-radius: 0 8px 8px 0;
            font-weight: 500;
        }
        .nav-item:hover { 
            background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); 
            color: #f1f5f9; 
            padding-left: 1.2rem;
        }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(74, 222, 128, 0.1), transparent); 
            border-left-color: #4ade80; 
            color: #4ade80; 
            font-weight: 700; 
        }

        /* === ğŸ’ ç™¾è¬ç´šä¸‹æ‹‰é¸å–® UI (æ–°å¢) === */
        .glass-select-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background-color: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0 10px;
            transition: all 0.3s ease;
            min-width: 90px;
        }
        .glass-select-wrapper:hover {
            background-color: rgba(30, 41, 59, 0.8);
            border-color: #4ade80; 
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.2);
        }
        .glass-select-icon {
            color: #4ade80;
            font-size: 0.8rem;
            margin-right: 8px;
            pointer-events: none;
        }
        .glass-select {
            appearance: none;
            -webkit-appearance: none;
            background-color: transparent;
            border: none;
            color: #e2e8f0;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 6px 20px 6px 0;
            cursor: pointer;
            outline: none;
            width: 100%;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
        .glass-select option { background-color: #0f172a; color: #e2e8f0; padding: 10px; }

        /* èªé€Ÿè† å›Šæ¨£å¼ */
        .speed-capsule {
            appearance: none;
            -webkit-appearance: none;
            background-color: transparent;
            color: #4ade80;
            font-weight: 800;
            font-size: 0.95rem;
            text-align: center;
            text-align-last: center;
            border: none;
            cursor: pointer;
            outline: none;
            background-image: none;
        }
        .speed-capsule:hover { text-shadow: 0 0 8px rgba(74, 222, 128, 0.6); }

        /* 5. é–±è®€å€å¡Šå„ªåŒ– */
        .content-block { 
            margin-bottom: 2rem; 
            padding: 1.5rem; 
            border-radius: 1rem; 
            background: transparent; 
            border: 1px solid transparent; 
            transition: all 0.3s ease; 
        }
        .content-block:hover { background: rgba(255, 255, 255, 0.02); }

        /* æ­£åœ¨æœ—è®€çš„é«˜äº® */
        .reading-active {
            background: linear-gradient(90deg, rgba(74, 222, 128, 0.05) 0%, rgba(244, 114, 182, 0.1) 50%, rgba(74, 222, 128, 0.05) 100%) !important;
            background-size: 200% 100% !important;
            animation: reading-scan 3s linear infinite;
            border-left: 4px solid #4ade80 !important; 
            border-radius: 4px 12px 12px 4px;
            box-shadow: 0 0 25px rgba(74, 222, 128, 0.1);
        }
        .reading-active .zh-text,
        .reading-active .en-text,
        .reading-active .sci-term {
            color: #f472b6 !important; /* æ¡ƒç´…è‰² */
            text-shadow: 0 0 5px rgba(244, 114, 182, 0.3);
            border-left-color: #f472b6 !important;
        }
        @keyframes reading-scan {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        /* 6. æ–‡å­—æ’ç‰ˆ */
        .en-text { font-size: 1.15rem; color: #4ade80; line-height: 1.7; margin-bottom: 0.75rem; font-weight: 500; font-family: 'Inter', sans-serif; cursor: pointer; transition: color 0.3s; }
        .en-text:hover { opacity: 0.8; color: #fff; }
        
        .zh-text { font-size: 1.05rem; color: #ffffff; line-height: 1.8; padding-left: 12px; border-left: 2px solid rgba(255, 255, 255, 0.1); cursor: pointer; font-weight: 400; transition: color 0.3s; }
        .zh-text:hover { color: #4ade80; border-left-color: #4ade80; }

        .sci-term { color: #facc15; font-weight: 700; border-bottom: 1.5px solid rgba(250, 204, 21, 0.3); cursor: pointer; padding: 0 2px; text-shadow: 0 0 10px rgba(250, 204, 21, 0.2); transition: all 0.2s; }
        .sci-term:hover { background-color: rgba(250, 204, 21, 0.2); color: #fff; border-radius: 4px; border-bottom-color: transparent; }

        .section-header { font-size: 1.5rem; font-weight: 800; color: #fff; margin-top: 3rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; gap: 0.75rem; }
        .section-header::before { content: ''; display: block; width: 6px; height: 28px; background: linear-gradient(to bottom, #4ade80, #059669); border-radius: 4px; }

        #canvas-container { display: none; }
        #reading-container { padding-bottom: 140px !important; }
        #control-dock { padding-bottom: env(safe-area-inset-bottom, 20px); bottom: max(1.5rem, env(safe-area-inset-bottom)); }

        .vocab-item { background: rgba(15, 23, 42, 0.4); border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 12px; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;}
        .vocab-item:hover { background: rgba(255, 255, 255, 0.05); }
        .en-term-label { color: #4ade80 !important; font-size: 1.1rem !important; font-weight: 600; margin-top: 2px; }

        .loader { border: 2px solid rgba(74, 222, 128, 0.1); border-top: 2px solid #4ade80; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-teal-500/30 selection:text-white">

    <div id="loader-overlay" class="absolute inset-0 bg-[#0f172a] z-50 flex flex-col items-center justify-center">
        <i class="fa-solid fa-satellite-dish text-5xl text-teal-400 animate-pulse mb-4"></i>
        <div class="text-teal-500 tracking-widest mt-2 font-bold">è³‡æ–™åº«é€£ç·šä¸­...</div>
    </div>

    <nav class="glass-panel sticky top-0 z-40 h-auto md:h-16 flex flex-col md:flex-row items-center shrink-0 border-b-0 shadow-lg">
        <div class="w-full px-4 md:px-6 py-2 flex justify-between items-center border-b border-white/10 md:border-b-0">
            <div class="flex items-center gap-4">
                <button onclick="goBack()" class="flex items-center gap-2 text-teal-400 hover:text-white transition group">
                    <div class="p-1 rounded border border-teal-500/30 group-hover:bg-teal-500/20 group-hover:border-teal-400">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                    <span class="text-sm font-bold tracking-wider hidden md:inline" data-i18n="return">è¿”å›</span>
                </button>
                <div class="flex items-center gap-2 cursor-default">
                    <div class="w-8 h-8 rounded-lg bg-teal-500/10 border border-teal-500/30 flex items-center justify-center text-teal-400">
                        <i class="fa-solid fa-book-journal-whills"></i>
                    </div>
                    <span class="text-lg font-bold text-white tracking-wide" data-i18n="page_title">ç§‘å­¸é›™èªé–±è®€</span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex bg-slate-900/50 rounded-lg p-1 border border-white/10">
                    <button onclick="setMode('en')" class="mode-btn px-3 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-en">EN</button>
                    <button onclick="setMode('dual')" class="mode-btn px-3 py-1 text-xs font-bold rounded bg-teal-600 text-white shadow-[0_0_10px_rgba(74,222,128,0.4)]" id="btn-dual">DUAL</button>
                    <button onclick="setMode('zh')" class="mode-btn px-3 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-zh">ç¹ä¸­</button>
                </div>

                <select id="ui-lang" class="bg-slate-900/50 border border-white/10 text-teal-100 rounded-lg px-2 py-1 text-xs outline-none cursor-pointer hover:bg-slate-800" onchange="changeLanguage()">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                </select>
            </div>
        </div>

        <div class="w-full px-4 md:px-6 py-2 bg-slate-900/60 flex flex-wrap gap-3 items-center text-sm border-t border-white/10 md:border-t-0 md:bg-transparent justify-end">
            <div class="glass-select-wrapper">
                <i class="fa-solid fa-layer-group glass-select-icon"></i>
                <select id="sel-stage" class="glass-select" onchange="filterUnits('stage')">
                    <option value="" disabled selected data-i18n="stage">Stage</option>
                </select>
            </div>

            <div class="glass-select-wrapper w-24">
                <i class="fa-solid fa-graduation-cap glass-select-icon"></i>
                <select id="sel-grade" class="glass-select" onchange="filterUnits('grade')" disabled>
                    <option value="" disabled selected data-i18n="grade">Grade</option>
                </select>
            </div>

            <div class="glass-select-wrapper w-28">
                <i class="fa-solid fa-book glass-select-icon"></i>
                <select id="sel-version" class="glass-select" onchange="filterUnits('version')" disabled>
                    <option value="" disabled selected data-i18n="version">Ver</option>
                </select>
            </div>

            <div class="glass-select-wrapper w-24">
                <i class="fa-regular fa-calendar glass-select-icon"></i>
                <select id="sel-semester" class="glass-select" onchange="filterUnits('semester')" disabled>
                    <option value="" disabled selected data-i18n="semester">Sem</option>
                </select>
            </div>

            <div class="glass-select-wrapper flex-grow md:flex-grow-0 md:w-64">
                <i class="fa-solid fa-list-ul glass-select-icon"></i>
                <select id="sel-unit" class="glass-select" onchange="loadSelectedUnit()" disabled>
                    <option value="" disabled selected data-i18n="unit">Select Unit</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="flex-grow flex overflow-hidden p-4 gap-4 relative z-10">
        <aside class="w-64 glass-panel rounded-2xl flex flex-col overflow-hidden hidden md:flex border-l border-white/10">
            <div class="p-4 border-b border-white/10 bg-slate-900/30">
                <h3 class="text-xs font-bold text-teal-500 tracking-widest mb-1" data-i18n="nav">ç›®éŒ„å°èˆª</h3>
                <div class="text-white font-bold text-sm truncate" id="nav-title">è«‹é¸æ“‡å–®å…ƒ</div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-2 space-y-1" id="unit-list">
                <div class="text-center text-slate-500 text-xs mt-10 p-4" data-i18n="select_hint">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å–®å…ƒã€‚</div>
            </div>
        </aside>

        <section class="flex-grow glass-panel rounded-2xl flex flex-col relative overflow-hidden border-x border-white/10">
            <div class="h-10 border-b border-white/10 bg-slate-900/30 flex items-center justify-between px-6 gap-3">
                <div class="flex items-center gap-2 min-w-0">
                    <i class="fa-solid fa-file-lines text-teal-400"></i>
                    <span class="text-xs font-bold text-teal-200 truncate" id="status-bar">READY</span>
                    <span id="trans-loading" class="hidden text-xs text-teal-400 flex items-center gap-1 ml-2"><div class="loader"></div> Translating...</span>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto p-6 md:p-8 relative" id="reading-container">
                <article class="max-w-4xl mx-auto transition-opacity duration-500" id="article-body">
                    <h1 class="text-2xl md:text-3xl font-black text-white mb-6 font-heading tracking-tight text-center" id="article-title">
                        <span class="text-slate-500 opacity-50" data-i18n="select_hint">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡å–®å…ƒ</span>
                    </h1>
                    <div id="article-content" class="space-y-4"></div>
                </article>
            </div>
        </section>

        <aside class="w-80 glass-panel rounded-2xl flex flex-col overflow-hidden hidden lg:flex border-l border-white/10">
            <div class="p-4 border-b border-white/10 bg-gradient-to-r from-slate-900/50 to-teal-900/10">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                    <h3 class="text-xs font-bold text-teal-400 tracking-widest" data-i18n="vocab_title">ç§‘å­¸è©å½™åº«</h3>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto" id="vocab-container">
                <div class="text-center py-10 opacity-50 text-sm text-teal-200/50" data-i18n="vocab_empty">
                    è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤
                </div>
            </div>
        </aside>
    </div>

    <div id="control-dock" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 flex items-center gap-3 p-2 pl-4 pr-3 rounded-full border border-teal-500/30 shadow-[0_8px_32px_rgba(0,0,0,0.4)] backdrop-blur-xl bg-slate-900/80 transition-all duration-300 w-[90%] max-w-md justify-between md:w-auto md:gap-6">
        
        <div class="flex items-center gap-2">
            <span class="text-[10px] font-bold text-teal-500/70 uppercase tracking-wider hidden md:inline">SPEED</span>
            <select id="play-rate" class="speed-capsule w-12 transition">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1.0" selected>1.0x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
            </select>
        </div>

        <div class="h-6 w-px bg-teal-500/20"></div>

        <div class="flex items-center gap-1 bg-black/20 rounded-full p-1">
            <button onclick="setVoice('male')" id="btn-male" class="w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 text-teal-400 hover:bg-teal-500/20 hover:text-white" title="ç”·è²">
                <i class="fa-solid fa-person text-lg"></i>
            </button>
            <button onclick="setVoice('female')" id="btn-female" class="w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 text-slate-500 hover:bg-teal-500/20 hover:text-white" title="å¥³è²">
                <i class="fa-solid fa-person-dress text-lg"></i>
            </button>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleSpeech()" class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-br from-teal-400 to-teal-600 text-white shadow-[0_0_15px_rgba(74,222,128,0.4)] hover:scale-105 active:scale-95 transition-all duration-300 group" id="btn-play">
                <i class="fa-solid fa-play text-lg ml-1 group-hover:animate-pulse"></i>
            </button>
            
            <button onclick="stopSpeech()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 border border-teal-500/30 text-teal-400 hover:bg-red-500/20 hover:text-red-400 hover:border-red-500/50 transition-all duration-300 active:scale-95">
                <i class="fa-solid fa-stop text-sm"></i>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 border border-teal-500/30 text-teal-100 px-4 py-2 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-2 pointer-events-none text-sm font-bold">
        <i class="fa-solid fa-circle-check text-teal-400"></i> <span id="toast-msg">Ready</span>
    </div>

    <script>
        const SHEET_ID = '1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk';
        const TARGET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbgkNiMflfeLQd3KN8F4yjjIr6G2flnCAy-nUPMiC7_xDfdg_0hJ2Qzbsr92u8htlPLFR8GwwQPK_g/pub?gid=0&single=true&output=csv';

        const COL_STAGE=0, COL_VERSION=2, COL_GRADE=3, COL_SEMESTER=4, COL_UNIT_NUM=6, COL_UNIT_NAME=7,
              COL_CONTENT=8, COL_CKIP=9, COL_VOCAB=18;

        let rawData=[], processedUnits=[], isSpeaking=false, currentVoice='female', translationCache={}, synth=window.speechSynthesis;
        let activeVocabMap = {};
        let currentBlockIndex = 0;

        let currentUnitTitleZh = "";
        let currentUnitTitleEn = "";

        const i18n = {
            'zh-TW': { return: 'è¿”å›', page_title: 'ç§‘å­¸é›™èªé–±è®€', nav: 'ç›®éŒ„å°èˆª', vocab_title: 'ç§‘å­¸è©å½™åº«', select_hint: 'è«‹å…ˆé¸æ“‡å–®å…ƒ', vocab_empty: 'è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤', stage: 'å­¸ç¿’éšæ®µ', grade: 'å¹´ç´š', version: 'ç‰ˆæœ¬', semester: 'å­¸æœŸ', unit: 'é¸æ“‡å–®å…ƒ' },
            'en': { return: 'RETURN', page_title: 'SCI-LINGUA READER', nav: 'NAVIGATION', vocab_title: 'VOCABULARY', select_hint: 'Select a unit to begin', vocab_empty: 'Terms will appear here', stage: 'Stage', grade: 'Grade', version: 'Version', semester: 'Semester', unit: 'Select Unit' },
            'ja': { return: 'æˆ»ã‚‹', page_title: 'ç§‘å­¦ãƒã‚¤ãƒªãƒ³ã‚¬ãƒ«', nav: 'ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³', vocab_title: 'ç§‘å­¦ç”¨èª', select_hint: 'å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„', vocab_empty: 'ç”¨èªã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™', stage: 'æ®µéš', grade: 'å­¦å¹´', version: 'ç‰ˆ', semester: 'å­¦æœŸ', unit: 'å˜å…ƒé¸æŠ' },
            'zh-CN': { return: 'è¿”å›', page_title: 'ç§‘å­¦åŒè¯­é˜…è¯»', nav: 'ç›®å½•å¯¼èˆª', vocab_title: 'ç§‘å­¦è¯æ±‡åº“', select_hint: 'è¯·å…ˆé€‰æ‹©å•å…ƒ', vocab_empty: 'è¯æ±‡å°†æ˜¾ç¤ºäºæ­¤', stage: 'å­¦ä¹ é˜¶æ®µ', grade: 'å¹´çº§', version: 'ç‰ˆæœ¬', semester: 'å­¦æœŸ', unit: 'é€‰æ‹©å•å…ƒ' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            if(synth) synth.onvoiceschanged = () => synth.getVoices();
            
            // âœ… é è¨­æ”¹ç‚ºå¥³è² (iOS ä¸Šé€šå¸¸å¥³è²è¼ƒå¥½)
            setVoice('female');

            document.addEventListener('touchstart', () => {
                try{
                    if(!synth) return;
                    synth.cancel();
                    const u = new SpeechSynthesisUtterance(" ");
                    u.volume = 0; u.rate = 1.0; u.pitch = 1.0;
                    synth.speak(u); synth.cancel(); synth.getVoices?.();
                }catch(e){}
            }, { once: true, passive: true });
        });

        function goBack() { window.location.href = 'student_science.html'; }

        function fetchData() {
            Papa.parse(TARGET_URL, {
                download: true, header: false,
                skipEmptyLines: true, // âœ… [é‡è¦ä¿®æ­£] è·³éç©ºè¡Œï¼Œé˜²æ­¢è³‡æ–™åº«è¼‰å…¥å¡æ­»
                complete: res => { processData(res.data); document.getElementById('loader-overlay').style.display='none'; showToast("è³‡æ–™åº«é€£ç·šæˆåŠŸ"); },
                error: () => document.getElementById('loader-overlay').innerHTML='<div class="text-red-500">Error: Check Network</div>'
            });
        }

        const norm = (s) => (s ?? '').toString().replace(/[\uFEFF\u200B\u200C\u200D]/g,'').replace(/ã€€/g,' ').trim();

        function parseVocabPairs(vocabText){
          const map = {};
          if(!vocabText) return map;
          vocabText.split(/[,;ï¼Œï¼›\n]+/).forEach(token=>{
            const t = (token||"").toString().trim();
            if(!t) return;
            let zh = "", en = "";
            const tabParts = t.split(/\t+/);
            if(tabParts.length >= 2){ zh = tabParts[0].trim(); en = tabParts.slice(1).join(' ').trim(); } 
            else {
              const sepParts = t.split(/[:ï¼š=ï¼]/);
              if(sepParts.length >= 2){ zh = sepParts[0].trim(); en = sepParts.slice(1).join(':').trim(); } 
              else {
                const m = t.match(/^(.+?)[ï¼ˆ(]\s*([^)ï¼‰]+?)\s*[)ï¼‰]\s*$/);
                if(m){ zh = (m[1]||"").trim(); en = (m[2]||"").trim(); } else { zh = t.trim(); en = ""; }
              }
            }
            if(zh) map[zh] = en;
          });
          return map;
        }

        function ckipLineToPlainAndHtml(ckipLine, vocabMap){ return { plain: "", html: "" }; }

        function processData(data) {
            rawData = data.slice(1);
            processedUnits = rawData.map((row, i) => {
                let content = (row[COL_CONTENT]||"").toString(),
                    ckip = (row[COL_CKIP]||"").toString(),
                    unitNum = norm(row[COL_UNIT_NUM]),
                    unitName = norm(row[COL_UNIT_NAME]);
                let title = (unitNum + (unitName ? " " + unitName : "")).trim() || `Unit ${i+1}`;
                return { id: i, stage: norm(row[COL_STAGE]), version: norm(row[COL_VERSION]), grade: norm(row[COL_GRADE]), semester: norm(row[COL_SEMESTER]), title, content, ckip, vocab: (row[COL_VOCAB]||"").toString() };
            }).filter(u => (u.content || u.ckip).length > 5);
            initFilters();
        }

        function initFilters() { populateSelect('sel-stage', [...new Set(processedUnits.map(u=>u.stage).filter(Boolean))], 'stage'); }

        function filterUnits(lvl) {
            const ids=['stage','grade','version','semester','unit'], sels=ids.map(id=>document.getElementById(`sel-${id}`));
            let filtered = processedUnits.filter(u => {
                if(sels[0].value && u.stage!==sels[0].value) return false;
                if(sels[1].value && !sels[1].disabled && u.grade!==sels[1].value) return false;
                if(sels[2].value && !sels[2].disabled && u.version!==sels[2].value) return false;
                if(sels[3].value && !sels[3].disabled && u.semester!==sels[3].value) return false;
                return true;
            });
            const update=(sel,p,key)=> populateSelect(sel.id, [...new Set(filtered.map(u=>u[p]).filter(Boolean))], key);
            if(lvl==='stage') { update(sels[1],'grade','grade'); resetSelects(sels.slice(2)); }
            else if(lvl==='grade') { update(sels[2],'version','version'); resetSelects(sels.slice(3)); }
            else if(lvl==='version') { update(sels[3],'semester','semester'); resetSelects(sels.slice(4)); }
            else if(lvl==='semester') {
                sels[4].innerHTML='<option value="" disabled selected data-i18n="unit">é¸æ“‡å–®å…ƒ</option>';
                filtered.forEach(u=>sels[4].add(new Option(u.title,u.id)));
                sels[4].disabled=false;
                changeLanguage();
            }
        }

        function populateSelect(id,items,i18nKey){
            const s=document.getElementById(id);
            s.innerHTML=`<option value="" disabled selected data-i18n="${i18nKey}">${(i18n['zh-TW'][i18nKey]||'Select')}</option>`;
            items.forEach(i=>s.add(new Option(i,i)));
            s.disabled=false;
            changeLanguage();
        }
        function resetSelects(els){
            els.forEach(e=>{
                const key = e.id.replace('sel-','');
                e.innerHTML=`<option value="" disabled selected data-i18n="${key}">...</option>`;
                e.disabled=true;
            });
            changeLanguage();
        }

        function loadSelectedUnit(){ const u=processedUnits.find(i=>i.id==document.getElementById('sel-unit').value); if(u) renderArticle(u); }

        function renderVocabSidebar() {
          const container = document.getElementById('vocab-container');
          container.innerHTML = '';
          const keys = Object.keys(activeVocabMap || {});
          if(keys.length === 0) {
            container.innerHTML = '<div class="text-center opacity-50 text-sm mt-10">ç„¡è©å½™è³‡æ–™</div>';
            return;
          }
          keys.forEach(zh => {
            const enVal = (activeVocabMap[zh] || "").toString().trim();
            const showEn = enVal ? enVal : "Loading...";
            const card = document.createElement('div');
            card.className = "vocab-item";
            card.innerHTML = `
              <div class="flex-1 pr-2">
                <div class="text-base font-bold text-yellow-400 cursor-pointer" onclick="speakText('${zh.replace(/'/g,"\\'")}')">${escapeHtml(zh)}</div>
                <div class="text-xs en-term-label cursor-pointer" data-zh="${escapeHtml(zh)}" onclick="speakVocabEn('${zh.replace(/'/g,"\\'")}', this)">${escapeHtml(showEn)}</div>
              </div>
              <div class="flex items-center gap-1">
                <button onclick="event.stopPropagation(); speakText('${zh.replace(/'/g,"\\'")}')" class="text-teal-300 hover:text-white px-2 py-1 rounded-full hover:bg-white/10 text-xs font-bold" title="å¿µä¸­æ–‡">ä¸­</button>
                <button onclick="event.stopPropagation(); speakVocabEn('${zh.replace(/'/g,"\\'")}', this)" class="text-teal-400 hover:text-white px-2 py-1 rounded-full hover:bg-white/10 text-xs font-bold" title="Read English">EN</button>
              </div>`;
            container.appendChild(card);
            if(!enVal) translateVocabItem(zh, card.querySelector('.en-term-label'));
          });
        }

        async function speakVocabEn(zh, btn){
          const card = btn && btn.closest ? btn.closest('.vocab-item') : null;
          const label = card ? card.querySelector('.en-term-label') : null;
          let en = (activeVocabMap[zh] || "").toString().trim();
          if(!en){ await translateVocabItem(zh, label); en = (activeVocabMap[zh] || "").toString().trim(); }
          speakText(en || zh);
        }

        async function translateToEn(text) {
          const src = (text || "").toString().trim();
          if(!src) return "";
          const cacheKey = "__title__" + src;
          if(translationCache[cacheKey]) return translationCache[cacheKey];
          try {
              const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`);
              const json = await res.json();
              let out = ""; (json[0] || []).forEach(x => out += (x[0] || ""));
              translationCache[cacheKey] = out;
              return out;
          } catch(e) { return src; }
        }

        function ensureTitleTranslated() {
          if(!currentUnitTitleZh) return;
          const existing = document.getElementById('title-en');
          if(existing && existing.innerText && existing.innerText !== 'Translating...') return;
          translateToEn(currentUnitTitleZh).then(en => {
            currentUnitTitleEn = en || "";
            const enEl = document.getElementById('title-en');
            if(enEl) enEl.innerText = currentUnitTitleEn || "";
          }).catch(() => {});
        }

        function rehighlightEnglishBlocks(){
          const ens = document.querySelectorAll('.en-text');
          ens.forEach(el => {
            const src = decodeURIComponent(el.getAttribute('data-source') || "");
            const cached = translationCache[src];
            if(cached){ el.innerHTML = makeClickable(highlightEnglishVocabInText(cached)); }
          });
        }

        async function renderArticle(unit) {
            currentUnitTitleZh = unit.title;
            currentUnitTitleEn = "";
            document.getElementById('article-title').innerHTML = `
              <div id="title-zh">${escapeHtml(currentUnitTitleZh)}</div>
              <div id="title-en" class="text-base md:text-lg font-semibold text-teal-400 italic mt-2">Translating...</div>
            `;
            document.getElementById('status-bar').innerText = unit.title;
            document.getElementById('nav-title').innerText = unit.title;
            activeVocabMap = parseVocabPairs(unit.vocab);
            renderVocabSidebar();
            
            const contentDiv = document.getElementById('article-content');
            contentDiv.innerHTML='';
            document.getElementById('unit-list').innerHTML='';

            let lines = (unit.content || "").split('\n').map(x=>x.trim()).filter(Boolean);
            if(lines.length===0 && unit.ckip){
                lines = unit.ckip.split('\n').map(x=>x.replace(/ã€€/g,' ').replace(/\([^)]*\)/g,'').trim()).filter(Boolean);
            }

            const unitCkipSet = unit.ckip ? getCkipTokenSet(unit.ckip) : null;
            const unitCkipTokens = unit.ckip ? getCkipTokenArray(unit.ckip) : [];
            const unitMergeSet = buildCkipMergeSet(unitCkipTokens, getMaxKeyLen(activeVocabMap));

            for(let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                if(!line) continue;
                if((line.length<40 && !/[ã€‚ï¼ï¼Ÿ.!?]$/.test(line)) || line.includes("æ´»å‹•")) {
                    const anchorId = `sec-${i}`;
                    const navItem = document.createElement('div');
                    navItem.className='nav-item';
                    navItem.innerText = line;
                    navItem.onclick=()=>{ document.getElementById(anchorId).scrollIntoView({behavior:'smooth',block:'center'}); };
                    document.getElementById('unit-list').appendChild(navItem);
                    contentDiv.innerHTML += `
                        <h2 id="${anchorId}" class="section-header items-start">
                            <div class="flex flex-col w-full">
                                <span class="zh-text text-xl md:text-2xl font-black cursor-pointer transition" onclick="speakText(this.innerText)">${escapeHtml(line)}</span>
                                <span class="en-text hidden text-base md:text-lg italic mt-1 font-medium cursor-pointer transition" 
                                      data-source="${encodeURIComponent(line)}"
                                      onclick="speakText(this.innerText)"></span>
                            </div>
                        </h2>`;
                } else {
                    let processed = processXRayWithCKIP(line, activeVocabMap, unitCkipSet, unitMergeSet);
                    contentDiv.innerHTML += `
                        <div class="content-block">
                            <p class="zh-text" onclick="speakText(this.innerText)">${processed}</p>
                            <p class="en-text hidden italic text-sm mt-2"
                               onclick="speakText(this.innerText)"
                               data-source="${encodeURIComponent(line)}"></p>
                        </div>`;
                }
            }
            setMode('dual');
        }

        function getCkipTokenSet(ckipLine){
          const raw = (ckipLine || "").toString().trim();
          if(!raw) return new Set();
          return new Set(raw.replace(/ã€€/g, " ").split(/\s+/).filter(Boolean).map(tok => tok.replace(/[\(ï¼ˆ].*$/, "")).filter(Boolean));
        }
        function getCkipTokenArray(ckipText) {
          const raw = (ckipText || "").toString().replace(/ã€€/g, " ").trim();
          if (!raw) return [];
          return raw.split(/\s+/).filter(Boolean).map(tok => tok.replace(/[\(ï¼ˆ].*$/, "")).filter(Boolean);
        }
        function getMaxKeyLen(vocabMap) {
          const keys = Object.keys(vocabMap || {});
          if (!keys.length) return 1;
          let m = 1; for (const k of keys) m = Math.max(m, (k || "").length); return m;
        }
        function buildCkipMergeSet(tokens, maxLen) {
          const set = new Set();
          if (!tokens || !tokens.length) return set;
          const L = Math.max(2, maxLen || 2);
          for (let i = 0; i < tokens.length; i++) {
            let acc = "";
            for (let j = i; j < tokens.length; j++) {
              acc += tokens[j];
              if (acc.length > L) break;
              if (acc.length >= 2) set.add(acc);
            }
          }
          return set;
        }
        function shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet) {
          if (!term) return false;
          if (!ckipTokenSet || ckipTokenSet.size === 0) return true;
          if (term.length === 1) return ckipTokenSet.has(term);
          if (ckipTokenSet.has(term)) return true;
          if (ckipMergeSet && ckipMergeSet.has(term)) return true;
          return false;
        }
        function processXRayWithCKIP(text, map, ckipTokenSet, ckipMergeSet) {
          const src = (text || "").toString().replace(/ã€€/g, "");
          const keys = Object.keys(map || {}).filter(Boolean).sort((a, b) => b.length - a.length);
          if (!keys.length) return escapeHtml(src);
          const spans = [];
          const overlaps = (s, e) => spans.some(sp => !(e <= sp.start || s >= sp.end));
          for (const term of keys) {
            let from = 0;
            while (true) {
              const idx = src.indexOf(term, from);
              if (idx === -1) break;
              const start = idx, end = idx + term.length;
              from = idx + term.length;
              if (overlaps(start, end)) continue;
              if (!shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet)) continue;
              spans.push({ start, end, term });
            }
          }
          if (!spans.length) return escapeHtml(src);
          spans.sort((a, b) => a.start - b.start);
          let html = "", last = 0;
          for (const sp of spans) {
            html += escapeHtml(src.slice(last, sp.start));
            const zh = sp.term;
            const js = ((map[zh] || zh) + "").toString().replace(/'/g, "\\'");
            const title = escapeHtml(((map[zh] || "") + "").toString());
            html += `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${title}">${escapeHtml(zh)}</span>`;
            last = sp.end;
          }
          html += escapeHtml(src.slice(last));
          return html;
        }

        async function translateVocabItem(zh, el) {
          try {
            const q = encodeURIComponent(zh);
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${q}`);
            const json = await res.json();
            const en = (json && json[0] && json[0][0] && json[0][0][0]) ? json[0][0][0] : "";
            if(el) el.innerText = en || "â€”";
            activeVocabMap[zh] = en || "";
            rehighlightEnglishBlocks();
            return en || "";
          } catch(e) {
            if(el) el.innerText = "â€”";
            activeVocabMap[zh] = "";
            rehighlightEnglishBlocks();
            return "";
          }
        }

        async function translateVisibleBlocks() {
            const ens = document.querySelectorAll('.en-text'), load=document.getElementById('trans-loading');
            let need=false; ens.forEach(e=>{if(!e.innerText)need=true}); if(!need)return;
            load.classList.remove('hidden');
            for(let el of ens) {
                if(el.innerText) continue;
                let src = decodeURIComponent(el.getAttribute('data-source') || "").replace(/ã€€/g,'');
                if(translationCache[src]) { el.innerHTML=makeClickable(highlightEnglishVocabInText(translationCache[src])); continue; }
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`);
                    const json = await res.json();
                    let txt=""; json[0].forEach(i=>txt+=i[0]);
                    el.innerHTML = makeClickable(highlightEnglishVocabInText(txt));
                    translationCache[src]=txt;
                } catch(e){ el.innerText="Error"; }
            }
            load.classList.add('hidden');
            rehighlightEnglishBlocks();
        }

        function makeClickable(html) { return `<span class="cursor-pointer hover:text-teal-300 transition">${html}</span>`; }
        function escapeHtml(s){ return (s||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
        function highlightEnglishVocabInText(txt){
          let safe = escapeHtml(txt);
          const terms = Object.values(activeVocabMap||{}).map(v => (v||"").trim()).filter(v => v && v !== "Loading..." && /[a-zA-Z]/.test(v));
          const uniq = [...new Set(terms)].sort((a,b)=>b.length-a.length);
          if(!uniq.length) return safe;
          for(const term of uniq){
            const escaped = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
            const isSingleWord = /^[A-Za-z]+$/.test(term);
            const re = isSingleWord ? new RegExp(`\\b(${escaped})\\b`,'gi') : new RegExp(`(${escaped})`,'gi');
            safe = safe.replace(re, (m) => {
              const js = m.replace(/'/g,"\\'");
              return `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${m}">${m}</span>`;
            });
          }
          return safe;
        }

        // ====================== [èªéŸ³æ’­æ”¾æ ¸å¿ƒé‚è¼¯] ======================

        function isIOSDevice(){
          return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        function isMostlyEnglish(txt){
          const t = (txt || "").toString();
          const latin = (t.match(/[A-Za-z]/g) || []).length;
          const cjk   = (t.match(/[\u4E00-\u9FFF]/g) || []).length;
          if (cjk === 0) return latin > 0;
          return latin > cjk * 2;
        }
        function splitTextForSpeak(text, isEng){
          const t = (text || "").toString().replace(/\s+/g, " ").trim();
          if(!t) return [];
          const maxLen = isEng ? 180 : 120;
          const out = [];
          let s = t;
          while(s.length > maxLen){
            let cut = -1;
            const punct = isEng ? /[.!?;:]/g : /[ã€‚ï¼ï¼Ÿï¼›ï¼š]/g;
            let m, last = -1;
            while((m = punct.exec(s.substring(0, maxLen))) !== null){ last = m.index + 1; }
            if(last >= Math.floor(maxLen * 0.4)) cut = last;
            if(cut === -1 && isEng){ const sp = s.lastIndexOf(" ", maxLen); if(sp >= Math.floor(maxLen * 0.5)) cut = sp; }
            if(cut === -1) cut = maxLen;
            out.push(s.slice(0, cut).trim());
            s = s.slice(cut).trim();
          }
          if(s) out.push(s);
          return out;
        }

        // âœ… [Siri å„ªå…ˆç‰ˆ] ç˜‹ç‹‚å°‹æ‰¾ Siri è²éŸ³
        function pickBestVoice(isEng, gender) {
            if (!window.speechSynthesis) return null;
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return null;
            const targetLang = isEng ? ['en-us', 'en-gb', 'en'] : ['zh-tw', 'zh-hk', 'zh-cn', 'zh'];
            const getScore = (voice) => {
                let score = 0;
                const name = voice.name.toLowerCase();
                const uri = (voice.voiceURI || "").toLowerCase();
                const lang = voice.lang.toLowerCase();
                if (targetLang.some(t => lang === t || lang.replace('_', '-').startsWith(t))) { score += 1000; } else { return -1; }
                
                // Siri & é«˜å“è³ªå„ªå…ˆ
                if (name.includes('siri') || uri.includes('siri')) score += 20000;
                if (name.includes('samantha')) score += 15000; // è‹±æ–‡é¦–é¸
                if (name.includes('meijia')) score += 15000;   // ä¸­æ–‡é¦–é¸ (å¦‚æœæ²’ Siri)
                if (name.includes('hsiaochen')) score += 20000; // Edge æ›‰è‡»
                if (name.includes('yunxi')) score += 20000;     // Edge é›²å¸Œ
                
                if (name.includes('enhanced') || uri.includes('enhanced')) score += 5000;
                if (name.includes('premium') || uri.includes('premium')) score += 5000;
                if (name.includes('natural')) score += 3000;
                if (name.includes('compact') || uri.includes('compact')) score -= 50000; // æ‡²ç½°æ©Ÿå™¨éŸ³

                // iOS å°ˆå±¬ï¼šå¦‚æœæ˜¯ iPhoneï¼Œä¸”æ²’æ‰¾åˆ° Siriï¼Œå¼·åˆ¶ç”¨ç¾ä½³/Samanthaï¼Œå¿½ç•¥æ€§åˆ¥ä»¥å…è®Šæ©Ÿå™¨éŸ³
                const isIphone = isIOSDevice();
                if (isIphone && !name.includes('siri') && (name.includes('meijia') || name.includes('samantha'))) {
                    score += 5000; 
                } else if (!name.includes('siri')) {
                    // ä¸€èˆ¬é‚è¼¯
                    if (gender === 'male') {
                        if (name.includes('male') || name.includes('man') || name.includes('boy')) score += 2000;
                        if (name.includes('female') || name.includes('woman') || name.includes('girl')) score -= 500;
                    } else {
                        if (name.includes('female') || name.includes('woman') || name.includes('girl')) score += 2000;
                        if (name.includes('male') || name.includes('man') || name.includes('boy')) score -= 500;
                    }
                }
                return score;
            };
            const sorted = voices.map(v => ({ v, score: getScore(v) })).filter(item => item.score > -10000).sort((a, b) => b.score - a.score);
            return sorted.length > 0 ? sorted[0].v : voices[0];
        }

        function speakText(txt, onComplete) {
            if (!synth) return;
            isSpeaking = true;
            if (synth.paused) synth.resume();
            
            const btn = document.getElementById('btn-play');
            if (btn) btn.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
            synth.cancel();

            const cleanTxt = (txt || "").toString().replace(/<[^>]*>/g, "").replace(/\u00A0/g, " ").trim();
            if (!cleanTxt) {
                if (onComplete) { setTimeout(() => { if (isSpeaking) onComplete(); }, 10); } 
                else { isSpeaking = false; if (btn) btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>'; }
                return;
            }

            const ios = isIOSDevice();
            const isEng = isMostlyEnglish(cleanTxt);
            const lang = isEng ? "en-US" : "zh-TW";
            const chunks = (ios && cleanTxt.length > (isEng ? 220 : 140)) ? splitTextForSpeak(cleanTxt, isEng) : [cleanTxt];
            const uiRate = parseFloat(document.getElementById('play-rate')?.value || "1.0");
            let idx = 0;

            const speakNext = () => {
                if (!isSpeaking) return;
                if (idx >= chunks.length) {
                    if (onComplete) { onComplete(); } 
                    else { isSpeaking = false; if (btn) btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>'; }
                    return;
                }
                const part = chunks[idx++];
                const u = new SpeechSynthesisUtterance(part);
                u.lang = lang;
                
                let voice = pickBestVoice(isEng, currentVoice);
                if (voice) u.voice = voice;

                if (ios) { u.pitch = 1.0; u.rate = 1.0; } 
                else { u.rate = uiRate; u.pitch = (currentVoice === 'male') ? 1.0 : 1.05; }

                u.onend = speakNext;
                u.onerror = () => { if (isSpeaking) speakNext(); };
                synth.speak(u);
            };
            speakNext();
        }

        function playSequence() {
            if (!isSpeaking) return;
            const blocks = document.querySelectorAll('.content-block');
            if (currentBlockIndex >= blocks.length) { stopSpeech(); return; }

            clearHighlights();
            const block = blocks[currentBlockIndex];
            if (block) {
                block.classList.add('reading-active');
                block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const enEl = block.querySelector('.en-text');
            const zhEl = block.querySelector('.zh-text');
            let textToRead = "";
            if (enEl && !enEl.classList.contains('hidden') && enEl.innerText) { textToRead = enEl.innerText; } 
            else if (zhEl) { textToRead = zhEl.innerText; }

            if (textToRead) {
                speakText(textToRead, () => {
                    if (!isSpeaking) return;
                    currentBlockIndex++;
                    playSequence();
                });
            } else {
                currentBlockIndex++;
                playSequence();
            }
        }

        function toggleSpeech() {
            const btn = document.getElementById('btn-play');
            if (isSpeaking) {
                isSpeaking = false;
                if (synth) synth.cancel();
                if (btn) btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
            } else {
                isSpeaking = true;
                if (btn) btn.innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
                if (synth && synth.paused) synth.resume();
                const blocks = document.querySelectorAll('.content-block');
                if (currentBlockIndex >= blocks.length) currentBlockIndex = 0;
                setTimeout(() => { if (isSpeaking) playSequence(); }, 10);
            }
        }

        function stopSpeech() {
            isSpeaking = false;
            if (synth) synth.cancel();
            currentBlockIndex = 0;
            clearHighlights();
            const btn = document.getElementById('btn-play');
            if (btn) btn.innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
        }

        function clearHighlights() {
            document.querySelectorAll('.reading-active').forEach(el => { el.classList.remove('reading-active'); });
        }

        function setVoice(g) {
            currentVoice = g;
            const activeClass = "w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 bg-teal-500 text-white shadow-lg scale-105";
            const inactiveClass = "w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 text-slate-500 hover:bg-teal-500/20 hover:text-white";
            document.getElementById('btn-male').className = (g === 'male') ? activeClass : inactiveClass;
            document.getElementById('btn-female').className = (g === 'female') ? activeClass : inactiveClass;
            stopSpeech();
        }

        function setMode(m) {
            ['en','dual','zh'].forEach(x=>document.getElementById(`btn-${x}`).className=x===m?"mode-btn px-3 py-1 text-xs font-bold rounded bg-teal-600 text-white shadow-[0_0_10px_rgba(74,222,128,0.4)] scale-105":"mode-btn px-3 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition");
            if(m!=='zh') translateVisibleBlocks();
            const en=document.querySelectorAll('.en-text'), zh=document.querySelectorAll('.zh-text');
            if(m==='en'){en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.add('hidden'));}
            else if(m==='zh'){en.forEach(e=>e.classList.add('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
            else{en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
            const tZh=document.getElementById('title-zh');
            const tEn=document.getElementById('title-en');
            if(tZh && tEn){
              if(m==='en'){ tZh.classList.add('hidden'); tEn.classList.remove('hidden'); }
              else if(m==='zh'){ tZh.classList.remove('hidden'); tEn.classList.add('hidden'); }
              else { tZh.classList.remove('hidden'); tEn.classList.remove('hidden'); }
            }
            if(m !== 'zh') ensureTitleTranslated();
        }

        function changeLanguage() {
            const lang = document.getElementById('ui-lang').value;
            const t = i18n[lang] || i18n['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if(t[k]) { if(el.tagName==='OPTION') el.text=t[k]; else el.innerText=t[k]; }
            });
        }

        function showToast(m) { const T=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; T.classList.remove('opacity-0','translate-y-10'); setTimeout(()=>T.classList.add('opacity-0','translate-y-10'),2000); }
    </script>
</body>
</html>
