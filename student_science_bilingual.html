<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI School | ç§‘å­¸é›™èªé–±è®€</title>
    
    <script>
        // ã€é–‹ç™¼æ¨¡å¼ã€‘å·²æš«æ™‚å°‡ä¸‹æ–¹æª¢æŸ¥è¨»è§£æ‰ï¼Œè®“æ‚¨å¯ä»¥ç›´æ¥é€²å…¥æ¸¬è©¦ã€‚
        /*
        if (!sessionStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }
        */
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                        heading: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        student: {
                            bg: '#0B1121',       /* æ·±å®‡å®™è— */
                            card: '#1E293B',     /* å¡ç‰‡åº•è‰² */
                            english: '#4ade80',  /* è¢å…‰è–„è·ç¶  */
                            highlight: '#f472b6',/* äº®æ¡ƒç´… */
                            term: '#fbbf24'      /* é‡‘é»ƒè‰² */
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 1. åŸºç¤è¨­å®š */
        body { 
            background-color: #0B1121; 
            color: #f1f5f9; 
            overflow: hidden; 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* æŸ”å’Œçš„æ¥µå…‰èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(30, 58, 138, 0.15), transparent 60%);
            z-index: -2; pointer-events: none;
        }

        /* 2. åœ“æ½¤çš„ç»ç’ƒå¡ç‰‡ - åŸºç¤é¡ */
        .glass-panel { 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); 
            border-radius: 1.5rem; 
        }

        /* [Visual] å€å¡Šé¡è‰²å€åˆ† */
        .panel-left { background: rgba(15, 23, 42, 0.7); } /* è¼ƒæ·±çš„è—è‰² (Menu) */
        .panel-center { background: rgba(30, 41, 59, 0.6); } /* æ¨™æº–é€å…‰ (Content) */
        .panel-right { background: rgba(30, 27, 75, 0.5); } /* å¸¶ä¸€é»ç´«çš„æ·±è‰² (Vocab) */

        /* æ²è»¸ç¾åŒ– */
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-track { background: transparent; }
        .scroll-area::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 99px; }
        .scroll-area::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        /* 3. å°èˆªé¸å–® (å´é‚Šæ¬„) */
        .nav-item { 
            transition: all 0.2s ease; 
            cursor: pointer; 
            padding: 1rem 1.2rem; 
            margin-bottom: 0.5rem; 
            font-size: 1rem; 
            color: #94a3b8; 
            border-radius: 1rem;
            font-weight: 500;
            display: flex; align-items: center;
        }
        .nav-item:hover { 
            background: rgba(255, 255, 255, 0.05); 
            color: #fff; 
            transform: translateX(4px);
        }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(74, 222, 128, 0.15), transparent); 
            color: #4ade80; 
            font-weight: 700; 
            box-shadow: inset 3px 0 0 #4ade80; 
        }

        /* 4. ç§‘å­¸è©å½™ */
        .sci-term { 
            color: #fbbf24; 
            font-weight: 700; 
            border-bottom: 2px dashed rgba(251, 191, 36, 0.4); 
            cursor: pointer; 
            transition: all 0.2s; 
            padding: 0 4px; 
            border-radius: 4px;
        }
        .sci-term:hover { 
            background-color: rgba(251, 191, 36, 0.2); 
            color: #fff; 
            border-bottom-color: transparent;
            transform: scale(1.05);
            display: inline-block;
        }

        /* 5. é–±è®€å€å¡Š (æ’ç‰ˆå„ªåŒ–) */
        .content-block { 
            margin-bottom: 3rem; /* å¢åŠ å€å¡Šé–“è· */
            padding: 1.5rem; 
            border-radius: 1.5rem; 
            background: transparent; 
            border: 1px solid transparent; 
            transition: all 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            gap: 1.25rem; /* [æ’ç‰ˆ] å¢åŠ ä¸­è‹±æ–‡ä¹‹é–“çš„è·é›¢ */
        }
        
        /* ğŸ¯ æ­£åœ¨æœ—è®€çš„é«˜äº® (æ¡ƒç´…ç³») */
        .reading-active {
            background: linear-gradient(90deg, rgba(244, 114, 182, 0.08) 0%, rgba(244, 114, 182, 0.15) 50%, rgba(244, 114, 182, 0.08) 100%) !important;
            border-left: 6px solid #f472b6 !important; 
            border-radius: 0.5rem 1.5rem 1.5rem 0.5rem;
            transform: scale(1.01);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        .reading-active .zh-text,
        .reading-active .en-text,
        .reading-active .sci-term,
        .reading-active .section-title-text { /* åŒ…å«æ¨™é¡Œæ–‡å­— */
            color: #f472b6 !important;
            text-shadow: 0 0 10px rgba(244, 114, 182, 0.4);
            border-bottom-color: transparent;
        }

        /* 6. å­—é«”æ’ç‰ˆ (å„ªåŒ–é–±è®€æ„Ÿ) */
        .en-text { 
            font-size: 1.3rem; /* [æ’ç‰ˆ] ç¨å¾®åŠ å¤§è‹±æ–‡ */
            color: #4ade80; 
            line-height: 1.7; 
            font-weight: 500; 
            font-family: 'Inter', sans-serif; 
            cursor: pointer; 
            transition: color 0.3s;
        }
        .en-text:hover { opacity: 0.9; color: #fff; }

        .zh-text { 
            font-size: 1.25rem; /* [æ’ç‰ˆ] ç¨å¾®åŠ å¤§ä¸­æ–‡ */
            color: #e2e8f0;     /* [æ’ç‰ˆ] ç¨å¾®èª¿äº®ä¸­æ–‡é¡è‰²ï¼Œå°æ¯”åº¦æ›´å¥½ */
            line-height: 2.0;   /* [æ’ç‰ˆ] å¢åŠ ä¸­æ–‡è¡Œé«˜ï¼Œé–±è®€æ›´èˆ’é© */
            letter-spacing: 0.08em; /* [æ’ç‰ˆ] å¢åŠ å­—è· */
            padding-left: 0;    /* [æ’ç‰ˆ] ç§»é™¤ä¸å¿…è¦çš„å…§ç¸®ï¼Œäº¤çµ¦ gap æ§åˆ¶ */
            cursor: pointer; 
            font-weight: 400; 
            transition: color 0.3s;
            text-align: justify; /* [æ’ç‰ˆ] å·¦å³å°é½Š */
        }
        .zh-text:hover { color: #f472b6; }

        /* [æ’ç‰ˆ] ç« ç¯€æ¨™é¡Œå„ªåŒ– */
        .section-header { 
            margin-top: 4rem; 
            margin-bottom: 2.5rem; 
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* æ”¹ç‚ºæ›´è¼•å¾®çš„åº•ç·š */
            background: rgba(255,255,255,0.02); /* æ¥µæ·¡çš„èƒŒæ™¯å‡¸é¡¯ */
            display: flex; 
            align-items: flex-start; 
            gap: 1rem; 
            transition: all 0.3s;
        }
        /* [æ’ç‰ˆ] æ¨™é¡Œå·¦å´è£é£¾ç·šåŠ å¼· */
        .section-header::before { 
            content: ''; display: block; width: 6px; height: 100%; min-height: 40px;
            background: #4ade80; border-radius: 99px; 
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.4); /* å¢åŠ å…‰æšˆ */
            margin-top: 4px;
        }
        .section-title-text {
            font-size: 1.8rem;
            font-weight: 900;
            color: #fff;
            line-height: 1.4;
            cursor: pointer;
        }

        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ (ä¿æŒåŸæ¨£) */
        .student-select-wrapper {
            position: relative; display: flex; align-items: center;
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 99px; 
            padding: 0 14px; 
            height: 40px;    
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            min-width: max-content; 
        }
        .student-select-wrapper:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
            border-color: #4ade80;
        }
        .student-select-icon { 
            color: #4ade80; 
            font-size: 0.875rem; 
            margin-right: 8px; 
            pointer-events: none; 
        }
        .student-select {
            appearance: none; -webkit-appearance: none;
            background: transparent; border: none;
            color: #fff; 
            font-size: 0.875rem; 
            font-weight: 600;    
            padding: 0 24px 0 0; 
            width: 100%; height: 100%;
            cursor: pointer; outline: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right center; background-repeat: no-repeat; background-size: 0.85em 0.85em; 
        }
        .student-select option { background-color: #1E293B; color: #fff; padding: 10px; }

        /* åº•éƒ¨æ’­æ”¾å™¨ */
        .player-dock {
            background: rgba(15, 23, 42, 0.95); /* åŠ æ·±ä¸€é»é˜²æ­¢é€åº•å¤ªå¤š */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        #reading-container { padding-bottom: 180px !important; }
        #control-dock { padding-bottom: env(safe-area-inset-bottom, 20px); bottom: max(1.5rem, env(safe-area-inset-bottom)); }

        .vocab-item { 
            background: rgba(255, 255, 255, 0.05); /* ç¨å¾®èª¿äº® */
            border-radius: 12px; margin-bottom: 8px; padding: 12px 16px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: all 0.2s; border: 1px solid transparent;
        }
        .vocab-item:hover { background: rgba(255, 255, 255, 0.1); border-color: #4ade80; transform: translateX(2px); }
        .en-term-label { color: #4ade80 !important; font-size: 1.1rem !important; font-weight: 700; }

        .loader { border: 3px solid rgba(74, 222, 128, 0.2); border-top: 3px solid #4ade80; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-teal-500/30 selection:text-white">

    <div id="loader-overlay" class="absolute inset-0 bg-[#0B1121] z-50 flex flex-col items-center justify-center">
        <div class="relative">
            <div class="absolute inset-0 bg-green-400 blur-xl opacity-20 rounded-full animate-pulse"></div>
            <i class="fa-solid fa-rocket text-6xl text-green-400 relative z-10 animate-bounce"></i>
        </div>
        <div class="text-green-400 tracking-widest mt-6 font-bold text-lg">è¼‰å…¥ç§‘å­¸å®‡å®™...</div>
    </div>

    <nav class="sticky top-4 z-40 px-4 flex flex-col md:flex-row items-center gap-3 shrink-0 pointer-events-none">
        <div class="glass-panel panel-left px-4 py-2 flex items-center gap-4 pointer-events-auto shadow-lg">
            <button onclick="goBack()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-green-400 hover:text-white transition group">
                <i class="fa-solid fa-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i>
            </button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400">
                    <i class="fa-solid fa-atom text-lg"></i>
                </div>
                <span class="text-lg font-black text-white tracking-wide" data-i18n="page_title">AI School</span>
            </div>
        </div>

        <div class="flex-grow flex flex-wrap gap-2 justify-end pointer-events-auto">
            <div class="student-select-wrapper w-auto">
                <i class="fa-solid fa-globe student-select-icon"></i>
                <select id="sel-lang" class="student-select" onchange="changeLanguage(this.value)">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                </select>
            </div>

            <div class="student-select-wrapper w-36">
                <i class="fa-solid fa-layer-group student-select-icon"></i>
                <select id="sel-stage" class="student-select" onchange="filterUnits('stage')">
                    <option value="" disabled selected data-i18n="stage">éšæ®µ</option>
                </select>
            </div>
            <div class="student-select-wrapper w-32">
                <i class="fa-solid fa-graduation-cap student-select-icon"></i>
                <select id="sel-grade" class="student-select" onchange="filterUnits('grade')" disabled>
                    <option value="" disabled selected data-i18n="grade">å¹´ç´š</option>
                </select>
            </div>
            <div class="student-select-wrapper w-36">
                <i class="fa-solid fa-book-open student-select-icon"></i>
                <select id="sel-version" class="student-select" onchange="filterUnits('version')" disabled>
                    <option value="" disabled selected data-i18n="version">ç‰ˆæœ¬</option>
                </select>
            </div>
            <div class="student-select-wrapper w-32">
                <i class="fa-regular fa-calendar-days student-select-icon"></i>
                <select id="sel-semester" class="student-select" onchange="filterUnits('semester')" disabled>
                    <option value="" disabled selected data-i18n="semester">å­¸æœŸ</option>
                </select>
            </div>
            <div class="student-select-wrapper flex-grow md:flex-grow-0 md:w-auto min-w-[200px]">
                <i class="fa-solid fa-list-ul student-select-icon"></i>
                <select id="sel-unit" class="student-select" onchange="loadSelectedUnit()" disabled>
                    <option value="" disabled selected data-i18n="unit">é¸æ“‡å­¸ç¿’å–®å…ƒ</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="flex-grow flex overflow-hidden p-4 gap-4 relative z-10 mt-2">
        <aside class="w-64 glass-panel panel-left flex flex-col overflow-hidden hidden md:flex">
            <div class="p-5 border-b border-white/10 bg-black/20">
                <h3 class="text-xs font-bold text-green-400 tracking-widest mb-1 uppercase" data-i18n="nav">MENU</h3>
                <div class="text-white font-bold text-lg truncate" id="nav-title">è«‹é¸æ“‡å–®å…ƒ</div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-3" id="unit-list">
                <div class="text-center text-slate-500 text-sm mt-10 p-4" data-i18n="select_hint">ğŸ‘ˆ è«‹å…ˆä¸Šæ–¹é¸æ“‡å–®å…ƒ</div>
            </div>
        </aside>

        <section class="flex-grow glass-panel panel-center flex flex-col relative overflow-hidden">
            <div class="h-14 border-b border-white/10 bg-black/20 flex items-center justify-between px-6 gap-3 shrink-0">
                <div class="flex items-center gap-2 min-w-0">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    <span class="text-xs font-bold text-green-200 truncate" id="status-bar">READY</span>
                    <span id="trans-loading" class="hidden text-xs text-green-400 flex items-center gap-1 ml-2"><div class="loader w-3 h-3"></div> ç¿»è­¯ä¸­...</span>
                </div>
                
                <div class="flex bg-black/30 rounded-full p-1 border border-white/10">
                    <button onclick="setMode('en')" class="px-4 py-1.5 text-xs font-bold rounded-full text-slate-400 hover:text-white transition" id="btn-en">EN</button>
                    <button onclick="setMode('dual')" class="px-4 py-1.5 text-xs font-bold rounded-full bg-green-500 text-white shadow-lg" id="btn-dual">é›™èª</button>
                    <button onclick="setMode('zh')" class="px-4 py-1.5 text-xs font-bold rounded-full text-slate-400 hover:text-white transition" id="btn-zh">ä¸­æ–‡</button>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto p-6 md:p-12 relative" id="reading-container">
                <article class="max-w-4xl mx-auto transition-opacity duration-500" id="article-body">
                    <h1 class="text-3xl md:text-4xl font-black text-white mb-10 text-center" id="article-title">
                        <span class="text-slate-500 opacity-30 text-2xl">ç­‰å¾…æ¢ç´¢...</span>
                    </h1>
                    <div id="article-content" class="space-y-2"></div> </article>
            </div>
        </section>

        <aside class="w-80 glass-panel panel-right flex flex-col overflow-hidden hidden lg:flex">
            <div class="p-5 border-b border-white/10 bg-gradient-to-r from-yellow-500/10 to-transparent">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fa-solid fa-lightbulb text-yellow-400"></i>
                    <h3 class="text-sm font-bold text-yellow-400 tracking-widest" data-i18n="vocab_title">ç§‘å­¸è©å½™åº«</h3>
                </div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-3" id="vocab-container">
                <div class="text-center py-10 opacity-30 text-sm text-white" data-i18n="vocab_empty">è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤</div>
            </div>
        </aside>
    </div>

    <div id="control-dock" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-[95%] max-w-lg">
        <div class="player-dock flex items-center justify-between gap-4">
            
            <div class="flex flex-col items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">SPEED</span>
                <select id="play-rate" class="appearance-none bg-transparent text-green-400 font-black text-lg text-center outline-none cursor-pointer w-12 hover:scale-110 transition">
                    <option value="0.5">0.5</option>
                    <option value="0.75">0.75</option>
                    <option value="1.0" selected>1.0</option>
                    <option value="1.25">1.25</option>
                    <option value="1.5">1.5</option>
                </select>
            </div>

           <div class="flex items-center gap-2 md:gap-4">
                <div class="flex bg-white/10 rounded-full p-1 gap-1 mr-2">
                    <button onclick="setVoice('male')" id="btn-male" class="w-9 h-9 rounded-full flex items-center justify-center transition text-slate-400 hover:text-white" title="ç”·è²">
                        <i class="fa-solid fa-person text-lg"></i>
                    </button>
                    <button onclick="setVoice('female')" id="btn-female" class="w-9 h-9 rounded-full flex items-center justify-center transition bg-green-500 text-white shadow-lg" title="å¥³è²">
                        <i class="fa-solid fa-person-dress text-lg"></i>
                    </button>
                </div>

                <button onclick="playPrev()" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-white hover:bg-white/10 transition" title="ä¸Šä¸€å¥">
                    <i class="fa-solid fa-backward-step text-lg"></i>
                </button>

                <button onclick="toggleSpeech()" class="w-14 h-14 md:w-16 md:h-16 flex items-center justify-center rounded-full bg-white text-black hover:scale-105 active:scale-95 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]" id="btn-play">
                    <i class="fa-solid fa-play text-2xl ml-1"></i>
                </button>

                <button onclick="playNext()" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-white hover:bg-white/10 transition" title="ä¸‹ä¸€å¥">
                    <i class="fa-solid fa-forward-step text-lg"></i>
                </button>

                <button onclick="toggleLoop()" id="btn-loop" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-400 hover:text-white hover:bg-white/10 transition" title="å–®å¥é‡è¦†">
                    <i class="fa-solid fa-repeat text-lg"></i>
                </button>

                <button onclick="stopSpeech()" class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-slate-600 text-slate-400 hover:border-red-500 hover:text-red-500 transition ml-2">
                    <i class="fa-solid fa-stop text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 border border-green-500/30 text-green-100 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 -translate-y-10 z-50 flex items-center gap-3 pointer-events-none text-sm font-bold backdrop-blur-md">
        <i class="fa-solid fa-circle-check text-green-400 text-lg"></i> <span id="toast-msg">Ready</span>
    </div>

    <script>
        const SHEET_ID = '1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk';
        const TARGET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbgkNiMflfeLQd3KN8F4yjjIr6G2flnCAy-nUPMiC7_xDfdg_0hJ2Qzbsr92u8htlPLFR8GwwQPK_g/pub?gid=0&single=true&output=csv';

        const COL_STAGE=0, COL_VERSION=2, COL_GRADE=3, COL_SEMESTER=4, COL_UNIT_NUM=6, COL_UNIT_NAME=7,
              COL_CONTENT=8, COL_CKIP=9, COL_VOCAB=18;

        let rawData=[], processedUnits=[], isSpeaking=false, isLooping=false, currentVoice='female', translationCache={}, synth=window.speechSynthesis;
        let activeVocabMap = {};
        let currentBlockIndex = 0;
        let currentUnitTitleZh = "";
        let currentUnitTitleEn = "";
        let currentLang = localStorage.getItem('appLang') || 'zh-TW';

        const i18n = {
            'zh-TW': { return: 'è¿”å›', page_title: 'AI School', nav: 'ç›®éŒ„', vocab_title: 'ç§‘å­¸è©å½™åº«', select_hint: 'ğŸ‘ˆ è«‹å…ˆä¸Šæ–¹é¸æ“‡å–®å…ƒ', vocab_empty: 'è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤', stage: 'éšæ®µ', grade: 'å¹´ç´š', version: 'ç‰ˆæœ¬', semester: 'å­¸æœŸ', unit: 'é¸æ“‡å–®å…ƒ' },
            'en': { return: 'Back', page_title: 'AI School', nav: 'MENU', vocab_title: 'Science Vocab', select_hint: 'ğŸ‘ˆ Select Unit Above', vocab_empty: 'Vocab will appear here', stage: 'Stage', grade: 'Grade', version: 'Version', semester: 'Semester', unit: 'Select Unit' },
            'ja': { return: 'æˆ»ã‚‹', page_title: 'AI School', nav: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', vocab_title: 'ç§‘å­¦ç”¨èªé›†', select_hint: 'ğŸ‘ˆ ä¸Šã‹ã‚‰å˜å…ƒã‚’é¸æŠ', vocab_empty: 'ã“ã“ã«ç”¨èªãŒè¡¨ç¤ºã•ã‚Œã¾ã™', stage: 'æ®µéš', grade: 'å­¦å¹´', version: 'ç‰ˆ', semester: 'å­¦æœŸ', unit: 'å˜å…ƒã‚’é¸æŠ' },
            'zh-CN': { return: 'è¿”å›', page_title: 'AI School', nav: 'ç›®å½•', vocab_title: 'ç§‘å­¦è¯æ±‡åº“', select_hint: 'ğŸ‘ˆ è¯·å…ˆä¸Šæ–¹é€‰æ‹©å•å…ƒ', vocab_empty: 'è¯æ±‡å°†æ˜¾ç¤ºäºæ­¤', stage: 'é˜¶æ®µ', grade: 'å¹´çº§', version: 'ç‰ˆæœ¬', semester: 'å­¦æœŸ', unit: 'é€‰æ‹©å•å…ƒ' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            fetchData();
            if(synth) synth.onvoiceschanged = () => synth.getVoices();
            setVoice('female'); 

            document.addEventListener('touchstart', () => {
                try{ if(!synth)return; synth.cancel(); const u=new SpeechSynthesisUtterance(" "); u.volume=0; synth.speak(u); }catch(e){}
            }, { once: true, passive: true });
        });

        function initLanguage() {
            const sel = document.getElementById('sel-lang');
            if(sel) sel.value = currentLang;
            applyLanguage(currentLang);
        }

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('appLang', lang); 
            applyLanguage(lang);
            const ids=['stage','grade','version','semester','unit'];
            ids.forEach(id => {
               const el = document.getElementById(`sel-${id}`);
               if(el && el.disabled) {
                   const key = id; 
                   const label = i18n[currentLang][key] || '...';
                   el.options[0].text = label;
               }
            });
            if(processedUnits.length > 0) {
                 filterUnits('stage');
            }
        }

        function applyLanguage(lang) {
            const texts = i18n[lang] || i18n['zh-TW'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(texts[key]) {
                    el.innerText = texts[key];
                }
            });
        }

        function goBack() { window.location.href = 'student_science.html'; }

        function fetchData() {
            Papa.parse(TARGET_URL, {
                download: true, header: false,
                skipEmptyLines: true, 
                complete: res => { processData(res.data); document.getElementById('loader-overlay').style.display='none'; showToast("æº–å‚™å®Œæˆï¼Œé–‹å§‹æ¢ç´¢å§ï¼"); },
                error: () => document.getElementById('loader-overlay').innerHTML='<div class="text-red-500">é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ•´</div>'
            });
        }

        const norm = (s) => (s ?? '').toString().replace(/[\uFEFF\u200B\u200C\u200D]/g,'').replace(/ã€€/g,' ').trim();

        function parseVocabPairs(vocabText){
          const map = {};
          if(!vocabText) return map;
          vocabText.split(/[,;ï¼Œï¼›\n]+/).forEach(token=>{
            const t = (token||"").toString().trim();
            if(!t) return;
            let zh = "", en = "";
            const tabParts = t.split(/\t+/);
            if(tabParts.length >= 2){ zh = tabParts[0].trim(); en = tabParts.slice(1).join(' ').trim(); } 
            else {
              const sepParts = t.split(/[:ï¼š=ï¼]/);
              if(sepParts.length >= 2){ zh = sepParts[0].trim(); en = sepParts.slice(1).join(':').trim(); } 
              else {
                const m = t.match(/^(.+?)[ï¼ˆ(]\s*([^)ï¼‰]+?)\s*[)ï¼‰]\s*$/);
                if(m){ zh = (m[1]||"").trim(); en = (m[2]||"").trim(); } else { zh = t.trim(); en = ""; }
              }
            }
            if(zh) map[zh] = en;
          });
          return map;
        }

        function processData(data) {
            rawData = data.slice(1);
            processedUnits = rawData.map((row, i) => {
                let content = (row[COL_CONTENT]||"").toString(),
                    ckip = (row[COL_CKIP]||"").toString(),
                    unitNum = norm(row[COL_UNIT_NUM]),
                    unitName = norm(row[COL_UNIT_NAME]);
                let title = (unitNum + (unitName ? " " + unitName : "")).trim() || `Unit ${i+1}`;
                return { id: i, stage: norm(row[COL_STAGE]), version: norm(row[COL_VERSION]), grade: norm(row[COL_GRADE]), semester: norm(row[COL_SEMESTER]), title, content, ckip, vocab: (row[COL_VOCAB]||"").toString() };
            }).filter(u => u.title);
            initFilters();
        }

        function initFilters() { populateSelect('sel-stage', [...new Set(processedUnits.map(u=>u.stage).filter(Boolean))], 'stage'); }

        function filterUnits(lvl) {
            const ids=['stage','grade','version','semester','unit'], sels=ids.map(id=>document.getElementById(`sel-${id}`));
            let filtered = processedUnits.filter(u => {
                if(sels[0].value && u.stage!==sels[0].value) return false;
                if(sels[1].value && !sels[1].disabled && u.grade!==sels[1].value) return false;
                if(sels[2].value && !sels[2].disabled && u.version!==sels[2].value) return false;
                if(sels[3].value && !sels[3].disabled && u.semester!==sels[3].value) return false;
                return true;
            });
            
            const update=(sel,p,key)=> populateSelect(sel.id, [...new Set(filtered.map(u=>u[p]).filter(Boolean))], key);
            if(lvl==='stage') { update(sels[1],'grade','grade'); resetSelects(sels.slice(2)); }
            else if(lvl==='grade') { update(sels[2],'version','version'); resetSelects(sels.slice(3)); }
            else if(lvl==='version') { update(sels[3],'semester','semester'); resetSelects(sels.slice(4)); }
            else if(lvl==='semester') {
                const label = i18n[currentLang]['unit'] || 'é¸æ“‡å–®å…ƒ';
                sels[4].innerHTML=`<option value="" disabled selected data-i18n="unit">${label}</option>`;
                filtered.forEach(u=>sels[4].add(new Option(u.title,u.id)));
                sels[4].disabled=false;
            }
        }

        function populateSelect(id,items,i18nKey){
            const s=document.getElementById(id);
            const label = i18n[currentLang][i18nKey] || i18n['zh-TW'][i18nKey] || 'è«‹é¸æ“‡';
            s.innerHTML=`<option value="" disabled selected>${label}</option>`;
            items.forEach(i=>s.add(new Option(i,i)));
            s.disabled=false;
        }
        function resetSelects(els){
            els.forEach(e=>{
                const key = e.id.replace('sel-','');
                const label = i18n[currentLang][key] || i18n['zh-TW'][key] || '...';
                e.innerHTML=`<option value="" disabled selected>${label}</option>`;
                e.disabled=true;
            });
        }

        function loadSelectedUnit(){ const u=processedUnits.find(i=>i.id==document.getElementById('sel-unit').value); if(u) renderArticle(u); }

        function renderVocabSidebar() {
          const container = document.getElementById('vocab-container');
          container.innerHTML = '';
          const keys = Object.keys(activeVocabMap || {});
          if(keys.length === 0) {
            const emptyText = i18n[currentLang]['vocab_empty'];
            container.innerHTML = `<div class="text-center opacity-30 text-sm mt-10 text-white">${emptyText}</div>`;
            return;
          }
          keys.forEach(zh => {
            const enVal = (activeVocabMap[zh] || "").toString().trim();
            const showEn = enVal ? enVal : "Loading...";
            const card = document.createElement('div');
            card.className = "vocab-item";
            card.innerHTML = `
              <div class="flex-1 pr-2">
                <div class="text-lg font-bold text-yellow-400 cursor-pointer mb-1" onclick="speakText('${zh.replace(/'/g,"\\'")}')">${escapeHtml(zh)}</div>
                <div class="text-sm en-term-label cursor-pointer" data-zh="${escapeHtml(zh)}" onclick="speakVocabEn('${zh.replace(/'/g,"\\'")}', this)">${escapeHtml(showEn)}</div>
              </div>
              <div class="flex items-center gap-1">
                <button onclick="event.stopPropagation(); speakText('${zh.replace(/'/g,"\\'")}')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white font-bold flex items-center justify-center text-xs">ä¸­</button>
                <button onclick="event.stopPropagation(); speakVocabEn('${zh.replace(/'/g,"\\'")}', this)" class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white font-bold flex items-center justify-center text-xs">EN</button>
              </div>`;
            container.appendChild(card);
            if(!enVal) translateVocabItem(zh, card.querySelector('.en-term-label'));
          });
        }

        async function speakVocabEn(zh, btn){
          const card = btn && btn.closest ? btn.closest('.vocab-item') : null;
          const label = card ? card.querySelector('.en-term-label') : null;
          let en = (activeVocabMap[zh] || "").toString().trim();
          if(!en){ await translateVocabItem(zh, label); en = (activeVocabMap[zh] || "").toString().trim(); }
          speakText(en || zh);
        }

        async function translateToEn(text) {
          const src = (text || "").toString().trim();
          if(!src) return "";
          const cacheKey = "__title__" + src;
          if(translationCache[cacheKey]) return translationCache[cacheKey];
          try {
              const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`);
              const json = await res.json();
              let out = ""; (json[0] || []).forEach(x => out += (x[0] || ""));
              translationCache[cacheKey] = out;
              return out;
          } catch(e) { return src; }
        }

        function ensureTitleTranslated() {
          if(!currentUnitTitleZh) return;
          const existing = document.getElementById('title-en');
          if(existing && existing.innerText && existing.innerText !== 'Translating...') return;
          translateToEn(currentUnitTitleZh).then(en => {
            currentUnitTitleEn = en || "";
            const enEl = document.getElementById('title-en');
            if(enEl) enEl.innerText = currentUnitTitleEn || "";
          }).catch(() => {});
        }

        function rehighlightEnglishBlocks(){
          const ens = document.querySelectorAll('.en-text');
          ens.forEach(el => {
            const src = decodeURIComponent(el.getAttribute('data-source') || "");
            const cached = translationCache[src];
            if(cached){ el.innerHTML = makeClickable(highlightEnglishVocabInText(cached)); }
          });
        }

        async function renderArticle(unit) {
            currentUnitTitleZh = unit.title;
            currentUnitTitleEn = "";
            document.getElementById('article-title').innerHTML = `
              <div id="title-zh">${escapeHtml(currentUnitTitleZh)}</div>
              <div id="title-en" class="text-xl md:text-2xl font-bold text-green-400 mt-2">Translating...</div>
            `;
            document.getElementById('status-bar').innerText = unit.title;
            document.getElementById('nav-title').innerText = unit.title;
            activeVocabMap = parseVocabPairs(unit.vocab);
            renderVocabSidebar();
            
            const contentDiv = document.getElementById('article-content');
            contentDiv.innerHTML='';
            document.getElementById('unit-list').innerHTML='';

            let lines = (unit.content || "").split('\n').map(x=>x.trim()).filter(Boolean);
            if(lines.length===0 && unit.ckip){
                lines = unit.ckip.split('\n').map(x=>x.replace(/ã€€/g,' ').replace(/\([^)]*\)/g,'').trim()).filter(Boolean);
            }

            const unitCkipSet = unit.ckip ? getCkipTokenSet(unit.ckip) : null;
            const unitCkipTokens = unit.ckip ? getCkipTokenArray(unit.ckip) : [];
            const unitMergeSet = buildCkipMergeSet(unitCkipTokens, getMaxKeyLen(activeVocabMap));

            for(let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                if(!line) continue;
                if((line.length<40 && !/[ã€‚ï¼ï¼Ÿ.!?]$/.test(line)) || line.includes("æ´»å‹•")) {
                    const anchorId = `sec-${i}`;
                    const navItem = document.createElement('div');
                    navItem.className='nav-item';
                    navItem.innerText = line;
                    navItem.onclick=()=>{ document.getElementById(anchorId).scrollIntoView({behavior:'smooth',block:'center'}); };
                    document.getElementById('unit-list').appendChild(navItem);
                    // [æ’ç‰ˆ] æ›´æ–° section-header çµæ§‹ï¼ŒåŠ å…¥ .section-title-text ä»¥ä¾¿ JS é¸æ“‡
                    contentDiv.innerHTML += `
                        <h2 id="${anchorId}" class="section-header">
                            <div class="flex flex-col w-full">
                                <span class="zh-text section-title-text" onclick="speakText(this.innerText)">${escapeHtml(line)}</span>
                                <span class="en-text hidden mt-1 font-bold" 
                                      data-source="${encodeURIComponent(line)}"
                                      onclick="speakText(this.innerText)"></span>
                            </div>
                        </h2>`;
                } else {
                    let processed = processXRayWithCKIP(line, activeVocabMap, unitCkipSet, unitMergeSet);
                    contentDiv.innerHTML += `
                        <div class="content-block">
                            <p class="zh-text" onclick="speakText(this.innerText)">${processed}</p>
                            <p class="en-text hidden"
                               onclick="speakText(this.innerText)"
                               data-source="${encodeURIComponent(line)}"></p>
                        </div>`;
                }
            }
            setMode('dual');
        }

        function getCkipTokenSet(ckipLine){
          const raw = (ckipLine || "").toString().trim();
          if(!raw) return new Set();
          return new Set(raw.replace(/ã€€/g, " ").split(/\s+/).filter(Boolean).map(tok => tok.replace(/[\(ï¼ˆ].*$/, "")).filter(Boolean));
        }
        function getCkipTokenArray(ckipText) {
          const raw = (ckipText || "").toString().replace(/ã€€/g, " ").trim();
          if (!raw) return [];
          return raw.split(/\s+/).filter(Boolean).map(tok => tok.replace(/[\(ï¼ˆ].*$/, "")).filter(Boolean);
        }
        function getMaxKeyLen(vocabMap) {
          const keys = Object.keys(vocabMap || {});
          if (!keys.length) return 1;
          let m = 1; for (const k of keys) m = Math.max(m, (k || "").length); return m;
        }
        function buildCkipMergeSet(tokens, maxLen) {
          const set = new Set();
          if (!tokens || !tokens.length) return set;
          const L = Math.max(2, maxLen || 2);
          for (let i = 0; i < tokens.length; i++) {
            let acc = "";
            for (let j = i; j < tokens.length; j++) {
              acc += tokens[j];
              if (acc.length > L) break;
              if (acc.length >= 2) set.add(acc);
            }
          }
          return set;
        }
        function shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet) {
          if (!term) return false;
          if (!ckipTokenSet || ckipTokenSet.size === 0) return true;
          if (term.length === 1) return ckipTokenSet.has(term);
          if (ckipTokenSet.has(term)) return true;
          if (ckipMergeSet && ckipMergeSet.has(term)) return true;
          return false;
        }
        function processXRayWithCKIP(text, map, ckipTokenSet, ckipMergeSet) {
          const src = (text || "").toString().replace(/ã€€/g, "");
          const keys = Object.keys(map || {}).filter(Boolean).sort((a, b) => b.length - a.length);
          if (!keys.length) return escapeHtml(src);
          const spans = [];
          const overlaps = (s, e) => spans.some(sp => !(e <= sp.start || s >= sp.end));
          for (const term of keys) {
            let from = 0;
            while (true) {
              const idx = src.indexOf(term, from);
              if (idx === -1) break;
              const start = idx, end = idx + term.length;
              from = idx + term.length;
              if (overlaps(start, end)) continue;
              if (!shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet)) continue;
              spans.push({ start, end, term });
            }
          }
          if (!spans.length) return escapeHtml(src);
          spans.sort((a, b) => a.start - b.start);
          let html = "", last = 0;
          for (const sp of spans) {
            html += escapeHtml(src.slice(last, sp.start));
            const zh = sp.term;
            const js = ((map[zh] || zh) + "").toString().replace(/'/g, "\\'");
            const title = escapeHtml(((map[zh] || "") + "").toString());
            html += `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${title}">${escapeHtml(zh)}</span>`;
            last = sp.end;
          }
          html += escapeHtml(src.slice(last));
          return html;
        }

        async function translateVocabItem(zh, el) {
          try {
            const q = encodeURIComponent(zh);
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${q}`);
            const json = await res.json();
            const en = (json && json[0] && json[0][0] && json[0][0][0]) ? json[0][0][0] : "";
            if(el) el.innerText = en || "â€”";
            activeVocabMap[zh] = en || "";
            rehighlightEnglishBlocks();
            return en || "";
          } catch(e) {
            if(el) el.innerText = "â€”";
            activeVocabMap[zh] = "";
            rehighlightEnglishBlocks();
            return "";
          }
        }

        async function translateVisibleBlocks() {
            const ens = document.querySelectorAll('.en-text'), load=document.getElementById('trans-loading');
            let need=false; ens.forEach(e=>{if(!e.innerText)need=true}); if(!need)return;
            load.classList.remove('hidden');
            for(let el of ens) {
                if(el.innerText) continue;
                let src = decodeURIComponent(el.getAttribute('data-source') || "").replace(/ã€€/g,'');
                if(translationCache[src]) { el.innerHTML=makeClickable(highlightEnglishVocabInText(translationCache[src])); continue; }
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`);
                    const json = await res.json();
                    let txt=""; json[0].forEach(i=>txt+=i[0]);
                    el.innerHTML = makeClickable(highlightEnglishVocabInText(txt));
                    translationCache[src]=txt;
                } catch(e){ el.innerText="Error"; }
            }
            load.classList.add('hidden');
            rehighlightEnglishBlocks();
        }

        function makeClickable(html) { return `<span class="cursor-pointer hover:text-green-300 transition">${html}</span>`; }
        function escapeHtml(s){ return (s||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
        function highlightEnglishVocabInText(txt){
          let safe = escapeHtml(txt);
          const terms = Object.values(activeVocabMap||{}).map(v => (v||"").trim()).filter(v => v && v !== "Loading..." && /[a-zA-Z]/.test(v));
          const uniq = [...new Set(terms)].sort((a,b)=>b.length-a.length);
          if(!uniq.length) return safe;
          for(const term of uniq){
            const escaped = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
            const isSingleWord = /^[A-Za-z]+$/.test(term);
            const re = isSingleWord ? new RegExp(`\\b(${escaped})\\b`,'gi') : new RegExp(`(${escaped})`,'gi');
            safe = safe.replace(re, (m) => {
              const js = m.replace(/'/g,"\\'");
              return `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${m}">${m}</span>`;
            });
          }
          return safe;
        }

        // ====================== TTS å„ªåŒ–ç‰ˆ (è‡ªç„¶åº¦+æ¨™é¡Œæœ—è®€) ======================
        
        function isIOSDevice(){
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        function isMostlyEnglish(txt){
            const t = (txt || "").toString();
            const latin = (t.match(/[A-Za-z]/g) || []).length;
            const cjk   = (t.match(/[\u4E00-\u9FFF]/g) || []).length;
            if (cjk === 0) return latin > 0;
            return latin > cjk * 2;
        }

        // [æ ¸å¿ƒä¿®æ”¹] èªéŸ³é¸æ“‡æ¬Šé‡å„ªåŒ– - é‡å°ä¸­æ–‡è‡ªç„¶åº¦èª¿æ•´
        function pickBestVoice(isEng, gender) {
            if (!window.speechSynthesis) return null;
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return null;

            const targetLang = isEng ? ['en-us', 'en-gb', 'en', 'en-au'] : ['zh-tw', 'zh-hk', 'zh-cn', 'zh'];

            const getScore = (voice) => {
                let score = 0;
                const name = voice.name.toLowerCase();
                const uri = (voice.voiceURI || "").toLowerCase();
                const lang = voice.lang.toLowerCase();

                // 1. èªç³»åŒ¹é…
                if (targetLang.some(t => lang === t || lang.replace('_', '-').startsWith(t))) { 
                    score += 1000; 
                    if (!isEng && (lang === 'zh-tw' || lang.includes('taiwan'))) score += 500;
                    if (isEng && (lang === 'en-us')) score += 200;
                } else { 
                    return -100000;
                }
                
                // 2. éŸ³è³ªå„ªåŒ–é—œéµå­— (å¢åŠ  Online/Neural æ¬Šé‡)
                if (name.includes('enhanced') || uri.includes('enhanced')) score += 5000; 
                if (name.includes('premium') || uri.includes('premium')) score += 5000;
                if (name.includes('natural') || name.includes('online') || name.includes('cloud') || name.includes('neural')) score += 6000; // Neural è²éŸ³é€šå¸¸æœ€å¥½
                if (name.includes('siri')) score += 4000;
                
                if (name.includes('compact') || uri.includes('compact')) score -= 8000; 

                // 3. æ€§åˆ¥èˆ‡ç‰¹å®šå„ªè³ªèªéŸ³ (å¾®è»Ÿ/Google é«˜å“è³ªèªéŸ³æ¸…å–®)
                if (gender === 'female') {
                    if (isEng) {
                        if (name.includes('samantha')) score += 20000; 
                        else if (name.includes('ava')) score += 15000;       
                        else if (name.includes('siri') && !name.includes('male')) score += 10000;
                        else if (name.includes('google') && name.includes('female')) score += 10000;
                        else if (name.includes('zira') || name.includes('susan')) score += 5000;
                        if (name.includes('male') || name.includes('man')) score -= 10000;
                    } 
                    else { // ä¸­æ–‡å¥³è²
                        if (name.includes('meijia')) score += 20000;    
                        else if (name.includes('hsiaoyu')) score += 18000; // MS Edge Neural (TW)
                        else if (name.includes('xiaoxiao')) score += 18000; // MS Edge Neural (CN)
                        else if (name.includes('tingting')) score += 15000; 
                        else if (name.includes('sinji')) score += 5000; 
                        else if (name.includes('google') && (lang === 'zh-tw' || lang === 'zh-cn')) score += 10000;
                        else if (name.includes('hanhan') || name.includes('yating')) score += 10000;
                        if (name.includes('male') || name.includes('man')) score -= 10000;
                    }
                } else {
                    if (isEng) {
                        if (name.includes('daniel')) score += 20000; 
                        else if (name.includes('alex')) score += 15000;
                        else if (name.includes('nathan')) score += 15000;
                        else if (name.includes('siri') && name.includes('male')) score += 10000;
                        if (name.includes('female') || name.includes('woman')) score -= 10000;
                    } 
                    else { // ä¸­æ–‡ç”·è²
                        if (name.includes('yunxi')) score += 18000; // MS Edge Neural (Male)
                        else if (name.includes('siri') && name.includes('male')) score += 15000;
                        else if (name.includes('li-mu')) score += 10000; 
                        else if (name.includes('zhiwei')) score += 15000;
                        else if (name.includes('google') && name.includes('male')) score += 10000;
                        if (name.includes('female') || name.includes('woman') || name.includes('meijia')) score -= 10000;
                    }
                }
                return score;
            };

            const sorted = voices.map(v => ({ v, score: getScore(v) })).filter(item => item.score > -5000).sort((a, b) => b.score - a.score);
            return sorted.length > 0 ? sorted[0].v : voices[0];
        }

        function speakText(txt, onComplete) {
            if (!synth) return;
            isSpeaking = true;
            if (synth.paused) synth.resume();
            
            const btn = document.getElementById('btn-play');
            if (btn) btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
            synth.cancel();

            const cleanTxt = (txt || "").toString().replace(/<[^>]*>/g, "").replace(/\u00A0/g, " ").trim();
            if (!cleanTxt) {
                if (onComplete) { setTimeout(() => { if (isSpeaking) onComplete(); }, 10); } 
                else { isSpeaking = false; if (btn) btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>'; }
                return;
            }

            const ios = isIOSDevice();
            const isEng = isMostlyEnglish(cleanTxt);
            const lang = isEng ? "en-US" : "zh-TW"; 
            
            // iOS åˆ†æ®µé‚è¼¯
            const chunks = (ios && cleanTxt.length > (isEng ? 300 : 100)) ? splitTextForSpeak(cleanTxt, isEng) : [cleanTxt];
            const uiRate = parseFloat(document.getElementById('play-rate')?.value || "1.0");
            let idx = 0;

            const speakNext = () => {
                if (!isSpeaking) return;
                if (idx >= chunks.length) {
                    if (onComplete) { onComplete(); } 
                    else { isSpeaking = false; if (btn) btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>'; }
                    return;
                }
                const part = chunks[idx++];
                const u = new SpeechSynthesisUtterance(part);
                u.lang = lang;
                
                let voice = pickBestVoice(isEng, currentVoice);
                if (voice) u.voice = voice;

                if (ios) { 
                    u.pitch = 1.0; 
                    u.rate = isEng ? uiRate : (uiRate * 0.95); 
                } else { 
                    u.rate = uiRate; 
                    // [èª¿æ•´] é‡å°é iOS ä¸­æ–‡ç”·è²ï¼Œç¨å¾®é™ä½ Pitch é¿å…æ©Ÿæ¢°éŸ³
                    if (!isEng && currentVoice === 'male') {
                         u.pitch = 0.95; 
                         u.rate = uiRate * 0.9; // ä¸­æ–‡ç¨å¾®æ…¢ä¸€é»æ¯”è¼ƒè‡ªç„¶
                    } else {
                         u.pitch = (currentVoice === 'male') ? 0.9 : 1.1; 
                    }
                }

                u.onend = speakNext;
                u.onerror = (e) => { if (isSpeaking) speakNext(); };
                synth.speak(u);
            };
            
            if(synth.getVoices().length === 0 && synth.onvoiceschanged) {
                synth.onvoiceschanged();
                setTimeout(speakNext, 100);
            } else {
                speakNext();
            }
        }
// [æ–°å¢åŠŸèƒ½] ä¸Šä¸€å¥
        function playPrev() {
            const blocks = document.querySelectorAll('.content-block, .section-header');
            if (currentBlockIndex > 0) {
                currentBlockIndex--;
                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡å•Ÿæ’­æ”¾ï¼›å¦‚æœæ²’åœ¨æ’­æ”¾ï¼Œåªç§»å‹•ç´¢å¼• (ä¹Ÿå¯ä»¥é¸æ“‡ç›´æ¥æ’­æ”¾)
                if (isSpeaking) {
                    stopSpeech(); // å…ˆåœæ­¢ç•¶å‰è²éŸ³
                    isSpeaking = true; // ä¿æŒæ’­æ”¾ç‹€æ…‹
                    document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
                    setTimeout(playSequence, 100);
                } else {
                    // å¦‚æœåŸæœ¬æ˜¯æš«åœï¼Œåªç§»å‹•ç•«é¢ç„¦é»
                    clearHighlights();
                    const block = blocks[currentBlockIndex];
                    if(block) block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // [æ–°å¢åŠŸèƒ½] ä¸‹ä¸€å¥
        function playNext() {
            const blocks = document.querySelectorAll('.content-block, .section-header');
            if (currentBlockIndex < blocks.length - 1) {
                currentBlockIndex++;
                if (isSpeaking) {
                    stopSpeech();
                    isSpeaking = true;
                    document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
                    setTimeout(playSequence, 100);
                } else {
                    clearHighlights();
                    const block = blocks[currentBlockIndex];
                    if(block) block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // [æ–°å¢åŠŸèƒ½] åˆ‡æ›é‡è¦†æ’­æ”¾
        function toggleLoop() {
            isLooping = !isLooping;
            const btn = document.getElementById('btn-loop');
            if(isLooping) {
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-green-400', 'bg-white/10'); // äº®ç‡ˆæ¨£å¼
                showToast("é–‹å•Ÿå–®å¥é‡è¦†");
            } else {
                btn.classList.add('text-slate-400');
                btn.classList.remove('text-green-400', 'bg-white/10');
                showToast("é—œé–‰å–®å¥é‡è¦†");
            }
        }
        function splitTextForSpeak(text, isEng) {
            const regex = isEng ? /([.?!;]+)/ : /([ã€‚ï¼ï¼Ÿï¼›]+)/;
            return text.split(regex).reduce((acc, curr, i) => {
                if (i % 2 === 0) acc.push(curr);
                else acc[acc.length - 1] += curr;
                return acc;
            }, []).filter(s => s.trim().length > 0);
        }

        function playSequence() {
            if (!isSpeaking) return;
            // [æ ¸å¿ƒä¿®æ­£] é¸æ“‡å™¨åŠ å…¥ .section-headerï¼Œè®“æ¨™é¡Œä¹Ÿè¢«é¸ä¸­
            const blocks = document.querySelectorAll('.content-block, .section-header');
            if (currentBlockIndex >= blocks.length) { stopSpeech(); return; }

            clearHighlights();
            const block = blocks[currentBlockIndex];
            if (block) {
                block.classList.add('reading-active');
                block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const enEl = block.querySelector('.en-text');
            const zhEl = block.querySelector('.zh-text');
            
            const enVisible = enEl && !enEl.classList.contains('hidden');
            const zhVisible = zhEl && !zhEl.classList.contains('hidden');
            
            let texts = [];
            // [æ ¸å¿ƒä¿®æ­£] é›™èªæ¨¡å¼ä¸‹ï¼Œå…ˆ Push ä¸­æ–‡ï¼Œå† Push è‹±æ–‡
            if (zhVisible && zhEl.innerText) texts.push(zhEl.innerText);
            if (enVisible && enEl.innerText) texts.push(enEl.innerText);

            if (texts.length > 0) {
                let tIdx = 0;
                const playNextPart = () => {
                    if(!isSpeaking) return;
                    if(tIdx >= texts.length) {
                        currentBlockIndex++;
                        playSequence();
                        return;
                    }
                    speakText(texts[tIdx], () => {
                        tIdx++;
                        setTimeout(playNextPart, 300); 
                    });
                };
                playNextPart();
            } else {
                currentBlockIndex++;
                playSequence();
            }
        }

        function toggleSpeech() {
            const btn = document.getElementById('btn-play');
            if (isSpeaking) {
                isSpeaking = false;
                if (synth) synth.cancel();
                if (btn) btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
            } else {
                isSpeaking = true;
                if (btn) btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                if (synth && synth.paused) synth.resume();
                
                if(synth.getVoices().length === 0 && synth.onvoiceschanged) synth.onvoiceschanged();

                // [ä¿®æ­£] é¸å–ç¯„åœæ“´å¤§è‡³æ¨™é¡Œ
                const blocks = document.querySelectorAll('.content-block, .section-header');
                if (currentBlockIndex >= blocks.length) currentBlockIndex = 0;
                setTimeout(() => { if (isSpeaking) playSequence(); }, 10);
            }
        }

        function stopSpeech() {
            isSpeaking = false;
            if (synth) synth.cancel();
            currentBlockIndex = 0;
            clearHighlights();
            const btn = document.getElementById('btn-play');
            if (btn) btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
        }

        function clearHighlights() {
            document.querySelectorAll('.reading-active').forEach(el => { el.classList.remove('reading-active'); });
        }

        function setVoice(g) {
            currentVoice = g;
            document.getElementById('btn-male').className = g==='male' ? 'w-9 h-9 rounded-full flex items-center justify-center transition bg-green-500 text-white shadow-lg' : 'w-9 h-9 rounded-full flex items-center justify-center transition text-slate-400 hover:text-white';
            document.getElementById('btn-female').className = g==='female' ? 'w-9 h-9 rounded-full flex items-center justify-center transition bg-green-500 text-white shadow-lg' : 'w-9 h-9 rounded-full flex items-center justify-center transition text-slate-400 hover:text-white';
            stopSpeech();
        }

        function setMode(m) {
            ['en','dual','zh'].forEach(x=>document.getElementById(`btn-${x}`).className=x===m?"px-4 py-1.5 text-xs font-bold rounded-full bg-green-500 text-white shadow-lg":"px-4 py-1.5 text-xs font-bold rounded-full text-slate-400 hover:text-white transition");
            if(m!=='zh') translateVisibleBlocks();
            const en=document.querySelectorAll('.en-text'), zh=document.querySelectorAll('.zh-text');
            if(m==='en'){en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.add('hidden'));}
            else if(m==='zh'){en.forEach(e=>e.classList.add('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
            else{en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
            const tZh=document.getElementById('title-zh');
            const tEn=document.getElementById('title-en');
            if(tZh && tEn){
              if(m==='en'){ tZh.classList.add('hidden'); tEn.classList.remove('hidden'); }
              else if(m==='zh'){ tZh.classList.remove('hidden'); tEn.classList.add('hidden'); }
              else { tZh.classList.remove('hidden'); tEn.classList.remove('hidden'); }
            }
            if(m !== 'zh') ensureTitleTranslated();
        }

        function showToast(m) { const T=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; T.classList.remove('opacity-0','-translate-y-10'); setTimeout(()=>T.classList.add('opacity-0','-translate-y-10'),2500); }
    </script>
</body>
</html>
