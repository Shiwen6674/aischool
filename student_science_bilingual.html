<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI School | 科學雙語閱讀</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        tech: {
                            bg: '#020617',
                            panel: 'rgba(15, 23, 42, 0.95)', 
                            border: 'rgba(45, 212, 191, 0.3)',
                            accent: '#2dd4bf', 
                            highlight: '#facc15'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #ccfbf1; overflow: hidden; }
        .glass-panel { background: rgba(10, 25, 47, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(45, 212, 191, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-track { background: rgba(2, 6, 23, 0.5); }
        .scroll-area::-webkit-scrollbar-thumb { background: #115e59; border-radius: 3px; }
        
        .nav-item { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; padding: 0.6rem 0.8rem; margin-bottom: 0.25rem; font-size: 0.9rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item:hover { background: rgba(45, 212, 191, 0.05); color: #ccfbf1; }
        .nav-item.active { background: linear-gradient(90deg, rgba(45, 212, 191, 0.1), transparent); border-left-color: #2dd4bf; color: #2dd4bf; font-weight: 700; }

        /* 黃色標示 */
        .sci-term { color: #facc15; font-weight: 700; border-bottom: 1px dashed rgba(250, 204, 21, 0.6); cursor: pointer; transition: all 0.2s; padding: 0 2px; }
        .sci-term:hover { background-color: rgba(250, 204, 21, 0.2); color: #fff; text-shadow: 0 0 10px #facc15; border-radius: 4px; }

        .custom-select { background-color: rgba(15, 23, 42, 0.8); border: 1px solid rgba(45, 212, 191, 0.3); color: #ccfbf1; appearance: none; padding-right: 1.5rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%232dd4bf' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.3rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; }
        
        .content-block { margin-bottom: 1rem; padding: 1rem; border-radius: 0.75rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s ease; }
        .en-text { font-size: 1.1rem; color: #e2e8f0; line-height: 1.6; margin-bottom: 0.5rem; font-weight: 500; font-family: 'Inter', sans-serif; cursor: pointer; transition: color 0.2s; }
        .en-text:hover { color: #2dd4bf; }
        .zh-text { font-size: 1rem; color: #94a3b8; line-height: 1.6; padding-left: 8px; border-left: 3px solid rgba(45, 212, 191, 0.3); cursor: pointer; }
        .zh-text:hover { color: #cbd5e1; }
        
        .section-header { font-size: 1.4rem; font-weight: 800; color: #fff; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(45, 212, 191, 0.3); display: flex; align-items: center; gap: 0.5rem; }
        .section-header::before { content: ''; display: block; width: 5px; height: 24px; background: #2dd4bf; border-radius: 2px; }
        
        /* Vocab List Style */
        .vocab-item { background: rgba(15, 23, 42, 0.6); border-bottom: 1px solid rgba(45, 212, 191, 0.1); padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .vocab-item:hover { background: rgba(250, 204, 21, 0.05); }

        #canvas-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .loader { border: 2px solid rgba(45, 212, 191, 0.1); border-top: 2px solid #2dd4bf; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-teal-500/30 selection:text-white">

    <div id="canvas-container"><canvas id="molecule-canvas"></canvas></div>

    <div id="loader-overlay" class="absolute inset-0 bg-[#020617] z-50 flex flex-col items-center justify-center">
        <i class="fa-solid fa-satellite-dish text-5xl text-teal-400 animate-pulse mb-4"></i>
        <div class="text-teal-500 tracking-widest mt-2 font-bold">資料庫連線中...</div>
    </div>

    <nav class="glass-panel sticky top-0 z-40 h-auto md:h-16 flex flex-col md:flex-row items-center shrink-0 border-b-0 shadow-lg">
        <div class="w-full px-4 md:px-6 py-2 flex justify-between items-center border-b border-teal-500/20 md:border-b-0">
            <div class="flex items-center gap-4">
                <button onclick="goBack()" class="flex items-center gap-2 text-teal-400 hover:text-white transition group">
                    <div class="p-1 rounded border border-teal-500/30 group-hover:bg-teal-500/20">
                        <i class="fa-solid fa-chevron-left"></i>
                    </div>
                    <span class="text-sm font-bold tracking-wider hidden md:inline" data-i18n="return">返回</span>
                </button>
                <div class="flex items-center gap-2 cursor-default">
                    <div class="w-8 h-8 rounded-lg bg-teal-500/10 border border-teal-500/30 flex items-center justify-center text-teal-400">
                        <i class="fa-solid fa-book-journal-whills"></i>
                    </div>
                    <span class="text-lg font-bold text-white tracking-wide" data-i18n="page_title">科學雙語閱讀</span>
                </div>
            </div>

            <!-- (已依需求 #3 移走：人聲/播停/語速控制，避免頂端擁擠) -->

            <div class="flex items-center gap-3">
                <div class="flex bg-slate-900/80 rounded-lg p-1 border border-teal-500/30">
                    <button onclick="setMode('en')" class="mode-btn px-2 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-en">EN</button>
                    <button onclick="setMode('dual')" class="mode-btn px-2 py-1 text-xs font-bold rounded bg-teal-600 text-white shadow-[0_0_10px_rgba(45,212,191,0.4)]" id="btn-dual">DUAL</button>
                    <button onclick="setMode('zh')" class="mode-btn px-2 py-1 text-xs font-bold rounded text-teal-500 hover:text-white transition" id="btn-zh">繁中</button>
                </div>
                
                <select id="ui-lang" class="bg-slate-900/80 border border-teal-500/30 text-teal-100 rounded-lg px-2 py-1 text-xs outline-none cursor-pointer hover:bg-slate-800" onchange="changeLanguage()">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="zh-CN">简体中文</option>
                </select>
            </div>
        </div>

        <div class="w-full px-4 md:px-6 py-2 bg-slate-900/80 flex flex-wrap gap-2 items-center text-sm border-t border-teal-500/20 md:border-t-0 md:bg-transparent justify-end">
            <span class="text-xs font-bold text-teal-500 mr-2"><i class="fa-solid fa-filter"></i> 篩選:</span>
            <select id="sel-stage" class="custom-select px-2 py-1 rounded w-24 text-xs font-bold" onchange="filterUnits('stage')"><option value="" disabled selected data-i18n="stage">學習階段</option></select>
            <select id="sel-grade" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" onchange="filterUnits('grade')" disabled><option value="" disabled selected data-i18n="grade">年級</option></select>
            <select id="sel-version" class="custom-select px-2 py-1 rounded w-24 text-xs font-bold" onchange="filterUnits('version')" disabled><option value="" disabled selected data-i18n="version">版本</option></select>
            <select id="sel-semester" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" onchange="filterUnits('semester')" disabled><option value="" disabled selected data-i18n="semester">學期</option></select>
            <select id="sel-unit" class="custom-select px-2 py-1 rounded flex-grow md:flex-grow-0 md:w-64 text-xs font-bold" onchange="loadSelectedUnit()" disabled><option value="" disabled selected data-i18n="unit">選擇單元</option></select>
        </div>
    </nav>

    <div class="flex-grow flex overflow-hidden p-4 gap-4 relative z-10">
        
        <aside class="w-64 glass-panel rounded-2xl flex flex-col overflow-hidden hidden md:flex">
            <div class="p-4 border-b border-teal-500/20 bg-slate-900/40">
                <h3 class="text-xs font-bold text-teal-500 tracking-widest mb-1" data-i18n="nav">目錄導航</h3>
                <div class="text-white font-bold text-sm truncate" id="nav-title">請選擇單元</div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-2 space-y-1" id="unit-list">
                <div class="text-center text-slate-500 text-xs mt-10 p-4" data-i18n="select_hint">請先從上方選擇單元。</div>
            </div>
        </aside>

        <section class="flex-grow glass-panel rounded-2xl flex flex-col relative overflow-hidden">
            <!-- status bar：依需求 #3 把控制移到中間內容上方 -->
            <div class="h-10 border-b border-teal-500/20 bg-slate-900/40 flex items-center justify-between px-6 gap-3">
                <div class="flex items-center gap-2 min-w-0">
                    <i class="fa-solid fa-file-lines text-teal-400"></i>
                    <span class="text-xs font-bold text-teal-200 truncate" id="status-bar">READY</span>
                    <span id="trans-loading" class="hidden text-xs text-teal-400 flex items-center gap-1 ml-2"><div class="loader"></div> Translating...</span>
                </div>

                <div class="flex items-center gap-3 shrink-0 bg-slate-900/50 rounded-full px-3 py-1 border border-teal-500/20">
                    <select id="play-rate" class="custom-select px-2 py-1 rounded w-20 text-xs font-bold" title="語速">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                    </select>

                    <div class="h-4 w-px bg-teal-500/30"></div>

                    <div class="flex items-center gap-1">
                        <button onclick="setVoice('male')" id="btn-male" class="text-teal-400 p-1 hover:text-white" title="男聲"><i class="fa-solid fa-user-tie"></i></button>
                        <button onclick="setVoice('female')" id="btn-female" class="text-slate-500 p-1 hover:text-white" title="女聲"><i class="fa-solid fa-user-graduate"></i></button>
                    </div>

                    <div class="h-4 w-px bg-teal-500/30"></div>

                    <div class="flex items-center gap-2">
                        <button onclick="toggleSpeech()" class="w-8 h-8 flex items-center justify-center rounded-full bg-teal-600 hover:bg-teal-500 text-white transition shadow-lg" id="btn-play" title="播放/暫停">
                            <i class="fa-solid fa-play text-xs"></i>
                        </button>
                        <button onclick="stopSpeech()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-700 hover:bg-red-500 text-white transition shadow-lg" title="停止">
                            <i class="fa-solid fa-stop text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto p-6 md:p-8 relative" id="reading-container">
                <article class="max-w-4xl mx-auto transition-opacity duration-500" id="article-body">
                    <h1 class="text-2xl md:text-3xl font-black text-white mb-6 font-heading tracking-tight text-center" id="article-title">
                        <span class="text-slate-500 opacity-50" data-i18n="select_hint">請先從上方選擇單元</span>
                    </h1>
                    <div id="article-content" class="space-y-4"></div>
                </article>
            </div>
        </section>

        <aside class="w-80 glass-panel rounded-2xl flex flex-col overflow-hidden hidden lg:flex border-l border-teal-500/30">
            <div class="p-4 border-b border-teal-500/20 bg-gradient-to-r from-slate-900/80 to-teal-900/20">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                    <h3 class="text-xs font-bold text-teal-400 tracking-widest" data-i18n="vocab_title">科學詞彙庫</h3>
                </div>
            </div>

            <div class="flex-grow scroll-area overflow-y-auto" id="vocab-container">
                <div class="text-center py-10 opacity-50 text-sm text-teal-200/50" data-i18n="vocab_empty">
                    詞彙將顯示於此
                </div>
            </div>
        </aside>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 border border-teal-500/30 text-teal-100 px-4 py-2 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-2 pointer-events-none text-sm font-bold">
        <i class="fa-solid fa-circle-check text-teal-400"></i> <span id="toast-msg">Ready</span>
    </div>

    <script>
        const SHEET_ID = '1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk';
        const TARGET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbgkNiMflfeLQd3KN8F4yjjIr6G2flnCAy-nUPMiC7_xDfdg_0hJ2Qzbsr92u8htlPLFR8GwwQPK_g/pub?gid=0&single=true&output=csv';

        const COL_STAGE=0, COL_VERSION=2, COL_GRADE=3, COL_SEMESTER=4, COL_UNIT_NUM=6, COL_UNIT_NAME=7, 
              COL_CONTENT=8, COL_CKIP=9, COL_VOCAB=18;

        let rawData=[], processedUnits=[], isSpeaking=false, currentVoice='male', translationCache={}, synth=window.speechSynthesis;
        let activeVocabMap = {};

        const i18n = {
            'zh-TW': { return: '返回', page_title: '科學雙語閱讀', nav: '目錄導航', vocab_title: '科學詞彙庫', select_hint: '請先選擇單元', vocab_empty: '詞彙將顯示於此', stage: '學習階段', grade: '年級', version: '版本', semester: '學期', unit: '選擇單元' },
            'en': { return: 'RETURN', page_title: 'SCI-LINGUA READER', nav: 'NAVIGATION', vocab_title: 'VOCABULARY', select_hint: 'Select a unit to begin', vocab_empty: 'Terms will appear here', stage: 'Stage', grade: 'Grade', version: 'Version', semester: 'Semester', unit: 'Select Unit' },
            'ja': { return: '戻る', page_title: '科学バイリンガル', nav: 'ナビゲーション', vocab_title: '科学用語', select_hint: '単元を選択してください', vocab_empty: '用語はここに表示されます', stage: '段階', grade: '学年', version: '版', semester: '学期', unit: '単元選択' },
            'zh-CN': { return: '返回', page_title: '科学双语阅读', nav: '目录导航', vocab_title: '科学词汇库', select_hint: '请先选择单元', vocab_empty: '词汇将显示于此', stage: '学习阶段', grade: '年级', version: '版本', semester: '学期', unit: '选择单元' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initCanvas(); fetchData();
            if(synth) synth.onvoiceschanged = () => synth.getVoices();
        });

        function goBack() { window.location.href = 'student_science.html'; }

        function fetchData() {
            Papa.parse(TARGET_URL, {
                download: true, header: false,
                complete: res => { processData(res.data); document.getElementById('loader-overlay').style.display='none'; showToast("資料庫連線成功"); },
                error: () => document.getElementById('loader-overlay').innerHTML='<div class="text-red-500">Error: Check Network</div>'
            });
        }

        // ✅ 需求 #1：避免國中資料「看起來一樣但其實字串不同」造成過濾失效
        const norm = (s) => (s ?? '').toString()
            .replace(/[\uFEFF\u200B\u200C\u200D]/g,'')   // BOM / 零寬
            .replace(/　/g,' ')                         // 全形空白
            .trim();

        function processData(data) {
            rawData = data.slice(1);
            processedUnits = rawData.map((row, i) => {
                let content = (row[COL_CONTENT]||"").toString(),
                    ckip = (row[COL_CKIP]||"").toString(),
                    unitNum = norm(row[COL_UNIT_NUM]),
                    unitName = norm(row[COL_UNIT_NAME]);

                let title = (unitNum + (unitName ? " " + unitName : "")).trim() || `Unit ${i+1}`;

                return { 
                    id: i, 
                    stage: norm(row[COL_STAGE]), 
                    version: norm(row[COL_VERSION]), 
                    grade: norm(row[COL_GRADE]), 
                    semester: norm(row[COL_SEMESTER]), 
                    title, 
                    content, 
                    ckip, 
                    vocab: (row[COL_VOCAB]||"").toString()
                };
            }).filter(u => (u.content || u.ckip).length > 5); // 保留可用資料（避免國中被整批濾掉）

            initFilters();
        }

        function initFilters() { populateSelect('sel-stage', [...new Set(processedUnits.map(u=>u.stage).filter(Boolean))], 'stage'); }

        function filterUnits(lvl) {
            const ids=['stage','grade','version','semester','unit'], sels=ids.map(id=>document.getElementById(`sel-${id}`));
            let filtered = processedUnits.filter(u => {
                if(sels[0].value && u.stage!==sels[0].value) return false;
                if(sels[1].value && !sels[1].disabled && u.grade!==sels[1].value) return false;
                if(sels[2].value && !sels[2].disabled && u.version!==sels[2].value) return false;
                if(sels[3].value && !sels[3].disabled && u.semester!==sels[3].value) return false;
                return true;
            });

            const update=(sel,p,key)=> populateSelect(sel.id, [...new Set(filtered.map(u=>u[p]).filter(Boolean))], key);

            if(lvl==='stage') { update(sels[1],'grade','grade'); resetSelects(sels.slice(2)); }
            else if(lvl==='grade') { update(sels[2],'version','version'); resetSelects(sels.slice(3)); }
            else if(lvl==='version') { update(sels[3],'semester','semester'); resetSelects(sels.slice(4)); }
            else if(lvl==='semester') { 
                sels[4].innerHTML='<option value="" disabled selected data-i18n="unit">選擇單元</option>'; 
                filtered.forEach(u=>sels[4].add(new Option(u.title,u.id))); 
                sels[4].disabled=false; 
                changeLanguage();
            }
        }

        // ✅ 修正：placeholder 文字用 i18n key，不再寫死 Select/...
        function populateSelect(id,items,i18nKey){
            const s=document.getElementById(id);
            s.innerHTML=`<option value="" disabled selected data-i18n="${i18nKey}">${(i18n['zh-TW'][i18nKey]||'Select')}</option>`;
            items.forEach(i=>s.add(new Option(i,i)));
            s.disabled=false;
            changeLanguage();
        }
        function resetSelects(els){
            els.forEach(e=>{
                const key = e.id.replace('sel-','');
                e.innerHTML=`<option value="" disabled selected data-i18n="${key}">...</option>`;
                e.disabled=true;
            });
            changeLanguage();
        }

        function loadSelectedUnit(){ const u=processedUnits.find(i=>i.id==document.getElementById('sel-unit').value); if(u) renderArticle(u); }

        async function renderArticle(unit) {
            document.getElementById('article-title').innerText = unit.title;
            document.getElementById('status-bar').innerText = unit.title;
            document.getElementById('nav-title').innerText = unit.title;

            activeVocabMap = {};
            if(unit.vocab) unit.vocab.split(/[,;，；\n]/).forEach(i=>{ let p=i.split(/[:：]/); if(p[0] && p[0].trim()) activeVocabMap[p[0].trim()]=p[1]?p[1].trim():""; });

            renderVocabSidebar();

            const contentDiv = document.getElementById('article-content'); contentDiv.innerHTML='';
            document.getElementById('unit-list').innerHTML=''; 

            // I 欄內容線性呈現；若 I 欄空但 J 欄 CKIP 有內容，最低限度 fallback（避免畫面空白）
            let lines = (unit.content || "").split('\n').map(x=>x.trim()).filter(Boolean);
            if(lines.length===0 && unit.ckip){
                lines = unit.ckip.split('\n').map(x=>x.replace(/　/g,' ').replace(/\([^)]*\)/g,'').trim()).filter(Boolean);
            }

            let secCount=0;

            for(let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                if(!line) continue;

                if((line.length<40 && !/[。！？.!?]$/.test(line)) || line.includes("活動")) {
                    secCount++;
                    const anchorId = `sec-${i}`;
                    const navItem = document.createElement('div'); navItem.className='nav-item';
                    navItem.innerText = line;
                    navItem.onclick=()=>{ document.getElementById(anchorId).scrollIntoView({behavior:'smooth',block:'center'}); };
                    document.getElementById('unit-list').appendChild(navItem);
                    contentDiv.innerHTML += `<h2 id="${anchorId}" class="section-header">${line}</h2>`;
                } else {
                    let processed = processXRayWithCKIP(line, activeVocabMap);
                    // ✅ 需求 #2：中文點中文、英文點英文（DUAL 下兩者各自朗讀）
                    contentDiv.innerHTML += `
                        <div class="content-block">
                            <p class="zh-text" onclick="speakText(this.innerText)">${processed}</p>
                            <p class="en-text hidden text-teal-200/80 italic text-sm mt-2" onclick="speakText(this.innerText)" data-source="${line}"></p>
                        </div>`;
                }
            }
            setMode('dual');
        }

        function processXRayWithCKIP(text, map) {
            let clean = text.replace(/　/g,'');
            const keys = Object.keys(map).sort((a,b)=>b.length-a.length);
            if(keys.length===0) return clean;
            const ptrn = new RegExp(`(${keys.map(k=>k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|')})`,'g');
            return clean.replace(ptrn, m=>`<span class="sci-term" onclick="event.stopPropagation(); speakText('${(map[m]||m).replace(/'/g,"\\'")}')" title="${(map[m]||'').replace(/"/g,'&quot;')}">${m}</span>`);
        }

        function renderVocabSidebar() {
            const container = document.getElementById('vocab-container');
            container.innerHTML = '';
            const keys = Object.keys(activeVocabMap);
            if(keys.length === 0) { container.innerHTML = '<div class="text-center opacity-50 text-sm mt-10">無詞彙資料</div>'; return; }
            keys.forEach(zh => {
                const en = activeVocabMap[zh] || "Loading...";
                const card = document.createElement('div'); card.className = "vocab-item";
                card.innerHTML = `
  <div class="flex-1 pr-2">
    <div class="text-base font-bold text-yellow-400 cursor-pointer"
         onclick="speakText('${zh.replace(/'/g,"\\'")}')">${zh}</div>
    <div class="text-xs text-teal-200 en-term-label cursor-pointer"
         data-zh="${zh}"
         onclick="speakText('${(en||'').replace(/'/g,"\\'")}')">${en}</div>
  </div>

  <div class="flex items-center gap-1">
    <!-- 中文按鈕：念中文 -->
    <button onclick="event.stopPropagation(); speakText('${zh.replace(/'/g,"\\'")}')"
            class="text-teal-300 hover:text-white px-2 py-1 rounded-full hover:bg-white/10 text-xs font-bold"
            title="念中文">中</button>

    <!-- 英文按鈕：念英文 -->
    <button onclick="event.stopPropagation(); speakText('${(en||zh).replace(/'/g,"\\'")}')"
            class="text-teal-400 hover:text-white px-2 py-1 rounded-full hover:bg-white/10 text-xs font-bold"
            title="Read English">EN</button>
  </div>
`;

                container.appendChild(card);
                if(!activeVocabMap[zh]) translateVocabItem(zh, card.querySelector('.en-term-label'));
            });
        }

        async function translateVocabItem(zh, el) {
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURI(zh)}`);
                const json = await res.json(); el.innerText = json[0][0][0]; activeVocabMap[zh] = el.innerText;
            } catch(e){}
        }

        async function translateVisibleBlocks() {
            const ens = document.querySelectorAll('.en-text'), load=document.getElementById('trans-loading');
            let need=false; ens.forEach(e=>{if(!e.innerText)need=true}); if(!need)return;
            load.classList.remove('hidden');
            for(let el of ens) {
                if(el.innerText) continue;
                let src=(el.getAttribute('data-source')||"").replace(/　/g,'');
                if(translationCache[src]) { el.innerHTML=makeClickable(translationCache[src]); continue; }
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURI(src)}`);
                    const json = await res.json();
                    let txt=""; json[0].forEach(i=>txt+=i[0]);
                    el.innerHTML = makeClickable(highlightEnglishVocabInText(txt));
translationCache[src]=txt;

                } catch(e){ el.innerText="Error"; }
            }
            load.classList.add('hidden');
        }

        function makeClickable(html) {
  // ✅ 讓整段英文仍可點擊朗讀（事件冒泡），但內層 sci-term 點擊會 stopPropagation
  return `<span class="cursor-pointer hover:text-teal-300 transition">${html}</span>`;
}


        function toggleSpeech() {
            const btn=document.getElementById('btn-play');
            if(synth.speaking && !synth.paused) { synth.pause(); btn.innerHTML='<i class="fa-solid fa-play text-xs"></i>'; isSpeaking=false; }
            else if(synth.paused) { synth.resume(); btn.innerHTML='<i class="fa-solid fa-pause text-xs"></i>'; isSpeaking=true; }
            else {
                let txt="";
                const en=document.querySelectorAll('.en-text'), isEn=en.length>0&&!en[0].classList.contains('hidden');
                document.querySelectorAll(isEn?'.en-text':'.zh-text').forEach(p=>txt+=p.innerText+" ");
                if(!txt) return;
                speakText(txt);
            }
        }
function escapeHtml(s){
  return (s||"").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

// ✅ 把 activeVocabMap 的「英文值」在英文句子中黃標
function highlightEnglishVocabInText(txt){
  let safe = escapeHtml(txt);

  // 取出英文詞彙（value），去除空/Loading
  const terms = Object.values(activeVocabMap||{})
    .map(v => (v||"").trim())
    .filter(v => v && v !== "Loading..." && /[a-zA-Z]/.test(v));

  const uniq = [...new Set(terms)].sort((a,b)=>b.length-a.length);
  if(!uniq.length) return safe;

  for(const term of uniq){
    const t = escapeHtml(term);
    const escaped = t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

    // 單字用 word boundary，比較不會誤標；片語就不用 boundary
    const isSingleWord = /^[A-Za-z]+$/.test(term);
    const re = isSingleWord ? new RegExp(`\\b(${escaped})\\b`,'gi') : new RegExp(`(${escaped})`,'gi');

    safe = safe.replace(re, (m) => {
      const js = m.replace(/'/g,"\\'");
      return `<span class="sci-term" onclick="event.stopPropagation(); speakText('${js}')" title="${m}">${m}</span>`;
    });
  }
  return safe;
}

        function stopSpeech() { synth.cancel(); isSpeaking=false; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play text-xs"></i>'; }

        // ✅ 需求 #7：更自然的 voice 選擇（優先 Microsoft Natural / Online，其次 Google）
        // ✅ 更自然的 voice 選擇：優先 Microsoft Online/Natural，其次 Google，再其次其他
function pickBestVoice(isEng, gender){
  const voices = (synth && synth.getVoices) ? synth.getVoices() : [];
  if(!voices.length) return null;

  const wantLang = isEng ? ['en-us','en-gb','en'] : ['zh-tw','zh-hk','zh-cn','zh'];
  const inLang = (v) => wantLang.some(l => (v.lang||'').toLowerCase().includes(l));

  const score = (v) => {
    const name = (v.name||'').toLowerCase();
    const lang = (v.lang||'').toLowerCase();
    let s = 0;

    // 語言匹配（中文強推 zh-TW）
    if(isEng){
      if(lang.includes('en-us')) s += 20;
      if(lang.includes('en-gb')) s += 15;
      if(lang.includes('en')) s += 10;
    }else{
      if(lang.includes('zh-tw')) s += 40;   // ★台灣中文最優先
      if(lang.includes('zh-hk')) s += 20;
      if(lang.includes('zh-cn')) s += 10;
      if(lang.includes('zh')) s += 5;
    }

    // Microsoft Online / Natural（Edge/Windows 常見，最自然）
    if(name.includes('microsoft') && name.includes('online')) s += 35;
    if(name.includes('microsoft') && name.includes('natural')) s += 45;
    if(name.includes('microsoft')) s += 10;

    // Google voices（Chrome 常見，次佳）
    if(name.includes('google')) s += 12;

    // 常見「比較機械」的關鍵字，稍微降分
    if(name.includes('compact')) s -= 8;
    if(name.includes('standard')) s -= 5;

    // 性別偏好（加分很小，不影響 Natural 的優先）
    if(isEng){
      if(gender==='male' && (name.includes('guy') || name.includes('david'))) s += 2;
      if(gender==='female' && (name.includes('jenny') || name.includes('aria') || name.includes('zira') || name.includes('susan'))) s += 2;
    }else{
      // 台灣常見自然聲（名稱因系統不同，不一定會出現；有就加分）
      if(name.includes('hsiaochen') || name.includes('yunjhe') || name.includes('yating') || name.includes('huihui')) s += 3;
    }

    return s;
  };

  const candidates = voices.filter(v => inLang(v));
  if(!candidates.length) return null;
  candidates.sort((a,b)=>score(b)-score(a));
  return candidates[0] || null;
}

function speakText(txt) {
  synth.cancel();
  const cleanTxt = (txt || "").toString().replace(/<[^>]*>/g, '').trim();
  if (!cleanTxt) return;

  const u = new SpeechSynthesisUtterance(cleanTxt);
  const isEng = /[a-zA-Z]/.test(cleanTxt);

  const voice = pickBestVoice(isEng, currentVoice);
  if (voice) u.voice = voice;

  const uiRate = parseFloat(document.getElementById('play-rate').value);

  // 讓中文更自然：稍慢一點通常更像真人
  if (isEng) {
    u.rate = uiRate;
    u.pitch = (currentVoice === 'male') ? 1.0 : 1.03;
  } else {
    u.rate = Math.max(0.85, Math.min(1.05, uiRate * 0.95));
    u.pitch = 1.0;
  }

  u.onstart = () => {
    isSpeaking = true;
    document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause text-xs"></i>';
  };
  u.onend = () => {
    isSpeaking = false;
    document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-play text-xs"></i>';
  };

  synth.speak(u);
}


        function setVoice(g) { 
            currentVoice=g; 
            document.getElementById('btn-male').className=g==='male'?'text-teal-400 p-1':'text-slate-500 p-1'; 
            document.getElementById('btn-female').className=g==='female'?'text-teal-400 p-1':'text-slate-500 p-1'; 
            stopSpeech();
        }

        function setMode(m) {
            ['en','dual','zh'].forEach(x=>document.getElementById(`btn-${x}`).className=x===m?"mode-btn px-2 py-1 text-xs font-bold rounded bg-teal-600 text-white":"mode-btn px-2 py-1 text-xs font-bold rounded text-teal-500 hover:text-white");
            if(m!=='zh') translateVisibleBlocks();
            const en=document.querySelectorAll('.en-text'), zh=document.querySelectorAll('.zh-text');
            if(m==='en'){en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.add('hidden'));}
            else if(m==='zh'){en.forEach(e=>e.classList.add('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
            else{en.forEach(e=>e.classList.remove('hidden'));zh.forEach(z=>z.classList.remove('hidden'));}
        }

        function changeLanguage() {
            const lang = document.getElementById('ui-lang').value;
            const t = i18n[lang] || i18n['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if(t[k]) { if(el.tagName==='OPTION') el.text=t[k]; else el.innerText=t[k]; }
            });
        }

        function showToast(m) { const T=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; T.classList.remove('opacity-0','translate-y-10'); setTimeout(()=>T.classList.add('opacity-0','translate-y-10'),2000); }
        function initCanvas() {
            const c=document.getElementById('molecule-canvas'),x=c.getContext('2d');
            let p=[]; function r(){c.width=window.innerWidth;c.height=window.innerHeight;}
            window.addEventListener('resize',r);r();
            class A{constructor(){this.x=Math.random()*c.width;this.y=Math.random()*c.height;this.vx=(Math.random()-.5)*.2;this.vy=(Math.random()-.5)*.2;this.s=Math.random()*2+1;this.color=`rgba(45,212,191,${Math.random()*0.3+0.1})`;}u(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>c.width)this.vx*=-1;if(this.y<0||this.y>c.height)this.vy*=-1;}d(){x.beginPath();x.arc(this.x,this.y,this.s,0,Math.PI*2);x.fillStyle=this.color;x.fill();}}
            for(let i=0;i<50;i++)p.push(new A());
            function a(){x.clearRect(0,0,c.width,c.height);p.forEach(b=>{b.u();b.d()});requestAnimationFrame(a);}a();
        }
    </script>
</body>
</html>
