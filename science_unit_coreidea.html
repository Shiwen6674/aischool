<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>單元重點整理 | AI Learning Hub</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700;900&family=Orbitron:wght@400;500;700;900&family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
            tech: ['Orbitron', 'sans-serif'],
            ui: ['Outfit', 'Noto Sans TC', 'sans-serif'],
          },
          colors: {
            deep: { bg: '#050b14', card: '#0f172a' },
            neon: { blue: '#3b82f6', cyan: '#06b6d4', purple: '#8b5cf6', accent: '#f43f5e', pink: '#f472b6' }
          },
          animation: {
            "fade-in-up": "fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards",
            "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            "float": "float 6s ease-in-out infinite",
            "hologram": "hologram 2s infinite linear",
          },
          keyframes: {
            fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } },
            float: { "0%, 100%": { transform: "translateY(0)" }, "50%": { transform: "translateY(-6px)" } },
            hologram: { "0%": { opacity: 0.8 }, "50%": { opacity: 1 }, "100%": { opacity: 0.8 } }
          },
          backgroundImage: {
            'grid-pattern': "linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px)",
          }
        }
      }
    };
    mermaid.initialize({
      startOnLoad: false,
      theme: 'base',
      themeVariables: { primaryColor: '#1e293b', edgeLabelBackground: '#ffffff', tertiaryColor: '#fff', lineColor: '#3b82f6', textColor: '#f1f5f9', mainBkg: '#0f172a' },
      securityLevel: 'loose',
      flowchart: { useMaxWidth: false, htmlLabels: true }
    });
  </script>

  <style>
    /* ===== 全局設定 ===== */
    body {
      background-color: #050b14;
      color: #e2e8f0;
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      overflow-x: hidden;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
    }

    .ambient-glow {
      position: fixed; top: -20%; left: 50%; transform: translateX(-50%);
      width: 100vw; height: 80vh;
      background: radial-gradient(circle, rgba(6, 182, 212, 0.15) 0%, rgba(59, 130, 246, 0.08) 40%, transparent 70%);
      filter: blur(80px);
      z-index: -2; pointer-events: none;
    }
    .grid-bg {
      position: fixed; inset: 0; z-index: -1; pointer-events: none;
      background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(circle at center, black 0%, transparent 80%);
    }

    /* ===== 元件：玻璃態與卡片 ===== */
    .hud-glass {
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }
    
    /* 亮色閱讀卡片 (用於摘要與詞彙) */
    .reading-paper {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(6, 182, 212, 0.1) inset;
      color: #1e293b;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .reading-paper:hover { box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.6); }

    /* [修正] 高質感深色閱讀卡片 (用於測驗與動動腦) - 解決閱讀吃力問題 */
    .reading-paper-dark {
      background: rgba(30, 41, 59, 0.75); /* 更深、更透的藍灰色 */
      backdrop-filter: blur(16px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
      color: #f1f5f9; /* 亮白文字，對比度高 */
      transition: all 0.3s ease;
    }
    .reading-paper-dark:hover {
      box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
      border-color: rgba(6, 182, 212, 0.2);
      background: rgba(30, 41, 59, 0.85);
    }

    /* [修正] 核心概念高亮樣式 */
    #summary-text strong, #summary-text b {
        color: #f472b6; /* 桃紅高亮 */
        font-weight: 900;
        background: rgba(244, 114, 182, 0.1); /* 黃底/粉底標示 */
        padding: 0 4px;
        border-radius: 4px;
        border-bottom: 2px solid #f472b6;
    }

    /* ===== 表單元件 (Select) ===== */
    select {
      appearance: none;
      -webkit-appearance: none;
      background-color: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: #e0f2fe;
      border-radius: 12px;
      padding: 12px 40px 12px 16px;
      font-family: 'Orbitron', 'Noto Sans TC', sans-serif;
      font-size: 0.95rem;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      width: 100%;
      color-scheme: dark;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2322d3ee'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3e%3c/svg%3e");
      background-position: right 1rem center;
      background-repeat: no-repeat;
      background-size: 1.2rem;
      box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
    }
    select:hover:not(:disabled) {
      background-color: rgba(15, 23, 42, 0.9);
      border-color: #22d3ee;
      box-shadow: 0 0 15px rgba(34, 211, 238, 0.3), inset 0 0 0 1px rgba(34, 211, 238, 0.1);
      transform: translateY(-1px);
    }
    select:focus {
      outline: none;
      border-color: #22d3ee;
      background-color: #0f172a;
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2), 0 0 25px rgba(34, 211, 238, 0.4);
    }
    select:disabled {
      background-color: rgba(15, 23, 42, 0.3);
      color: #64748b;
      border-color: rgba(255, 255, 255, 0.05);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23475569'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3e%3c/svg%3e");
    }

    /* ===== 生成按鈕 ===== */
    #btn-generate:not(:disabled) {
      background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      position: relative; overflow: hidden;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
    }
    #btn-generate:not(:disabled)::after {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: linear-gradient(rgba(255,255,255,0.2), transparent);
      transform: rotate(45deg) translateY(-100%);
      animation: shine 3s infinite;
    }
    @keyframes shine { 
      0% { transform: rotate(45deg) translateY(-100%); }
      20% { transform: rotate(45deg) translateY(100%); }
      100% { transform: rotate(45deg) translateY(100%); }
    }

    /* ===== 細節樣式 ===== */
    .section-title { font-family: 'Outfit', 'Noto Sans TC', sans-serif; position: relative; display: inline-block; }
    .section-title::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 40%; height: 3px; background: linear-gradient(90deg, #06b6d4, transparent); border-radius: 2px; }

    #summary-text h3 { font-family: 'Outfit', 'Noto Sans TC', sans-serif; color: #0f172a; font-size: 1.25rem; font-weight: 800; margin-top: 1.5rem; padding-left: 1rem; border-left: 4px solid #06b6d4; }
    #summary-text li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: #334155; }
    #summary-text li::before { content: "\f054"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: #06b6d4; font-size: 0.7rem; position: absolute; left: 0; top: 0.2rem; }

    .vocab-item { border: 1px solid #e2e8f0; background: #fff; transition: all 0.3s ease; }
    .vocab-item:hover { border-color: #06b6d4; transform: translateX(5px); box-shadow: 0 4px 12px rgba(6, 182, 212, 0.1); }

    .quiz-option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
    .quiz-option-btn:hover:not(:disabled) { background: #f0f9ff; border-color: #06b6d4; transform: scale(1.01); }
    .quiz-option-btn.selected-correct { background: #ecfdf5 !important; border-color: #10b981 !important; color: #064e3b !important; }
    .quiz-option-btn.selected-wrong { background: #fef2f2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; }

    .tech-loader { width: 60px; height: 60px; border: 3px solid rgba(6, 182, 212, 0.1); border-top-color: #06b6d4; border-radius: 50%; animation: spin 1s linear infinite; position: relative; box-shadow: 0 0 20px rgba(6, 182, 212, 0.2); }
    .tech-loader::before { content:''; position: absolute; inset: 5px; border-radius: 50%; border: 3px solid transparent; border-top-color: #3b82f6; animation: spin 2s linear infinite reverse; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ===== 小科 AI ===== */
    .chat-hologram {
      backdrop-filter: blur(20px);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(6, 182, 212, 0.5);
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.2), inset 0 0 20px rgba(6, 182, 212, 0.05);
      border-radius: 1.5rem;
      color: #e0f2fe;
      position: fixed; 
    }
    .chat-hologram-header {
      background: linear-gradient(90deg, rgba(6, 182, 212, 0.2), transparent);
      border-bottom: 1px solid rgba(6, 182, 212, 0.3);
      cursor: grab;
    }
    .chat-hologram-header:active { cursor: grabbing; }
    
    .chat-bubble-ai {
      background: rgba(6, 182, 212, 0.15);
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: #a5f3fc;
      border-radius: 1rem 1rem 1rem 0;
    }
    .chat-bubble-user {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #bfdbfe;
      border-radius: 1rem 1rem 0 1rem;
    }
    
    /* [修正] Mermaid SVG 樣式 */
    .mermaid svg {
        width: 100% !important;
        height: auto !important;
        max-width: none !important;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.1); }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

    /* [修正] Modal 樣式優化 */
    #image-modal { backdrop-filter: blur(12px); background-color: rgba(5, 11, 20, 0.85); }
    #modal-content { 
        width: 95vw !important; 
        max-width: 1200px !important;
        background-color: #f8fafc !important; /* 亮白灰色底，高對比 */
        color: #1e293b;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    /* 強制 Modal 內的 Mermaid 圖表使用深色樣式以配合白底 */
    #modal-content svg { background-color: transparent !important; }
    #modal-content .node rect, #modal-content .node circle, #modal-content .node polygon { fill: #e2e8f0 !important; stroke: #64748b !important; stroke-width: 2px; }
    #modal-content .nodeLabel, #modal-content .edgeLabel { fill: #0f172a !important; color: #0f172a !important; font-weight: 600; }
    #modal-content .edgePath path { stroke: #64748b !important; stroke-width: 2px; }
    #modal-content .marker { fill: #64748b !important; stroke: #64748b !important; }


    .pdf-page-break { page-break-before: always; }
    .click-mask { cursor: zoom-in; }

    /* [修正] 詞彙欄捲軸設定 */
    #vocab-panel {
        display: flex;
        flex-direction: column;
        /* 高度由 JS 動態控制 */
    }
    #vocab-list-container {
        flex: 1;
        overflow-y: auto; /* 內容過長時顯示捲軸 */
        min-height: 0;    
        padding-right: 6px; 
    }

    /* [修正] 預覽圖容器優化 */
    #chart-container {
        min-height: 350px; 
        background: rgba(15, 23, 42, 0.6); 
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 0 0 1rem 1rem;
    }

    @media (max-width: 640px) { .hud-glass { backdrop-filter: blur(12px); background: rgba(15,23,42,0.85); } }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  
  <div class="grid-bg"></div>
  <div class="ambient-glow"></div>

  <nav class="hud-glass sticky top-0 z-50 h-16 sm:h-20 flex items-center border-b border-slate-700/30 no-print">
    <div class="max-w-7xl mx-auto px-4 w-full flex justify-between items-center">
      <div class="flex items-center gap-6">
        <a href="https://shiwen6674.github.io/aischool/student_science.html" class="group flex items-center gap-3 text-slate-400 hover:text-cyan-400 transition duration-300">
          <div class="w-8 h-8 rounded-lg border border-slate-600 group-hover:border-cyan-400 flex items-center justify-center bg-slate-800/50 transition">
            <i class="fa-solid fa-flask text-xs"></i>
          </div>
          <span class="font-ui font-semibold text-sm hidden md:block uppercase tracking-wider" data-i18n="back_science">返回自然科學</span>
        </a>
        <div class="h-6 w-px bg-slate-700 hidden sm:block"></div>
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center border border-cyan-500/30">
            <i class="fa-solid fa-atom text-cyan-400 text-sm"></i>
          </div>
          <div>
            <h1 class="font-tech font-bold text-base sm:text-lg text-white tracking-wide leading-none" data-i18n="page_title">UNIT SUMMARY</h1>
            <p class="text-[10px] text-cyan-500 font-mono tracking-[0.2em] uppercase mt-1" data-i18n="page_subtitle">AI-Powered Analytics</p>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="relative group">
          <select id="language-selector" onchange="changeLanguage()">
            <option value="zh-TW" selected>繁體中文</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="zh-CN">简体中文</option>
          </select>
        </div>
        <div class="flex items-center gap-2 pl-4 border-l border-slate-700">
          <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
          <div id="user-info" class="text-xs font-mono text-cyan-400">Visitor</div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-32 relative z-10">
    
    <div id="selection-panel" class="hud-glass rounded-2xl p-6 sm:p-8 mb-10 border-t border-cyan-500/20 relative overflow-hidden animate-fade-in-up no-print">
      <div class="absolute top-0 right-0 p-4 opacity-20 pointer-events-none">
        <i class="fa-solid fa-database text-6xl text-cyan-500"></i>
      </div>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 relative z-10">
        <div>
          <h2 class="font-tech text-xl sm:text-2xl text-white flex items-center gap-3">
            <span class="w-1 h-6 bg-cyan-500 rounded-full"></span>
            <span data-i18n="settings_title">Select Target Unit</span>
          </h2>
          <p class="text-slate-400 text-xs mt-1 ml-4" data-i18n="settings_subtitle">Initialize AI Analysis Protocol</p>
        </div>
        <span id="db-status" class="text-xs font-mono font-bold text-cyan-500 mt-2 sm:mt-0 bg-cyan-900/20 px-3 py-1 rounded border border-cyan-900/50" data-state="loading">
          <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> <span data-i18n="db_loading">System Check...</span>
        </span>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-5 relative z-10">
        <div class="group">
          <label class="block text-[10px] font-mono text-cyan-300/70 mb-1.5 uppercase tracking-wider" data-i18n="label_stage">Stage</label>
          <select id="sel-stage"></select>
        </div>
        <div class="group">
          <label class="block text-[10px] font-mono text-cyan-300/70 mb-1.5 uppercase tracking-wider" data-i18n="label_publisher">Publisher</label>
          <select id="sel-publisher" disabled></select>
        </div>
        <div class="group">
          <label class="block text-[10px] font-mono text-cyan-300/70 mb-1.5 uppercase tracking-wider" data-i18n="label_grade">Grade</label>
          <select id="sel-grade" disabled></select>
        </div>
        <div class="group">
          <label class="block text-[10px] font-mono text-cyan-300/70 mb-1.5 uppercase tracking-wider" data-i18n="label_semester">Semester</label>
          <select id="sel-semester" disabled></select>
        </div>
        <div class="group">
          <label class="block text-[10px] font-mono text-cyan-300/70 mb-1.5 uppercase tracking-wider" data-i18n="label_unit">Unit Name</label>
          <select id="sel-unit" disabled></select>
        </div>
      </div>
      <div class="mt-8 flex justify-end relative z-10">
        <button id="btn-generate" onclick="startGeneration()" disabled class="px-8 py-3 rounded-lg font-bold text-white shadow-lg hover:shadow-cyan-500/50 transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-3 text-sm tracking-wide">
          <i class="fa-solid fa-wand-magic-sparkles"></i> 
          <span data-i18n="btn_generate">AI 整理重點</span>
        </button>
      </div>
    </div>

    <div id="loading-view" class="hidden flex-col items-center justify-center py-32 animate-pulse-slow">
      <div class="tech-loader mb-6"></div>
      <h3 class="text-2xl font-tech font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500" data-i18n="ai_generating">PROCESSING DATA...</h3>
    </div>

    <div id="content-view" class="hidden animate-fade-in-up">
      <div class="mb-8 flex flex-col md:flex-row justify-between md:items-end gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span id="result-tag" class="text-[10px] font-mono font-bold bg-cyan-900/40 text-cyan-300 px-3 py-1 rounded border border-cyan-500/30">TAG</span>
            <div class="h-px w-10 bg-cyan-500/50"></div>
          </div>
          <h1 id="result-title" class="text-4xl md:text-5xl font-ui font-black text-white leading-tight drop-shadow-xl">Title</h1>
        </div>
        <div class="flex gap-3 no-print">
          <button onclick="downloadTXT()" class="bg-slate-800/80 hover:bg-slate-700 text-cyan-400 border border-slate-600 hover:border-cyan-500 px-5 py-2.5 rounded-lg font-bold text-xs transition flex items-center gap-2 backdrop-blur-sm">
            <i class="fa-solid fa-file-code"></i>
            <span data-i18n="btn_txt">EXPORT .TXT</span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-start">
        
        <div id="summary-panel" class="md:col-span-8 reading-paper p-8">
          <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
              <i class="fa-solid fa-star text-lg"></i>
            </div>
            <h3 class="font-ui font-bold text-slate-800 text-xl section-title" data-i18n="title_summary">Core Concepts</h3>
          </div>
          <div id="summary-text" class="prose prose-slate max-w-none text-slate-700 leading-loose text-base md:text-lg"></div>
        </div>

        <div id="vocab-panel" class="md:col-span-4 reading-paper p-6 bg-slate-50/50">
          <div class="flex items-center gap-3 mb-6 flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600">
              <i class="fa-solid fa-spell-check"></i>
            </div>
            <h3 class="font-ui font-bold text-slate-800 text-lg section-title" data-i18n="title_vocab">Keywords</h3>
          </div>
          <div id="vocab-list-container" class="custom-scrollbar pr-1">
            <div id="keywords-list" class="space-y-3 pb-2"></div>
          </div>
        </div>

        <div class="md:col-span-12 reading-paper-dark p-1 bg-slate-800/50 border-slate-700/50 pdf-page-break">
          <div class="p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-900/30 rounded-t-xl">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                <i class="fa-solid fa-project-diagram"></i>
              </div>
              <h3 class="font-ui font-bold text-white text-lg section-title" data-i18n="title_map">Knowledge Graph</h3>
              <button onclick="openModal()" class="ml-2 text-[10px] bg-indigo-900/80 text-indigo-200 px-3 py-1 rounded-full hover:bg-indigo-800 transition border border-indigo-500/30" data-i18n="tap_to_zoom">Expand</button>
            </div>
            <button onclick="openModal()" class="text-slate-400 hover:text-indigo-400 transition"><i class="fa-solid fa-expand"></i></button>
          </div>
          
          <div class="p-4 overflow-hidden relative" id="chart-container">
            <div class="click-mask" onclick="openModal()"></div>
            <div id="mermaid-chart" class="w-full flex justify-center"></div>
          </div>
        </div>

        <div class="md:col-span-12 reading-paper-dark p-8 pdf-page-break">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center text-red-400">
              <i class="fa-solid fa-lightbulb"></i>
            </div>
            <h3 class="font-ui font-bold text-white text-lg section-title" data-i18n="title_myth">Myth Busting</h3>
          </div>
          <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>

        <div id="quiz-panel" class="md:col-span-12 reading-paper-dark p-8 border-t-2 border-emerald-500/20">
          <div class="flex justify-between items-center mb-6 border-b border-slate-700/50 pb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                <i class="fa-solid fa-brain"></i>
              </div>
              <h3 class="font-ui font-bold text-white text-xl section-title">
                <span id="quiz-title" data-i18n="quiz">Unit Quiz</span>
              </h3>
            </div>
            <div id="quiz-progress" class="font-mono text-xs font-bold text-emerald-400 bg-emerald-900/30 px-3 py-1 rounded-full border border-emerald-500/30">
              0 / 0
            </div>
          </div>

          <div id="quiz-body" class="space-y-8">
            <div id="quiz-question" class="font-ui font-bold text-white text-xl leading-relaxed"></div>
            <div id="quiz-options" class="grid grid-cols-1 gap-4"></div>
            <div id="quiz-feedback" class="hidden animate-fade-in-up"></div>
            <div class="flex justify-end pt-4">
              <button id="quiz-main-btn" onclick="handleQuizMainButton()" class="px-8 py-3 rounded-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm shadow-lg shadow-emerald-900/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                Next Question
              </button>
            </div>
          </div>

          <div id="quiz-empty" class="text-sm text-slate-400 italic p-4 text-center" data-i18n="quiz_not_ready"></div>

          <div id="quiz-result" class="hidden mt-8 bg-slate-900/50 rounded-2xl p-8 border border-slate-700/50 backdrop-blur-sm">
            <div class="flex flex-col md:flex-row justify-between items-center gap-8 mb-8">
              <div class="text-center md:text-left">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2" data-i18n="quiz_score_title">Final Score</div>
                <div id="quiz-score-number" class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 font-tech">0</div>
                <div id="quiz-score-label" class="text-sm text-emerald-500 font-bold mt-2 tracking-wide"></div>
              </div>
              <div id="quiz-result-text" class="text-lg font-bold text-white bg-slate-800/50 px-6 py-3 rounded-xl border border-slate-700"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="h-72 relative p-4 bg-slate-800/30 rounded-xl border border-slate-700/30">
                <canvas id="quiz-radar"></canvas>
              </div>
              <div id="quiz-result-detail" class="text-sm text-slate-300 leading-relaxed bg-slate-800/50 p-6 rounded-xl border border-slate-700/50 shadow-inner overflow-y-auto max-h-72 custom-scrollbar"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <div id="floating-chat" class="hidden fixed bottom-6 right-6 z-[100] no-print">
    <div id="xiaoke-window" class="chat-hologram closed w-80 md:w-96 flex flex-col overflow-hidden h-[500px] transition-all duration-300 transform scale-0 opacity-0 origin-bottom-right absolute bottom-20 right-0">
      <div id="xiaoke-header" class="chat-hologram-header p-4 flex justify-between items-center">
        <div class="flex items-center gap-3 select-none">
          <div class="relative">
            <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="小科" class="w-10 h-10 rounded-full border-2 border-cyan-400 bg-slate-900 object-cover shadow-[0_0_10px_#06b6d4]">
            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-800 animate-pulse"></div>
          </div>
          <div>
            <span class="font-tech font-bold text-cyan-300 block leading-none tracking-wide text-lg">XIAOKE AI</span>
            <span class="text-[10px] text-cyan-600 font-mono uppercase tracking-widest">System Online</span>
          </div>
        </div>
        <button onclick="toggleChat()" class="text-cyan-600 hover:text-cyan-300 transition"><i class="fa-solid fa-xmark"></i></button>
      </div>
      
      <div class="flex-1 p-4 overflow-y-auto text-sm space-y-4 custom-scrollbar" id="chat-messages"></div>
      
      <div class="p-3 border-t border-cyan-500/30 flex gap-2 bg-slate-900/50">
        <input type="text" id="chat-input" data-i18n-placeholder="chat_placeholder" placeholder="Ask AI..." 
          class="flex-1 bg-slate-800/50 border border-cyan-500/30 rounded-lg px-4 py-2 text-sm focus:border-cyan-400 focus:shadow-[0_0_10px_rgba(6,182,212,0.3)] outline-none text-cyan-100 placeholder-cyan-800 transition"
          onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()" class="bg-cyan-600/80 hover:bg-cyan-500 text-white w-10 h-10 rounded-lg transition shadow-[0_0_15px_rgba(6,182,212,0.4)] flex items-center justify-center border border-cyan-400/50">
          <i class="fa-solid fa-paper-plane text-xs"></i>
        </button>
      </div>
    </div>

    <div class="relative group cursor-pointer" onclick="toggleChat()">
        <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-cyan-900/80 text-cyan-300 text-xs font-bold px-3 py-1 rounded-full border border-cyan-500/50 opacity-0 group-hover:opacity-100 transition whitespace-nowrap shadow-[0_0_10px_rgba(6,182,212,0.5)] pointer-events-none">
            我是小科
        </div>
        <button class="w-16 h-16 rounded-full shadow-[0_0_25px_rgba(6,182,212,0.6)] flex items-center justify-center hover:scale-105 transition-all overflow-hidden border-2 border-cyan-400 relative bg-slate-900">
          <div class="absolute inset-0 bg-cyan-500/20 animate-ping"></div>
          <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="小科" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition z-10">
        </button>
    </div>
  </div>

  <div id="image-modal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 transition-opacity duration-300" onclick="closeModal()">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
    <button class="absolute top-6 right-6 text-white/70 hover:text-white text-4xl transition z-10" onclick="closeModal()"><i class="fa-solid fa-circle-xmark"></i></button>
    <div id="modal-content" class="relative z-10 overflow-auto max-h-[95vh] p-6" onclick="event.stopPropagation()"></div>
  </div>

  <script>
    const chatWindow = document.getElementById("xiaoke-window");
    
    window.toggleChat = function() {
        if (!chatWindow) return;
        const isClosed = chatWindow.classList.contains("closed");
        if (isClosed) {
            chatWindow.classList.remove("closed", "scale-0", "opacity-0");
            const chatBody = document.getElementById("chat-messages");
            if (chatBody && !chatBody.innerHTML.trim()) {
                const unitName = (filters && filters.unitName) || "這個單元";
                chatBody.innerHTML = `
                    <div class="chat-bubble-ai self-start p-3 shadow-sm max-w-[85%] text-sm mb-2">
                      <span class="font-bold text-cyan-400 block mb-1 text-xs tracking-wider">SYSTEM MESSAGE</span>
                      ${tf("chat_greet", {unit: unitName})}
                    </div>`;
            }
        } else {
            chatWindow.classList.add("closed", "scale-0", "opacity-0");
        }
    };

    const dragItem = document.getElementById("floating-chat");
    let active = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    dragItem.addEventListener("mousedown", dragStart, false);
    dragItem.addEventListener("mouseup", dragEnd, false);
    dragItem.addEventListener("mousemove", drag, false);

    function dragStart(e) {
      if (e.target.closest("#xiaoke-window")) return;
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
      if (e.target.closest("button") || e.target.closest(".group")) {
        active = true;
      }
    }
    function dragEnd(e) {
      initialX = currentX;
      initialY = currentY;
      active = false;
    }
    function drag(e) {
      if (active) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        setTranslate(currentX, currentY, dragItem);
      }
    }
    function setTranslate(xPos, yPos, el) {
      el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
    }
    
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";

    let allData = [];
    let filters = {};
    let currentResultData = null;
    let mythData = [];
    let quizState = { questions: [], currentIndex: 0, hasAnswered: false, answers: [] };
    let quizRadarChart = null;

    const translations = {
      "zh-TW": {
        back_science: "返回自然科學",
        page_title: "單元重點整理",
        page_subtitle: "AI 驅動分析",
        settings_title: "選擇學習單元",
        settings_subtitle: "初始化 AI 分析協定",
        label_stage: "學習階段",
        label_publisher: "版本",
        label_grade: "年級",
        label_semester: "學期",
        label_unit: "單元名稱",
        btn_generate: "AI 整理重點",
        btn_txt: "下載 TXT",
        title_summary: "核心概念摘要",
        title_vocab: "科學詞彙與定義",
        title_map: "知識架構圖",
        title_myth: "科學動動腦",
        db_loading: "系統連線中...",
        db_success: "資料庫連線成功",
        db_fail: "連線失敗",
        db_fail_retry: "連線失敗，請重試",
        ai_generating: "正在處理數據...",
        tap_to_zoom: "點擊放大",
        myth_tip: "先想一想，再作答",
        myth_true: "正確 O",
        myth_false: "錯誤 X",
        msg_correct: "恭喜答對了！",
        msg_wrong: "可惜答錯了！",
        msg_seq: "請依照題號順序作答！",
        vocab_none: "無詞彙資料",
        summary_fail: "生成摘要失敗...",
        map_fail: "架構圖繪製失敗",
        map_none: "無架構圖數據",
        myth_none: "本單元暫無迷思概念題",
        quiz: "單元小測驗",
        quiz_prefix: "單元小測驗－{unit}",
        quiz_not_ready: "測驗尚未準備好",
        quiz_result_btn: "看結果",
        quiz_next: "下一題",
        quiz_score_title: "測驗成績",
        quiz_ai_analyzing: "AI 分析中...",
        quiz_result_text: "答對 {correct} 題 / 共 {total} 題",
        txt_need_generate: "請先生成內容後再下載！",
        txt_download_fail: "下載失敗",
        ai_generate_fail: "生成失敗: {msg}",
        api_format_error: "API 格式錯誤",
        chat_greet: "你好，我是小科。關於「{unit}」，有什麼我可以幫你的嗎？",
        chat_placeholder: "輸入問題...",
        select_default: "請選擇..."
      },
      "en": {
        back_science: "Back to Natural Science",
        page_title: "UNIT SUMMARY",
        page_subtitle: "AI-Powered Analytics",
        settings_title: "Select Target Unit",
        settings_subtitle: "Initialize AI Analysis Protocol",
        label_stage: "Stage",
        label_publisher: "Publisher",
        label_grade: "Grade",
        label_semester: "Semester",
        label_unit: "Unit Name",
        btn_generate: "AI Organize Highlights",
        btn_txt: "EXPORT .TXT",
        title_summary: "Core Concepts",
        title_vocab: "Keywords",
        title_map: "Knowledge Graph",
        title_myth: "Myth Busting",
        db_loading: "System Check...",
        db_success: "System Online",
        db_fail: "Connection Failed",
        db_fail_retry: "Retry Connection",
        ai_generating: "PROCESSING DATA...",
        tap_to_zoom: "Tap to Zoom",
        myth_tip: "Think first",
        myth_true: "True",
        myth_false: "False",
        msg_correct: "Correct!",
        msg_wrong: "Incorrect",
        msg_seq: "Answer in order!",
        vocab_none: "No Data",
        summary_fail: "Generation Failed",
        map_fail: "Render Failed",
        map_none: "No Graph Data",
        myth_none: "No Myth Data",
        quiz: "Unit Quiz",
        quiz_prefix: "Quiz - {unit}",
        quiz_not_ready: "Quiz Not Ready",
        quiz_result_btn: "Results",
        quiz_next: "Next",
        quiz_score_title: "Final Score",
        quiz_ai_analyzing: "Analyzing...",
        quiz_result_text: "{correct} / {total} Correct",
        txt_need_generate: "Generate content first!",
        txt_download_fail: "Download Failed",
        ai_generate_fail: "Error: {msg}",
        api_format_error: "API Format Error",
        chat_greet: "Hi, I'm Xiaoke. How can I help with '{unit}'?",
        chat_placeholder: "Ask AI...",
        select_default: "Select..."
      },
      "zh-CN": {
        back_science: "返回自然科学",
        page_title: "单元重点整理",
        page_subtitle: "AI 驱动分析",
        settings_title: "选择学习单元",
        settings_subtitle: "初始化 AI 分析协定",
        label_stage: "学习阶段",
        label_publisher: "版本",
        label_grade: "年级",
        label_semester: "学期",
        label_unit: "单元名称",
        btn_generate: "AI 整理重点",
        btn_txt: "下载 TXT",
        title_summary: "核心概念摘要",
        title_vocab: "科学词汇与定义",
        title_map: "知识架构图",
        title_myth: "科学动动脑",
        db_loading: "系统连线中...",
        db_success: "资料库连线成功",
        db_fail: "连线失败",
        db_fail_retry: "连线失败，请重试",
        ai_generating: "正在处理数据...",
        tap_to_zoom: "点击放大",
        myth_tip: "先想一想，再作答",
        myth_true: "正确 O",
        myth_false: "错误 X",
        msg_correct: "恭喜答对了！",
        msg_wrong: "可惜答错了！",
        msg_seq: "请依照题号顺序作答！",
        vocab_none: "无词汇资料",
        summary_fail: "生成摘要失败...",
        map_fail: "架构图绘制失败",
        map_none: "无架构图数据",
        myth_none: "本单元暂无迷思概念题",
        quiz: "单元小测验",
        quiz_prefix: "单元小测验－{unit}",
        quiz_not_ready: "测验尚未准备好",
        quiz_result_btn: "看结果",
        quiz_next: "下一題",
        quiz_score_title: "测验成绩",
        quiz_ai_analyzing: "AI 分析中...",
        quiz_result_text: "答对 {correct} 题 / 共 {total} 题",
        txt_need_generate: "请先生成内容后再下载！",
        txt_download_fail: "下载失败",
        ai_generate_fail: "生成失败: {msg}",
        api_format_error: "API 格式错误",
        chat_greet: "你好，我是小科。关于“{unit}”，有什么我可以帮你的吗？",
        chat_placeholder: "输入问题...",
        select_default: "请选择..."
      },
      "ja": {
        back_science: "自然科学に戻る",
        page_title: "単元のまとめ",
        page_subtitle: "AI駆動分析",
        settings_title: "学習単元を選択",
        settings_subtitle: "AI分析プロトコル初期化",
        label_stage: "段階",
        label_publisher: "出版社",
        label_grade: "学年",
        label_semester: "学期",
        label_unit: "単元名",
        btn_generate: "AI 要点整理",
        btn_txt: "TXT出力",
        title_summary: "核心概念",
        title_vocab: "科学用語",
        title_map: "知識マップ",
        title_myth: "考えてみよう",
        db_loading: "システムチェック...",
        db_success: "オンライン",
        db_fail: "接続失敗",
        db_fail_retry: "再試行",
        ai_generating: "データ処理中...",
        tap_to_zoom: "拡大",
        myth_tip: "考えてから回答",
        myth_true: "正解",
        myth_false: "不正解",
        msg_correct: "正解です！",
        msg_wrong: "残念！",
        msg_seq: "順番に回答してください",
        vocab_none: "データなし",
        summary_fail: "生成失敗",
        map_fail: "描画失敗",
        map_none: "マップなし",
        myth_none: "データなし",
        quiz: "単元テスト",
        quiz_prefix: "テスト - {unit}",
        quiz_not_ready: "準備中",
        quiz_result_btn: "結果",
        quiz_next: "次へ",
        quiz_score_title: "スコア",
        quiz_ai_analyzing: "分析中...",
        quiz_result_text: "正解 {correct} / 全 {total}",
        txt_need_generate: "先に生成してください",
        txt_download_fail: "保存失敗",
        ai_generate_fail: "エラー: {msg}",
        api_format_error: "API形式エラー",
        chat_greet: "こんにちは、小科です。「{unit}」について何か聞きたいですか？",
        chat_placeholder: "質問を入力...",
        select_default: "選択..."
      }
    };

    let currentLang = "zh-TW";

    function t(key){
      return (translations[currentLang] && translations[currentLang][key]) ? translations[currentLang][key] : key;
    }

    function tf(key, vars={}){
      let s = t(key);
      Object.keys(vars).forEach(k => { s = s.replace(new RegExp("\\{"+k+"\\}","g"), String(vars[k])); });
      return s;
    }

    function changeLanguage(){
      const langSel = document.getElementById("language-selector");
      if (!langSel) return;
      currentLang = langSel.value;
      
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if(key) el.innerText = t(key);
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if(key) el.setAttribute("placeholder", t(key));
      });

      const selects = ["sel-stage", "sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
      selects.forEach(id => {
        const el = document.getElementById(id);
        if(el && el.options.length > 0 && el.options[0].disabled) {
           el.options[0].text = t('select_default'); 
        }
      });

      refreshQuizUIText();
      refreshMythUIText();
    }

    function refreshMythUIText(){
      document.querySelectorAll(".myth-option-btn").forEach(btn => {
         if(btn.id.includes("true")) btn.innerText = t("myth_true");
         if(btn.id.includes("false")) btn.innerText = t("myth_false");
      });
    }

    function refreshQuizUIText(){
      const quizTitleEl = document.getElementById("quiz-title");
      if (quizTitleEl){
        const unitName = (filters && filters.unitName) || (currentResultData && (currentResultData.unitName || (currentResultData.raw_content && currentResultData.raw_content.unitName))) || "";
        quizTitleEl.innerText = unitName ? tf("quiz_prefix",{unit:unitName}) : t("quiz");
      }
      const progress = document.getElementById("quiz-progress");
      if (progress){
        const total = (quizState.questions && quizState.questions.length) ? quizState.questions.length : 0;
        const n = (total > 0) ? (quizState.currentIndex + 1) : 0;
        progress.innerText = `${n} / ${total}`;
      }
      const btnMain = document.getElementById("quiz-main-btn");
      if (btnMain && !btnMain.classList.contains("hidden")){
        const total = (quizState.questions && quizState.questions.length) ? quizState.questions.length : 0;
        const isLast = (total > 0 && quizState.currentIndex === total - 1);
        btnMain.innerText = isLast ? t("quiz_result_btn") : t("quiz_next");
      }
      const empty = document.getElementById("quiz-empty");
      if (empty) empty.innerText = t("quiz_not_ready");
    }

    window.onload = async () => {
      currentLang = localStorage.getItem("slh_lang") || "zh-TW";
      const langSel = document.getElementById("language-selector");
      if(langSel) langSel.value = currentLang;
      changeLanguage();

      const user = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"Guest"}');
      const userInfo = document.getElementById("user-info");
      if (userInfo) userInfo.innerText = user.name;

      const selStage = document.getElementById("sel-stage");
      const dbStatus = document.getElementById("db-status");

      try {
        const res = await fetch(GAS_API_URL + "?action=get_metadata");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); }
        catch (parseError) {
          console.error("JSON Error:", text);
          throw new Error("Invalid JSON");
        }

        if(json.status === "success") {
          allData = json.data;
          if (dbStatus) {
            dbStatus.dataset.state = "success";
            dbStatus.innerHTML = `<i class="fa-solid fa-check mr-2"></i> ${t("db_success")}`;
            dbStatus.className = "text-xs font-mono font-bold text-emerald-400 mt-2 sm:mt-0 bg-emerald-900/20 px-3 py-1 rounded border border-emerald-900/50";
          }
          initSelectors();
        } else {
          throw new Error(json.message || "Status Fail");
        }
      } catch(e) {
        console.error("DB Load Fail:", e);
        if (dbStatus) {
          dbStatus.dataset.state = "fail";
          dbStatus.innerText = t("db_fail");
          dbStatus.className = "text-xs font-mono font-bold text-red-500 bg-red-900/20 px-3 py-1 rounded";
        }
        if (selStage) {
          selStage.innerHTML = `<option value="" disabled selected>${t("db_fail_retry")}</option>`;
          selStage.disabled = true;
        }
      }
    };

    function initSelectors() {
      const stages = [...new Set(allData.map(d => d.stage))];
      populate("sel-stage", stages);

      const ids = ["sel-stage", "sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
      ids.forEach((id, idx) => {
         const el = document.getElementById(id);
         if(el) el.onchange = (e) => {
             if(id === "sel-unit") {
                 filters.unitName = e.target.value;
                 const btn = document.getElementById("btn-generate");
                 if (btn) btn.disabled = false;
             } else {
                 updateLevel(idx + 1, e.target.value);
             }
         }
      });
    }

    function updateLevel(level, value) {
      if(level===1) filters={stage:value};
      if(level===2){filters.publisher=value; delete filters.grade; delete filters.semester; delete filters.unitName;}
      if(level===3){filters.grade=value; delete filters.semester; delete filters.unitName;}
      if(level===4){filters.semester=value; delete filters.unitName;}

      const ids=["sel-publisher","sel-grade","sel-semester","sel-unit"];
      for(let i=level; i<4; i++){
        const el = document.getElementById(ids[i]);
        if (el) {
          el.innerHTML = `<option disabled selected>${t("select_default")}</option>`;
          el.disabled = true;
        }
      }
      const btn = document.getElementById("btn-generate");
      if (btn) btn.disabled=true;

      const relevantData = allData.filter(d => {
        const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
        return safeMatch(d.stage, filters.stage) &&
               safeMatch(d.publisher, filters.publisher) &&
               safeMatch(d.grade, filters.grade) &&
               safeMatch(d.semester, filters.semester);
      });

      if(level===1) populate("sel-publisher", [...new Set(relevantData.map(d=>d.publisher))]);
      if(level===2) populate("sel-grade", [...new Set(relevantData.map(d=>d.grade))].sort((a,b)=>a-b), "grade");
      if(level===3) populate("sel-semester", [...new Set(relevantData.map(d=>d.semester))], "semester");
      if(level===4) {
        const unitSelect = document.getElementById("sel-unit");
        if (!unitSelect) return;
        unitSelect.innerHTML = `<option disabled selected>${t("select_default")}</option>`;
        if(relevantData.length>0) {
          relevantData.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.unitName;
            opt.text = (d.unitType && !isNaN(d.unitType)) ? `第${d.unitType}課 ${d.unitName}` : d.unitName;
            unitSelect.add(opt);
          });
          unitSelect.disabled=false;
        }
      }
    }

    function populate(id, list, type) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = `<option disabled selected>${t("select_default")}</option>`;
      list.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        if(type==="grade") opt.text = o + "年級";
        else if(type==="semester") opt.text = (o==="上" ? "上學期" : (o==="下" ? "下學期" : o));
        else opt.text = o;
        el.add(opt);
      });
      el.disabled=false;
    }

    async function startGeneration() {
      const selPanel = document.getElementById("selection-panel");
      const loading = document.getElementById("loading-view");
      if (selPanel) selPanel.classList.add("hidden");
      if (loading) { loading.classList.remove("hidden"); loading.classList.add("flex"); }

      try {
        const res = await fetch(GAS_API_URL, {
          method: "POST",
          body: JSON.stringify({ action: "get_content_and_generate", filters: filters })
        });

        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); }
        catch(parseError) { throw new Error(t("api_format_error")); }

        if(json.status === "success") {
          currentResultData = json.data;
          renderResult(json.data);
        } else {
          throw new Error(json.message || "Failed");
        }
      } catch(e) {
        alert(tf("ai_generate_fail",{msg:e.message}));
        const selPanelAgain = document.getElementById("selection-panel");
        if (selPanelAgain) selPanelAgain.classList.remove("hidden");
        const loadingAgain = document.getElementById("loading-view");
        if (loadingAgain) { loadingAgain.classList.add("hidden"); loadingAgain.classList.remove("flex"); }
        const btn = document.getElementById("btn-generate");
        if (btn) btn.disabled = false;
      }
    }

    // [修正] 高度同步函式：以摘要欄高度為基準
    function syncVocabHeight() {
        const summaryPanel = document.getElementById('summary-panel');
        const vocabPanel = document.getElementById('vocab-panel');
        
        if (summaryPanel && vocabPanel) {
            // 重置高度 (針對 RWD 切換時)
            vocabPanel.style.height = 'auto';
            
            // 手機版 (小於 768px) 為上下排列，不需要同步高度
            if (window.innerWidth < 768) return;

            // 1. 獲取摘要欄的實際內容高度
            const targetHeight = summaryPanel.offsetHeight;
            
            // 2. 強制設定詞彙欄高度與摘要欄一致
            vocabPanel.style.height = `${targetHeight}px`;
        }
    }

    function renderResult(data) {
      const raw = data.raw_content || {};

      const resultTitle = document.getElementById('result-title');
      if (resultTitle) {
        resultTitle.innerText = data.topic || data.unitName || raw.unitName || filters.unitName || 'Title';
      }

      const resultTag = document.getElementById('result-tag');
      if (resultTag) {
        const p = data.publisher || filters.publisher || '';
        const g = data.grade || filters.grade || '';
        const rawS = data.semester || filters.semester || '';
        let s = rawS;
        if (rawS === '上') s = '上學期'; else if (rawS === '下') s = '下學期';
        resultTag.innerText = `${p} ${g}年級 ${s}`;
      }

      const summaryBox = document.getElementById('summary-text');
      if (summaryBox) {
        let summaryContent = data.summary;
        if (summaryContent && typeof summaryContent === 'object') {
          summaryContent = summaryContent.summary_html || summaryContent.html || summaryContent.content || summaryContent.text || summaryContent.summary || '';
        }
        if (!summaryContent && raw.text_summary) summaryContent = raw.text_summary;
        summaryBox.innerHTML = summaryContent || t("summary_fail");
      }

      const keywordList = document.getElementById('keywords-list');
      if (keywordList) {
        keywordList.innerHTML = '';
        let kList = data.keywords || (data.summary && (data.summary.keywords || data.summary.vocab_list)) || raw.vocab_list || [];
        if (Array.isArray(kList) && kList.length > 0) {
          kList.forEach(k => {
            const term = typeof k === 'object' ? (k.term || k.word || '') : k;
            const def  = typeof k === 'object' ? (k.def || k.definition || '') : '';
            if (!term) return;
            const div = document.createElement('div');
            div.className = 'vocab-item p-3 rounded-lg mb-2';
            div.innerHTML = `<span class="font-bold text-cyan-600 text-base block mb-1">${term}</span><span class="text-xs text-slate-600 leading-relaxed block">${def}</span>`;
            keywordList.appendChild(div);
          });
        } else {
          keywordList.innerHTML = `<div class="text-slate-400 p-2 text-xs">${t("vocab_none")}</div>`;
          mythData = [];
        }
      }

      const chartDiv = document.getElementById('mermaid-chart');
      if (chartDiv) {
        let mapData = data.mindMap || (data.summary && (data.summary.mindMap || data.summary.mermaid)) || '';
        if (mapData && typeof mapData === 'string') {
          mapData = mapData.replace(/```mermaid/i, '').replace(/```/g, '').trim();
        }
        if (mapData) {
          chartDiv.innerHTML = `<div class="mermaid">${mapData}</div>`;
          try {
            mermaid.init(undefined, document.querySelectorAll('.mermaid')).then(() => {
              const svg = chartDiv.querySelector('svg');
              if (svg) {
                // [修正] 移除 inline style 讓 CSS 控制
                svg.removeAttribute('style'); 
                svg.removeAttribute('width'); 
                svg.removeAttribute('height');
                svg.style.fontFamily = '"Inter","Noto Sans TC", sans-serif';
              }
            });
          } catch (e) {
            console.error('Mermaid Error', e);
            chartDiv.innerText = t("map_fail");
          }
        } else {
          chartDiv.innerText = t("map_none");
        }
      }

      const mythListEl = document.getElementById('myth-list');
      if (mythListEl) {
        mythListEl.innerHTML = '';
        let mList = data.myths || (data.summary && data.summary.myths) || [];
        if (Array.isArray(mList) && mList.length > 0) {
          const limitedMyths = mList.slice(0, 10);
          mythData = limitedMyths;
          limitedMyths.forEach((m, index) => {
            const rawMyth = m.myth || m.misconception || '';
            let statement = m.question || rawMyth || '';
            statement = statement.replace(/^迷思[:：]\s*/,'').replace(/^常見想法[:：]\s*/,'').trim();
            const cardId = `myth-${index}`;
            const div = document.createElement('div');
            // [修正] 亮字 (text-white) 與深色背景
            div.className = 'bg-slate-800/80 p-5 rounded-xl border border-white/10 shadow-lg flex flex-col gap-4 backdrop-blur-sm transition hover:border-red-400/30';
            div.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-gradient-to-br from-red-500 to-orange-500 text-white text-xs font-bold shadow-sm">Q${index + 1}</span>
                  <span class="text-[10px] font-bold text-red-300 uppercase tracking-wider">Concept Check</span>
                </div>
              </div>
              <div class="text-base font-bold text-white leading-relaxed tracking-wide">${statement}</div>
              <div class="flex gap-3 mt-2">
                <button id="${cardId}-btn-true" onclick="answerMyth(${index}, true)" class="myth-option-btn flex-1 py-2.5 text-sm font-bold rounded-lg border border-slate-600 bg-slate-700/50 text-slate-200 hover:bg-slate-600 hover:text-white transition">${t("myth_true")}</button>
                <button id="${cardId}-btn-false" onclick="answerMyth(${index}, false)" class="myth-option-btn flex-1 py-2.5 text-sm font-bold rounded-lg border border-slate-600 bg-slate-700/50 text-slate-200 hover:bg-slate-600 hover:text-white transition">${t("myth_false")}</button>
              </div>
              <div id="${cardId}-feedback" class="mt-2 hidden text-sm leading-relaxed rounded-lg p-4 bg-slate-900/80 border border-slate-700 text-slate-200 shadow-inner"></div>
            `;
            mythListEl.appendChild(div);
          });
        } else {
          mythListEl.innerHTML = `<div class="text-slate-400 p-2 text-xs">${t("myth_none")}</div>`;
          mythData = [];
        }
      }

      const quizRaw = data.quiz || (data.summary && data.summary.quiz) || [];
      initQuiz(quizRaw);

      const loadingView = document.getElementById('loading-view');
      const contentView = document.getElementById('content-view');
      if (loadingView) { loadingView.classList.add('hidden'); loadingView.classList.remove('flex'); }
      if (contentView) { contentView.classList.remove('hidden'); }
      const btn = document.getElementById('btn-generate');
      if (btn) btn.disabled = false;
      const chatBtn = document.getElementById('floating-chat');
      if (chatBtn) chatBtn.classList.remove('hidden');
      
      changeLanguage();
      
      // [修正] 觸發高度同步
      setTimeout(syncVocabHeight, 200);
      window.addEventListener('resize', syncVocabHeight);
    }

    function downloadTXT() {
      if (!currentResultData) { alert(t("txt_need_generate")); return; }
      const stage = filters.stage || (currentResultData && currentResultData.stage) || "";
      const publisher= filters.publisher || (currentResultData && currentResultData.publisher) || "";
      const grade = filters.grade || (currentResultData && currentResultData.grade) || "";
      const semRaw = filters.semester || (currentResultData && currentResultData.semester) || "";
      const unitName = (currentResultData.raw_content ? currentResultData.raw_content.unitName : filters.unitName) || "";
      let semesterLabel = semRaw === "上" ? "上學期" : (semRaw === "下" ? "下學期" : semRaw);

      let content = `【單元來源資訊】\n--------------------\n學習階段：${stage}\n版本：${publisher}\n年級：${grade}年級\n學期：${semesterLabel}\n單元名稱：${unitName}\n\n`;
      const summaryEl = document.getElementById("summary-text");
      content += `【一、核心概念摘要】\n--------------------\n${summaryEl ? summaryEl.innerText.replace(/\n\s*\n/g, "\n\n").trim() : ""}\n\n`;

      content += `【二、科學詞彙與定義】\n--------------------\n`;
      let vList = currentResultData.keywords || (currentResultData.summary ? (currentResultData.summary.keywords || currentResultData.summary.vocab_list) : []) || [];
      if (Array.isArray(vList) && vList.length > 0) {
        vList.forEach((v, i) => { content += `${i + 1}. ${v.term || v}\n   說明：${v.def || ""}\n\n`; });
      } else { content += "無詞彙資料\n\n"; }

      content += `【三、科學動動腦】\n--------------------\n`;
      let mList = currentResultData.myths || (currentResultData.summary ? currentResultData.summary.myths : []) || [];
      if (Array.isArray(mList) && mList.length > 0) {
        mList.forEach((m, i) => {
           content += `● 題目 ${i + 1}：${(m.question || m.myth || "").replace(/^迷思[:：]\s*/, "")}\n   正確觀念：${m.correct || m.explanation || ""}\n\n`; 
        });
      } else { content += "無題目\n"; }

      try {
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `${unitName || "unit"}_重點整理.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (e) { alert(t("txt_download_fail")); }
    }

    async function sendChatMessage() {
      const input = document.getElementById("chat-input");
      if (!input) return;
      const msg = input.value.trim();
      if(!msg) return;
      const chatBody = document.getElementById("chat-messages");
      if (chatBody) {
        chatBody.innerHTML += `<div class="chat-bubble-user self-end p-3 shadow-sm max-w-[85%] ml-auto text-sm mb-2">${msg}</div>`;
        chatBody.scrollTop = chatBody.scrollHeight;
      }
      input.value = "";
      try {
        const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"Visitor"}');
        const contextText = currentResultData ? (currentResultData.raw_content ? currentResultData.raw_content.text : "") : "";
        const contextVocab = currentResultData ? (currentResultData.raw_content ? currentResultData.raw_content.vocab_str : "") : "";
        const res = await fetch(GAS_API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'chat_with_ai', message: msg, currentUnit: filters.unitName || "",
            contextText: contextText, contextVocab: contextVocab, userName: currentUser.name,
            stage: filters.stage, publisher: filters.publisher, grade: filters.grade, semester: filters.semester
          })
        });
        const json = await res.json();
        const cleanReply = (json.data || "").replace(/\*\*/g, "");
        if (chatBody) {
          chatBody.innerHTML += `
            <div class="chat-bubble-ai self-start p-3 shadow-sm max-w-[85%] text-sm mb-2">
              <span class="font-bold text-cyan-400 block mb-1 text-xs tracking-wider">AI TUTOR</span>
              ${cleanReply}
            </div>`;
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      } catch(e) { console.error(e); }
    }

    function openModal() {
      const chartDiv = document.getElementById("mermaid-chart");
      if (!chartDiv || !chartDiv.innerHTML.trim() || chartDiv.innerText.includes("錯誤")) return;
      const modal = document.getElementById("image-modal");
      const content = document.getElementById("modal-content");
      if (!modal || !content) return;
      content.innerHTML = chartDiv.innerHTML;
      const svg = content.querySelector("svg");
      if (svg) { 
          // [修正] 確保 Modal 內的 SVG 可見且放大
          svg.removeAttribute("style"); 
          svg.style.width = "100%"; 
          svg.style.height = "auto";
          svg.style.minWidth = "800px"; // 強制最小寬度
          svg.style.backgroundColor = "transparent"; // 由 Modal 背景控制
      }
      modal.classList.remove("hidden"); modal.classList.add("flex");
    }
    function closeModal() {
      const modal = document.getElementById("image-modal");
      if (!modal) return;
      modal.classList.add("hidden"); modal.classList.remove("flex");
    }

    function answerMyth(index, chooseTrue) {
      if (!Array.isArray(mythData) || !mythData[index]) return;
      try {
        let firstUnanswered = -1;
        for (let i = 0; i < mythData.length; i++) {
          const fb = document.getElementById(`myth-${i}-feedback`);
          if (fb && fb.dataset.answered !== "1") { firstUnanswered = i; break; }
        }
        if (firstUnanswered !== -1 && index !== firstUnanswered) { alert(t("msg_seq")); return; }
      } catch (e) {}

      const cardId = `myth-${index}`;
      const btnTrue = document.getElementById(`${cardId}-btn-true`);
      const btnFalse = document.getElementById(`${cardId}-btn-false`);
      const feedback = document.getElementById(`${cardId}-feedback`);
      if (!btnTrue || !btnFalse || !feedback) return;
      if (feedback.dataset.answered === "1") return;
      feedback.dataset.answered = "1";

      const correct = mythData[index].correct || mythData[index].explanation || '';
      const isTrueFlag = (typeof mythData[index].isTrue === "boolean") ? mythData[index].isTrue : null;
      let isCorrectChoice;
      if (isTrueFlag === null) isCorrectChoice = !chooseTrue;
      else isCorrectChoice = (chooseTrue === isTrueFlag);

      [btnTrue, btnFalse].forEach(btn => btn.classList.add("opacity-50"));
      if (chooseTrue) btnTrue.classList.remove("opacity-50"); else btnFalse.classList.remove("opacity-50");

      feedback.innerHTML = isCorrectChoice ? 
        `<div class="font-bold text-emerald-400 mb-2 flex items-center gap-2"><i class="fa-solid fa-circle-check"></i> ${t("msg_correct")}</div><div class="text-slate-300 pl-6 border-l-2 border-emerald-500/30">${correct}</div>` : 
        `<div class="font-bold text-red-400 mb-2 flex items-center gap-2"><i class="fa-solid fa-circle-xmark"></i> ${t("msg_wrong")}</div><div class="text-slate-300 pl-6 border-l-2 border-red-500/30">${correct}</div>`;
      feedback.classList.remove("hidden");
    }

    function initQuiz(quizRaw) {
      const quizPanel = document.getElementById("quiz-panel");
      const quizBody = document.getElementById("quiz-body");
      const quizEmpty = document.getElementById("quiz-empty");
      const quizTitleEl = document.getElementById("quiz-title");

      if (!quizPanel || !quizBody || !quizEmpty || !quizTitleEl) return;
      const unitName = (filters && filters.unitName) || (currentResultData && (currentResultData.unitName || (currentResultData.raw_content && currentResultData.raw_content.unitName))) || "";
      quizTitleEl.innerText = unitName ? tf("quiz_prefix",{unit:unitName}) : t("quiz");

      const sourceArray = Array.isArray(quizRaw) ? quizRaw.slice(0, 10) : [];
      if (!Array.isArray(sourceArray) || sourceArray.length === 0) {
        quizState.questions = []; quizState.currentIndex = 0; quizState.hasAnswered = false; quizState.answers = [];
        quizBody.classList.add("hidden"); quizEmpty.classList.remove("hidden");
        return;
      }
      quizState.questions = sourceArray.map((q, idx) => {
        let correctIndex = -1;
        if (typeof q.correctIndex === "number") correctIndex = q.correctIndex;
        else if (typeof q.answerIndex === "number") correctIndex = q.answerIndex;
        else if (typeof q.correct === "number") correctIndex = q.correct;
        else if (typeof q.ans === "number") correctIndex = q.ans;
        else if (typeof q.answer === "string") {
          const map = { "A": 0, "B": 1, "C": 2, "D": 3 };
          const key = q.answer.trim().toUpperCase()[0];
          if (map[key] !== undefined) correctIndex = map[key];
        }
        return { id: q.id || `Q${idx+1}`, stem: q.stem||q.question||q.text||`Q${idx+1}`, options: q.options||q.choices||[], correctIndex, explanation: q.explanation||"", concept: q.concept||`Q${idx+1}` };
      });
      quizState.currentIndex = 0; quizState.hasAnswered = false; quizState.answers = [];
      quizEmpty.classList.add("hidden"); quizBody.classList.remove("hidden");
      renderQuizQuestion();
    }

    function renderQuizQuestion() {
      const q = quizState.questions[quizState.currentIndex];
      const quizQuestionEl = document.getElementById("quiz-question");
      const quizOptionsEl = document.getElementById("quiz-options");
      const quizFeedbackEl = document.getElementById("quiz-feedback");
      const quizProgressEl = document.getElementById("quiz-progress");
      const btnMain = document.getElementById("quiz-main-btn");

      if (!q || !quizQuestionEl) return;
      const total = quizState.questions.length;
      const index = quizState.currentIndex;

      quizQuestionEl.innerHTML = `<span class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Question ${index+1}</span>${q.stem}`;
      quizOptionsEl.innerHTML = "";
      quizFeedbackEl.classList.add("hidden"); quizFeedbackEl.innerHTML = "";
      quizState.hasAnswered = false;

      const letters = ["A","B","C","D","E"];
      q.options.forEach((opt, optIndex) => {
        const btn = document.createElement("button");
        btn.type = "button";
        // [修正] 優化測驗選項按鈕樣式
        btn.className = "quiz-option-btn w-full text-left px-5 py-4 text-base rounded-xl border border-slate-600 bg-slate-700/40 text-slate-100 font-medium flex items-center hover:bg-slate-700/60 hover:border-cyan-400/50 transition-all group";
        btn.setAttribute("data-opt-index", optIndex);
        btn.onclick = () => handleQuizAnswer(optIndex);
        btn.innerHTML = `<span class="w-8 h-8 rounded-full bg-slate-800 text-slate-300 text-sm font-bold flex items-center justify-center mr-4 border border-slate-600 group-hover:border-cyan-400/50 transition-colors">${letters[optIndex]||""}</span>${opt}`;
        quizOptionsEl.appendChild(btn);
      });

      quizProgressEl.innerText = `${index+1} / ${total}`;
      btnMain.disabled = true;
      btnMain.innerText = (index === total - 1) ? t("quiz_result_btn") : t("quiz_next");
    }

    function handleQuizAnswer(selectedIndex) {
      if (quizState.hasAnswered) return;
      const q = quizState.questions[quizState.currentIndex];
      const quizOptionsEl = document.getElementById("quiz-options");
      const quizFeedbackEl = document.getElementById("quiz-feedback");
      const buttons = Array.from(quizOptionsEl.querySelectorAll("button.quiz-option-btn"));
      const correctIndex = q.correctIndex;
      let isCorrect = (selectedIndex === correctIndex && correctIndex >= 0);

      quizState.answers[quizState.currentIndex] = { correct: isCorrect, concept: q.concept };
      buttons.forEach(btn => btn.disabled = true);

      if (isCorrect) {
        buttons[selectedIndex].classList.add("selected-correct");
        // [修正] 優化測驗回饋樣式
        quizFeedbackEl.className = "mt-6 text-sm rounded-xl p-5 bg-emerald-900/40 border border-emerald-500/50 text-emerald-100 shadow-lg backdrop-blur-sm";
        quizFeedbackEl.innerHTML = `<div class="font-bold flex items-center gap-3 text-lg mb-2"><i class="fa-solid fa-circle-check text-emerald-400"></i> ${t("msg_correct")}</div><div class="mt-2 opacity-90 leading-relaxed pl-8 border-l-2 border-emerald-500/30">${q.explanation}</div>`;
      } else {
        buttons[selectedIndex].classList.add("selected-wrong");
        if(correctIndex >= 0 && buttons[correctIndex]) buttons[correctIndex].classList.add("selected-correct");
        quizFeedbackEl.className = "mt-6 text-sm rounded-xl p-5 bg-red-900/40 border border-red-500/50 text-red-100 shadow-lg backdrop-blur-sm";
        quizFeedbackEl.innerHTML = `<div class="font-bold flex items-center gap-3 text-lg mb-2"><i class="fa-solid fa-circle-xmark text-red-400"></i> ${t("msg_wrong")}</div><div class="mt-2 opacity-90 leading-relaxed pl-8 border-l-2 border-red-500/30">${q.explanation}</div>`;
      }
      quizFeedbackEl.classList.remove("hidden");
      quizState.hasAnswered = true;
      document.getElementById("quiz-main-btn").disabled = false;
      try { submitQuizLog(q, selectedIndex, correctIndex, isCorrect); } catch (e) {}
    }

    function submitQuizLog(question, selectedIndex, correctIndex, isCorrect) {
      const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"訪客"}');
      const payload = {
        action: "log_quiz_answer", userName: currentUser.name,
        stage: filters.stage, publisher: filters.publisher, grade: filters.grade, semester: filters.semester,
        unitName: (filters && filters.unitName) || "",
        questionId: question.id, questionIndex: quizState.currentIndex + 1, questionText: question.stem,
        studentAnswer: selectedIndex.toString(), correctAnswer: correctIndex.toString(), isCorrect: isCorrect ? "1" : "0"
      };
      const params = new URLSearchParams(payload);
      fetch(`${GAS_API_URL}?${params.toString()}`).catch(err => {});
    }

    function handleQuizMainButton() {
      if (!quizState.questions.length) return;
      if (!quizState.hasAnswered) return;
      const isLast = (quizState.currentIndex === quizState.questions.length - 1);
      if (isLast) renderQuizResult();
      else { quizState.currentIndex += 1; renderQuizQuestion(); }
    }

    function renderQuizResult() {
      const totalQ = quizState.questions.length;
      const resultBox = document.getElementById("quiz-result");
      const scoreNumberEl = document.getElementById("quiz-score-number");
      const resultTextEl = document.getElementById("quiz-result-text");
      const detailEl = document.getElementById("quiz-result-detail");
      const canvas = document.getElementById("quiz-radar");
      
      document.getElementById("quiz-body").classList.add("hidden");
      document.getElementById("quiz-progress").parentElement.classList.add("hidden"); 
      resultBox.classList.remove("hidden");

      const answered = quizState.answers.filter(a => a);
      const correctCount = answered.filter(a => a.correct).length;
      const score = Math.round((correctCount / totalQ) * 100);

      scoreNumberEl.innerText = score;
      resultTextEl.innerText = `${correctCount} / ${totalQ}`;

      const conceptStats = {};
      quizState.questions.forEach((q, idx) => {
        const concept = q.concept || `Q${idx + 1}`;
        if (!conceptStats[concept]) conceptStats[concept] = { total: 0, correct: 0 };
        conceptStats[concept].total += 1;
        if (quizState.answers[idx] && quizState.answers[idx].correct) conceptStats[concept].correct += 1;
      });
      const concepts = Object.keys(conceptStats);
      const conceptScores = concepts.map(c => Math.round((conceptStats[c].correct / conceptStats[c].total) * 100));

      const ctx = canvas.getContext("2d");
      if (quizRadarChart) quizRadarChart.destroy();
      quizRadarChart = new Chart(ctx, {
        type: "bar",
        data: { labels: concepts, datasets: [{ label: "Accuracy (%)", data: conceptScores, backgroundColor: '#34d399', borderRadius: 6, barThickness: 24 }] },
        options: {
          responsive: true, maintainAspectRatio: false, indexAxis: "y",
          scales: { 
              x: { min: 0, max: 100, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8', font: {family: "'Orbitron', sans-serif"} } }, 
              y: { grid: { display: false }, ticks: { color: '#e2e8f0', font: {family: "'Noto Sans TC', sans-serif", weight: 'bold'} } } 
          },
          plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', titleColor: '#22d3ee', bodyColor: '#e2e8f0', padding: 12, cornerRadius: 8 } }
        }
      });
      
      const scoreLabel = document.getElementById("quiz-score-label");
      scoreLabel.innerText = t("quiz_ai_analyzing");
      detailEl.innerHTML = `<div class="flex items-center gap-3 text-cyan-400"><i class="fa-solid fa-microchip fa-spin"></i> ${t("ai_generating")}</div>`;
      
      const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"Visitor"}');
      const raw = currentResultData && currentResultData.raw_content ? currentResultData.raw_content : {};
      const payload = {
         action: "quiz_ai_summary", userName: currentUser.name,
         stage: filters.stage, publisher: filters.publisher, grade: filters.grade, semester: filters.semester, unitName: filters.unitName,
         score: score, totalQuestions: totalQ, totalCorrect: correctCount, concepts: concepts, conceptScores: conceptScores,
         answers: quizState.questions.map((q,i)=>({index:i+1, concept: q.concept, correct: quizState.answers[i]?.correct})),
         contextText: raw.text||"", contextVocab: raw.vocab_str||""
      };

      fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
      .then(res => res.text())
      .then(text => {
        let json; try { json = JSON.parse(text); } catch(e){ json = {data: text}; }
        let d = json.data || json.summary || json.text || json;
        if (typeof d === "object") d = (d.summary || "") + "<br><br>" + (d.detail || "");
        detailEl.innerHTML = d || t("quiz_ai_fallback1");
        scoreLabel.innerText = "Analysis Complete";
      })
      .catch(() => {
        detailEl.innerText = t("quiz_ai_fallback2");
        scoreLabel.innerText = "Offline";
      });
    }
  </script>
</body>
</html>
