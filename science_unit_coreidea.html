<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI School | ç§‘å­¸é›™èªé–±è®€</title>
    
    <script>
        // é–‹ç™¼éšæ®µæš«æ™‚è¨»è§£ï¼Œä¸Šç·šå‰è«‹æ‰“é–‹
        /*
        if (!sessionStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }
        */
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                        heading: ['Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        student: {
                            bg: '#0B1121',
                            card: '#1E293B',
                            english: '#4ade80',
                            highlight: '#f472b6',
                            term: '#fbbf24'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 1. åŸºç¤èˆ‡èƒŒæ™¯ */
        body { 
            background-color: #0B1121; 
            color: #f1f5f9; 
            overflow: hidden; 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body::before {
            content: '';
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(30, 58, 138, 0.15), transparent 60%);
            z-index: -2; pointer-events: none;
        }

        /* 2. ç»ç’ƒé¢æ¿ */
        .glass-panel { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); 
            border-radius: 1.5rem; 
        }

        /* 3. æ²è»¸ç¾åŒ– (è¶…ç´°ç·»ç‰ˆ) */
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-track { background: transparent; }
        .scroll-area::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 99px; }
        .scroll-area::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* 4. å´é‚Šé¸å–® */
        .nav-item { 
            transition: all 0.2s ease; cursor: pointer; padding: 1rem 1.2rem; 
            margin-bottom: 0.5rem; font-size: 0.95rem; color: #94a3b8; 
            border-radius: 1rem; font-weight: 500; display: flex; align-items: center;
        }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: #fff; transform: translateX(4px); }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(74, 222, 128, 0.15), transparent); 
            color: #4ade80; font-weight: 700; box-shadow: inset 3px 0 0 #4ade80; 
        }

        /* 5. æ‘˜è¦å¡ç‰‡ (é‡é»è¨­è¨ˆï¼šå¤šå½©å¡ç‰‡) */
        .summary-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        /* å¡ç‰‡å·¦å´çš„å½©è‰²æ¢ (ç”± JS å‹•æ…‹ä¸Šè‰²) */
        .summary-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--card-color, #4ade80);
            box-shadow: 0 0 10px var(--card-color, #4ade80);
        }

        /* 6. æ–‡å­—æ¨£å¼å„ªåŒ– */
        .en-text { font-size: 1.15rem; color: #cbd5e1; line-height: 1.6; margin-bottom: 0.8rem; font-weight: 600; cursor: pointer; transition: color 0.3s; }
        .en-text:hover { color: #fff; }
        .zh-text { font-size: 1.05rem; color: #94a3b8; line-height: 1.8; cursor: pointer; font-weight: 400; transition: color 0.3s; }
        .zh-text:hover { color: #fff; }

        /* æœ—è®€ä¸­çš„é«˜äº®æ•ˆæœ */
        .reading-active {
            background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent) !important;
            border-color: var(--card-color, #f472b6) !important;
        }
        .reading-active .en-text { color: var(--card-color, #f472b6) !important; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .reading-active .zh-text { color: #fff !important; }

        /* 7. ç§‘å­¸è©å½™ (å»é™¤é†œåº•ç·šï¼Œæ”¹ç‚ºé«˜ç´šé«˜äº®) */
        .sci-term { 
            color: var(--card-color, #f472b6); /* è·Ÿéš¨å¡ç‰‡é¡è‰² */
            font-weight: 700; 
            cursor: pointer; 
            padding: 0 2px;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            border-bottom: none !important; /* ç§»é™¤åº•ç·š */
        }
        .sci-term:hover { 
            color: #fff; 
            background: var(--card-color, #f472b6);
            border-radius: 4px;
            box-shadow: 0 0 10px var(--card-color, #f472b6);
        }

        /* 8. è©å½™æ¬„ (è·Ÿéš¨é«˜åº¦ + å…§éƒ¨æ²å‹•) */
        #vocab-column {
            /* é—œéµï¼šè®“å®ƒå¡«å……çˆ¶å®¹å™¨é«˜åº¦ï¼Œä½†å…§å®¹éå¤šæ™‚æ²å‹• */
            height: 100%; 
            overflow-y: auto;
            max-height: calc(100vh - 200px); /* é˜²çˆ†ç‰ˆ */
        }
        .vocab-card-item {
            background: rgba(0,0,0,0.2);
            border-radius: 12px; margin-bottom: 8px; padding: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
        }
        .vocab-card-item:hover {
            border-color: rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
        }

        /* 9. çŸ¥è­˜åœ–è­œ Modal (æ»¿ç‰ˆæ·±è‰²) */
        #graph-modal {
            position: fixed; inset: 0; z-index: 100;
            background: #0B1121; /* ç´”æ·±è‰²èƒŒæ™¯ */
            display: none; flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        #graph-container { flex-grow: 1; width: 100%; height: 100%; }
        #graph-close {
            position: absolute; top: 20px; right: 20px; z-index: 101;
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(255,255,255,0.1); color: #fff;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
            font-size: 1.5rem; transition: all 0.2s;
        }
        #graph-close:hover { background: #ef4444; border-color: #ef4444; transform: rotate(90deg); }

        /* ä¸‹æ‹‰é¸å–® UI å„ªåŒ– */
        .student-select-wrapper {
            position: relative; display: flex; align-items: center;
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 99px; padding: 0 14px; height: 40px;
            transition: all 0.3s; cursor: pointer; min-width: max-content; 
        }
        .student-select-wrapper:hover { background-color: rgba(255, 255, 255, 0.15); border-color: #4ade80; }
        .student-select-icon { color: #4ade80; font-size: 0.875rem; margin-right: 8px; pointer-events: none; }
        .student-select {
            appearance: none; background: transparent; border: none; color: #fff; 
            font-size: 0.875rem; font-weight: 600; padding: 0 24px 0 0; width: 100%; height: 100%;
            cursor: pointer; outline: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right center; background-repeat: no-repeat; background-size: 0.85em;
        }
        .student-select option { background-color: #1E293B; color: #fff; padding: 10px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æ’­æ”¾å™¨ */
        .player-dock { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; padding: 0.75rem 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-teal-500/30 selection:text-white">

    <div id="loader-overlay" class="absolute inset-0 bg-[#0B1121] z-50 flex flex-col items-center justify-center">
        <div class="relative">
            <div class="absolute inset-0 bg-green-400 blur-xl opacity-20 rounded-full animate-pulse"></div>
            <i class="fa-solid fa-rocket text-6xl text-green-400 relative z-10 animate-bounce"></i>
        </div>
        <div class="text-green-400 tracking-widest mt-6 font-bold text-lg">è¼‰å…¥ç§‘å­¸å®‡å®™...</div>
    </div>

    <div id="graph-modal">
        <button id="graph-close" onclick="closeGraph()"><i class="fa-solid fa-xmark"></i></button>
        <div id="graph-container"></div>
        <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 bg-black/50 px-6 py-2 rounded-full text-white/70 text-sm backdrop-blur-md pointer-events-none">
            <i class="fa-solid fa-mouse-pointer mr-2"></i>æ»¾è¼ªç¸®æ”¾ Â· æ‹–æ›³ç§»å‹• Â· é›™æ“Šç¯€é»èšç„¦
        </div>
    </div>

    <nav class="sticky top-4 z-40 px-4 flex flex-col md:flex-row items-center gap-3 shrink-0 pointer-events-none">
        <div class="glass-panel px-4 py-2 flex items-center gap-4 pointer-events-auto shadow-lg">
            <button onclick="goBack()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-green-400 hover:text-white transition group">
                <i class="fa-solid fa-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i>
            </button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400">
                    <i class="fa-solid fa-atom text-lg"></i>
                </div>
                <span class="text-lg font-black text-white tracking-wide" data-i18n="page_title">AI School</span>
            </div>
        </div>

        <div class="flex-grow flex flex-wrap gap-2 justify-end pointer-events-auto">
            <div class="student-select-wrapper w-auto">
                <i class="fa-solid fa-globe student-select-icon"></i>
                <select id="sel-lang" class="student-select" onchange="changeLanguage(this.value)">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                </select>
            </div>
            <div class="student-select-wrapper w-32"><select id="sel-stage" class="student-select" onchange="filterUnits('stage')"><option disabled selected data-i18n="stage">éšæ®µ</option></select></div>
            <div class="student-select-wrapper w-28"><select id="sel-grade" class="student-select" onchange="filterUnits('grade')" disabled><option disabled selected data-i18n="grade">å¹´ç´š</option></select></div>
            <div class="student-select-wrapper w-32"><select id="sel-version" class="student-select" onchange="filterUnits('version')" disabled><option disabled selected data-i18n="version">ç‰ˆæœ¬</option></select></div>
            <div class="student-select-wrapper w-28"><select id="sel-semester" class="student-select" onchange="filterUnits('semester')" disabled><option disabled selected data-i18n="semester">å­¸æœŸ</option></select></div>
            <div class="student-select-wrapper flex-grow md:w-auto min-w-[180px]"><select id="sel-unit" class="student-select" onchange="loadSelectedUnit()" disabled><option disabled selected data-i18n="unit">é¸æ“‡å–®å…ƒ</option></select></div>
        </div>
    </nav>

    <div class="flex-grow flex overflow-hidden p-4 gap-4 relative z-10 mt-2">
        
        <aside class="w-64 glass-panel flex flex-col overflow-hidden hidden md:flex">
            <div class="p-5 border-b border-white/10 bg-black/20">
                <h3 class="text-xs font-bold text-green-400 tracking-widest mb-1 uppercase" data-i18n="nav">MENU</h3>
                <div class="text-white font-bold text-lg truncate" id="nav-title">è«‹é¸æ“‡å–®å…ƒ</div>
            </div>
            <div class="flex-grow scroll-area overflow-y-auto p-3" id="unit-list">
                <div class="text-center text-slate-500 text-sm mt-10 p-4" data-i18n="select_hint">ğŸ‘ˆ è«‹å…ˆä¸Šæ–¹é¸æ“‡å–®å…ƒ</div>
            </div>
        </aside>

        <div class="flex-grow flex gap-4 overflow-hidden relative">
            
            <section class="flex-1 glass-panel flex flex-col relative overflow-hidden" style="min-width: 0;">
                <div class="h-14 border-b border-white/10 bg-black/20 flex items-center justify-between px-6 gap-3 shrink-0">
                    <div class="flex items-center gap-2 min-w-0">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                        <span class="text-xs font-bold text-green-200 truncate" id="status-bar">READY</span>
                        <span id="trans-loading" class="hidden text-xs text-green-400 flex items-center gap-1 ml-2"><div class="loader w-3 h-3"></div> ç¿»è­¯ä¸­...</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="openGraph()" class="px-3 py-1.5 text-xs font-bold rounded-full bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500 hover:text-white border border-indigo-500/30 transition flex items-center gap-1">
                            <i class="fa-solid fa-share-nodes"></i> çŸ¥è­˜åœ–è­œ
                        </button>
                        <div class="flex bg-black/30 rounded-full p-1 border border-white/10">
                            <button onclick="setMode('en')" class="px-3 py-1 text-xs font-bold rounded-full text-slate-400 hover:text-white transition" id="btn-en">EN</button>
                            <button onclick="setMode('dual')" class="px-3 py-1 text-xs font-bold rounded-full bg-green-500 text-white shadow-lg" id="btn-dual">é›™èª</button>
                            <button onclick="setMode('zh')" class="px-3 py-1 text-xs font-bold rounded-full text-slate-400 hover:text-white transition" id="btn-zh">ä¸­æ–‡</button>
                        </div>
                    </div>
                </div>

                <div class="flex-grow scroll-area overflow-y-auto p-6 md:p-8 pb-32" id="reading-container">
                    <article class="max-w-4xl mx-auto transition-opacity duration-500" id="article-body">
                        <h1 class="text-3xl md:text-4xl font-black text-white mb-8 text-center" id="article-title">
                            <span class="text-slate-500 opacity-30 text-2xl">ç­‰å¾…æ¢ç´¢...</span>
                        </h1>
                        <div id="article-content" class="space-y-6"></div>
                    </article>
                </div>
            </section>

            <aside class="w-80 glass-panel flex flex-col overflow-hidden hidden lg:flex shrink-0">
                <div class="p-5 border-b border-white/10 bg-gradient-to-r from-yellow-500/10 to-transparent shrink-0">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fa-solid fa-lightbulb text-yellow-400"></i>
                        <h3 class="text-sm font-bold text-yellow-400 tracking-widest" data-i18n="vocab_title">ç§‘å­¸è©å½™åº«</h3>
                    </div>
                </div>
                <div class="flex-grow scroll-area p-3" id="vocab-column">
                    <div id="vocab-container">
                        <div class="text-center py-10 opacity-30 text-sm text-white" data-i18n="vocab_empty">è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="control-dock" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-[95%] max-w-lg">
        <div class="player-dock flex items-center justify-between gap-4">
            <div class="flex flex-col items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">SPEED</span>
                <select id="play-rate" class="appearance-none bg-transparent text-green-400 font-black text-lg text-center outline-none cursor-pointer w-12 hover:scale-110 transition">
                    <option value="0.5">0.5</option>
                    <option value="0.75">0.75</option>
                    <option value="1.0" selected>1.0</option>
                    <option value="1.25">1.25</option>
                    <option value="1.5">1.5</option>
                </select>
            </div>
            <div class="flex items-center gap-6">
                <div class="flex bg-white/10 rounded-full p-1 gap-1">
                    <button onclick="setVoice('male')" id="btn-male" class="w-9 h-9 rounded-full flex items-center justify-center transition text-slate-400 hover:text-white"><i class="fa-solid fa-person text-lg"></i></button>
                    <button onclick="setVoice('female')" id="btn-female" class="w-9 h-9 rounded-full flex items-center justify-center transition bg-green-500 text-white shadow-lg"><i class="fa-solid fa-person-dress text-lg"></i></button>
                </div>
                <button onclick="toggleSpeech()" class="w-16 h-16 flex items-center justify-center rounded-full bg-white text-black hover:scale-105 active:scale-95 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]" id="btn-play">
                    <i class="fa-solid fa-play text-2xl ml-1"></i>
                </button>
                <button onclick="stopSpeech()" class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-slate-600 text-slate-400 hover:border-red-500 hover:text-red-500 transition">
                    <i class="fa-solid fa-stop text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 border border-green-500/30 text-green-100 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 -translate-y-10 z-50 flex items-center gap-3 pointer-events-none text-sm font-bold backdrop-blur-md">
        <i class="fa-solid fa-circle-check text-green-400 text-lg"></i> <span id="toast-msg">Ready</span>
    </div>

    <script>
        // è¨­å®šæª”èˆ‡è®Šæ•¸
        const SHEET_ID = '1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk';
        const TARGET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbgkNiMflfeLQd3KN8F4yjjIr6G2flnCAy-nUPMiC7_xDfdg_0hJ2Qzbsr92u8htlPLFR8GwwQPK_g/pub?gid=0&single=true&output=csv';
        const COL_STAGE=0, COL_VERSION=2, COL_GRADE=3, COL_SEMESTER=4, COL_UNIT_NUM=6, COL_UNIT_NAME=7, COL_CONTENT=8, COL_CKIP=9, COL_VOCAB=18;
        
        let rawData=[], processedUnits=[], isSpeaking=false, currentVoice='female', translationCache={}, synth=window.speechSynthesis;
        let activeVocabMap = {};
        let currentBlockIndex = 0;
        let currentUnitTitleZh = "", currentUnitTitleEn = "";
        let currentLang = localStorage.getItem('appLang') || 'zh-TW';
        let network = null; // Graph instance

        // é®®æ˜çš„é…è‰²ç›¤ (ç”¨æ–¼å¡ç‰‡èˆ‡ç¯€é»)
        const colorPalette = [
            '#f472b6', // Pink
            '#34d399', // Emerald
            '#60a5fa', // Blue
            '#fbbf24', // Amber
            '#a78bfa', // Purple
            '#f87171'  // Red
        ];

        const i18n = {
            'zh-TW': { page_title: 'AI School', nav: 'ç›®éŒ„', vocab_title: 'ç§‘å­¸è©å½™åº«', select_hint: 'ğŸ‘ˆ è«‹å…ˆä¸Šæ–¹é¸æ“‡å–®å…ƒ', vocab_empty: 'è©å½™å°‡é¡¯ç¤ºæ–¼æ­¤', stage: 'éšæ®µ', grade: 'å¹´ç´š', version: 'ç‰ˆæœ¬', semester: 'å­¸æœŸ', unit: 'é¸æ“‡å–®å…ƒ' },
            'en': { page_title: 'AI School', nav: 'MENU', vocab_title: 'Science Vocab', select_hint: 'ğŸ‘ˆ Select Unit Above', vocab_empty: 'Vocab will appear here', stage: 'Stage', grade: 'Grade', version: 'Version', semester: 'Semester', unit: 'Select Unit' },
            'ja': { page_title: 'AI School', nav: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', vocab_title: 'ç§‘å­¦ç”¨èªé›†', select_hint: 'ğŸ‘ˆ ä¸Šã‹ã‚‰å˜å…ƒã‚’é¸æŠ', vocab_empty: 'ã“ã“ã«ç”¨èªãŒè¡¨ç¤ºã•ã‚Œã¾ã™', stage: 'æ®µéš', grade: 'å­¦å¹´', version: 'ç‰ˆ', semester: 'å­¦æœŸ', unit: 'å˜å…ƒã‚’é¸æŠ' },
            'zh-CN': { page_title: 'AI School', nav: 'ç›®å½•', vocab_title: 'ç§‘å­¦è¯æ±‡åº“', select_hint: 'ğŸ‘ˆ è¯·å…ˆä¸Šæ–¹é€‰æ‹©å•å…ƒ', vocab_empty: 'è¯æ±‡å°†æ˜¾ç¤ºäºæ­¤', stage: 'é˜¶æ®µ', grade: 'å¹´çº§', version: 'ç‰ˆæœ¬', semester: 'å­¦æœŸ', unit: 'é€‰æ‹©å•å…ƒ' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            fetchData();
            if(synth) synth.onvoiceschanged = () => synth.getVoices();
            setVoice('female'); 
            document.addEventListener('touchstart', () => { try{ if(!synth)return; synth.cancel(); const u=new SpeechSynthesisUtterance(" "); u.volume=0; synth.speak(u); }catch(e){} }, { once: true, passive: true });
        });

        function initLanguage() {
            const sel = document.getElementById('sel-lang');
            if(sel) sel.value = currentLang;
            applyLanguage(currentLang);
        }
        function changeLanguage(lang) {
            currentLang = lang; localStorage.setItem('appLang', lang); applyLanguage(lang);
            const ids=['stage','grade','version','semester','unit'];
            ids.forEach(id => {
               const el = document.getElementById(`sel-${id}`);
               if(el && el.disabled) el.options[0].text = i18n[currentLang][id] || '...';
            });
            if(processedUnits.length > 0) filterUnits('stage');
        }
        function applyLanguage(lang) {
            const texts = i18n[lang] || i18n['zh-TW'];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(texts[key]) el.innerText = texts[key]; });
        }
        function goBack() { window.location.href = 'student_science.html'; }

        // Data Fetching
        function fetchData() {
            Papa.parse(TARGET_URL, {
                download: true, header: false, skipEmptyLines: true,
                complete: res => { processData(res.data); document.getElementById('loader-overlay').style.display='none'; showToast("æº–å‚™å®Œæˆï¼Œé–‹å§‹æ¢ç´¢å§ï¼"); },
                error: () => document.getElementById('loader-overlay').innerHTML='<div class="text-red-500">é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ•´</div>'
            });
        }
        const norm = (s) => (s ?? '').toString().replace(/[\uFEFF\u200B\u200C\u200D]/g,'').replace(/ã€€/g,' ').trim();
        function parseVocabPairs(vocabText){
          const map = {}; if(!vocabText) return map;
          vocabText.split(/[,;ï¼Œï¼›\n]+/).forEach(token=>{
            const t = (token||"").toString().trim(); if(!t) return;
            let zh = "", en = "";
            const tabParts = t.split(/\t+/);
            if(tabParts.length >= 2){ zh = tabParts[0].trim(); en = tabParts.slice(1).join(' ').trim(); } 
            else {
              const sepParts = t.split(/[:ï¼š=ï¼]/);
              if(sepParts.length >= 2){ zh = sepParts[0].trim(); en = sepParts.slice(1).join(':').trim(); } 
              else {
                const m = t.match(/^(.+?)[ï¼ˆ(]\s*([^)ï¼‰]+?)\s*[)ï¼‰]\s*$/);
                if(m){ zh = (m[1]||"").trim(); en = (m[2]||"").trim(); } else { zh = t.trim(); en = ""; }
              }
            }
            if(zh) map[zh] = en;
          });
          return map;
        }
        function processData(data) {
            rawData = data.slice(1);
            processedUnits = rawData.map((row, i) => {
                let content = (row[COL_CONTENT]||"").toString(), ckip = (row[COL_CKIP]||"").toString(),
                    unitNum = norm(row[COL_UNIT_NUM]), unitName = norm(row[COL_UNIT_NAME]);
                let title = (unitNum + (unitName ? " " + unitName : "")).trim() || `Unit ${i+1}`;
                return { id: i, stage: norm(row[COL_STAGE]), version: norm(row[COL_VERSION]), grade: norm(row[COL_GRADE]), semester: norm(row[COL_SEMESTER]), title, content, ckip, vocab: (row[COL_VOCAB]||"").toString() };
            }).filter(u => u.title);
            initFilters();
        }

        // Filters
        function initFilters() { populateSelect('sel-stage', [...new Set(processedUnits.map(u=>u.stage).filter(Boolean))], 'stage'); }
        function filterUnits(lvl) {
            const ids=['stage','grade','version','semester','unit'], sels=ids.map(id=>document.getElementById(`sel-${id}`));
            let filtered = processedUnits.filter(u => {
                if(sels[0].value && u.stage!==sels[0].value) return false;
                if(sels[1].value && !sels[1].disabled && u.grade!==sels[1].value) return false;
                if(sels[2].value && !sels[2].disabled && u.version!==sels[2].value) return false;
                if(sels[3].value && !sels[3].disabled && u.semester!==sels[3].value) return false;
                return true;
            });
            const update=(sel,p,key)=> populateSelect(sel.id, [...new Set(filtered.map(u=>u[p]).filter(Boolean))], key);
            if(lvl==='stage') { update(sels[1],'grade','grade'); resetSelects(sels.slice(2)); }
            else if(lvl==='grade') { update(sels[2],'version','version'); resetSelects(sels.slice(3)); }
            else if(lvl==='version') { update(sels[3],'semester','semester'); resetSelects(sels.slice(4)); }
            else if(lvl==='semester') {
                const label = i18n[currentLang]['unit'] || 'é¸æ“‡å–®å…ƒ';
                sels[4].innerHTML=`<option value="" disabled selected data-i18n="unit">${label}</option>`;
                filtered.forEach(u=>sels[4].add(new Option(u.title,u.id)));
                sels[4].disabled=false;
            }
        }
        function populateSelect(id,items,i18nKey){
            const s=document.getElementById(id);
            const label = i18n[currentLang][i18nKey] || i18n['zh-TW'][i18nKey] || 'è«‹é¸æ“‡';
            s.innerHTML=`<option value="" disabled selected>${label}</option>`;
            items.forEach(i=>s.add(new Option(i,i))); s.disabled=false;
        }
        function resetSelects(els){
            els.forEach(e=>{
                const key = e.id.replace('sel-','');
                const label = i18n[currentLang][key] || i18n['zh-TW'][key] || '...';
                e.innerHTML=`<option value="" disabled selected>${label}</option>`; e.disabled=true;
            });
        }
        function loadSelectedUnit(){ const u=processedUnits.find(i=>i.id==document.getElementById('sel-unit').value); if(u) renderArticle(u); }

        // Render Article & Cards
        async function renderArticle(unit) {
            currentUnitTitleZh = unit.title; currentUnitTitleEn = "";
            document.getElementById('article-title').innerHTML = `
              <div id="title-zh">${escapeHtml(currentUnitTitleZh)}</div>
              <div id="title-en" class="text-xl md:text-2xl font-bold text-green-400 mt-2">Translating...</div>
            `;
            document.getElementById('status-bar').innerText = unit.title;
            document.getElementById('nav-title').innerText = unit.title;
            activeVocabMap = parseVocabPairs(unit.vocab);
            renderVocabSidebar();
            
            const contentDiv = document.getElementById('article-content');
            contentDiv.innerHTML='';
            document.getElementById('unit-list').innerHTML='';

            let lines = (unit.content || "").split('\n').map(x=>x.trim()).filter(Boolean);
            if(lines.length===0 && unit.ckip){
                lines = unit.ckip.split('\n').map(x=>x.replace(/ã€€/g,' ').replace(/\([^)]*\)/g,'').trim()).filter(Boolean);
            }

            const unitCkipSet = unit.ckip ? getCkipTokenSet(unit.ckip) : null;
            const unitCkipTokens = unit.ckip ? getCkipTokenArray(unit.ckip) : [];
            const unitMergeSet = buildCkipMergeSet(unitCkipTokens, getMaxKeyLen(activeVocabMap));

            // ç”Ÿæˆæ‘˜è¦å¡ç‰‡
            let cardIndex = 0;
            for(let i=0; i<lines.length; i++) {
                let line = lines[i].trim();
                if(!line) continue;
                if((line.length<40 && !/[ã€‚ï¼ï¼Ÿ.!?]$/.test(line)) || line.includes("æ´»å‹•")) {
                    // æ¨™é¡Œ
                    const anchorId = `sec-${i}`;
                    const navItem = document.createElement('div');
                    navItem.className='nav-item'; navItem.innerText = line;
                    navItem.onclick=()=>{ document.getElementById(anchorId).scrollIntoView({behavior:'smooth',block:'center'}); };
                    document.getElementById('unit-list').appendChild(navItem);
                    contentDiv.innerHTML += `
                        <h2 id="${anchorId}" class="section-header">
                            <div class="flex flex-col w-full">
                                <span class="zh-text text-2xl md:text-3xl font-black cursor-pointer transition" onclick="speakText(this.innerText)">${escapeHtml(line)}</span>
                                <span class="en-text hidden text-xl md:text-2xl mt-2 font-bold cursor-pointer transition" 
                                      data-source="${encodeURIComponent(line)}"
                                      onclick="speakText(this.innerText)"></span>
                            </div>
                        </h2>`;
                } else {
                    // å…§å®¹å€å¡Š -> è½‰ç‚ºå¡ç‰‡
                    let processed = processXRayWithCKIP(line, activeVocabMap, unitCkipSet, unitMergeSet, cardIndex);
                    // è¼ªæ›¿é¡è‰²
                    const myColor = colorPalette[cardIndex % colorPalette.length];
                    
                    contentDiv.innerHTML += `
                        <div class="summary-card content-block" style="--card-color: ${myColor}">
                            <p class="zh-text" onclick="speakText(this.innerText)">${processed}</p>
                            <p class="en-text hidden mt-3"
                               onclick="speakText(this.innerText)"
                               data-source="${encodeURIComponent(line)}"></p>
                        </div>`;
                    cardIndex++;
                }
            }
            setMode('dual');
            initGraph(lines); // åˆå§‹åŒ–åœ–è¡¨
        }

        // æ¸²æŸ“å³å´è©å½™
        function renderVocabSidebar() {
          const container = document.getElementById('vocab-container');
          container.innerHTML = '';
          const keys = Object.keys(activeVocabMap || {});
          if(keys.length === 0) {
            container.innerHTML = `<div class="text-center opacity-30 text-sm mt-10 text-white">${i18n[currentLang]['vocab_empty']}</div>`;
            return;
          }
          keys.forEach(zh => {
            const enVal = (activeVocabMap[zh] || "").toString().trim();
            const showEn = enVal ? enVal : "Loading...";
            const card = document.createElement('div');
            card.className = "vocab-card-item"; // æ”¹ç”¨å¡ç‰‡æ¨£å¼
            card.innerHTML = `
              <div class="flex-1 pr-2">
                <div class="text-lg font-bold text-yellow-400 cursor-pointer mb-1" onclick="speakText('${zh.replace(/'/g,"\\'")}')">${escapeHtml(zh)}</div>
                <div class="text-sm en-term-label cursor-pointer text-slate-300" data-zh="${escapeHtml(zh)}" onclick="speakVocabEn('${zh.replace(/'/g,"\\'")}', this)">${escapeHtml(showEn)}</div>
              </div>
              <div class="flex items-center gap-1 mt-2">
                <button onclick="event.stopPropagation(); speakText('${zh.replace(/'/g,"\\'")}')" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs text-white">ä¸­æ–‡ç™¼éŸ³</button>
                <button onclick="event.stopPropagation(); speakVocabEn('${zh.replace(/'/g,"\\'")}', this)" class="px-2 py-1 rounded bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white text-xs">EN</button>
              </div>`;
            container.appendChild(card);
            if(!enVal) translateVocabItem(zh, card.querySelector('.en-term-label'));
          });
        }

        // CKIP Logic (with Color injection)
        function processXRayWithCKIP(text, map, ckipTokenSet, ckipMergeSet, cardIdx) {
          const src = (text || "").toString().replace(/ã€€/g, "");
          const keys = Object.keys(map || {}).filter(Boolean).sort((a, b) => b.length - a.length);
          // å–å¾—è©²å¡ç‰‡çš„é¡è‰²ï¼Œè®“é‡é»è©å½™ä¹Ÿç”¨é€™é¡è‰²é«˜äº®
          const highlightColor = colorPalette[cardIdx % colorPalette.length];
          
          if (!keys.length) return escapeHtml(src);
          const spans = [];
          const overlaps = (s, e) => spans.some(sp => !(e <= sp.start || s >= sp.end));
          for (const term of keys) {
            let from = 0;
            while (true) {
              const idx = src.indexOf(term, from); if (idx === -1) break;
              const start = idx, end = idx + term.length; from = idx + term.length;
              if (overlaps(start, end)) continue;
              if (!shouldMarkZhTerm(term, ckipTokenSet, ckipMergeSet)) continue;
              spans.push({ start, end, term });
            }
          }
          if (!spans.length) return escapeHtml(src);
          spans.sort((a, b) => a.start - b.start);
          let html = "", last = 0;
          for (const sp of spans) {
            html += escapeHtml(src.slice(last, sp.start));
            const zh = sp.term;
            const js = ((map[zh] || zh) + "").toString().replace(/'/g, "\\'");
            const title = escapeHtml(((map[zh] || "") + "").toString());
            // é€™è£¡å°‡ highlightColor æ³¨å…¥ CSS è®Šæ•¸
            html += `<span class="sci-term" style="--card-color:${highlightColor}" onclick="event.stopPropagation(); speakText('${js}')" title="${title}">${escapeHtml(zh)}</span>`;
            last = sp.end;
          }
          html += escapeHtml(src.slice(last));
          return html;
        }

        function getCkipTokenSet(ckipLine){ const raw=(ckipLine||"").toString().trim(); if(!raw)return new Set(); return new Set(raw.replace(/ã€€/g," ").split(/\s+/).filter(Boolean).map(tok=>tok.replace(/[\(ï¼ˆ].*$/,"")).filter(Boolean)); }
        function getCkipTokenArray(ckipText){ const raw=(ckipText||"").toString().replace(/ã€€/g," ").trim(); if(!raw)return[]; return raw.split(/\s+/).filter(Boolean).map(tok=>tok.replace(/[\(ï¼ˆ].*$/,"")).filter(Boolean)); }
        function getMaxKeyLen(vocabMap){ const keys=Object.keys(vocabMap||{}); if(!keys.length)return 1; let m=1;for(const k of keys)m=Math.max(m,(k||"").length); return m; }
        function buildCkipMergeSet(tokens,maxLen){ const set=new Set(); if(!tokens||!tokens.length)return set; const L=Math.max(2,maxLen||2); for(let i=0;i<tokens.length;i++){ let acc=""; for(let j=i;j<tokens.length;j++){ acc+=tokens[j]; if(acc.length>L)break; if(acc.length>=2)set.add(acc); } } return set; }
        function shouldMarkZhTerm(term,ckipSet,mergeSet){ if(!term)return false; if(!ckipSet||ckipSet.size===0)return true; if(term.length===1)return ckipSet.has(term); if(ckipSet.has(term))return true; if(mergeSet&&mergeSet.has(term))return true; return false; }

        // ====================== Knowledge Graph (Vis.js) ======================
        function openGraph() {
            document.getElementById('graph-modal').style.display = 'flex';
            if(network) network.fit();
        }
        function closeGraph() { document.getElementById('graph-modal').style.display = 'none'; }

        function initGraph(lines) {
            const container = document.getElementById('graph-container');
            const nodes = new vis.DataSet([]);
            const edges = new vis.DataSet([]);
            
            // ç°¡å–®æ¼”ç®—æ³•ï¼šå°‡æ®µè½ä¸­çš„é—œéµå­—ä½œç‚ºç¯€é»ï¼Œæ®µè½æ¨™é¡Œä½œç‚ºä¸­å¿ƒ
            let parentId = 0;
            nodes.add({ id: 0, label: currentUnitTitleZh, shape: 'hexagon', color: '#fff', font: {size: 40, color: '#000'} });

            let cardIndex = 0;
            lines.forEach((line, idx) => {
                const isTitle = (line.length<40 && !/[ã€‚ï¼ï¼Ÿ.!?]$/.test(line)) || line.includes("æ´»å‹•");
                if(isTitle) {
                    parentId = idx + 1;
                    nodes.add({ 
                        id: parentId, label: line, shape: 'box', 
                        color: { background: '#334155', border: '#94a3b8' }, 
                        font: {color: '#fff', size: 24} 
                    });
                    edges.add({ from: 0, to: parentId, color: {color: 'rgba(255,255,255,0.2)'} });
                } else {
                    // åˆ†æè©²æ®µè½ä¸­çš„è©å½™
                    const keys = Object.keys(activeVocabMap).filter(k => line.includes(k));
                    const myColor = colorPalette[cardIndex % colorPalette.length];
                    
                    if(keys.length > 0) {
                        keys.forEach(k => {
                            // é¿å…é‡è¤‡ç¯€é» ID (ç°¡å–® hash)
                            const nodeId = k; 
                            try {
                                if(!nodes.get(nodeId)) {
                                    nodes.add({ 
                                        id: nodeId, label: k, shape: 'dot', size: 15,
                                        color: { background: myColor, border: '#fff' },
                                        font: {color: '#cbd5e1', size: 18}
                                    });
                                }
                                edges.add({ from: parentId, to: nodeId, color: {color: 'rgba(255,255,255,0.1)'} });
                            } catch(e){}
                        });
                    }
                    cardIndex++;
                }
            });

            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: { borderWidth: 2, shadow: true },
                edges: { width: 2, smooth: { type: 'continuous' } },
                physics: { 
                    stabilization: false, 
                    barnesHut: { gravitationalConstant: -3000, springLength: 200 } 
                },
                layout: { randomSeed: 2 } // å›ºå®šä½ˆå±€
            };
            network = new vis.Network(container, data, options);
            
            // é›™æ“Šèšç„¦
            network.on("doubleClick", function (params) {
                if (params.nodes.length > 0) {
                    network.focus(params.nodes[0], { scale: 1.5, animation: true });
                }
            });
        }

        // ====================== TTS & Translation ======================
        async function translateVocabItem(zh, el) {
          try { const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(zh)}`); const json=await res.json(); const en=(json&&json[0]&&json[0][0]&&json[0][0][0])?json[0][0][0]:""; if(el)el.innerText=en||"â€”"; activeVocabMap[zh]=en||""; rehighlightEnglishBlocks(); return en||""; } catch(e){ if(el)el.innerText="â€”"; activeVocabMap[zh]=""; rehighlightEnglishBlocks(); return ""; }
        }
        async function speakVocabEn(zh, btn){ const card=btn?.closest('.vocab-card-item'); const label=card?.querySelector('.en-term-label'); let en=(activeVocabMap[zh]||"").trim(); if(!en){ await translateVocabItem(zh, label); en=(activeVocabMap[zh]||"").trim(); } speakText(en||zh); }
        async function translateToEn(text) {
          const src=(text||"").trim(); if(!src)return""; const k="__title__"+src; if(translationCache[k])return translationCache[k];
          try { const res=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`); const json=await res.json(); let out=""; (json[0]||[]).forEach(x=>out+=(x[0]||"")); translationCache[k]=out; return out; } catch(e){return src;}
        }
        function ensureTitleTranslated() { if(!currentUnitTitleZh)return; const el=document.getElementById('title-en'); if(el&&el.innerText&&el.innerText!=='Translating...')return; translateToEn(currentUnitTitleZh).then(e=>{currentUnitTitleEn=e||""; if(el)el.innerText=currentUnitTitleEn;}).catch(()=>{}); }
        function rehighlightEnglishBlocks(){ const ens=document.querySelectorAll('.en-text'); ens.forEach(el=>{ const s=decodeURIComponent(el.getAttribute('data-source')||""); const c=translationCache[s]; if(c) el.innerHTML=makeClickable(highlightEnglishVocabInText(c)); }); }
        async function translateVisibleBlocks() {
            const ens=document.querySelectorAll('.en-text'), load=document.getElementById('trans-loading');
            let need=false; ens.forEach(e=>{if(!e.innerText)need=true}); if(!need)return;
            load.classList.remove('hidden');
            for(let el of ens) {
                if(el.innerText)continue; let src=decodeURIComponent(el.getAttribute('data-source')||"").replace(/ã€€/g,'');
                if(translationCache[src]){ el.innerHTML=makeClickable(highlightEnglishVocabInText(translationCache[src])); continue; }
                try { const res=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-TW&tl=en&dt=t&q=${encodeURIComponent(src)}`); const json=await res.json(); let txt=""; json[0].forEach(i=>txt+=i[0]); el.innerHTML=makeClickable(highlightEnglishVocabInText(txt)); translationCache[src]=txt; } catch(e){el.innerText="Error";}
            } load.classList.add('hidden'); rehighlightEnglishBlocks();
        }
        function makeClickable(h){return `<span class="cursor-pointer hover:text-green-300 transition">${h}</span>`;}
        function escapeHtml(s){return (s||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");}
        function highlightEnglishVocabInText(txt){
          let s=escapeHtml(txt); const terms=Object.values(activeVocabMap||{}).map(v=>(v||"").trim()).filter(v=>v&&v!=="Loading..."&&/[a-zA-Z]/.test(v)); const uniq=[...new Set(terms)].sort((a,b)=>b.length-a.length);
          if(!uniq.length)return s;
          for(const t of uniq){ const esc=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); const re=new RegExp(`\\b(${esc})\\b`,'gi'); s=s.replace(re,m=>`<span class="sci-term" onclick="event.stopPropagation(); speakText('${m.replace(/'/g,"\\'")}')" title="${m}">${m}</span>`); } return s;
        }

        // TTS & Player
        function isIOSDevice(){ return /iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1); }
        function isMostlyEnglish(t){ const l=(t.match(/[A-Za-z]/g)||[]).length, c=(t.match(/[\u4E00-\u9FFF]/g)||[]).length; return c===0?l>0:l>c*2; }
        function pickBestVoice(isEng, gender) {
            if(!window.speechSynthesis)return null; const vs=window.speechSynthesis.getVoices(); if(!vs.length)return null;
            const target = isEng ? ['en-us','en-gb','en'] : ['zh-tw','zh-hk','zh'];
            const getScore = (v) => {
                let s=0, n=v.name.toLowerCase(), u=(v.voiceURI||"").toLowerCase(), l=v.lang.toLowerCase();
                if(target.some(t=>l.includes(t))) { s+=1000; if(!isEng&&l.includes('tw'))s+=500; if(isEng&&l.includes('us'))s+=200; } else return -1e5;
                if(n.includes('enhanced')||u.includes('enhanced')||n.includes('premium')) s+=5000;
                if(gender==='female') { if(isEng&&(n.includes('samantha')||n.includes('ava')))s+=2e4; else if(!isEng&&(n.includes('meijia')||n.includes('tingting')))s+=2e4; if(n.includes('female'))s+=1000; }
                else { if(isEng&&(n.includes('daniel')||n.includes('alex')))s+=2e4; else if(!isEng&&n.includes('sinji'))s+=1e4; if(n.includes('male'))s+=1000; }
                return s;
            };
            return vs.map(v=>({v,s:getScore(v)})).sort((a,b)=>b.s-a.s)[0]?.v || vs[0];
        }
        function speakText(txt, cb) {
            if(!synth)return; isSpeaking=true; if(synth.paused)synth.resume();
            document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-pause"></i>'; synth.cancel();
            const clean=(txt||"").replace(/<[^>]*>/g,"").trim();
            if(!clean){ if(cb)setTimeout(cb,10); else { isSpeaking=false; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play ml-1"></i>'; } return; }
            const isEng=isMostlyEnglish(clean), u=new SpeechSynthesisUtterance(clean);
            u.voice=pickBestVoice(isEng, currentVoice); u.lang=isEng?'en-US':'zh-TW';
            if(isIOSDevice()){ u.pitch=1; u.rate=parseFloat(document.getElementById('play-rate').value)*(isEng?1:0.95); }
            else { u.rate=parseFloat(document.getElementById('play-rate').value); u.pitch=currentVoice==='male'?0.9:1.1; }
            u.onend=()=>{ if(cb)cb(); else { isSpeaking=false; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play ml-1"></i>'; } };
            u.onerror=()=>{ if(isSpeaking && cb) cb(); };
            synth.speak(u);
        }
        function playSequence() {
            if(!isSpeaking)return; const cards=document.querySelectorAll('.summary-card');
            if(currentBlockIndex>=cards.length){ stopSpeech(); return; }
            clearHighlights(); const card=cards[currentBlockIndex];
            if(card){ card.classList.add('reading-active'); card.scrollIntoView({behavior:'smooth',block:'center'}); }
            const en=card.querySelector('.en-text'), zh=card.querySelector('.zh-text');
            const texts=[]; if(en&&!en.classList.contains('hidden')&&en.innerText)texts.push(en.innerText); if(zh&&!zh.classList.contains('hidden')&&zh.innerText)texts.push(zh.innerText);
            if(texts.length){
                let i=0; const next=()=>{ if(!isSpeaking)return; if(i>=texts.length){ currentBlockIndex++; playSequence(); return; } speakText(texts[i], ()=>{ i++; setTimeout(next,300); }); }; next();
            } else { currentBlockIndex++; playSequence(); }
        }
        function toggleSpeech(){ 
            if(isSpeaking){ isSpeaking=false; synth.cancel(); document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play ml-1"></i>'; }
            else { isSpeaking=true; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-pause"></i>'; if(synth.paused)synth.resume(); setTimeout(playSequence,10); }
        }
        function stopSpeech(){ isSpeaking=false; synth.cancel(); currentBlockIndex=0; clearHighlights(); document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play ml-1"></i>'; }
        function clearHighlights(){ document.querySelectorAll('.reading-active').forEach(e=>e.classList.remove('reading-active')); }
        function setVoice(g){ currentVoice=g; document.getElementById('btn-male').className=g==='male'?'w-9 h-9 rounded-full flex items-center justify-center transition bg-green-500 text-white shadow-lg':'w-9 h-9 rounded-full flex items-center justify-center transition text-slate-400 hover:text-white'; document.getElementById('btn-female').className=g==='female'?'w-9 h-9 rounded-full flex items-center justify-center transition bg-green-500 text-white shadow-lg':'w-9 h-9 rounded-full flex items-center justify-center transition text-slate-400 hover:text-white'; stopSpeech(); }
        function setMode(m){ 
            ['en','dual','zh'].forEach(x=>document.getElementById(`btn-${x}`).className=x===m?"px-3 py-1 text-xs font-bold rounded-full bg-green-500 text-white shadow-lg":"px-3 py-1 text-xs font-bold rounded-full text-slate-400 hover:text-white transition");
            if(m!=='zh') translateVisibleBlocks();
            const ens=document.querySelectorAll('.en-text'), zhs=document.querySelectorAll('.zh-text');
            if(m==='en'){ens.forEach(e=>e.classList.remove('hidden'));zhs.forEach(z=>z.classList.add('hidden'));}
            else if(m==='zh'){ens.forEach(e=>e.classList.add('hidden'));zhs.forEach(z=>z.classList.remove('hidden'));}
            else{ens.forEach(e=>e.classList.remove('hidden'));zhs.forEach(z=>z.classList.remove('hidden'));}
            const tZh=document.getElementById('title-zh'), tEn=document.getElementById('title-en');
            if(tZh&&tEn){ if(m==='en'){tZh.classList.add('hidden');tEn.classList.remove('hidden');} else if(m==='zh'){tZh.classList.remove('hidden');tEn.classList.add('hidden');} else{tZh.classList.remove('hidden');tEn.classList.remove('hidden');} }
            if(m!=='zh') ensureTitleTranslated();
        }
        function showToast(m) { const T=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; T.classList.remove('opacity-0','-translate-y-10'); setTimeout(()=>T.classList.add('opacity-0','-translate-y-10'),2500); }
    </script>
</body>
</html>
