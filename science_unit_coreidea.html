<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 診斷中心 | Science Learning Hub</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+TC:wght@300;400;500;700;900&family=Orbitron:wght@500;700;900&family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
            mono: ['Orbitron', 'monospace'],
            serif: ['Noto Serif TC', 'serif'],
          },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
            },
            tech: {
              dark: '#0f172a',
              panel: 'rgba(255, 255, 255, 0.85)',
            }
          },
          boxShadow: {
            'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
            'glow': '0 0 15px rgba(59, 130, 246, 0.5)',
            'float': '0 10px 30px -10px rgba(0,0,0,0.1)'
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'drive': 'drive 1s ease-in-out forwards',
          },
          keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } }
          }
        }
      }
    };
  </script>

  <style>
    body {
      background-color: #f1f5f9;
      background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
      background-size: 40px 40px;
      color: #1e293b;
    }

    /* Glass Effect Panel */
    .glass-panel {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border-radius: 1.5rem;
      transition: all 0.3s ease;
    }
    
    /* Custom Select */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
    }

    /* Race Track HUD */
    .race-track {
      position: relative;
      height: 12px;
      background: #e2e8f0;
      border-radius: 999px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .race-progress {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      border-radius: 999px;
      width: 0%;
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }
    .race-car {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: #ef4444;
      transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
    }
    .finish-line {
      position: absolute; right: 0; top: 50%; transform: translateY(-50%);
      font-size: 1.2rem; color: #1e293b;
    }

    /* Option Button */
    .opt-btn {
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }
    .opt-btn:hover:not(:disabled) {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
    }
    .opt-btn.selected {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
    }
    .opt-btn.selected .badge { background: rgba(255,255,255,0.2); color: white; }

    /* Loader */
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%;
      width: 50px; height: 50px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* PDF Specific Styles (Hidden from screen) */
    #pdf-report {
      width: 210mm; min-height: 297mm; background: white; padding: 20mm;
      font-family: 'Noto Sans TC', serif; display: none;
    }
    .pdf-header { text-align: center; border-bottom: 2px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px; }
    .pdf-section { margin-bottom: 30px; page-break-inside: avoid; }
    .pdf-title { font-size: 18px; font-weight: bold; color: #1e293b; border-left: 5px solid #3b82f6; padding-left: 10px; margin-bottom: 15px; }
    .pdf-score-box { display: flex; justify-content: center; gap: 40px; margin-bottom: 20px; }
    .pdf-score-circle { width: 100px; height: 100px; border-radius: 50%; border: 8px solid #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 900; color: #3b82f6; }
    .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .pdf-table th { background: #f1f5f9; padding: 8px; text-align: left; border-bottom: 2px solid #cbd5e1; }
    .pdf-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
  </style>
</head>

<body class="flex flex-col min-h-screen">

  <div id="loading-overlay" class="fixed inset-0 bg-slate-900/90 z-[100] hidden flex-col items-center justify-center text-white backdrop-blur-sm">
    <div class="loader mb-4"></div>
    <div id="loading-title" class="text-xl font-bold tracking-widest font-mono">SYSTEM INITIALIZING</div>
    <div id="loading-desc" class="text-sm text-slate-400 mt-2">Connecting to AI Neural Network...</div>
  </div>

  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="./student.html" class="flex items-center gap-2 text-slate-500 hover:text-blue-600 transition">
          <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></div>
          <span class="font-bold hidden sm:inline" data-i18n="back">返回</span>
        </a>
        <div class="h-6 w-px bg-slate-300 hidden sm:block"></div>
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-user-doctor text-blue-600 text-xl"></i>
          <div>
            <h1 class="font-black text-slate-800 leading-none" data-i18n="page_title">AI 適性診斷中心</h1>
            <p class="text-[10px] text-slate-400 font-mono tracking-wider">ADAPTIVE DIAGNOSIS</p>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="relative">
          <i class="fa-solid fa-globe absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
          <select id="language-selector" onchange="changeLanguage()" class="pl-8 pr-8 py-1.5 rounded-full border border-slate-200 text-xs font-bold bg-slate-50 hover:bg-white transition focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
            <option value="zh-TW">繁體中文</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="zh-CN">简体中文</option>
          </select>
        </div>
        
        <div id="connBadge" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 border border-slate-200 text-xs font-bold text-slate-400">
          <i class="fa-solid fa-circle-notch fa-spin"></i> <span data-i18n="connecting">連線中...</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 py-8 flex-1 space-y-8 pb-24">

    <section class="glass-panel p-6 md:p-8 relative overflow-hidden group hover:shadow-lg">
      <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
      
      <div class="flex flex-wrap items-center justify-between mb-6 border-b border-slate-100 pb-4 relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center text-lg font-bold shadow-lg shadow-blue-500/20">1</div>
          <h2 class="text-xl font-bold text-slate-800" data-i18n="step1_title">診斷範圍設定</h2>
        </div>
        <button id="btnReload" class="text-sm text-blue-500 font-bold hover:bg-blue-50 px-3 py-1.5 rounded-lg transition flex items-center gap-2">
          <i class="fa-solid fa-rotate"></i> <span data-i18n="btn_reload">重整資料庫</span>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 relative z-10">
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-400 uppercase ml-1" data-i18n="label_stage">學習階段</label>
          <select id="selStage" class="w-full p-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"></select>
        </div>
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-400 uppercase ml-1" data-i18n="label_grade">年級</label>
          <select id="selGrade" class="w-full p-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"></select>
        </div>
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-400 uppercase ml-1" data-i18n="label_semester">學期</label>
          <select id="selSemester" class="w-full p-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"></select>
        </div>
        <div class="space-y-1">
          <label class="text-xs font-bold text-slate-400 uppercase ml-1" data-i18n="label_publisher">版本</label>
          <select id="selPublisher" class="w-full p-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"></select>
          <div id="publisherHint" class="hidden"></div>
        </div>
        <div class="space-y-1 lg:col-span-1">
          <label class="text-xs font-bold text-slate-400 uppercase ml-1" data-i18n="label_unit">單元</label>
          <select id="selUnit" class="w-full p-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"></select>
          <div id="unitHint" class="hidden"></div>
        </div>
      </div>

      <div class="mt-8 pt-4 border-t border-slate-100 flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3 bg-slate-50 px-4 py-2 rounded-xl border border-slate-200">
          <i class="fa-solid fa-list-ol text-slate-400"></i>
          <span class="text-sm font-bold text-slate-600" data-i18n="question_count">題數</span>
          <input id="inpN" type="number" min="5" max="40" step="1" value="15" class="w-12 bg-transparent text-center font-mono font-bold text-lg text-blue-600 focus:outline-none">
        </div>
        <button id="btnStart" class="w-full sm:w-auto px-8 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-lg shadow-lg hover:shadow-blue-500/30 hover:-translate-y-0.5 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-2">
          <i class="fa-solid fa-rocket"></i> <span data-i18n="btn_start">開始診斷</span>
        </button>
      </div>
    </section>

    <section class="glass-panel p-6 md:p-8 relative overflow-hidden border-l-4 border-orange-400">
      <div class="absolute top-0 left-0 w-32 h-32 bg-orange-400/5 rounded-full blur-3xl -translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>

      <div class="flex items-center justify-between mb-4 relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-orange-500 text-white flex items-center justify-center text-lg font-bold shadow-lg shadow-orange-500/20">2</div>
          <div>
            <h2 class="text-xl font-bold text-slate-800" data-i18n="step2_title">智能作答區</h2>
            <p class="text-[10px] text-slate-400 font-mono tracking-wider">AI ADAPTIVE TESTING</p>
          </div>
        </div>
        <div class="font-mono text-xl font-black text-orange-500" id="progText">0/0</div>
        <button id="btnFinish" class="hidden" disabled></button>
      </div>

      <div class="race-track">
        <div id="progBar" class="race-progress"></div>
        <div id="turtleIcon" class="race-car" style="left: 0%"><i class="fa-solid fa-car-side"></i></div>
        <div class="finish-line"><i class="fa-solid fa-flag-checkered"></i></div>
      </div>

      <div id="qArea" class="mt-8 relative z-10 min-h-[300px]">
        <div id="qEmpty" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
          <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4 animate-float">
            <i class="fa-solid fa-gamepad text-3xl"></i>
          </div>
          <p class="font-bold" data-i18n="waiting_start">等待測驗啟動...</p>
        </div>

        <div id="qWrap" class="hidden">
          <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm mb-6">
            <span class="inline-block px-3 py-1 rounded bg-orange-100 text-orange-700 text-xs font-bold mb-3">QUESTION</span>
            <div id="qStem" class="text-xl font-serif font-bold text-slate-800 leading-relaxed"></div>
          </div>

          <div id="optWrap" class="grid grid-cols-1 gap-3 mb-6"></div>

          <div class="flex flex-col md:flex-row items-center gap-4 bg-white/50 p-4 rounded-xl border border-white">
            <div id="hint" class="flex-1 text-sm font-bold text-slate-500 flex items-center gap-2">
              <i class="fa-solid fa-circle-info text-blue-400"></i> <span data-i18n="hint_select">請選擇一個選項</span>
            </div>
            <div class="flex gap-3 w-full md:w-auto">
              <button id="btnSubmit" class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-slate-800 text-white font-bold hover:bg-slate-900 disabled:opacity-50 disabled:cursor-not-allowed transition shadow flex items-center justify-center gap-2">
                <span data-i18n="btn_submit">送出</span> <i class="fa-solid fa-paper-plane"></i>
              </button>
              <button id="btnNext" disabled class="flex-1 md:flex-none px-6 py-2.5 rounded-lg bg-slate-200 text-slate-400 font-bold disabled:cursor-not-allowed transition flex items-center justify-center gap-2">
                <span data-i18n="btn_next">下一題</span> <i class="fa-solid fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="resultSec" class="hidden glass-panel p-6 md:p-8 relative overflow-hidden border-l-4 border-emerald-500">
      <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

      <div class="flex flex-wrap items-center justify-between mb-8 relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-emerald-600 text-white flex items-center justify-center text-lg font-bold shadow-lg shadow-emerald-500/20">3</div>
          <h2 class="text-xl font-bold text-slate-800" data-i18n="step3_title">診斷報告</h2>
        </div>
        <div class="flex gap-2">
          <button id="btnDownload" class="px-4 py-2 rounded-lg bg-slate-800 text-white text-sm font-bold hover:bg-slate-900 transition shadow flex items-center gap-2">
            <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_pdf">下載報告書</span>
          </button>
          <button id="btnRestart" class="px-4 py-2 rounded-lg border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-50 transition flex items-center gap-2">
            <i class="fa-solid fa-rotate-left"></i> <span data-i18n="btn_restart">重測</span>
          </button>
        </div>
        <div id="btnCopy" class="hidden"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
          <div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1" data-i18n="accuracy">答對題數</div>
            <div id="resScore" class="text-4xl font-mono font-black text-slate-800">—</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl"><i class="fa-solid fa-bullseye"></i></div>
        </div>
        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
          <div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1" data-i18n="score">總分</div>
            <div id="resScore100" class="text-4xl font-mono font-black text-emerald-600">—</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl"><i class="fa-solid fa-trophy"></i></div>
        </div>
        <div id="resTestId" class="hidden"></div>
      </div>

      <div class="bg-red-50/50 rounded-2xl p-6 border border-red-100 mb-6">
        <h3 class="text-lg font-bold text-red-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-microscope"></i> <span data-i18n="wrong_analysis">錯題概念分析</span></h3>
        <div id="resWrong" class="space-y-3"></div>
      </div>

      <div class="bg-white/60 rounded-2xl p-6 border border-slate-200">
        <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-user-doctor"></i> <span data-i18n="ai_feedback">AI 學習處方</span></h3>
        <div id="resFeedback" class="prose prose-slate max-w-none text-slate-600 font-medium whitespace-pre-wrap"></div>
      </div>
    </section>

  </main>

  <div id="pdf-report">
    <div style="height: 1100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 10px solid #f1f5f9; padding: 40px; text-align: center; position: relative;">
      <div style="font-size: 80px; color: #3b82f6; margin-bottom: 30px;"><i class="fa-solid fa-atom"></i></div>
      <div style="font-size: 24px; color: #64748b; margin-bottom: 10px; font-weight: bold; letter-spacing: 4px;">AI SCHOOL 自然科學</div>
      <div style="font-size: 48px; color: #0f172a; font-weight: 900; margin-bottom: 20px;">概念理解診斷報告書</div>
      <div id="pdf-unit-name" style="font-size: 28px; color: #334155; font-weight: bold; border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 60px;"></div>
      
      <div style="text-align: left; width: 60%; font-size: 18px; line-height: 2.5;">
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #e2e8f0;">
          <span style="color: #64748b;">學生姓名：</span><span id="pdf-student-name" style="font-weight: bold;"></span>
        </div>
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #e2e8f0;">
          <span style="color: #64748b;">診斷日期：</span><span style="font-weight: bold;">2025年12月16日</span>
        </div>
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #e2e8f0;">
          <span style="color: #64748b;">報告編號：</span><span id="pdf-report-id" style="font-weight: bold; font-family: monospace;"></span>
        </div>
      </div>
      <div style="position: absolute; bottom: 40px; font-size: 12px; color: #94a3b8;">Science Learning Hub • Adaptive Diagnosis System</div>
    </div>

    <div class="html2pdf__page-break"></div>

    <div style="padding: 40px;">
      <div class="pdf-header">
        <h2 style="margin: 0; color: #0f172a; font-size: 28px; font-weight: bold;">診斷分析詳情</h2>
      </div>

      <div class="pdf-section">
        <div class="pdf-title">一、測驗分數</div>
        <div class="pdf-score-box">
          <div style="text-align: center;">
            <div id="pdf-score-circle" class="pdf-score-circle">--</div>
            <div style="font-size: 14px; font-weight: bold; color: #3b82f6; margin-top: 10px;">總分 (100分制)</div>
          </div>
          <div style="display: flex; flex-direction: column; justify-content: center; gap: 10px;">
            <div style="font-size: 16px;">答對題數：<span id="pdf-raw-score" style="font-weight: bold;"></span></div>
            <div style="font-size: 14px; color: #64748b;">整體評語：<span id="pdf-comment" style="font-weight: bold; color: #0f172a;"></span></div>
          </div>
        </div>
      </div>

      <div class="pdf-section">
        <div class="pdf-title">二、錯題概念分析</div>
        <div style="font-size: 14px; color: #64748b; margin-bottom: 10px;">以下是本次測驗中偵測到理解較弱的概念點：</div>
        <div id="pdf-wrong-list"></div>
      </div>

      <div class="pdf-section">
        <div class="pdf-title">三、AI 診斷結果</div>
        <div id="pdf-ai-diagnosis" style="font-size: 14px; line-height: 1.8; color: #334155; text-align: justify;"></div>
      </div>

      <div class="pdf-section">
        <div class="pdf-title">四、學習補強建議</div>
        <div id="pdf-remedial" style="font-size: 14px; line-height: 1.8; color: #334155; text-align: justify; background: #f8fafc; padding: 15px; border-radius: 8px;"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-6 right-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300 hidden">
    <div class="bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 border border-slate-700 max-w-sm">
      <div id="toastIcon" class="text-2xl"></div>
      <div>
        <div id="toastTitle" class="font-bold"></div>
        <div id="toastMsg" class="text-xs text-slate-400 mt-1"></div>
      </div>
    </div>
  </div>

  <script>
    /* ===========================
       0) GAS URL & CONSTANTS
    =========================== */
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxvAOgRDBE6T-2R37UeTzo0RSQukgGOlEYyBrTw8zUSOlIKNIzLdJXozjNx4Hn6brc2/exec";
    const CONTENT_DB_ID = "1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk";
    const CONTENT_SHEET_NAME = "Sheet1";
    const USER_DB_ID = "1cDOsaa7E0EwD1R9CeCWoGf8_9ZMcFv8fxQ5d-LWUKu8";
    const USER_SHEET_NAME = "Users_student";
    const USER_STUDENTID_COL = "J";

    const ACTION = { GET_UNIT_OPTIONS: "getUnitOptions", START_CAT: "startCAT", SUBMIT_NEXT: "submitAndNext", FINISH_CAT: "finishCAT" };
    const META_ACTION_CANDIDATES = ["get_metadata", "getMaterialTree", "getTextbookMeta", "getContentMeta", "getContentOptions", "getTextbookOptions", "getLessonOptions", ACTION.GET_UNIT_OPTIONS];
    const STUDENTID_ACTION_CANDIDATES = ["getStudentIdByEmail", "getStudentIDByEmail", "resolveStudentIdByEmail", "resolveStudentIDByEmail", "resolveStudentId", "resolveStudentID", "getStudentId", "get_student_id", "getUserByEmail", "get_user_by_email", "getUser", "get_user", "getProfile", "get_profile"];

    /* ===========================
       1) I18N SYSTEM (NEW)
    =========================== */
    const i18n = {
      "zh-TW": {
        back: "返回",
        page_title: "AI 適性診斷中心",
        connecting: "連線中...",
        connected: "系統連線正常",
        disconnected: "連線中斷",
        step1_title: "診斷範圍設定",
        btn_reload: "重整資料庫",
        label_stage: "學習階段",
        label_grade: "年級",
        label_semester: "學期",
        label_publisher: "版本",
        label_unit: "單元",
        question_count: "測驗題數",
        btn_start: "開始診斷",
        step2_title: "智能作答區",
        waiting_start: "等待測驗啟動...",
        hint_select: "請選擇一個選項",
        btn_submit: "送出",
        btn_next: "下一題",
        step3_title: "診斷報告",
        btn_pdf: "下載報告書",
        btn_restart: "重測",
        accuracy: "答對題數",
        score: "總分 (100分制)",
        wrong_analysis: "錯題概念分析",
        ai_feedback: "AI 學習處方",
        msg_ready: "準備就緒",
        msg_menu_updated: "單元選單已更新",
        msg_start_success: "測驗開始，請加油！",
        msg_submit_success: "作答成功！",
        msg_finish: "診斷完成",
        msg_generating_pdf: "正在製作您的 PDF 報告...",
        ph_loading: "載入中...",
        ph_select_stage: "請先選擇學習階段...",
        ph_select_grade: "請先選擇年級...",
        ph_no_data: "無資料",
        loading_title: "系統初始化中",
        loading_desc: "正在建立神經網路連接...",
        loading_q_title: "AI 正在命題中...",
        loading_q_desc: "第一次建立測驗模型約需 15-20 秒，請耐心候候",
        loading_a_title: "AI 診斷運算中...",
        loading_a_desc: "正在分析您的概念理解模型，生成學習處方..."
      },
      "en": {
        back: "Back",
        page_title: "AI Adaptive Diagnosis",
        connecting: "Connecting...",
        connected: "System Online",
        disconnected: "Disconnected",
        step1_title: "Configuration",
        btn_reload: "Reload DB",
        label_stage: "Stage",
        label_grade: "Grade",
        label_semester: "Semester",
        label_publisher: "Version",
        label_unit: "Unit",
        question_count: "Items",
        btn_start: "Start Diagnosis",
        step2_title: "Testing Area",
        waiting_start: "Waiting to start...",
        hint_select: "Please select an option",
        btn_submit: "Submit",
        btn_next: "Next",
        step3_title: "Diagnosis Report",
        btn_pdf: "Download Report",
        btn_restart: "Restart",
        accuracy: "Correct Count",
        score: "Total Score",
        wrong_analysis: "Concept Analysis",
        ai_feedback: "AI Prescription",
        msg_ready: "Ready",
        msg_menu_updated: "Menu Updated",
        msg_start_success: "Test Started!",
        msg_submit_success: "Submitted!",
        msg_finish: "Diagnosis Complete",
        msg_generating_pdf: "Generating PDF Report...",
        ph_loading: "Loading...",
        ph_select_stage: "Select Stage first...",
        ph_select_grade: "Select Grade first...",
        ph_no_data: "No Data",
        loading_title: "Initializing",
        loading_desc: "Connecting to Neural Network...",
        loading_q_title: "AI Generating...",
        loading_q_desc: "First time setup takes 15-20s, please wait.",
        loading_a_title: "Analyzing...",
        loading_a_desc: "Generating learning prescription..."
      },
      "ja": {
        back: "戻る",
        page_title: "AI 適応型診断",
        connecting: "接続中...",
        connected: "接続完了",
        disconnected: "切断されました",
        step1_title: "診断設定",
        btn_reload: "DB更新",
        label_stage: "段階",
        label_grade: "学年",
        label_semester: "学期",
        label_publisher: "出版社",
        label_unit: "単元",
        question_count: "問題数",
        btn_start: "診断開始",
        step2_title: "テストエリア",
        waiting_start: "開始を待機中...",
        hint_select: "選択肢を選んでください",
        btn_submit: "送信",
        btn_next: "次へ",
        step3_title: "診断レポート",
        btn_pdf: "レポート保存",
        btn_restart: "再テスト",
        accuracy: "正解数",
        score: "総合スコア",
        wrong_analysis: "誤答分析",
        ai_feedback: "AI学習処方箋",
        msg_ready: "準備完了",
        msg_menu_updated: "メニュー更新完了",
        msg_start_success: "テスト開始！",
        msg_submit_success: "送信完了！",
        msg_finish: "診断完了",
        msg_generating_pdf: "PDFレポートを作成中...",
        ph_loading: "読み込み中...",
        ph_select_stage: "段階を選択...",
        ph_select_grade: "学年を選択...",
        ph_no_data: "データなし",
        loading_title: "初期化中",
        loading_desc: "ニューラルネットワークに接続中...",
        loading_q_title: "AI出題中...",
        loading_q_desc: "初回は15〜20秒かかります。お待ちください。",
        loading_a_title: "AI分析中...",
        loading_a_desc: "学習処方箋を作成しています..."
      },
      "zh-CN": {
        back: "返回",
        page_title: "AI 适性诊断中心",
        connecting: "连接中...",
        connected: "系统连接正常",
        disconnected: "连接中断",
        step1_title: "诊断范围设定",
        btn_reload: "刷新数据库",
        label_stage: "学习阶段",
        label_grade: "年级",
        label_semester: "学期",
        label_publisher: "版本",
        label_unit: "单元",
        question_count: "测验题数",
        btn_start: "开始诊断",
        step2_title: "智能作答区",
        waiting_start: "等待测验启动...",
        hint_select: "请选择一个选项",
        btn_submit: "提交",
        btn_next: "下一题",
        step3_title: "诊断报告",
        btn_pdf: "下载报告书",
        btn_restart: "重测",
        accuracy: "答对题数",
        score: "总分 (100分制)",
        wrong_analysis: "错题概念分析",
        ai_feedback: "AI 学习处方",
        msg_ready: "准备就绪",
        msg_menu_updated: "单元菜单已更新",
        msg_start_success: "测验开始，请加油！",
        msg_submit_success: "作答成功！",
        msg_finish: "诊断完成",
        msg_generating_pdf: "正在制作您的 PDF 报告...",
        ph_loading: "载入中...",
        ph_select_stage: "请先选择学习阶段...",
        ph_select_grade: "请先选择年级...",
        ph_no_data: "无资料",
        loading_title: "系统初始化中",
        loading_desc: "正在建立神经网络连接...",
        loading_q_title: "AI 正在命题中...",
        loading_q_desc: "第一次建立测验模型约需 15-20 秒，请耐心候候",
        loading_a_title: "AI 诊断运算中...",
        loading_a_desc: "正在分析您的概念理解模型，生成学习处方..."
      }
    };

    let currentLang = "zh-TW";

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function changeLanguage() {
      const selector = document.getElementById("language-selector");
      currentLang = selector.value;
      
      document.querySelectorAll("[data-i18n]").forEach(el => {
        el.innerText = t(el.getAttribute("data-i18n"));
      });
      
      // Update placeholders in dropdowns via refreshAllDropdowns if possible, or direct access
      if (Meta.mode === "tree") refreshAllDropdowns(); // Re-renders options with translated placeholders
    }

    /* ===========================
       2) GLOBAL STATE & UI UTILS
    =========================== */
    const Meta = { mode: "tree", tree: {}, unitIndex: {}, publishers: [], unitsByPublisher: {} };
    const CAT = { started: false, test_id: "", student_id: "", current: null, next: null, selected: "", n: 15, step: 0 };

    const UI = {
      setConn(ok, msg){
        const b = document.getElementById("connBadge");
        if(ok){
          b.innerHTML = `<i class="fa-solid fa-wifi text-emerald-500"></i> <span data-i18n="connected">${t("connected")}</span>`;
          b.className = "hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-50 border border-emerald-200 text-xs font-bold text-emerald-600";
        }else{
          b.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> <span data-i18n="disconnected">${t("disconnected")}</span>`;
          b.className = "hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-50 border border-red-200 text-xs font-bold text-red-600";
          if(msg) UI.toast("Error", msg, "bad");
        }
      },
      toast(title, msg, type="info"){
        const t = document.getElementById("toast");
        const ic = document.getElementById("toastIcon");
        const tt = document.getElementById("toastTitle");
        const tm = document.getElementById("toastMsg");
        let iconHTML = '<i class="fa-solid fa-circle-info text-blue-400"></i>';
        if(type==="good") iconHTML = '<i class="fa-solid fa-circle-check text-emerald-400"></i>';
        if(type==="warn") iconHTML = '<i class="fa-solid fa-triangle-exclamation text-amber-400"></i>';
        if(type==="bad")  iconHTML = '<i class="fa-solid fa-circle-xmark text-red-400"></i>';
        ic.innerHTML = iconHTML;
        tt.textContent = title; tm.textContent = msg;
        t.classList.remove("hidden"); void t.offsetWidth;
        t.classList.remove("translate-y-20", "opacity-0");
        clearTimeout(UI._timer);
        UI._timer = setTimeout(()=>{
          t.classList.add("translate-y-20", "opacity-0");
          setTimeout(()=>t.classList.add("hidden"), 300);
        }, 4000);
      },
      setProgress(step, total){
        const txt = document.getElementById("progText");
        const bar = document.getElementById("progBar");
        const turtle = document.getElementById("turtleIcon");
        txt.textContent = `${step}/${total}`;
        const pct = total ? Math.min(100, (step/total)*100) : 0;
        bar.style.width = pct + "%";
        turtle.style.left = pct + "%";
        if(pct > 0) turtle.classList.add("animate-drive"); // Optional visual
      },
      showLoading(show, titleKey, descKey){
        const el = document.getElementById("loading-overlay");
        if(show){
          document.getElementById("loading-title").textContent = t(titleKey);
          document.getElementById("loading-desc").textContent = t(descKey);
          el.classList.remove("hidden"); el.classList.add("flex");
        } else {
          el.classList.add("hidden"); el.classList.remove("flex");
        }
      },
      showQuestion(show){
        document.getElementById("qEmpty").classList.toggle("hidden", show);
        document.getElementById("qWrap").classList.toggle("hidden", !show);
      },
      showResult(show){
        document.getElementById("resultSec").classList.toggle("hidden", !show);
        if(show) setTimeout(() => document.getElementById("resultSec").scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
      }
    };

    /* ===========================
       3) API & LOGIC (UNCHANGED)
    =========================== */
    function buildFormBody(payload){ const p=new URLSearchParams(); const action=payload?.action??""; if(action)p.set("action",action); if(payload?.content_db_id)p.set("content_db_id",String(payload.content_db_id)); if(payload?.sheet_name)p.set("sheet_name",String(payload.sheet_name)); if(payload?.email!=null)p.set("email",String(payload.email)); if(payload?.user_db_id)p.set("user_db_id",String(payload.user_db_id)); if(payload?.user_sheet_name)p.set("user_sheet_name",String(payload.user_sheet_name)); if(payload?.student_id_col)p.set("student_id_col",String(payload.student_id_col)); p.set("payload",JSON.stringify(payload??{})); if(payload?.subject!=null)p.set("subject",String(payload.subject)); if(payload?.stage!=null)p.set("stage",String(payload.stage)); if(payload?.grade!=null)p.set("grade",String(payload.grade)); if(payload?.semester!=null)p.set("semester",String(payload.semester)); const unit=payload?.unit; if(unit){ if(unit.subject!=null)p.set("subject",String(unit.subject)); if(unit.stage!=null)p.set("stage",String(unit.stage)); if(unit.grade!=null)p.set("grade",String(unit.grade)); if(unit.semester!=null)p.set("semester",String(unit.semester)); if(unit.textbook_version!=null)p.set("textbook_version",String(unit.textbook_version)); if(unit.unit_name!=null)p.set("unit_name",String(unit.unit_name)); if(unit.lesson_no!=null)p.set("lesson_no",String(unit.lesson_no)); if(unit.lesson_name!=null)p.set("lesson_name",String(unit.lesson_name)); if(unit.unit_key!=null)p.set("unit_key",String(unit.unit_key)); } const sid=payload?.student_id??payload?.student?.student_id; if(sid!=null)p.set("student_id",String(sid)); const keys=["test_id","item_id","response_option","max_items","min_items","stop_se","grade"]; for(const k of keys){ if(payload?.[k]!=null)p.set(k,String(payload[k])); } const settings=payload?.settings; if(settings){ if(settings.max_items!=null&&!p.has("max_items"))p.set("max_items",String(settings.max_items)); if(settings.min_items!=null&&!p.has("min_items"))p.set("min_items",String(settings.min_items)); if(settings.stop_se!=null&&!p.has("stop_se"))p.set("stop_se",String(settings.stop_se)); } return p; }
    function safeParseJSON(text){ const t=String(text??"").trim().replace(/^\)\]\}'\s*\n?/,""); try{return JSON.parse(t);}catch{return null;} }
    function normalizeOk(obj){ if(!obj||typeof obj!=="object")throw new Error("後端未回傳 JSON。"); const st=String(obj.status??"").toLowerCase(); if(st==="error"||st==="fail"||st==="failed")throw new Error(obj.message||obj.error||"後端回傳失敗（status=error）。"); if(st==="success")return{...obj,ok:true}; if(obj.ok===false)throw new Error(obj.error||obj.message||"後端回傳失敗。"); if(obj.success===false)throw new Error(obj.error||obj.message||"後端回傳失敗。"); if(obj.ok===true)return obj; if(obj.success===true)return{...obj,ok:true}; if(obj.error)throw new Error(obj.error); if(obj.message&&st)throw new Error(obj.message); return{...obj,ok:true}; }
    async function api(payload){ let lastErr=null; try{ const url=new URL(GAS_API_URL); if(payload?.action)url.searchParams.set("action",payload.action); if(payload?.content_db_id)url.searchParams.set("content_db_id",String(payload.content_db_id)); if(payload?.sheet_name)url.searchParams.set("sheet_name",String(payload.sheet_name)); if(payload?.email!=null)url.searchParams.set("email",String(payload.email)); if(payload?.user_db_id)url.searchParams.set("user_db_id",String(payload.user_db_id)); if(payload?.user_sheet_name)url.searchParams.set("user_sheet_name",String(payload.user_sheet_name)); if(payload?.student_id_col)url.searchParams.set("student_id_col",String(payload.student_id_col)); if(payload?.subject!=null)url.searchParams.set("subject",String(payload.subject)); if(payload?.stage!=null)url.searchParams.set("stage",String(payload.stage)); if(payload?.grade!=null)url.searchParams.set("grade",String(payload.grade)); if(payload?.semester!=null)url.searchParams.set("semester",String(payload.semester)); const res=await fetch(url.toString(),{method:"GET",redirect:"follow"}); const text=await res.text(); const json=safeParseJSON(text); if(json)return normalizeOk(json); throw new Error("後端未回傳 JSON（GET）。"); }catch(e){ lastErr=e; } try{ const formBody=buildFormBody(payload); const res=await fetch(GAS_API_URL,{method:"POST",body:formBody,redirect:"follow"}); const text=await res.text(); const json=safeParseJSON(text); if(json)return normalizeOk(json); throw new Error("後端未回傳 JSON（form POST）。"); }catch(e){ lastErr=e; } try{ const res=await fetch(GAS_API_URL,{method:"POST",body:JSON.stringify(payload),redirect:"follow"}); const text=await res.text(); const json=safeParseJSON(text); if(json)return normalizeOk(json); throw new Error("後端未回傳 JSON（JSON POST）。"); }catch(e){ throw new Error(String(e?.message||lastErr?.message||e)); } }
    async function ping(){ try{ const res=await fetch(GAS_API_URL,{method:"GET",redirect:"follow"}); if(!res.ok)throw new Error("HTTP "+res.status); UI.setConn(true); return true; }catch(e){ UI.setConn(false,String(e?.message||e)); return false; } }

    /* ===========================
       4) DATA & TREE
    =========================== */
    function normStage(v){const s=String(v??"").trim();if(s.includes("國小")||s==="小學")return"國小";if(s.includes("國中")||s==="國中部")return"國中";return s;}
    function normSemester(v){const s=String(v??"").trim();if(s.includes("上"))return"上學期";if(s.includes("下"))return"下學期";return s;}
    function normVersion(v){return String(v??"").trim();}
    function normLessonNo(v){return String(v??"").trim();}
    function normLessonName(v){return String(v??"").trim();}
    function toIntGrade(v){const n=Number(String(v??"").replace(/[^\d]/g,""));return Number.isFinite(n)?n:NaN;}
    function buildTreeFromRows(rows){ const tree={}; const unitIndex={}; for(const r of rows){ const stage=normStage(r.stage??r["中小學"]??r["學習階段"]??r.level??r.school_stage); const grade=toIntGrade(r.grade??r["年級"]); const semester=normSemester(r.semester??r["學期"]); const version=normVersion(r.textbook_version??r.publisher??r["版本"]??r["出版社"]); const lessonNo=normLessonNo(r.lesson_no??r["課別"]??r.unit_no??r["課序"]); const lessonName=normLessonName(r.lesson_name??r["課名"]??r.unit_name??r["單元"]??r["單元名稱"]); if(!stage||!Number.isFinite(grade)||!semester||!version||!lessonName)continue; const unitName=(lessonNo?`${lessonNo} ${lessonName}`:lessonName).trim(); const unitKey=`${stage}||${grade}||${semester}||${version}||${lessonNo}||${lessonName}`; if(!tree[stage])tree[stage]={}; if(!tree[stage][grade])tree[stage][grade]={}; if(!tree[stage][grade][semester])tree[stage][grade][semester]={}; if(!tree[stage][grade][semester][version])tree[stage][grade][semester][version]=[]; tree[stage][grade][semester][version].push({unit_key:unitKey,lesson_no:lessonNo,lesson_name:lessonName,unit_name:unitName}); unitIndex[unitKey]={unit_key:unitKey,stage,grade,semester,textbook_version:version,lesson_no:lessonNo,lesson_name:lessonName,unit_name:unitName}; } for(const st of Object.keys(tree)){ for(const g of Object.keys(tree[st])){ for(const sem of Object.keys(tree[st][g])){ for(const ver of Object.keys(tree[st][g][sem])){ const arr=tree[st][g][sem][ver]||[]; const seen=new Set(); const uniq=[]; for(const u of arr){ if(seen.has(u.unit_key))continue; seen.add(u.unit_key); uniq.push(u); } uniq.sort((a,b)=>{ const an=Number(String(a.lesson_no||"").replace(/[^\d]/g,"")); const bn=Number(String(b.lesson_no||"").replace(/[^\d]/g,"")); if(Number.isFinite(an)&&Number.isFinite(bn)&&an!==bn)return an-bn; return String(a.unit_name).localeCompare(String(b.unit_name),"zh-Hant"); }); tree[st][g][sem][ver]=uniq; } } } } return{tree,unitIndex}; }
    function buildTreeFromLegacy(publishers,unitsByPublisher,grade,semester){ const tree={}; const unitIndex={}; const st=(grade<=6)?"國小":"國中"; const sem=normSemester(semester); tree[st]={}; tree[st][grade]={}; tree[st][grade][sem]={}; for(const ver of(publishers||[])){ const units=(unitsByPublisher&&unitsByPublisher[ver])?unitsByPublisher[ver]:[]; tree[st][grade][sem][ver]=[]; for(const u of units){ const unitName=String(u??"").trim(); if(!unitName)continue; const unitKey=`${st}||${grade}||${sem}||${ver}||||${unitName}`; tree[st][grade][sem][ver].push({unit_key:unitKey,lesson_no:"",lesson_name:unitName,unit_name:unitName}); unitIndex[unitKey]={unit_key:unitKey,stage:st,grade,semester:sem,textbook_version:ver,lesson_no:"",lesson_name:unitName,unit_name:unitName}; } } return{tree,unitIndex}; }
    async function loadMaterialTree(){ let lastErr=null; for(const act of META_ACTION_CANDIDATES){ try{ const json=await api({action:act,content_db_id:CONTENT_DB_ID,sheet_name:CONTENT_SHEET_NAME,subject:"自然科學"}); if(json.tree&&typeof json.tree==="object"){Meta.tree=json.tree;Meta.unitIndex=json.unitIndex||{};Meta.mode="tree";return true;} const rows=json.rows||json.data||json.items||json.materials; if(Array.isArray(rows)&&rows.length){const built=buildTreeFromRows(rows);Meta.tree=built.tree;Meta.unitIndex=built.unitIndex;Meta.mode="tree";return true;} if(Array.isArray(json.publishers)&&json.unitsByPublisher){Meta.publishers=json.publishers;Meta.unitsByPublisher=json.unitsByPublisher;Meta.mode="legacy";return true;} if(Array.isArray(json)&&json.length){const built=buildTreeFromRows(json);Meta.tree=built.tree;Meta.unitIndex=built.unitIndex;Meta.mode="tree";return true;} throw new Error("回傳格式不含教材選單資料。"); }catch(e){lastErr=e;} } throw new Error(String(lastErr?.message||lastErr||"無法載入教材選單。")); }

    /* ===========================
       5) DROPDOWNS (With I18N placeholders)
    =========================== */
    function setOptions(selectEl, options, placeholderKey){ 
      selectEl.innerHTML=""; 
      if(!options||options.length===0){ 
        const op=document.createElement("option"); op.value=""; op.textContent=t(placeholderKey); selectEl.appendChild(op); return; 
      } 
      for(const {value,label} of options){ const op=document.createElement("option"); op.value=String(value); op.textContent=String(label); selectEl.appendChild(op); } 
    }
    function getSelStage(){return document.getElementById("selStage").value.trim();}
    function getSelGrade(){return Number(document.getElementById("selGrade").value);}
    function getSelSemester(){return document.getElementById("selSemester").value.trim();}
    function getSelVersion(){return document.getElementById("selPublisher").value.trim();}
    function getSelUnitKey(){return document.getElementById("selUnit").value.trim();}
    
    function refreshAllDropdowns(){ 
      const selStage=document.getElementById("selStage"); const selGrade=document.getElementById("selGrade"); const selSem=document.getElementById("selSemester"); const selVer=document.getElementById("selPublisher"); const selUnit=document.getElementById("selUnit"); 
      const stageKeys=Object.keys(Meta.tree||{}).sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant")); 
      const prevStage=selStage.value; 
      setOptions(selStage,stageKeys.map(s=>({value:s,label:s})),"ph_no_data"); 
      if(prevStage&&stageKeys.includes(prevStage))selStage.value=prevStage; 
      
      const stage=getSelStage(); 
      const gradesObj=(Meta.tree&&stage&&Meta.tree[stage])?Meta.tree[stage]:{}; 
      const gradeKeys=Object.keys(gradesObj).map(x=>Number(x)).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b); 
      const prevGrade=selGrade.value; 
      setOptions(selGrade,gradeKeys.map(g=>({value:g,label:`${g}年級`})),"ph_select_stage"); 
      if(prevGrade&&gradeKeys.map(String).includes(String(prevGrade)))selGrade.value=prevGrade; 
      
      const grade=getSelGrade(); 
      const semObj=(gradesObj&&Number.isFinite(grade)&&gradesObj[grade])?gradesObj[grade]:{}; 
      const semKeys=Object.keys(semObj); const semOrder=["上學期","下學期"]; semKeys.sort((a,b)=>semOrder.indexOf(a)-semOrder.indexOf(b)); 
      const prevSem=selSem.value; 
      setOptions(selSem,semKeys.map(s=>({value:s,label:s})),"ph_select_grade"); 
      if(prevSem&&semKeys.includes(prevSem))selSem.value=prevSem; 
      
      const semester=getSelSemester(); 
      const verObj=(semObj&&semester&&semObj[semester])?semObj[semester]:{}; 
      const verKeys=Object.keys(verObj).sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant")); 
      const prevVer=selVer.value; 
      setOptions(selVer,verKeys.map(v=>({value:v,label:v})),"ph_no_data"); 
      if(prevVer&&verKeys.includes(prevVer))selVer.value=prevVer; 
      
      const version=getSelVersion(); 
      const unitsArr=(verObj&&version&&Array.isArray(verObj[version]))?verObj[version]:[]; 
      const prevUnit=selUnit.value; 
      setOptions(selUnit,unitsArr.map(u=>({value:u.unit_key,label:u.unit_name})),"ph_no_data"); 
      if(prevUnit&&unitsArr.some(u=>u.unit_key===prevUnit))selUnit.value=prevUnit; 
      
      document.getElementById("publisherHint").textContent=""; document.getElementById("unitHint").textContent=""; 
    }
    
    async function loadLegacyByGradeSemester(){ const selStage=document.getElementById("selStage"); const selGrade=document.getElementById("selGrade"); const selSem=document.getElementById("selSemester"); const selVer=document.getElementById("selPublisher"); const selUnit=document.getElementById("selUnit"); const stageOptions=[{value:"國小",label:"國小"},{value:"國中",label:"國中"}]; setOptions(selStage,stageOptions,"ph_no_data"); const stage=getSelStage()||"國小"; selStage.value=stage; const gradeList=(stage==="國中")?[7,8,9]:[3,4,5,6]; setOptions(selGrade,gradeList.map(g=>({value:g,label:`${g}年級`})),"ph_no_data"); setOptions(selSem,[{value:"上學期",label:"上學期"},{value:"下學期",label:"下學期"}],"ph_no_data"); const grade=getSelGrade()||gradeList[0]; const semester=getSelSemester()||"上學期"; document.getElementById("publisherHint").textContent=""; document.getElementById("unitHint").textContent=""; const json=await api({ action:ACTION.GET_UNIT_OPTIONS, content_db_id:CONTENT_DB_ID, sheet_name:CONTENT_SHEET_NAME, subject:"自然科學", stage, grade, semester }); Meta.publishers=Array.isArray(json.publishers)?json.publishers:[]; Meta.unitsByPublisher=json.unitsByPublisher||{}; const publishers=Meta.publishers||[]; setOptions(selVer,publishers.map(p=>({value:p,label:p})),"ph_no_data"); const built=buildTreeFromLegacy(publishers,Meta.unitsByPublisher,grade,semester); Meta.tree=built.tree; Meta.unitIndex=built.unitIndex; refreshAllDropdowns(); }
    async function bootstrapMaterials(){ document.getElementById("publisherHint").textContent=""; document.getElementById("unitHint").textContent=""; Meta.mode="tree"; Meta.tree={}; Meta.unitIndex={}; await loadMaterialTree(); if(Meta.mode==="tree"){refreshAllDropdowns();return;} await loadLegacyByGradeSemester(); }

    /* ===========================
       6) TEST FLOW & RENDERING
    =========================== */
    function getUnit(){ const stage=getSelStage(); const grade=getSelGrade(); const semester=getSelSemester(); const textbook_version=getSelVersion(); const unit_key=getSelUnitKey(); const u=Meta.unitIndex[unit_key]||{}; const unit_name=(u.unit_name||"").trim(); return{subject:"自然科學",stage,grade,semester,textbook_version,unit_name,unit_key,lesson_no:u.lesson_no||"",lesson_name:u.lesson_name||""}; }
    function normalizeItem(raw){ if(!raw)return null; const optObj=raw.options||{}; return{ item_id:String(raw.item_id||"").trim(), stem:String(raw.stem||"").trim(), textbook_source:String(raw.textbook_source||"").trim(), concept_tag:String(raw.concept_tag||"").trim(), options:{ A:String(raw.option_A??optObj.A??""), B:String(raw.option_B??optObj.B??""), C:String(raw.option_C??optObj.C??""), D:String(raw.option_D??optObj.D??"") } }; }
    function parseAndRenderStimulus(rawStem){ const marker="[STIMULUS_JSON]"; const idx=rawStem.indexOf(marker); if(idx<0){return{text:rawStem,html:""};} const textPart=rawStem.substring(0,idx).trim(); const jsonPart=rawStem.substring(idx+marker.length).trim(); let htmlPart=""; try{ const data=JSON.parse(jsonPart); if(data.kind==="table"&&data.table){ const cols=data.table.columns||[]; const rows=data.table.rows||[]; htmlPart=`<div class="my-4 overflow-x-auto border border-orange-200 rounded-xl shadow-sm bg-white"><table class="min-w-full divide-y divide-orange-100 text-sm"><thead class="bg-orange-50"><tr>${cols.map(c=>`<th class="px-4 py-3 text-left font-bold text-orange-900 whitespace-nowrap">${c}</th>`).join('')}</tr></thead><tbody class="divide-y divide-orange-100 bg-white">${rows.map(r=>`<tr class="hover:bg-orange-50/50">${r.map(cell=>`<td class="px-4 py-3 text-slate-700 whitespace-nowrap">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`; } }catch(e){console.error("表格解析失敗:",e);} return{text:textPart,html:htmlPart}; }
    function getStudentIdFromLogin(){ const storages=[sessionStorage,localStorage]; const directKeys=["student_id","StudentID","SLH_student_id","slh_student_id","user_student_id","login_student_id","current_student_id"]; for(const S of storages){ for(const k of directKeys){ const v=S.getItem(k); const s=String(v??"").trim(); if(s)return s; } } return ""; }
    async function ensureStudentId(){ if(CAT.student_id)return String(CAT.student_id).trim(); let sid=String(getStudentIdFromLogin()||"").trim(); if(sid){ CAT.student_id=sid; return sid; } return "GUEST"; /* Fallback for demo */ }
    function clampNum(x,lo,hi,def){ const n=Number(x); return Number.isFinite(n)?Math.max(lo,Math.min(hi,n)):def; }
    function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // Render Question
    function renderItem(item){
      UI.showQuestion(true);
      const content = parseAndRenderStimulus(item.stem || "");
      const stemDiv = document.getElementById("qStem");
      stemDiv.innerHTML = "";
      const textNode = document.createElement("div"); textNode.textContent = content.text; stemDiv.appendChild(textNode);
      if (content.html) { const wrapper = document.createElement("div"); wrapper.innerHTML = content.html; stemDiv.appendChild(wrapper); }

      const wrap = document.getElementById("optWrap"); wrap.innerHTML = "";
      CAT.selected = "";
      const btnSubmit = document.getElementById("btnSubmit"); const btnNext = document.getElementById("btnNext");
      
      btnSubmit.disabled = true; btnSubmit.classList.add('opacity-50', 'cursor-not-allowed');
      btnNext.disabled = true; btnNext.classList.add('opacity-50', 'cursor-not-allowed', 'bg-slate-200', 'text-slate-400');
      btnNext.classList.remove('bg-emerald-500', 'text-white', 'shadow-lg');

      document.getElementById("hint").innerHTML = `<i class="fa-solid fa-circle-info text-blue-400"></i> ${t("hint_select")}`;

      const letters = ["A","B","C","D"];
      for(const L of letters){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "opt-btn text-left w-full px-5 py-4 rounded-xl bg-white transition focus:outline-none flex items-start gap-4";
        btn.setAttribute("data-letter", L);
        btn.innerHTML = `<div class="badge w-8 h-8 rounded-lg bg-slate-100 text-slate-500 font-bold flex items-center justify-center shrink-0 transition">${L}</div><div class="flex-1 text-slate-700 font-medium pt-1">${escapeHtml(item.options[L] || "")}</div>`;
        btn.onclick = () => selectOption(L);
        wrap.appendChild(btn);
      }
    }

    function selectOption(letter){
      CAT.selected = letter;
      document.querySelectorAll("#optWrap button").forEach(b=>{
        if(b.getAttribute("data-letter") === letter) b.classList.add("selected");
        else b.classList.remove("selected");
      });
      const btnSubmit = document.getElementById("btnSubmit");
      btnSubmit.disabled = false; btnSubmit.classList.remove('opacity-50', 'cursor-not-allowed');
      document.getElementById("hint").innerHTML = `<i class="fa-solid fa-circle-check text-emerald-500"></i> Selected <b>${letter}</b>`;
    }

    async function startTest(){
      const unit = getUnit();
      if(!unit.stage || !unit.grade || !unit.semester || !unit.textbook_version || !unit.unit_name){
        UI.toast("Error", "Please select all unit options.", "warn"); return;
      }
      const sid = await ensureStudentId();
      const n = clampNum(Number(document.getElementById("inpN").value), 5, 40, 15);
      CAT.n = n;
      document.getElementById("btnStart").disabled = true;
      UI.showLoading(true, "loading_q_title", "loading_q_desc");

      try{
        const json = await api({ action: ACTION.START_CAT, student: { student_id: sid }, unit, settings: { max_items: n } });
        CAT.started = true; CAT.student_id = sid; CAT.test_id = json.test_id || ""; CAT.step = 0;
        const first = normalizeItem(json.item);
        if(!first) throw new Error("No items returned.");
        CAT.current = first; CAT.next = null;
        UI.setProgress(0, CAT.n);
        document.getElementById("btnFinish").disabled = false;
        renderItem(first);
        UI.toast("Success", t("msg_start_success"), "good");
        setTimeout(() => document.querySelector(".glass-panel:nth-of-type(2)").scrollIntoView({ behavior: 'smooth', block: 'start' }), 500);
      }catch(e){
        UI.toast("Error", String(e?.message || e), "bad");
      }finally{
        document.getElementById("btnStart").disabled = false;
        UI.showLoading(false);
      }
    }

    async function submitAnswer(){
      if(!CAT.started || !CAT.current) return;
      if(!CAT.selected){ UI.toast("Info", t("hint_select"), "warn"); return; }
      
      const btnSubmit = document.getElementById("btnSubmit"); const btnNext = document.getElementById("btnNext");
      btnSubmit.disabled = true; btnSubmit.classList.add('opacity-50');
      btnNext.disabled = true;
      document.getElementById("hint").innerHTML = `<i class="fa-solid fa-spinner fa-spin text-blue-500"></i> ...`;
      
      const unit = getUnit();
      try{
        const json = await api({
          action: ACTION.SUBMIT_NEXT, test_id: CAT.test_id, student_id: CAT.student_id,
          item_id: CAT.current.item_id, response_option: CAT.selected,
          max_items: CAT.n, min_items: CAT.n, stop_se: 0, grade: String(unit.grade || "")
        });
        const prog = json.progress || {};
        CAT.step = Number(prog.n_admin || (CAT.step + 1));
        UI.setProgress(CAT.step, CAT.n);
        if(json.done === true || CAT.step >= CAT.n){ await finishTest(); return; }
        const next = normalizeItem(json.item);
        if(!next) throw new Error("No next item.");
        CAT.next = next;
        
        btnNext.disabled = false;
        btnNext.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-slate-200', 'text-slate-400');
        btnNext.classList.add('bg-emerald-500', 'text-white', 'shadow-lg');
        document.getElementById("hint").innerHTML = `<span class="text-emerald-600 font-bold"><i class="fa-solid fa-circle-check"></i> ${t("msg_submit_success")}</span>`;
      }catch(e){
        UI.toast("Error", String(e?.message||e), "bad");
        btnSubmit.disabled = false; btnSubmit.classList.remove('opacity-50');
      }
    }

    function goNext(){ if(!CAT.next) return; CAT.current = CAT.next; CAT.next = null; renderItem(CAT.current); }

    async function finishTest(){
      document.getElementById("btnFinish").disabled = true; document.getElementById("btnSubmit").disabled = true; document.getElementById("btnNext").disabled = true;
      UI.showLoading(true, "loading_a_title", "loading_a_desc");

      try{
        const json = await api({ action: ACTION.FINISH_CAT, test_id: CAT.test_id, student_id: CAT.student_id });
        UI.showResult(true); UI.showLoading(false);

        document.getElementById("resScore").textContent = json.score ?? "—";
        const scoreStr = json.score || "0/0"; 
        const [correct, total] = scoreStr.split('/').map(Number);
        const finalScore = total ? Math.round((correct / total) * 100) : 0;
        document.getElementById("resScore100").textContent = finalScore;
        document.getElementById("resTestId").textContent = json.test_id ?? "";

        let fb = json.feedback_student || "No feedback.";
        fb = fb.replace(/你的能力估計.*?測量精度.*?。/g, "");
        fb = fb.replace(/相對優勢概念：/g, "👍 **優勢概念**：");
        fb = fb.replace(/建議優先補強概念：/g, "💪 **補強建議**：");
        fb = fb.replace(/錯題建議回看：/g, "📖 **複習重點**：");
        if (finalScore === 100) fb = "🎉 **太完美了！** 你的觀念非常清晰！\n\n" + fb;
        document.getElementById("resFeedback").textContent = fb.trim();

        const wrongHtml = (json.wrong_items || []).map((w,i)=>`
          <div class="bg-white p-4 rounded-xl border border-red-100 flex gap-4">
            <div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center font-bold shrink-0">${i+1}</div>
            <div>
              <div class="text-slate-700">關於「<span class="font-bold text-red-500">${escapeHtml(w.concept_tag)}</span>」的觀念還不夠熟悉。</div>
              ${w.textbook_source?`<div class="mt-2 text-sm text-slate-500 bg-slate-50 px-2 py-1 rounded inline-block"><i class="fa-solid fa-book-open text-blue-400"></i> ${escapeHtml(w.textbook_source)}</div>`:''}
            </div>
          </div>`).join('');
        document.getElementById("resWrong").innerHTML = wrongHtml || `<div class="bg-emerald-50 p-4 rounded-xl text-emerald-700">Excellent! No wrong answers.</div>`;

        preparePDFData(json, finalScore, fb, wrongHtml);
        UI.toast("Info", t("msg_finish"), "good");
        CAT.started = false;
      }catch(e){
        UI.showLoading(false);
        UI.toast("Error", String(e?.message||e), "bad");
      }
    }

    function preparePDFData(json, finalScore, fb, wrongHtml) {
        const unit = getUnit();
        document.getElementById('pdf-unit-name').textContent = unit.unit_name || "未命名單元";
        document.getElementById('pdf-student-name').textContent = CAT.student_id || "Guest";
        document.getElementById('pdf-report-id').textContent = json.test_id || "N/A";
        document.getElementById('pdf-score-circle').textContent = finalScore;
        document.getElementById('pdf-raw-score').textContent = json.score || "0/0";
        
        let comment = "尚可";
        if (finalScore >= 90) comment = "優秀"; else if (finalScore >= 80) comment = "良好"; else if (finalScore >= 60) comment = "及格"; else comment = "需加油";
        document.getElementById('pdf-comment').textContent = comment;
        
        const xs = json.wrong_items || [];
        if (xs.length === 0) {
            document.getElementById('pdf-wrong-list').innerHTML = '<div style="color: #10b981; font-weight: bold; padding: 10px; background: #f0fdf4;">恭喜！本次測驗無錯題，概念掌握極佳。</div>';
        } else {
            document.getElementById('pdf-wrong-list').innerHTML = xs.map((w, i) => `
                <div style="margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">
                    <div style="font-weight: bold; color: #b91c1c;">${i+1}. 概念弱點：${escapeHtml(w.concept_tag || "未標示")}</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">建議複習：${escapeHtml(w.textbook_source || "全單元")}</div>
                </div>`).join('');
        }
        
        // Split AI Feedback for better presentation
        const parts = fb.split('\n\n');
        document.getElementById('pdf-ai-diagnosis').innerText = parts[0] || ""; // Concept Strength/Weakness
        document.getElementById('pdf-remedial').innerText = parts.slice(1).join('\n\n') || "請參考課本內容進行複習。"; // Remedial
    }

    document.getElementById("btnDownload").addEventListener("click", function() {
        const element = document.getElementById('pdf-report');
        element.style.display = 'block'; 
        UI.toast("Info", t("msg_generating_pdf"), "info");
        const opt = { margin: 0, filename: `Diagnosis_${getUnit().unit_name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save().then(() => { element.style.display = 'none'; UI.toast("Success", "PDF Saved", "good"); });
    });

    document.getElementById("btnRestart").addEventListener("click", ()=>{
      CAT.started = false; CAT.test_id = ""; CAT.current = null; CAT.next = null; CAT.selected = ""; CAT.step = 0;
      UI.setProgress(0, Number(document.getElementById("inpN").value)||0);
      UI.showQuestion(false); UI.showResult(false);
      document.getElementById("btnFinish").disabled = true; document.getElementById("btnSubmit").disabled = true; document.getElementById("btnNext").disabled = true;
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    /* ===========================
       7) INITIALIZATION
    =========================== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      UI.showLoading(true, "loading_title", "loading_desc");
      UI.setProgress(0, clampNum(Number(document.getElementById("inpN").value),5,40,15));
      await ping();
      try{ await bootstrapMaterials(); UI.toast("Success", t("msg_ready"), "good"); }
      catch(e){ UI.toast("Error", String(e?.message||e), "bad"); }
      finally{ UI.showLoading(false); }

      document.getElementById("btnReload").addEventListener("click", async ()=>{
        try{ await bootstrapMaterials(); UI.toast("Success", t("msg_menu_updated"), "good"); }
        catch(e){ UI.toast("Error", String(e?.message||e), "bad"); }
      });

      document.getElementById("selStage").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); else loadLegacyByGradeSemester(); });
      document.getElementById("selGrade").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); else loadLegacyByGradeSemester(); });
      document.getElementById("selSemester").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); else loadLegacyByGradeSemester(); });
      document.getElementById("selPublisher").addEventListener("change", ()=>{ if(Meta.mode==="tree")refreshAllDropdowns(); });

      document.getElementById("inpN").addEventListener("change", ()=>{
        const n = clampNum(Number(document.getElementById("inpN").value),5,40,15);
        document.getElementById("inpN").value = n;
        if(!CAT.started) UI.setProgress(0, n);
      });

      document.getElementById("btnStart").addEventListener("click", startTest);
      document.getElementById("btnSubmit").addEventListener("click", submitAnswer);
      document.getElementById("btnNext").addEventListener("click", goNext);
      document.getElementById("btnFinish").addEventListener("click", finishTest);
    });
  </script>
</body>
</html>
