<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–®å…ƒé‡é»ç²¾ç†Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { student: '#3b82f6' },
                    animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" },
                    keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } }
                }
            }
        }
        mermaid.initialize({
            startOnLoad: false,
            theme: 'neutral',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true }
        });
    </script>
    
    <style>
        /* =========================================
           1. å…¨åŸŸè¨­å®š & ç§‘å¹»èƒŒæ™¯
           ========================================= */
        body {
            background-color: #0B1121;
            color: #f1f5f9;
            font-family: 'Inter', 'Noto Sans TC', "Microsoft JhengHei", sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(56, 189, 248, 0.1), transparent 60%);
            z-index: -2; pointer-events: none;
        }

        /* =========================================
           2. ç»ç’ƒæ“¬æ…‹é¢æ¿
           ========================================= */
        .glass-panel, .glass-card {
            background: rgba(30, 41, 59, 0.7) !important;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
            border-radius: 1.5rem !important;
            color: #e2e8f0 !important;
        }

        /* =========================================
           3. [ä¿®æ­£] ç™½åº•å€å¡Šå¼·åˆ¶æ·±è‰²æ–‡å­— (è§£æ±ºæ¸¬é©—çœ‹ä¸åˆ°å­—)
           ========================================= */
        .glass-panel.bg-white, .bg-white {
            color: #1e293b !important; 
        }
        #quiz-body .text-slate-800, 
        #quiz-question, 
        #quiz-result-text,
        .quiz-option-btn,
        #myth-list .text-slate-800 {
            color: #0f172a !important; /* å¼·åˆ¶æ·±è‰²å­— */
        }

        /* =========================================
           4. å…ƒä»¶æ¨£å¼
           ========================================= */
        select, .tech-select {
            background-color: rgba(15, 23, 42, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #fff !important;
            border-radius: 0.75rem !important;
            transition: all 0.3s ease;
        }
        select:focus {
            border-color: #38bdf8 !important;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            outline: none;
        }
        select:disabled { opacity: 0.5; cursor: not-allowed; }

        #btn-generate, .tech-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%) !important;
            border: none !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4) !important;
            transition: all 0.3s ease !important;
        }
        #btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6) !important;
        }
        #btn-generate:disabled { filter: grayscale(1); opacity: 0.5; }

        nav {
            background: rgba(15, 23, 42, 0.95) !important;
            border-bottom: 1px solid rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(12px);
        }

        .quiz-option-btn {
            background-color: #f8fafc !important;
            border: 1px solid #cbd5e1 !important;
        }
        .quiz-option-btn:hover {
            background-color: #eff6ff !important;
            border-color: #60a5fa !important;
        }

        .vocab-item { 
            background: rgba(255,255,255,0.9) !important; 
            border-color: rgba(255,255,255,0.1) !important; 
            color: #1e293b !important;
        }
        .vocab-item .text-slate-600 { color: #475569 !important; }
        
        .loader { border-color: rgba(255,255,255,0.1); border-top-color: #38bdf8; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } }

        /* =========================================
           5. æ ¸å¿ƒæ¦‚å¿µæ’ç‰ˆ (å¡ç‰‡å¼)
           ========================================= */
        #summary-panel { border-left: 5px solid #3b82f6 !important; background: #f8fafc !important; }
        
        .summary-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
            color: #1e293b !important;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.08);
            border-color: #bfdbfe;
        }
        
        #summary-text { font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; }
        
        #summary-text h3 {
            font-size: 1.35rem; font-weight: 800; color: #1e3a8a !important;
            margin-top: 0 !important; margin-bottom: 1rem; padding-left: 0.8rem;
            border-left: 5px solid #3b82f6; 
            background: linear-gradient(90deg, #eff6ff 0%, transparent 100%);
            line-height: 1.6; border-radius: 0 4px 4px 0;
        }
        #summary-text strong, #summary-text b {
            background: linear-gradient(120deg, rgba(253, 224, 71, 0.3) 0%, rgba(253, 224, 71, 0.6) 100%);
            padding: 0 4px; border-radius: 2px; color: #0f172a !important; font-weight: 800;
        }
        #summary-text ul { list-style: none; padding-left: 0; margin: 0; }
        #summary-text li { 
            position: relative; padding-left: 1.5rem; margin-bottom: 0.6rem; 
            line-height: 1.7; font-size: 1.05rem; color: #475569 !important;
        }
        #summary-text > .summary-card > ul > li::before { content: "â—"; color: #3b82f6; font-weight: bold; position: absolute; left: 0.2rem; top: 0; }
        #summary-text ul ul { margin-top: 0.4rem; padding-left: 0.5rem; }
        #summary-text ul ul li::before { content: "â—‹"; color: #94a3b8; font-weight: normal; position: absolute; left: 0.2rem; top: 0; }

        /* =========================================
           6. å€å¡Šé¡è‰²è­˜åˆ¥
           ========================================= */
        #vocab-panel { border-left: 5px solid #a855f7 !important; background: #faf5ff !important; }
        #vocab-panel h3 { color: #6b21a8 !important; }
        .glass-panel:has(#chart-container) { border-top: 5px solid #06b6d4 !important; background: #ecfeff !important; }
        .glass-panel:has(#myth-list) { border-left: 5px solid #f97316 !important; background: #fff7ed !important; }
        #quiz-panel { border-left: 5px solid #10b981 !important; background: #f0fdf4 !important; }

        /* =========================================
           7. å°ç§‘å®šä½èˆ‡ç‰¹æ•ˆ
           ========================================= */
        #floating-chat {
            position: fixed; 
            bottom: 1.5rem; right: 1.5rem;
            display: flex; flex-direction: column; align-items: end;
            z-index: 9999;
            touch-action: none; 
            user-select: none;
        }
        
        /* æ¡Œé¢ç‰ˆï¼šå°ç§‘è¦–çª—å¼·åˆ¶å®šä½åœ¨ã€Œåœ–ç¤ºä¸Šæ–¹ã€ä¸”å¾€å·¦ä¸Šæ–¹å±•é–‹ */
        @media (min-width: 641px) {
            #xiaoke-window {
                position: absolute;
                bottom: 80px; /* ä½æ–¼åœ–ç¤ºä¸Šæ–¹ */
                right: 0;
                margin-bottom: 0;
                transform-origin: bottom right;
            }
        }

        .xiaoke-glow {
            position: relative; z-index: 10;
            border: 2px solid rgba(56, 189, 248, 0.6);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4), 0 0 30px rgba(59, 130, 246, 0.2);
            animation: float-pulse 3s infinite ease-in-out;
            cursor: grab; transition: transform 0.2s, box-shadow 0.2s;
        }
        .xiaoke-glow:active { cursor: grabbing; transform: scale(0.95); box-shadow: 0 0 25px rgba(56, 189, 248, 0.8); }
        @keyframes float-pulse {
            0%, 100% { transform: translateY(0); filter: brightness(1); }
            50% { transform: translateY(-6px); filter: brightness(1.2) drop-shadow(0 0 8px rgba(56, 189, 248, 0.6)); }
        }
        
        .xiaoke-tooltip {
            position: absolute; bottom: 85px; right: 10px;
            background: white; color: #0f172a;
            padding: 8px 16px; border-radius: 16px; border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 0.9rem; font-weight: 700; white-space: nowrap;
            pointer-events: none; opacity: 0;
            transform: translateY(10px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 9998;
        }
        .xiaoke-tooltip.show { opacity: 1; transform: translateY(0) scale(1); }

        /* =========================================
           8. æ‰‹æ©Ÿç‰ˆé¢å„ªåŒ– (RWD)
           ========================================= */
        @media (max-width: 640px) {
            nav { height: 3.5rem; padding: 0 1rem; }
            nav h1 { font-size: 1.1rem; }
            main { padding-top: 5rem !important; padding-bottom: 7rem !important; }
            
            #floating-chat { bottom: 1rem; right: 1rem; }
            
            /* æ‰‹æ©Ÿç‰ˆè¦–çª—ä½”æ»¿åº•éƒ¨ */
            #xiaoke-window {
                position: fixed;
                width: 92vw !important; left: 4vw !important; bottom: 5.5rem !important; right: auto !important;
                height: 60vh !important;
                transform-origin: bottom center;
            }
            .xiaoke-glow { cursor: default; } 
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="fixed top-0 left-0 right-0 h-16 flex items-center justify-between px-6 z-50 no-print">
        <div class="flex items-center">
            <a href="student_science.html" class="flex items-center gap-2 text-slate-300 hover:text-white transition group decoration-0">
                <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition">
                    <i class="fa-solid fa-arrow-left text-sm text-white"></i>
                </div>
                <span class="font-bold tracking-wide text-white hidden md:block" data-i18n="back_home">è¿”å› AI Science</span>
            </a>
        </div>

        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center pointer-events-none">
            <h1 class="text-xl font-black text-white tracking-widest bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-400" data-i18n="page_title">
                å–®å…ƒé‡é»ç²¾ç†Ÿ
            </h1>
            <span class="text-[10px] text-slate-400 tracking-[0.2em] uppercase hidden sm:block" data-i18n="page_subtitle">AI Intelligent Note Generation</span>
        </div>

        <div class="flex items-center gap-4">
            <div class="relative ml-2">
                <select id="language-selector" onchange="changeLanguage()" class="bg-slate-800 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1 focus:outline-none">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                </select>
            </div>
            <div class="flex items-center gap-2 pl-2 border-l border-white/10">
                 <div id="user-info" class="text-sm font-bold text-blue-400">è¨ªå®¢</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 pt-24 pb-24 flex-1 w-full">
        <div id="selection-panel" class="glass-panel p-8 relative overflow-hidden no-print">
            <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 blur-[80px] rounded-full pointer-events-none"></div>

            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h2 class="font-bold text-lg text-white flex items-center gap-2">
                    <i class="fa-solid fa-database text-cyan-400"></i> 
                    <span data-i18n="settings_title">è«‹æŒ‘é¸ä½ è¦çš„å­¸ç¿’å–®å…ƒ</span>
                </h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="flex flex-col gap-2">
                    <label class="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1" data-i18n="label_stage">å­¸ç¿’éšæ®µ</label>
                    <select id="sel-stage" class="w-full p-3"><option value="" disabled selected>Loading...</option></select>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1" data-i18n="label_publisher">ç‰ˆæœ¬</label>
                    <select id="sel-publisher" disabled class="w-full p-3"><option value="" disabled selected data-i18n="select_default">Select...</option></select>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1" data-i18n="label_grade">å¹´ç´š</label>
                    <select id="sel-grade" disabled class="w-full p-3"><option value="" disabled selected data-i18n="select_default">Select...</option></select>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1" data-i18n="label_semester">å­¸æœŸ</label>
                    <select id="sel-semester" disabled class="w-full p-3"><option value="" disabled selected data-i18n="select_default">Select...</option></select>
                </div>
                <div class="flex flex-col gap-2 md:col-span-2 lg:col-span-4">
                    <label class="text-xs text-slate-400 font-bold uppercase tracking-wider ml-1" data-i18n="label_unit">å–®å…ƒåç¨±</label>
                    <select id="sel-unit" disabled class="w-full p-3"><option value="" disabled selected data-i18n="select_default">Select...</option></select>
                </div>
            </div>

            <div class="mt-8 flex justify-end pt-4 border-t border-white/10">
                <button id="btn-generate" onclick="startGeneration()" disabled class="px-8 py-3 rounded-xl font-bold flex items-center gap-2 group disabled:cursor-not-allowed">
                    <i class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition"></i> 
                    <span data-i18n="btn_generate">AI é‡é»æ•´ç†</span>
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI å–®å…ƒé‡é»æ•´ç†ä¸­...</h3>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6 flex flex-col md:flex-row justify-between md:items-end gap-4 relative z-20">
                <div>
                    <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                    <h1 id="result-title" class="text-3xl font-black text-white mt-2">Title</h1>
                </div>
                
                <div class="flex flex-wrap gap-2 no-print relative w-full md:w-auto justify-start md:justify-end" style="z-index: 500;">
                    <button onclick="downloadTXT()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 py-3 rounded-xl font-bold text-sm transition cursor-pointer border border-slate-200 shadow-sm flex items-center active:scale-95">
                        <i class="fa-solid fa-file-lines mr-2"></i> 
                        <span data-i18n="btn_txt">ä¸‹è¼‰ TXT</span>
                    </button>
                   </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start"> 
                
                <div id="summary-panel" class="md:col-span-2 glass-panel p-6 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-blue-800 mb-4 text-xl"><i class="fa-solid fa-star text-yellow-400"></i> <span data-i18n="title_summary">æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦</span></h3>
                    <div id="summary-text" class="prose max-w-none leading-relaxed"></div>
                </div>
                
                <div id="vocab-panel" class="glass-panel p-6 rounded-2xl shadow-sm flex flex-col">
                    <h3 class="font-bold text-slate-700 mb-4 text-xl"><span data-i18n="title_vocab">ç§‘å­¸è©å½™èˆ‡å®šç¾©</span></h3>
                    <div class="flex-1 overflow-y-auto custom-scrollbar min-h-0 pr-2">
                        <div id="keywords-list" class="space-y-3 pb-2"></div>
                    </div>
                </div>

                <div class="md:col-span-3 glass-panel p-6 rounded-2xl shadow-sm pdf-page-break">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-cyan-700 text-xl cursor-pointer hover:text-cyan-900 transition w-fit select-none flex items-center gap-2" onclick="openModal()" ontouchend="openModal()">
                            <i class="fa-solid fa-project-diagram"></i> 
                            <span data-i18n="title_map">çŸ¥è­˜æ¶æ§‹åœ–</span> 
                            <span class="text-xs bg-cyan-100 text-cyan-600 px-2 py-0.5 rounded-full ml-2">é»æ“Šæ”¾å¤§</span>
                        </h3>
                        <button onclick="openModal()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold border border-blue-200 hover:bg-blue-100 transition no-pdf">
                            <i class="fa-solid fa-expand mr-1"></i> å…¨è¢å¹•
                        </button>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4 md:p-6 border border-slate-100 overflow-hidden w-full relative h-auto" id="chart-container">
                        <div class="click-mask" onclick="openModal()"></div>
                        <div id="mermaid-chart" class="w-full"></div>
                    </div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl shadow-sm pdf-page-break">
                    <h3 class="font-bold text-orange-600 mb-4 text-xl">
                        <i class="fa-solid fa-lightbulb"></i> 
                        <span data-i18n="title_myth">ç§‘å­¸å‹•å‹•è…¦</span>
                    </h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch"></div>
                </div>

                <div id="quiz-panel" class="md:col-span-3 glass-panel p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-emerald-700 text-xl flex items-center gap-2">
                            <i class="fa-solid fa-circle-question"></i>
                            <span id="quiz-title">å–®å…ƒå°æ¸¬é©—</span>
                        </h3>
                        <div id="quiz-progress" class="text-xs font-bold text-emerald-700 bg-emerald-100 px-3 py-1 rounded-full">
                            ç¬¬ 0 é¡Œï¼å…± 0 é¡Œ
                        </div>
                    </div>
                    <div id="quiz-body" class="space-y-3">
                        <div id="quiz-question" class="font-bold text-slate-800 mb-2 leading-relaxed text-sm md:text-base"></div>
                        <div id="quiz-options" class="space-y-2"></div>
                        <div id="quiz-feedback" class="mt-4 text-sm rounded-xl px-3 py-2 hidden"></div>
                        <div class="mt-4 flex justify-center items-center relative z-[200]">
                            <button id="quiz-main-btn" type="button" onclick="handleQuizMainButton()"
                                class="text-xs px-4 py-2 rounded-full bg-emerald-600 text-white font-semibold shadow border border-emerald-700/60 hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed">
                                ä¸‹ä¸€é¡Œ
                            </button>
                        </div>
                    </div>

                    <div id="quiz-empty" class="text-sm text-slate-500">
                        æœ¬å–®å…ƒçš„å°æ¸¬é©—å°šæœªæº–å‚™å¥½ï¼Œä¹‹å¾Œæœƒç”±è€å¸«å†è£œä¸Šå–”ã€‚
                    </div>

                    <div id="quiz-result" class="mt-6 hidden rounded-2xl border border-emerald-300 bg-white shadow-sm p-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                            <div>
                                <div class="text-xs font-semibold text-slate-500">ä½ çš„æ¸¬é©—æˆç¸¾</div>
                                <div id="quiz-score-number" class="text-3xl font-black text-emerald-700">0 åˆ†</div>
                                <div id="quiz-score-label" class="text-xs font-semibold text-emerald-600 mt-1"></div>
                            </div>
                            <div id="quiz-result-text" class="text-sm text-slate-700 md:text-right"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                            <div class="w-full max-w-md h-56 mx-auto">
                                <canvas id="quiz-radar" class="w-full h-full"></canvas>
                            </div>
                            <div id="quiz-result-detail" class="text-sm text-slate-700 leading-relaxed whitespace-pre-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="floating-chat" class="hidden fixed bottom-6 right-6 z-[9999] flex flex-col items-end gap-3 no-print" style="touch-action: none; display: none;">
        
        <div id="xiaoke-tooltip" class="xiaoke-tooltip">
            å—¨ï¼æˆ‘æ˜¯å°ç§‘ ğŸ‘‹
        </div>

        <div id="xiaoke-window" class="chat-window closed w-80 md:w-96 bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-blue-200 flex flex-col overflow-hidden h-[450px] transition-all origin-bottom-right hidden">
            <div class="bg-gradient-to-r from-blue-600 to-cyan-500 p-3 text-white flex justify-between items-center shadow-md cursor-grab active:cursor-grabbing" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                <div class="flex items-center gap-2 pointer-events-none">
                    <div class="w-8 h-8 rounded-full bg-white p-0.5 shadow-sm">
                        <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="å°ç§‘" class="w-full h-full object-cover rounded-full">
                    </div>
                    <span class="font-bold text-sm tracking-wide">å°ç§‘ AI åŠ©æ‰‹</span>
                </div>
                <button onclick="toggleChat()" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" class="text-white/80 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition cursor-pointer">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
           
            <div class="flex-1 p-4 bg-slate-50/50 overflow-y-auto text-sm space-y-3 custom-scrollbar" id="chat-messages">
            </div>
           
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="å•å•å°ç§‘..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-cyan-400 outline-none transition text-slate-800" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white w-10 h-10 rounded-full hover:shadow-lg hover:scale-105 transition flex items-center justify-center shadow-md">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>

        <div id="xiaoke-avatar-btn" class="xiaoke-glow w-16 h-16 rounded-full bg-white p-1 cursor-pointer active:scale-95 transition-transform shadow-xl z-[10000]" 
             onmousedown="startDrag(event)" onclick="if(!isDragging) toggleChat()" ontouchstart="startDrag(event)">
            <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="å°ç§‘" class="w-full h-full object-cover rounded-full pointer-events-none">
        </div>
    </div>

    <div id="image-modal" class="fixed inset-0 z-[200] bg-black/95 hidden flex-col items-center justify-center p-2 transition-opacity duration-300" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/90 hover:text-white text-5xl font-bold p-2 z-[201]" onclick="closeModal()">&times;</button>
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-[98vw] h-auto max-h-[95vh] overflow-auto p-4 relative" onclick="event.stopPropagation()"></div>
    </div>

    <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
    
    let allData = [];
    let filters = {};
    let currentResultData = null;
    let mythData = [];
    let quizState = {
        questions: [],
        currentIndex: 0,
        hasAnswered: false,
        answers: []   
    };
    let quizRadarChart = null; 

    const i18n = {
        "zh-TW": { 
            back_home:"è¿”å› AI Science", 
            page_title:"å–®å…ƒé‡é»ç²¾ç†Ÿ", 
            page_subtitle:"AI æ™ºèƒ½ç­†è¨˜ç”Ÿæˆ", 
            settings_title:"è«‹æŒ‘é¸ä½ è¦çš„å­¸ç¿’å–®å…ƒ", 
            label_stage:"å­¸ç¿’éšæ®µ", 
            label_publisher:"ç‰ˆæœ¬", 
            label_grade:"å¹´ç´š", 
            label_semester:"å­¸æœŸ", 
            label_unit:"å–®å…ƒåç¨±", 
            btn_generate:"AI é‡é»æ•´ç†", 
            btn_txt:"ä¸‹è¼‰ TXT", 
            btn_pdf:"ä¸‹è¼‰ PDF", 
            title_summary:"æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦", 
            title_vocab:"ç§‘å­¸è©å½™èˆ‡å®šç¾©", 
            title_map:"çŸ¥è­˜æ¶æ§‹åœ–", 
            title_myth:"ç§‘å­¸å‹•å‹•è…¦",
            select_default: "è«‹é¸æ“‡" 
        },
        "en": { 
            back_home:"Back to AI Science", 
            page_title:"Unit Mastery", 
            page_subtitle:"AI Intelligent Note Generation", 
            settings_title:"Select Learning Unit", 
            label_stage:"Level", 
            label_publisher:"Publisher", 
            label_grade:"Grade", 
            label_semester:"Semester", 
            label_unit:"Unit", 
            btn_generate:"AI Summary", 
            btn_txt:"Download TXT", 
            btn_pdf:"Download PDF", 
            title_summary:"Core Concepts", 
            title_vocab:"Vocabulary", 
            title_map:"Mind Map", 
            title_myth:"Thinking Check",
            select_default: "Select..." 
        },
        "ja": { 
            back_home:"AI Scienceã«æˆ»ã‚‹", 
            page_title:"å˜å…ƒãƒã‚¹ã‚¿ãƒ¼", 
            page_subtitle:"AIãƒãƒ¼ãƒˆç”Ÿæˆ", 
            settings_title:"å­¦ç¿’å˜å…ƒã‚’é¸æŠ", 
            label_stage:"æ®µéš", 
            label_publisher:"å‡ºç‰ˆç¤¾", 
            label_grade:"å­¦å¹´", 
            label_semester:"å­¦æœŸ", 
            label_unit:"å˜å…ƒ", 
            btn_generate:"ç”Ÿæˆã™ã‚‹", 
            btn_txt:"TXTã‚’ä¿å­˜", 
            btn_pdf:"PDFã‚’ä¿å­˜", 
            title_summary:"æ ¸å¿ƒæ¦‚å¿µ", 
            title_vocab:"ç§‘å­¦ç”¨èª", 
            title_map:"çŸ¥è­˜ãƒãƒƒãƒ—", 
            title_myth:"è€ƒãˆã¦ã¿ã‚ˆã†",
            select_default: "é¸æŠã—ã¦ãã ã•ã„" 
        },
        "zh-CN": { 
            back_home:"è¿”å› AI Science", 
            page_title:"å•å…ƒé‡ç‚¹ç²¾ç†Ÿ", 
            page_subtitle:"AI æ™ºèƒ½ç¬”è®°ç”Ÿæˆ", 
            settings_title:"è¯·æŒ‘é€‰ä½ è¦çš„å­¦ä¹ å•å…ƒ", 
            label_stage:"å­¦ä¹ é˜¶æ®µ", 
            label_publisher:"ç‰ˆæœ¬", 
            label_grade:"å¹´çº§", 
            label_semester:"å­¦æœŸ", 
            label_unit:"å•å…ƒåç§°", 
            btn_generate:"AI é‡ç‚¹æ•´ç†", 
            btn_txt:"ä¸‹è½½ TXT", 
            btn_pdf:"ä¸‹è½½ PDF", 
            title_summary:"æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦", 
            title_vocab:"ç§‘å­¦è¯æ±‡ä¸å®šä¹‰", 
            title_map:"çŸ¥è¯†æ¶æ„å›¾", 
            title_myth:"ç§‘å­¦åŠ¨åŠ¨è„‘",
            select_default: "è¯·é€‰æ‹©" 
        }
    };

    window.onload = async () => {
        const user = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"è¨ªå®¢"}');
        const userInfo = document.getElementById("user-info");
        if (userInfo) userInfo.innerText = user.name;
        
        // â˜… å¼·åˆ¶éš±è—å°ç§‘ (é›™é‡ç¢ºä¿)
        const chatBtn = document.getElementById('floating-chat');
        if (chatBtn) chatBtn.classList.add('hidden');

        const selStage = document.getElementById("sel-stage");

        try {
            const res = await fetch(GAS_API_URL + "?action=get_metadata");
            if (!res.ok) {
                throw new Error(`ä¼ºæœå™¨ HTTP éŒ¯èª¤: ${res.status}`);
            }

            const text = await res.text();
            let json;
            try {
                json = JSON.parse(text);
            } catch (parseError) {
                console.error("JSON è§£æå¤±æ•—çš„åŸå§‹æ–‡æœ¬:", text);
                throw new Error(`API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼ŒåŸå§‹å…§å®¹é–‹é ­: ${text.substring(0, 50)}...`);
            }
            
            if(json.status === "success") {
                allData = json.data;
                const dbStatus = document.getElementById("db-status");
                if (dbStatus) {
                    dbStatus.innerHTML = `<i class="fa-solid fa-check"></i> è³‡æ–™åº«é€£ç·šæˆåŠŸ`;
                    dbStatus.className = "text-xs font-bold text-green-600";
                }
                initSelectors();
            } else {
                throw new Error(json.message || "API å›æ‡‰ç‹€æ…‹éæˆåŠŸ");
            }
        } catch(e) {
            console.error("è¼‰å…¥å…ƒæ•¸æ“šå¤±æ•—:", e);
            const dbStatus = document.getElementById("db-status");
            
            if (dbStatus) {
                dbStatus.innerText = "é€£ç·šå¤±æ•—";
                dbStatus.className = "text-xs font-bold text-red-500";
            }
            
            const selStageAgain = document.getElementById("sel-stage");
            if (selStageAgain) {
                selStageAgain.innerHTML = '<option value="" disabled selected>é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦...</option>';
                selStageAgain.disabled = true;
            }
            
            alert(`ç„¡æ³•è¼‰å…¥è³‡æ–™åº«ï¼\néŒ¯èª¤é¡å‹: ${e.message}`);
        }
    };

    function changeLanguage() {
        const langSel = document.getElementById("language-selector");
        if (!langSel) return;
        const lang = langSel.value;
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (i18n[lang][key]) el.innerText = i18n[lang][key];
        });
    }

    function initSelectors() {
        const stages = [...new Set(allData.map(d => d.stage))];
        populate("sel-stage", stages);

        const selStage = document.getElementById("sel-stage");
        const selPublisher = document.getElementById("sel-publisher");
        const selGrade = document.getElementById("sel-grade");
        const selSemester = document.getElementById("sel-semester");
        const selUnit = document.getElementById("sel-unit");

        if (selStage) selStage.onchange = (e) => updateLevel(1, e.target.value);
        if (selPublisher) selPublisher.onchange = (e) => updateLevel(2, e.target.value);
        if (selGrade) selGrade.onchange = (e) => updateLevel(3, e.target.value);
        if (selSemester) selSemester.onchange = (e) => updateLevel(4, e.target.value);
        if (selUnit) selUnit.onchange = (e) => { 
            filters.unitName = e.target.value; 
            const btn = document.getElementById("btn-generate");
            if (btn) btn.disabled = false; 
        };
        
        changeLanguage();
    }

    function updateLevel(level, value) {
        if(level===1) filters={stage:value};
        if(level===2){filters.publisher=value; delete filters.grade; delete filters.semester; delete filters.unitName;}
        if(level===3){filters.grade=value; delete filters.semester; delete filters.unitName;}
        if(level===4){filters.semester=value; delete filters.unitName;}

        const ids=["sel-publisher","sel-grade","sel-semester","sel-unit"];
        for(let i=level;i<4;i++){
            const el = document.getElementById(ids[i]);
            if (el) {
                el.innerHTML='<option disabled selected data-i18n="select_default">Select...</option>';
                el.disabled=true;
            }
        }
        const btn = document.getElementById("btn-generate");
        if (btn) btn.disabled=true;

        const relevantData = allData.filter(d => {
            const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
            return safeMatch(d.stage, filters.stage) &&
                   safeMatch(d.publisher, filters.publisher) &&
                   safeMatch(d.grade, filters.grade) &&
                   safeMatch(d.semester, filters.semester);
        });

        if(level===1) populate("sel-publisher", [...new Set(relevantData.map(d=>d.publisher))]);
        if(level===2) populate("sel-grade", [...new Set(relevantData.map(d=>d.grade))].sort((a,b)=>a-b), "grade");
        if(level===3) populate("sel-semester", [...new Set(relevantData.map(d=>d.semester))], "semester");
        if(level===4) {
            const unitSelect = document.getElementById("sel-unit");
            if (!unitSelect) return;
            unitSelect.innerHTML='<option disabled selected data-i18n="select_default">Select...</option>';
            if(relevantData.length>0) {
                relevantData.forEach(d => {
                    const opt = document.createElement("option");
                    opt.value = d.unitName;
                    opt.text = (d.unitType && !isNaN(d.unitType)) ? `ç¬¬${d.unitType}èª² ${d.unitName}` : d.unitName;
                    unitSelect.add(opt);
                });
                unitSelect.disabled=false;
            }
        }
        
        changeLanguage();
    }

    function populate(id, list, type) {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML='<option disabled selected data-i18n="select_default">Select...</option>';
        list.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o;
            if(type==="grade") opt.text=o+"å¹´ç´š";
            else if(type==="semester") opt.text=(o==="ä¸Š"?"ä¸Šå­¸æœŸ":(o==="ä¸‹"?"ä¸‹å­¸æœŸ":o));
            else opt.text=o;
            el.add(opt);
        });
        el.disabled=false;
    }

    async function startGeneration() {
        const selPanel = document.getElementById("selection-panel");
        const loading = document.getElementById("loading-view");
        if (selPanel) selPanel.classList.add("hidden");
        if (loading) {
            loading.classList.remove("hidden");
            loading.classList.add("flex");
        }

        try {
            const res = await fetch(GAS_API_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: "get_content_and_generate", filters: filters }) 
            });
            
            if (!res.ok) {
                throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${res.status}`);
            }
            
            const text = await res.text();
            let json;
            try {
                json = JSON.parse(text);
            } catch(parseError) {
                console.error("JSON è§£æå¤±æ•—çš„åŸå§‹æ–‡æœ¬:", text);
                throw new Error("API è¿”å›è³‡æ–™æ ¼å¼éŒ¯èª¤ (éå®Œæ•´ JSON)ã€‚");
            }

            if(json.status === "success") { 
                currentResultData = json.data; 
                renderResult(json.data); 
            } else {
                throw new Error(json.message || "API è¿”å›ç‹€æ…‹ç‚ºå¤±æ•—");
            }
        } catch(e) { 
            alert("AI ç”Ÿæˆå¤±æ•—ï¼è«‹æª¢æŸ¥ API æˆ–é‡è©¦ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message); 
            
            const selPanelAgain = document.getElementById("selection-panel");
            if (selPanelAgain) selPanelAgain.classList.remove("hidden");
            const loadingAgain = document.getElementById("loading-view");
            if (loadingAgain) {
                loadingAgain.classList.add("hidden");
                loadingAgain.classList.remove("flex");
            }
            
            const btn = document.getElementById("btn-generate");
            if (btn) btn.disabled = false;
        }
    }
function normalizeMermaidCode(code) {
    if (!code || typeof code !== "string") return "";

    code = code.replace(/```mermaid\s*/i, "").replace(/```/g, "").trim();
    code = code.replace(/^mermaid\s*\n/i, "").trim();

    const lines = code.split("\n");
    let header = "";
    for (const line of lines) {
        const t = line.trim();
        if (!t) continue;
        if (t.startsWith("%%")) continue; // Mermaid comment / init directive
        header = t.toLowerCase();
        break;
    }

    // é€™äº›é–‹é ­éƒ½å±¬æ–¼ Mermaid åˆæ³•åœ–å½¢é¡å‹ï¼Œä¸è¦ç¡¬æ”¹æˆ graph TD
    const okStarts = [
        "graph", "flowchart", "mindmap", "mindmap-v2",
        "sequencediagram", "statediagram", "classdiagram",
        "erdiagram", "journey", "gantt", "pie", "timeline"
    ];

    const firstToken = header ? header.split(/\s+/)[0] : "";
    if (okStarts.includes(firstToken)) return code;

    // è‹¥æ²’æ¨™é ­ï¼Œä½†å…§å®¹çœ‹èµ·ä¾†åƒ flowchartï¼Œæ‰è£œ graph TD
    if (code.includes("-->") || code.includes("---") || code.includes("==>")) {
        return "graph TD\n" + code;
    }

    // å…¶ä»–æƒ…æ³ï¼šåŸæ¨£å›å‚³ï¼ˆé¿å…è¶Šä¿®è¶Šå£ï¼‰
    return code;
}

async function renderMermaidSafe(targetEl, rawCode) {
    if (!targetEl) return;

    const code = normalizeMermaidCode(rawCode);
    if (!code) {
        targetEl.innerText = "ç„¡æ¶æ§‹åœ–æ•¸æ“š";
        return;
    }

    // é—œéµï¼šç”¨ textContentï¼Œä¸ç”¨ innerHTMLï¼ˆé¿å… <br> ç­‰è¢«ç€è¦½å™¨ç•¶ HTML åƒæ‰ï¼‰
    targetEl.innerHTML = "";
    const wrapper = document.createElement("div");
    wrapper.className = "mermaid";
    wrapper.textContent = code;
    targetEl.appendChild(wrapper);

    try {
        if (mermaid.parse) {
            await mermaid.parse(code);
        }
        if (mermaid.run) {
            await mermaid.run({ nodes: [wrapper] });
        } else {
            // å¾Œå‚™ï¼ˆç†è«–ä¸Š v10 æœ‰ runï¼‰
            mermaid.init(undefined, [wrapper]);
        }

        const svg = targetEl.querySelector("svg");
        if (svg) {
            svg.removeAttribute("width");
            svg.removeAttribute("height");
            svg.style.width = "100%";
            svg.style.height = "auto";
            svg.style.display = "block";
            svg.style.margin = "0 auto";
            svg.style.fontFamily = '"Microsoft JhengHei", "Noto Sans TC", sans-serif';
            svg.style.fontSize = "16px";
        }
    } catch (e) {
        console.error("Mermaid ç¹ªåœ–å¤±æ•—ï¼š", e, "\nåŸå§‹ç¢¼ï¼š\n", code);
        targetEl.innerHTML = "æ¶æ§‹åœ–ç¹ªè£½å¤±æ•—ï¼ˆMermaid èªæ³•éŒ¯èª¤ï¼‰";
    }
}

    function renderResult(data) {
        console.log("æ¸²æŸ“æ•¸æ“š:", data);

        const raw = data.raw_content || {};

        const resultTitle = document.getElementById('result-title');
        if (resultTitle) {
            resultTitle.innerText =
                data.topic ||
                data.unitName ||
                raw.unitName ||
                filters.unitName ||
                'ç„¡æ¨™é¡Œ';
        }

        const resultTag = document.getElementById('result-tag');
        if (resultTag) {
            const p = data.publisher || filters.publisher || '';
            const g = data.grade || filters.grade || '';
            const rawS = data.semester || filters.semester || '';

            let s = rawS;
            if (rawS === 'ä¸Š') s = 'ä¸Šå­¸æœŸ';
            else if (rawS === 'ä¸‹') s = 'ä¸‹å­¸æœŸ';

            resultTag.innerText = `${p} ${g}å¹´ç´š ${s}`;
        }

        const summaryBox = document.getElementById('summary-text');
        if (summaryBox) {
            let content = data.summary;
            if (typeof content === 'object') {
                content = content.summary_html || content.html || content.content || content.text || content.summary || '';
            } else if (!content && raw.text_summary) {
                content = raw.text_summary;
            }

            if (content) {
                if (!content.includes('<') && content.includes('\n')) {
                    content = content.split('\n').map(line => {
                        line = line.trim();
                        if (!line) return '';
                        if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]ã€|^[0-9]+\./.test(line)) {
                            return `<h3>${line}</h3>`;
                        }
                        if (/^[\(ï¼ˆ][0-9]+[\)ï¼‰]|^[-â€¢]/.test(line)) {
                            return `<ul><li>${line}</li></ul>`;
                        }
                        return `<p>${line}</p>`;
                    }).join('');
                }
                
                if (!content.includes('<div class="summary-card">')) {
                   const parts = content.split(/(?=<h3>)/); 
                   if (parts.length > 1) {
                      content = parts.map(part => `<div class="summary-card">${part}</div>`).join('');
                   } else {
                      content = `<div class="summary-card">${content}</div>`;
                   }
                }
                
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
            summaryBox.innerHTML = content || 'ç”Ÿæˆæ‘˜è¦å¤±æ•—...';
        }

        const keywordList = document.getElementById('keywords-list');
        if (keywordList) {
            keywordList.innerHTML = '';

            let kList =
                data.keywords ||
                (data.summary && (data.summary.keywords || data.summary.vocab_list)) ||
                raw.vocab_list ||
                [];

            if (Array.isArray(kList) && kList.length > 0) {
                kList.forEach(k => {
                    const term = typeof k === 'object' ? (k.term || k.word || '') : k;
                    const def  = typeof k === 'object' ? (k.def || k.definition || '') : '';

                    if (!term) return;

                    const div = document.createElement('div');
                    div.className = 'vocab-item bg-white p-3 rounded-xl border border-blue-100 hover:border-blue-300 transition shadow-sm mb-2';
                    div.innerHTML =
                        `<span class="font-bold text-blue-700 text-lg block mb-1">${term}</span>` +
                        `<span class="text-sm text-slate-600 leading-relaxed block">${def}</span>`;
                    keywordList.appendChild(div);
                });
            } else {
                keywordList.innerHTML = '<div class="text-slate-400 p-2">ç„¡è©å½™è³‡æ–™</div>';
                mythData = [];
            }
        }

const chartDiv = document.getElementById('mermaid-chart');
if (chartDiv) {
    let mapData =
        data.mindMap ||
        (data.summary && (data.summary.mindMap || data.summary.mermaid)) ||
        '';

    if (mapData && typeof mapData === 'string') {
        mapData = mapData.replace(/```mermaid/i, '').replace(/```/g, '').trim();
    }

    if (mapData) {
        // ç”¨å®‰å…¨æ¸²æŸ“ï¼ˆé¿å… innerHTML ç ´å£ Mermaid æ–‡å­—ï¼‰
        renderMermaidSafe(chartDiv, mapData);
    } else {
        chartDiv.innerText = 'ç„¡æ¶æ§‹åœ–æ•¸æ“š';
    }
}


            if (mapData) {
                chartDiv.innerHTML = `<div class="mermaid">${mapData}</div>`;
                try {
                    mermaid.init(undefined, document.querySelectorAll('.mermaid')).then(() => {
                        const svg = chartDiv.querySelector('svg');
                        if (svg) {
                            svg.removeAttribute('style');
                            svg.removeAttribute('width');
                            svg.removeAttribute('height');
                            
                            svg.style.height = "auto";
                            svg.style.display = "block";
                            svg.style.margin = "0 auto";
                            svg.style.fontFamily = '"Microsoft JhengHei", sans-serif';
                            svg.style.fontSize = "16px"; 
                        }
                    });
                } catch (e) {
                    console.error('Mermaid ç¹ªåœ–å¤±æ•—', e);
                    chartDiv.innerText = 'æ¶æ§‹åœ–ç¹ªè£½å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
                }
            } else {
                chartDiv.innerText = 'ç„¡æ¶æ§‹åœ–æ•¸æ“š';
            }
        }

        const mythListEl = document.getElementById('myth-list');
        if (mythListEl) {
            mythListEl.innerHTML = '';

            let mList = data.myths || (data.summary && data.summary.myths) || [];
            if (Array.isArray(mList) && mList.length > 0) {
                const limitedMyths = mList.slice(0, 10);
                mythData = limitedMyths;

                limitedMyths.forEach((m, index) => {
                    const rawMyth    = m.myth || m.misconception || '';
                    const correctExp = m.correct || m.explanation || '';

                    if (!rawMyth && !correctExp) return;

                    let statement = m.question || rawMyth || '';
                    statement = statement
                        .replace(/^è¿·æ€[:ï¼š]\s*/,'')
                        .replace(/^å¸¸è¦‹æƒ³æ³•[:ï¼š]\s*/,'')
                        .trim();

                    const cardId = `myth-${index}`;
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col gap-3';

                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-50 text-blue-600 text-xs font-bold">Q${index + 1}</span>
                                <span class="text-xs font-bold text-slate-500">ç§‘å­¸å‹•å‹•è…¦</span>
                            </div>
                            <span class="text-[11px] text-slate-400">å…ˆæƒ³ä¸€æƒ³ï¼Œå†ä½œç­”</span>
                        </div>
                        <div class="text-sm md:text-base text-slate-800 leading-relaxed"><b>${statement}</b></div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="${cardId}-btn-true" onclick="answerMyth(${index}, true)" class="myth-option-btn flex-1 px-3 py-2.5 text-sm rounded-xl border border-slate-200 bg-slate-50 hover:bg-slate-100 hover:border-blue-300 text-slate-700 text-center">
                                <span class="block font-semibold">æ­£ç¢º O</span>
                            </button>
                            <button id="${cardId}-btn-false" onclick="answerMyth(${index}, false)" class="myth-option-btn flex-1 px-3 py-2.5 text-sm rounded-xl border border-slate-200 bg-slate-50 hover:bg-slate-100 hover:border-emerald-300 text-slate-700 text-center">
                                <span class="block font-semibold">éŒ¯èª¤ X</span>
                            </button>
                        </div>
                        <div id="${cardId}-feedback" class="mt-3 hidden text-sm leading-relaxed rounded-xl border border-slate-100 bg-slate-50 px-3 py-2"></div>
                    `;
                    mythListEl.appendChild(div);
                });
            } else {
                mythListEl.innerHTML = '<div class="text-slate-400 p-2">æœ¬å–®å…ƒæš«ç„¡ã€Œç§‘å­¸å‹•å‹•è…¦ã€å°é¡Œã€‚</div>';
                mythData = [];
            }
        }

        const quizRaw = data.quiz || (data.summary && data.summary.quiz) || [];
        initQuiz(quizRaw);

        const loadingView = document.getElementById('loading-view');
        const contentView = document.getElementById('content-view');
        if (loadingView) {
            loadingView.classList.add('hidden');
            loadingView.classList.remove('flex');
        }
        if (contentView) {
            contentView.classList.remove('hidden');
        }

        const btn = document.getElementById('btn-generate');
        if (btn) btn.disabled = false;
        
        // â˜… [ä¿®æ­£] æˆåŠŸç”Ÿæˆå¾Œï¼Œç§»é™¤ inline style é¡¯ç¤ºæ‡¸æµ®æŒ‰éˆ•
        const chatBtn = document.getElementById('floating-chat');
        if (chatBtn) {
            chatBtn.classList.remove('hidden'); 
            chatBtn.style.display = 'flex'; // æ¢å¾© flex ä½ˆå±€
        }
        const chatWin = document.getElementById("xiaoke-window");
        if(chatWin) {
            chatWin.classList.add("closed");
            chatWin.classList.add("hidden");
        }
        const tooltip = document.getElementById("xiaoke-tooltip");
        if (tooltip) {
            tooltip.classList.add("show");
            setTimeout(() => { tooltip.classList.remove("show"); }, 5000);
        }

        setTimeout(syncVocabHeight, 100);
    }

    function downloadTXT() {
        if (!currentResultData) { 
            alert("è«‹å…ˆç”Ÿæˆå…§å®¹å¾Œå†ä¸‹è¼‰ï¼"); 
            return; 
        }

        const stage    = filters.stage    || (currentResultData && currentResultData.stage)    || "";
        const publisher = filters.publisher || (currentResultData && currentResultData.publisher) || "";
        const grade    = filters.grade    || (currentResultData && currentResultData.grade)    || "";
        const semRaw   = filters.semester || (currentResultData && currentResultData.semester) || "";
        const unitName = (currentResultData.raw_content ? currentResultData.raw_content.unitName : filters.unitName) || "";

        let semesterLabel = semRaw;
        if (semRaw === "ä¸Š") semesterLabel = "ä¸Šå­¸æœŸ";
        else if (semRaw === "ä¸‹") semesterLabel = "ä¸‹å­¸æœŸ";

        let content = "";

        content += "ã€å–®å…ƒä¾†æºè³‡è¨Šã€‘\n";
        content += "----------------------------------------\n";
        content += `å­¸ç¿’éšæ®µï¼š${stage || "-"}\n`;
        content += `ç‰ˆæœ¬ï¼š${publisher || "-"}\n`;
        content += `å¹´ç´šï¼š${grade ? grade + "å¹´ç´š" : "-"}\n`;
        content += `å­¸æœŸï¼š${semesterLabel || "-"}\n`;
        content += `å–®å…ƒåç¨±ï¼š${unitName || "-"}\n\n`;

        content += "========================================\n";
        content += "  å–®å…ƒé‡é»æ•´ç†\n";
        content += "========================================\n\n";

        const summaryEl = document.getElementById("summary-text");
        let summary = summaryEl ? summaryEl.innerText.replace(/\n\s*\n/g, "\n\n").trim() : "";

        content += "ã€ä¸€ã€æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦ã€‘\n";
        content += "----------------------------------------\n";
        content += (summary || "æœ¬å–®å…ƒçš„æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦å°šæœªæä¾›ã€‚") + "\n\n\n";

        content += "ã€äºŒã€ç§‘å­¸è©å½™èˆ‡å®šç¾©ã€‘\n";
        content += "----------------------------------------\n";

        let vList = currentResultData.keywords 
            || (currentResultData.summary ? (currentResultData.summary.keywords || currentResultData.summary.vocab_list) : []) 
            || [];

        if (Array.isArray(vList) && vList.length > 0) {
            vList.forEach((v, i) => {
                const term = v.term || v;
                const def  = v.def || "";
                content += `${i + 1}. ${term}\n`;
                content += `   èªªæ˜ï¼š${def || "ï¼ˆå°šæœªæä¾›è§£é‡‹ï¼‰"}\n\n`;
            });
        } else {
            content += "ç›®å‰å°šæœªæ•´ç†å‡ºæœ¬å–®å…ƒçš„ç§‘å­¸è©å½™èˆ‡å®šç¾©ã€‚\n\n";
        }

        content += "\nã€ä¸‰ã€ç§‘å­¸å‹•å‹•è…¦ã€‘\n";
        content += "----------------------------------------\n";

        let mList = currentResultData.myths 
            || (currentResultData.summary ? currentResultData.summary.myths : []) 
            || [];

        if (Array.isArray(mList) && mList.length > 0) {
            mList.forEach((m, i) => {
                const stem = (m.question || m.myth || "")
                    .replace(/^è¿·æ€[:ï¼š]\s*/, "")
                    .replace(/^å¸¸è¦‹æƒ³æ³•[:ï¼š]\s*/, "");
                const ans  = m.correct || m.explanation || "";

                content += `â— é¡Œç›® ${i + 1}ï¼š${stem}\n`;
                content += `   æ­£ç¢ºè§€å¿µï¼š${ans || "ï¼ˆå°šæœªæä¾›èªªæ˜ï¼‰"}\n\n`;
            });
        } else {
            content += "æœ¬å–®å…ƒç›®å‰å°šæœªè¨­å®šã€Œç§‘å­¸å‹•å‹•è…¦ã€é¡Œç›®ã€‚\n";
        }

        try {
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url  = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${unitName || filters.unitName || "unit"}_é‡é»æ•´ç†.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error(e);
            alert("TXT ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æ›ä¸€å€‹ç€è¦½å™¨ã€‚");
        }
    }

    function toggleChat() {
        const win = document.getElementById("xiaoke-window");
        const tooltip = document.getElementById("xiaoke-tooltip");
        if (!win) return;
        
        if (tooltip) tooltip.classList.remove("show");

        const wasClosed = win.classList.contains("closed");
        
        if (wasClosed) {
            win.classList.remove("hidden");
            setTimeout(() => win.classList.remove("closed"), 10);
            
            const chatBody = document.getElementById("chat-messages");
            if (chatBody && chatBody.innerHTML.trim() === "") {
                let currentUnitName = filters.unitName || "é€™å€‹å–®å…ƒ";
                const sel = document.getElementById("sel-unit");
                if (sel && sel.selectedIndex > -1 && !sel.disabled) {
                    currentUnitName = sel.options[sel.selectedIndex].text;
                }

                const greetMsg = `Hiï¼Œä½ å¥½ï¼æˆ‘æ˜¯å°ç§‘ï¼Œé—œæ–¼ã€${currentUnitName}ã€‘ï¼Œä½ æœ‰ä»€éº¼å•é¡Œè¦å•æˆ‘ï¼Ÿ`;

                chatBody.innerHTML = `
                    <div class="self-start flex gap-2 max-w-[90%]">
                        <div class="w-8 h-8 rounded-full bg-white border border-slate-200 p-0.5 shrink-0 shadow-sm">
                            <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 leading-relaxed">
                            <span class="font-bold text-blue-500 block mb-1 text-xs">å°ç§‘ AI åŠ©æ‰‹</span>
                            ${greetMsg}
                        </div>
                    </div>`;
            }
        } else {
            win.classList.add("closed");
            setTimeout(() => win.classList.add("hidden"), 300);
        }
    }

    let isDragging = false;
    let dragStartX, dragStartY;
    let initialLeft, initialTop;

    function startDrag(e) {
        if (e.type === 'mousedown' && e.button !== 0) return;
        
        const container = document.getElementById("floating-chat");
        if (!container) return;

        isDragging = false;
        
        if(e.type === 'touchstart') {
            dragStartX = e.touches[0].clientX;
            dragStartY = e.touches[0].clientY;
        } else {
            dragStartX = e.clientX;
            dragStartY = e.clientY;
        }

        const rect = container.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        container.style.bottom = "auto";
        container.style.right = "auto";
        container.style.left = `${initialLeft}px`;
        container.style.top = `${initialTop}px`;

        if(e.type === 'touchstart') {
            document.addEventListener("touchmove", onDrag, { passive: false });
            document.addEventListener("touchend", stopDrag);
        } else {
            document.addEventListener("mousemove", onDrag);
            document.addEventListener("mouseup", stopDrag);
        }
    }

    function onDrag(e) {
        let clientX, clientY;
        if(e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
            e.preventDefault(); 
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        const dx = clientX - dragStartX;
        const dy = clientY - dragStartY;

        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
            isDragging = true;
        }

        const container = document.getElementById("floating-chat");
        if (container) {
            container.style.left = `${initialLeft + dx}px`;
            container.style.top = `${initialTop + dy}px`;
        }
    }

    function stopDrag(e) {
        document.removeEventListener("mousemove", onDrag);
        document.removeEventListener("mouseup", stopDrag);
        document.removeEventListener("touchmove", onDrag);
        document.removeEventListener("touchend", stopDrag);
        setTimeout(() => { isDragging = false; }, 100);
    }

    async function sendChatMessage() {
        const input = document.getElementById("chat-input"); 
        if (!input) return;
        const msg = input.value.trim(); 
        if(!msg) return;

        const chatBody = document.getElementById("chat-messages");
        if (chatBody) {
            chatBody.innerHTML += `<div class="self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] ml-auto text-sm">${msg}</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        input.value = "";

        try {
            const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"è¨ªå®¢"}');
            const contextText = currentResultData ? (currentResultData.raw_content ? currentResultData.raw_content.text : "") : "";
            const contextVocab = currentResultData ? (currentResultData.raw_content ? currentResultData.raw_content.vocab_str : "") : "";
            const res = await fetch(GAS_API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'chat_with_ai', 
                    message: msg, 
                    currentUnit: filters.unitName || "",
                    contextText: contextText,
                    contextVocab: contextVocab,
                    userName: currentUser.name,
                    stage: filters.stage,
                    publisher: filters.publisher,
                    grade: filters.grade,
                    semester: filters.semester 
                }) 
            });
            const json = await res.json();
            const cleanReply = (json.data || "").replace(/\*\*/g, "");
            if (chatBody) {
                chatBody.innerHTML += `<div class="self-start bgç™½ border border-slate-100 p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">å°ç§‘ AI åŠ©æ‰‹</span>${cleanReply}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        } catch(e) { 
            console.error(e); 
        }
    }

    function openModal() {
        const chartDiv = document.getElementById("mermaid-chart");
        if (!chartDiv || !chartDiv.innerHTML.trim() || chartDiv.innerText.includes("éŒ¯èª¤")) {
            return;
        }

        const modal   = document.getElementById("image-modal");
        const content = document.getElementById("modal-content");
        if (!modal || !content) return;

        content.innerHTML = chartDiv.innerHTML;
        content.className = "bg-white rounded-lg shadow-2xl w-[98vw] h-auto max-h-[95vh] overflow-auto p-4 relative";

        const wrapper = content.querySelector(".mermaid");
        if (wrapper) {
            wrapper.style.width = "100%";
            wrapper.style.overflow = "auto";
        }

        const svg = content.querySelector("svg");
        if (svg) {
            svg.removeAttribute("style");
            svg.removeAttribute("width");
            svg.removeAttribute("height");

            svg.style.display = "block";
            svg.style.margin  = "0 auto";
            svg.style.width  = "100%";   
            svg.style.height = "auto";
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function closeModal() {
        const modal = document.getElementById("image-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    function syncVocabHeight() {
        const summaryPanel = document.getElementById("summary-panel");
        const vocabPanel   = document.getElementById("vocab-panel");
        
        if (!summaryPanel || !vocabPanel) return;
        if (window.innerWidth < 768) {
            vocabPanel.style.height = "auto";
            return;
        }

        vocabPanel.style.height = "auto";
        const targetHeight = summaryPanel.offsetHeight;
        vocabPanel.style.height = targetHeight + "px";
    }

    function answerMyth(index, chooseTrue) {
        if (!Array.isArray(mythData) || !mythData[index]) return;

        try {
            let firstUnanswered = -1;
            for (let i = 0; i < mythData.length; i++) {
                const fb = document.getElementById(`myth-${i}-feedback`);
                if (fb && fb.dataset.answered !== "1") {
                    firstUnanswered = i;
                    break;
                }
            }
            if (firstUnanswered !== -1 && index !== firstUnanswered) {
                alert("è«‹ä¾ç…§é¡Œè™Ÿé †åºä½œç­”ï¼Œå…ˆå®Œæˆå‰ä¸€é¡Œå–”ï¼");
                return;
            }
        } catch (e) {
            console.log("myth sequential guard error:", e);
        }

        const cardId = `myth-${index}`;
        const btnTrue  = document.getElementById(`${cardId}-btn-true`);
        const btnFalse = document.getElementById(`${cardId}-btn-false`);
        const feedback = document.getElementById(`${cardId}-feedback`);
        if (!btnTrue || !btnFalse || !feedback) return;

        if (feedback.dataset.answered === "1") return;
        feedback.dataset.answered = "1";

        const myth    = mythData[index].myth || mythData[index].misconception || '';
        const correct = mythData[index].correct || mythData[index].explanation || '';

        const isTrueFlag = (typeof mythData[index].isTrue === "boolean") ? mythData[index].isTrue : null;
        let isCorrectChoice;
        if (isTrueFlag === null) {
            isCorrectChoice = !chooseTrue;
        } else {
            isCorrectChoice = (chooseTrue === isTrueFlag);
        }

        [btnTrue, btnFalse].forEach(btn => {
            btn.classList.remove(
                "border-green-500","bg-green-50","text-green-700",
                "border-red-500","bg-red-50","text-red-700",
                "opacity-70"
            );
        });

        let html = "";

        if (isCorrectChoice) {
            if (chooseTrue) {
                btnTrue.classList.add("border-green-500","bg-green-50","text-green-700");
                btnFalse.classList.add("opacity-70");
            } else {
                btnFalse.classList.add("border-green-500","bg-green-50","text-green-700");
                btnTrue.classList.add("opacity-70");
            }
            html = `
                <div class="font-semibold text-emerald-700 mb-1">æ­å–œç­”å°äº†ï¼ä½ çœŸæ£’ï¼</div>
                <div class="text-slate-700 text-sm mb-1">${correct}</div>
            `;
        } else {
            if (chooseTrue) {
                btnTrue.classList.add("border-red-500","bg-red-50","text-red-700");
                btnFalse.classList.add("border-green-500","bg-green-50","text-green-700");
            } else {
                btnFalse.classList.add("border-red-500","bg-red-50","text-red-700");
                btnTrue.classList.add("border-green-500","bg-green-50","text-green-700");
            }
            html = `
                <div class="font-semibold text-orange-600 mb-1">å¯æƒœç­”éŒ¯äº†ï¼Œå†è©¦è©¦ï¼</div>
                <div class="text-slate-700 text-sm mb-1">${correct}</div>
            `;
        }

        feedback.innerHTML = html;
        feedback.classList.remove("hidden");
    }

    function initQuiz(quizRaw) {
        const quizPanel   = document.getElementById("quiz-panel");
        const quizBody    = document.getElementById("quiz-body");
        const quizEmpty   = document.getElementById("quiz-empty");
        const quizTitleEl = document.getElementById("quiz-title");

        if (!quizPanel || !quizBody || !quizEmpty || !quizTitleEl) return;

        const unitName =
            (filters && filters.unitName) ||
            (currentResultData &&
                (currentResultData.unitName ||
                 (currentResultData.raw_content && currentResultData.raw_content.unitName))) ||
            "";
        quizTitleEl.innerText = unitName ? `å–®å…ƒå°æ¸¬é©—ï¼${unitName}` : "å–®å…ƒå°æ¸¬é©—";

        const sourceArray = Array.isArray(quizRaw) ? quizRaw.slice(0, 10) : [];

        if (!Array.isArray(sourceArray) || sourceArray.length === 0) {
            quizState.questions     = [];
            quizState.currentIndex = 0;
            quizState.hasAnswered  = false;
            quizBody.classList.add("hidden");
            quizEmpty.classList.remove("hidden");
            const progress = document.getElementById("quiz-progress");
            if (progress) progress.innerText = "ç¬¬ 0 é¡Œï¼å…± 0 é¡Œ";
            return;
        }

        quizState.questions = sourceArray.map((q, idx) => {
            const stem = q.stem || q.question || q.text || `ç¬¬ ${idx + 1} é¡Œ`;
            let options = q.options || q.choices || q.choice || [];
            if (!Array.isArray(options)) options = [];
            let correctIndex = -1;

            if (typeof q.correctIndex === "number") correctIndex = q.correctIndex;
            else if (typeof q.answerIndex === "number") correctIndex = q.answerIndex;
            else if (typeof q.correct === "number") correctIndex = q.correct;
            else if (typeof q.ans === "number") correctIndex = q.ans;
            else if (typeof q.answer === "string") {
                const map = { "A": 0, "B": 1, "C": 2, "D": 3 };
                const key = q.answer.trim().toUpperCase()[0];
                if (map[key] !== undefined) correctIndex = map[key];
            }

            const explanation = q.explanation || q.explain || q.detail || q.reason || "";
            const id = q.id || `Q${idx + 1}`;
            const concept = q.concept || q.conceptName || q.topic || `ç¬¬ ${idx + 1} é¡Œ`;

            return { id, stem, options, correctIndex, explanation, concept };
        });

        quizState.currentIndex = 0;
        quizState.hasAnswered  = false;
        quizState.answers      = []; 

        quizEmpty.classList.add("hidden");
        quizBody.classList.remove("hidden");

        renderQuizQuestion();
    }

    function renderQuizQuestion() {
        const q = quizState.questions[quizState.currentIndex];
        const quizQuestionEl = document.getElementById("quiz-question");
        const quizOptionsEl  = document.getElementById("quiz-options");
        const quizFeedbackEl = document.getElementById("quiz-feedback");
        const quizProgressEl = document.getElementById("quiz-progress");
        const btnMain        = document.getElementById("quiz-main-btn");

        if (!q || !quizQuestionEl || !quizOptionsEl || !quizFeedbackEl || !quizProgressEl || !btnMain) return;

        const total = quizState.questions.length;
        const index = quizState.currentIndex;

        quizQuestionEl.innerHTML = `<span class="inline-block text-xs font-bold text-slate-500 mb-1">ç¬¬ ${index + 1} é¡Œ</span><br>${q.stem}`;
        quizOptionsEl.innerHTML  = "";
        quizFeedbackEl.classList.add("hidden");
        quizFeedbackEl.innerHTML = "";
        quizState.hasAnswered    = false;

        const letters = ["A", "B", "C", "D", "E", "F"];
        q.options.forEach((opt, optIndex) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "quiz-option-btn w-full text-left px-3 py-2.5 text-sm rounded-xl border border-slate-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 text-slate-800 flex items-center";
            btn.setAttribute("data-opt-index", optIndex);
            btn.onclick = () => handleQuizAnswer(optIndex);
            btn.innerHTML = `<span class="inline-flex items-center justify-center w-6 h-6 mr-2 rounded-full bg-emerald-50 text-emerald-700 text-xs font-bold shrink-0">${letters[optIndex] || ""}</span>${opt}`;
            quizOptionsEl.appendChild(btn);
        });

        quizProgressEl.innerText = `ç¬¬ ${index + 1} é¡Œï¼å…± ${total} é¡Œ`;

        btnMain.disabled = true;
        btnMain.classList.add("opacity-40","cursor-not-allowed");
        btnMain.innerText = (index === total - 1) ? "çœ‹çµæœ" : "ä¸‹ä¸€é¡Œ";
    }

    function handleQuizAnswer(selectedIndex) {
        if (quizState.hasAnswered) return;
        const q = quizState.questions[quizState.currentIndex];
        if (!q) return;

        const quizOptionsEl  = document.getElementById("quiz-options");
        const quizFeedbackEl = document.getElementById("quiz-feedback");
        if (!quizOptionsEl || !quizFeedbackEl) return;

        const buttons = Array.from(quizOptionsEl.querySelectorAll("button.quiz-option-btn"));
        const correctIndex = typeof q.correctIndex === "number" ? q.correctIndex : -1;

        buttons.forEach((btn) => {
            btn.disabled = true;
            btn.classList.remove(
                "border-green-500","bg-green-50","text-green-700",
                "border-red-500","bg-red-50","text-red-700"
            );
        });

        let isCorrect = (selectedIndex === correctIndex && correctIndex >= 0);

        quizState.answers[quizState.currentIndex] = {
            concept: q.concept || q.conceptName || q.topic || `ç¬¬ ${quizState.currentIndex + 1} é¡Œ`,
            isCorrect: isCorrect,
            correct: isCorrect
        };

        if (isCorrect) {
            const btn = buttons[selectedIndex];
            if (btn) {
                btn.classList.add("border-green-500","bg-green-50","text-green-700");
            }
            quizFeedbackEl.className = "mt-4 text-sm rounded-xl px-3 py-2 bg-emerald-50 border border-emerald-200 text-emerald-800";
            quizFeedbackEl.innerHTML = `
                <div class="font-semibold text-emerald-700 mb-1">æ­å–œç­”å°äº†ï¼ä½ çœŸæ£’ï¼</div>
                <div class="text-slate-700 text-sm mb-1">${q.explanation || ""}</div>
            `;
        } else {
            const chosenBtn = buttons[selectedIndex];
            if (chosenBtn) {
                chosenBtn.classList.add("border-red-500","bg-red-50","text-red-700");
            }
            if (correctIndex >= 0 && buttons[correctIndex]) {
                buttons[correctIndex].classList.add("border-green-500","bg-green-50","text-green-700");
            }
            quizFeedbackEl.className = "mt-4 text-sm rounded-xl px-3 py-2 bg-orange-50 border border-orange-200 text-orange-800";
            quizFeedbackEl.innerHTML = `
                <div class="font-semibold text-orange-600 mb-1">å¯æƒœç­”éŒ¯äº†ï¼Œå†è©¦è©¦ï¼</div>
                <div class="text-slate-700 text-sm mb-1">${q.explanation || ""}</div>
            `;
        }

        quizFeedbackEl.classList.remove("hidden");
        quizState.hasAnswered = true;

        const btnMain = document.getElementById("quiz-main-btn");
        if (btnMain) {
            const isLast = (quizState.currentIndex === quizState.questions.length - 1);
            btnMain.disabled = false;
            btnMain.classList.remove("opacity-40","cursor-not-allowed");
            btnMain.innerText = isLast ? "çœ‹çµæœ" : "ä¸‹ä¸€é¡Œ";
        }

        try {
            submitQuizLog(q, selectedIndex, correctIndex, isCorrect);
        } catch (e) {
            console.log("submitQuizLog ç•¥éæˆ–å¤±æ•—ï¼š", e);
        }
    }

    function renderQuizResult() {
        const totalQ = quizState.questions.length;
        if (!totalQ) return;

        const resultBox      = document.getElementById("quiz-result");
        const scoreNumberEl  = document.getElementById("quiz-score-number");
        const scoreLabelEl   = document.getElementById("quiz-score-label");
        const resultTextEl   = document.getElementById("quiz-result-text");
        const detailEl       = document.getElementById("quiz-result-detail");
        const canvas         = document.getElementById("quiz-radar");
        const quizBody       = document.getElementById("quiz-body");
        const quizProgress   = document.getElementById("quiz-progress");
        const btnMain        = document.getElementById("quiz-main-btn");

        if (!resultBox || !scoreNumberEl || !scoreLabelEl || !resultTextEl || !detailEl || !canvas) return;

        if (quizBody) quizBody.classList.add("hidden");
        if (quizProgress) quizProgress.classList.add("hidden");
        if (btnMain) btnMain.classList.add("hidden");

        const answered = quizState.answers.filter(a => a);
        const correctCount = answered.filter(a => a.correct).length;
        const score = Math.round((correctCount / totalQ) * 100);

        resultBox.classList.remove("hidden");

        scoreNumberEl.innerText = `${score} åˆ†`;
        scoreLabelEl.innerText = "AI æ­£åœ¨åˆ†æä½ çš„ä½œç­”çµæœâ€¦";
        resultTextEl.innerText = `ä½ ç­”å° ${correctCount} é¡Œï¼å…± ${totalQ} é¡Œã€‚`;

        const conceptStats = {};
        quizState.questions.forEach((q, idx) => {
            const concept = q.concept || q.conceptName || q.topic || `ç¬¬ ${idx + 1} é¡Œ`;
            if (!conceptStats[concept]) {
                conceptStats[concept] = { total: 0, correct: 0 };
            }
            conceptStats[concept].total += 1;
            const ans = quizState.answers[idx];
            if (ans && ans.correct) {
                conceptStats[concept].correct += 1;
            }
        });

        const concepts = Object.keys(conceptStats);
        const conceptScores = concepts.map(c => {
            const s = conceptStats[c];
            return Math.round((s.correct / s.total) * 100);
        });

        detailEl.innerText = "AI åˆ†æä¸­â€¦";

        const ctx = canvas.getContext("2d");
        if (quizRadarChart) {
            quizRadarChart.destroy();
        }
        quizRadarChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: concepts,
                datasets: [{
                    label: "ç­”å°ç‡ (ï¼…)",
                    data: conceptScores
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: "y",
                scales: {
                    x: {
                        min: 0,
                        max: 100,
                        ticks: {
                            stepSize: 100,
                            callback: (value) => {
                                const v = Number(value);
                                if (v === 0)   return "ç­”éŒ¯";
                                if (v === 100) return "ç­”å°";
                                return "";
                            }
                        }
                    },
                    y: {
                        ticks: {
                            autoSkip: false
                        }
                    }
                }
            }
        });

        try {
            requestQuizAISummary(score, concepts, conceptScores, correctCount, totalQ);
        } catch (e) {
            console.log("requestQuizAISummary å‘¼å«å¤±æ•—ï¼ˆå‰ç«¯å±¤ç´šï¼‰ï¼š", e);
        }
    }
// ====== [QUIZ å¿…è£œï¼šä¸‹ä¸€é¡ŒæŒ‰éˆ•è™•ç†] ======
function handleQuizMainButton() {
  // å°šæœªä½œç­”ï¼Œä¸å…è¨±ä¸‹ä¸€é¡Œ
  if (!quizState.hasAnswered) return;

  const total = quizState.questions.length;
  const idx = quizState.currentIndex;

  // æœ€å¾Œä¸€é¡Œï¼šé¡¯ç¤ºçµæœ
  if (idx >= total - 1) {
    renderQuizResult();
    return;
  }

  // ä¸‹ä¸€é¡Œ
  quizState.currentIndex += 1;
  quizState.hasAnswered = false;
  renderQuizQuestion();
}

// ====== [QUIZ å»ºè­°è£œï¼šé¿å… Console å™´éŒ¯ï¼ˆå¯å…ˆç©ºæ®¼ï¼‰] ======
function submitQuizLog(q, selectedIndex, correctIndex, isCorrect) {
  // å…ˆç•™ç©ºï¼šä¹‹å¾Œè¦é€åˆ° GAS å†è£œ fetch
}

function requestQuizAISummary(score, concepts, conceptScores, correctCount, totalQ) {
  // å…ˆç•™ç©ºï¼šä¹‹å¾Œè¦å‘¼å« GAS ç”¢ç”Ÿè¨ºæ–·å†è£œ fetch
  const scoreLabelEl = document.getElementById("quiz-score-label");
  const detailEl = document.getElementById("quiz-result-detail");
  if (scoreLabelEl) scoreLabelEl.innerText = "ä½œç­”åˆ†æå®Œæˆ";
  if (detailEl) detailEl.innerText = "ï¼ˆå°šæœªå•Ÿç”¨ AI è¨ºæ–·æ‘˜è¦åŠŸèƒ½ï¼‰";
}

    window.addEventListener('resize', syncVocabHeight);  
    </script>
</body>
</html>
