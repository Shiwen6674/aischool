<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ•™å¸«å¾Œå°ï½œAI è¨ºæ–·å ±è¡¨</title>
  <style>
    /* === 1. åŸºæœ¬æ¨£å¼ (CSS) === */
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }

    /* ç™»å…¥å€å¡Š */
    .login-box { text-align: center; margin-bottom: 20px; padding: 20px; background: #ecf0f1; border-radius: 8px; }
    input[type="password"] { padding: 10px; width: 200px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 16px; }
    button.btn-primary { padding: 10px 20px; background: #3498db; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: 0.3s; }
    button.btn-primary:hover { background: #2980b9; }

    /* è¡¨æ ¼å€å¡Š */
    #dashboard { display: none; } /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œé¡¯ç¤º */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #34495e; color: #fff; white-space: nowrap; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
    .score-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 0.9em; }
    .high { background-color: #27ae60; }
    .mid { background-color: #f39c12; }
    .low { background-color: #e74c3c; }

    /* å½ˆå‡ºè¦–çª— (Modal) */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 25px; border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
    .close-btn:hover { color: #333; }
    .modal-header { font-size: 1.2em; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: #2c3e50; }
    
    /* è¨ºæ–·å…§å®¹æ¨£å¼ */
    .diag-section { margin-bottom: 20px; }
    .diag-title { font-weight: bold; color: #e67e22; margin-bottom: 8px; font-size: 1.1em; }
    .action-list { padding-left: 20px; }
    .action-list li { margin-bottom: 8px; line-height: 1.6; }
    .loading { text-align: center; color: #7f8c8d; font-style: italic; display: none; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ‘¨â€ğŸ« æ•™å¸«å¾Œå°ï¼šAI å­¸ç¿’è¨ºæ–·å„€è¡¨æ¿</h1>

  <div class="login-box" id="loginSection">
    <p>è«‹è¼¸å…¥æ•™å¸«é€šé—œå¯†ç¢¼</p>
    <input type="password" id="teacherPwd" placeholder="è¼¸å…¥å¯†ç¢¼ (é è¨­: admin)">
    <button class="btn-primary" onclick="fetchTeacherData()">ç™»å…¥æŸ¥è©¢</button>
    <div id="loadingText" class="loading">è³‡æ–™è®€å–ä¸­ï¼Œè«‹ç¨å€™...</div>
  </div>

  <div id="dashboard">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>å­¸ç”Ÿæ¸¬é©—ç´€éŒ„åˆ—è¡¨</h3>
      <button class="btn-primary" onclick="location.reload()" style="background:#95a5a6; font-size:14px;">é‡æ–°æ•´ç†</button>
    </div>
    <table id="reportTable">
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>åº§è™Ÿ/ID</th>
          <th>å¾—åˆ†</th>
          <th>èƒ½åŠ›å€¼(Î¸)</th>
          <th>AI ç¸½çµæ‘˜è¦</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal(event)">&times;</span>
    <div class="modal-header" id="modalTitle">å­¸ç”Ÿè©³æƒ…</div>
    <div id="modalBody">
      </div>
  </div>
</div>

<script>
  /* === 2. JavaScript é‚è¼¯ === */
  
  // â˜…â˜…â˜… è«‹å‹™å¿…ä¿®æ”¹é€™è£¡ï¼šæ›æˆä½ ç™¼å¸ƒå¾Œçš„ Web App ç¶²å€ â˜…â˜…â˜…
  const GAS_URL = "https://script.google.com/macros/s/ä½ çš„ç™¼å¸ƒID/exec"; 

  // 1. ç²å–è³‡æ–™
  function fetchTeacherData() {
    const pwd = document.getElementById('teacherPwd').value.trim();
    if(!pwd) { alert("è«‹è¼¸å…¥å¯†ç¢¼ï¼"); return; }

    // é¡¯ç¤º Loading
    document.getElementById('loadingText').style.display = 'block';
    
    // ç™¼é€è«‹æ±‚
    const apiUrl = `${GAS_URL}?action=get_teacher_data&password=${encodeURIComponent(pwd)}`;

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        document.getElementById('loadingText').style.display = 'none';
        
        if (!data.ok) {
          alert("éŒ¯èª¤ï¼š" + (data.error || "ç„¡æ³•è®€å–è³‡æ–™"));
          return;
        }

        if (data.reports.length === 0) {
          alert("ç›®å‰å°šç„¡å­¸ç”Ÿæ¸¬é©—è³‡æ–™ã€‚");
          return;
        }

        // ç™»å…¥æˆåŠŸï¼Œåˆ‡æ›ç•«é¢
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
        renderTable(data.reports);
      })
      .catch(err => {
        document.getElementById('loadingText').style.display = 'none';
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯ç‹€æ…‹ã€‚\n" + err);
      });
  }

  // 2. æ¸²æŸ“è¡¨æ ¼
  function renderTable(reports) {
    const tbody = document.querySelector("#reportTable tbody");
    tbody.innerHTML = ""; // æ¸…ç©ºèˆŠè³‡æ–™

    reports.forEach(row => {
      const tr = document.createElement("tr");
      
      // æ™‚é–“æ ¼å¼åŒ–
      const date = new Date(row.timestamp);
      const timeStr = date.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });

      // åˆ†æ•¸é¡è‰²æ¨™è¨˜
      let badgeClass = "low";
      if(row.score >= 80) badgeClass = "high";
      else if(row.score >= 60) badgeClass = "mid";

      tr.innerHTML = `
        <td>${timeStr}</td>
        <td><strong>${row.student_id}</strong></td>
        <td><span class="score-badge ${badgeClass}">${row.score}</span></td>
        <td>${row.theta}</td>
        <td style="color:#555; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          ${row.summary || "(ç„¡æ‘˜è¦)"}
        </td>
        <td><button style="padding:5px 10px; cursor:pointer;" onclick="showDetail(${rowsJson(row)})">æŸ¥çœ‹è™•æ–¹ç±¤</button></td>
      `;
      
      // é»æ“Šæ•´è¡Œä¹Ÿå¯ä»¥é–‹
      tr.addEventListener('click', (e) => {
        // é¿å…é»åˆ°æŒ‰éˆ•æ™‚è§¸ç™¼å…©æ¬¡
        if(e.target.tagName !== 'BUTTON') showDetail(row);
      });

      tbody.appendChild(tr);
    });
  }

  // è¼”åŠ©ï¼šå°‡ç‰©ä»¶è½‰ç‚º JSON å­—ä¸²å‚³é (éœ€è™•ç†è·³è„«å­—å…ƒ)
  function rowsJson(row) {
    // é€™è£¡ç‚ºäº†ç°¡å–®ï¼Œç›´æ¥åœ¨ onclick å‚³éç‰©ä»¶ç´¢å¼•æœƒæ¯”è¼ƒå®‰å…¨ï¼Œ
    // ä½†å› ç‚ºæˆ‘å€‘æ˜¯ç”Ÿæˆ HTMLï¼Œç›´æ¥ç”¨é–‰åŒ…æ¦‚å¿µåœ¨ renderTable è£¡çš„ addEventListener è™•ç†æœ€å¥½ (å¦‚ä¸Šæ–¹çš„ tr.addEventListener)
    // é€™è£¡åªæ˜¯ç‚ºäº† button onclick èªæ³•ç›¸å®¹ï¼Œå¯¦éš›ä¸Š tr.addEventListener å·²è¶³å¤ ã€‚
    return ""; 
  }

  // 3. é¡¯ç¤ºå½ˆçª—è©³æƒ…
  function showDetail(row) {
    const modal = document.getElementById('detailModal');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');

    title.innerText = `å­¸ç”Ÿï¼š${row.student_id} (å¾—åˆ†:${row.score})`;

    // å–å‡ºå®Œæ•´ AI å›é¥‹
    const ai = row.full_feedback || {};
    const weak = ai.weakness_analysis || "ç„¡å¼±é»åˆ†æ";
    const plans = Array.isArray(ai.action_plan) ? ai.action_plan : ["ç„¡å…·é«”å»ºè­°"];

    // çµ„è£ HTML
    let html = "";

    // å¼±é»åˆ†æå€å¡Š
    html += `
      <div class="diag-section">
        <div class="diag-title">ğŸ” å¼±é»è¨ºæ–·èˆ‡è¿·æ€æ¦‚å¿µ</div>
        <div style="white-space: pre-line; color:#34495e; background:#f9f9f9; padding:10px; border-radius:5px;">
          ${weak}
        </div>
      </div>
    `;

    // è™•æ–¹ç±¤å€å¡Š
    html += `
      <div class="diag-section">
        <div class="diag-title">ğŸ’Š AI å­¸ç¿’è™•æ–¹ç±¤ (Action Plan)</div>
        <ul class="action-list">
          ${plans.map(p => `<li>${p}</li>`).join('')}
        </ul>
      </div>
    `;

    body.innerHTML = html;
    modal.style.display = 'flex';
  }

  // 4. é—œé–‰å½ˆçª—
  function closeModal(e) {
    // é»æ“Šé®ç½©æˆ– X æŒ‰éˆ•æ‰é—œé–‰
    if (e.target.id === 'detailModal' || e.target.classList.contains('close-btn')) {
      document.getElementById('detailModal').style.display = 'none';
    }
  }
</script>

</body>
</html>
